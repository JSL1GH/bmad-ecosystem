\chapter{Physics}

%-----------------------------------------------------------------
\section{Units}
\label{s:units}

\bmad\ uses SI (Syst\'eme International) units as shown in
Table~\ref{t:units}.  Note that \mad\ uses different units. For example,
\mad's unit of Particle Energy is GeV not eV.
\begin{table}[h]
\centering
\begin{tabular}{|l|l|} \hline
  {\em Quantity}     & {\em Units}       \\ \hline
  Angles             &    radians        \\ 
  Phase Angles (RF)  &    radians/2$\pi$ \\ 
  Frequency          &    Hz             \\ 
  Current            &    Amps           \\ 
  Kick               &    radians        \\ 
  Length             &    meters         \\ 
  Magnetic Field     &    Tesla          \\ 
  Particle Energy    &    eV             \\ 
  Voltage            &    Volts          \\ \hline
\end{tabular}
\caption{Physical Units used by \bmad.}
\label{t:units}
\end{table}


%-----------------------------------------------------------------
\section{Constants}
\label{s:constants}

\bmad\ defines commonly used physical and mathematical constants as
shown in Table~\ref{t:constants}.  All symbols use straight SI units
except for \vn{e_mass} and \vn{p_mass} which are provided for
compatibility with \mad.

\begin{table}
\centering
\begin{tabular}{|l|l|l|l|} \hline
  {\em Symbol}   & {\em Value}       & {\em Units} &  {\em Name}     \\ \hline
  pi             & 3.14159265359          &        &                   \\
  twopi          & 2 * pi                 &        &                   \\
  fourpi         & 4 * pi                 &        &                   \\
  sqrt\_2        & 1.4142135623731        &        &                   \\
  m\_electron    & $0.51099906 \pow{6}$   & eV     & Electron mass     \\
  m\_proton      & $0.938271998 \pow{9}$  & eV     & Proton mass       \\
  c\_light       & $2.99792458 \pow{8}$   & m/s    & Speed of light    \\
  r\_e           & $2.8179380 \pow{-15}$  & m      & Electron radius   \\
  r\_p           & $1.5346980 \pow{-18}$  & m      & Proton radius     \\
  e\_charge      & $1.6021892 \pow{-19}$  & C      & Electron charge   \\
  h\_planck      & $6.626196 \pow{-34}$   & J/Hz   & Planck's constant \\
  h\_bar\_planck & $1.054591 \pow{-34}$   & J s    & Planck / $2\pi$   \\
  e\_mass        & $0.51099906 \pow{-3}$  & GeV    & Electron mass     \\
  p\_mass        & $0.938271998$          & GeV    & Proton mass     \\ \hline
\end{tabular}
\caption{Physical and Mathematical constants recognized by \bmad.}
\label{t:constants}
\end{table}


%-----------------------------------------------------------------
\section{Magnetic Fields}
\label{s:fields}

Start with the assumption that the local magnetic field has no
longitudinal component (obviously this assumption does not work with,
say, a solenoid).  Following \mad, the vertical magnetic field is
expanded in a Taylor Series
\Begineq
  B_y(x, 0) = \sum_n B_n \, \frac{x^n}{n!}
\Endeq
Assuming that the Reference Orbit is locally along a straight line
(there are correction terms if the Reference Orbit is locally curved) the 
field up to $3^{rd}$ order is
\begin{alignat}{5}
  B_x &=           &&B_1 y \plus         &&B_2 \, xy       && \plus && \frac{1}{6} B_3 (3x^2 y - y^3) \plus \ldots \\
  B_y &= B_0 \plus &&B_1 x + \frac{1}{2} &&B_2 (x^2 - y^2) && \plus && \frac{1}{6} B_3 (x^3 - 3x y^2) \plus \ldots
\end{alignat}
When specifying magnetic multipole components what is used is the
normalized integrated multipole $K_nL$
\Begineq
  K_nL = \frac{c \, L \, B_n}{P_0}
\Endeq
where $L \, B_n$ is the integrated multipole component over a length
$L$ and $P_0$ is the nominal beam momentum. Note that often you will see
$P_0$ written as $B\rho$. This is just an old notation where $\rho$
is the bending radius of a particle with the nominal energy in a field
of strength $B$. In terms of the kicks $\Delta p_x$ and $\Delta p_y$
a particle experineces going through a multipole field is
\begin{alignat}{5}
  \Delta p_x & = \frac{-L \, B_y}{P_0} \\
             & = -K_0 L \;-\; 
             && K_1 L \, x \plus 
             \frac{1}{2} && K_2 L (y^2 - x^2) && \plus 
             && \frac{1}{6} K_3 L (3x y^2 - x^3) \plus \ldots \nonumber \\
  \Delta p_y & = \frac{L \, B_x}{P_0} \\
             & =     
             && K_1 L \, y \plus 
             && K_2 L \, xy && \plus 
             && \frac{1}{6} K_3L (3x^2 y - y^3) \plus \ldots \nonumber 
\end{alignat}
Note that in particular a positive $K_1L$ quadrupole component gives
horizontal focusing and vertical defocusing. 

If the fields associated with a particular $B_n$ multipole component
are rotated in the $(x, y)$ plane by an angle $\phi_n$ the magnetic
field at a point $(x,y)$ can be expressed in complex notation as
\Begineq
  B_y(x,y) + i B_x(x,y) = 
                \frac{1}{n!} B_n e^{-i(n+1)\phi_n} \, e^{i n \theta} \, r^n 
\Endeq
where $(r, \theta)$ are the polar coordinates of the point $(x, y)$.

Another representation of the magnetic field used by \bmad\ divides
the fields into normal $b_n$ and skew $a_n$ components In terms of
these components the magnetic field is
\Begineq
  \frac{L}{P_0} \, (B_y + i B_x) = (b_n + i a_n) \, (x + i y)^n
\Endeq
The conversion between $a_n$, $b_n$ and $K_nL$, $\phi_n$ is
\Begineq
  b_n + i a_n = \frac{1}{n!} \, K_nL \, e^{-i(n+1)\phi_n}
\Endeq
or
\begin{align}
  K_n L &= n! \, \sqrt{a_n^2 + b_n^2} \\
  \tan[(n+1) \phi_n] &= \frac{-a_n}{b_n}
\end{align}

When the $a_n$ and $b_n$ are associated with a physical element (as
opposed to the $a_n$ and $b_n$ associated with an \vn{ab_multipole}),
a measurement radius $r_0$ and a scale factor
$F$ are used to scale the $a_n$ and $b_n$ according to the formula
\begin{align}
  a_n &\rightarrow 
        a_n \cdot F \cdot \frac{r_0^{n_\text{ref}}}{r_0^n} \nonumber \\
  b_n &\rightarrow 
        b_n \cdot F \cdot \frac{r_0^{n_\text{ref}}}{r_0^n}
\end{align}
$r_0$ is set by the \vn{radius} attribute of an element. $F$ and $n_\text{ref}$ 
are set automatically depending upon the type of element as shown in 
table~\ref{t:ab}

\begin{table}[h]
\centering
\begin{tabular}{|l|l|l|} \hline
\tt
  {\em Element} & $F$                              & $n_\text{ref}$ \\ \hline
  Kicker        & $\sqrt{{\tt Hkick}^2 + {\tt Vkick}^2}$ & 0 \\
  Hkicker       & Kick                                   & 0 \\
  Vkicker       & Kick                                   & 0 \\
  Rbend         & G * L                                  & 0 \\
  Sbend         & G * L                                  & 0 \\
  Elseparator   & $\sqrt{{\tt Hkick}^2 + {\tt Vkick}^2}$ & 0 \\
  Quadrupole    & K1 * L                                 & 1 \\
  Solenoid      & KS * L                                 & 1 \\
  Sol\_Quad     & K1 * L                                 & 1 \\
  Sextupole     & K2 * L                                 & 2 \\
  Octupole      & K3 * L                                 & 3 \\ \hline
\end{tabular}
\caption{$F$ and $n_\text{ref}$ for various elements.}
\label{t:ab}
\end{table}

%-----------------------------------------------------------------
\section{Taylor Maps}
\label{s:taylor_phys}

A Transport Map ${\cal M}: {\cal R}^6 \rightarrow {\cal R}^6$ through
an element or a section of a lattice is a function that maps the
starting phase space coordinates $\Bf r_{in}$ to the ending
coordinates $\Bf r_{out}$
\begin{equation}
  \Bf r_(out) = {\cal M} \, \Bf r_(in)
\end{equation}
${\cal M}$ is made up of 6 functions ${\cal M}_i: {\cal R}^6
 \rightarrow {\cal R}$. Each of these functions maps to one of the $r_{out}$
coordinates. These functions can be expanded in a Taylor
series. The Taylor Map corresponding to $\cal M$ is the collection of
the 6 Taylor series. Each series is in the form
\Begineq
  r_i(out) = \sum_{j = 1}^N \, C_{ij} \, \prod_{k = 1}^6 \, r_k^{e_{ijk}}(in)
\Endeq
Where the $C_{ij}$ are coefficients and the $e_{ijk}$ are integer exponents.
The order of the Map is
\Begineq
  \mbox{Map Order} = \max_{i,j} \, \sum_{k = 1}^6 e_{ijk}
\Endeq

%-----------------------------------------------------------------
\section{Symplectification}
\label{s:symp_method}

If the evolution of a system can be described using a Hamiltonian then
it can be shown that the linear part of any transport map (the Jacobian)
must obey the symplectic condition. If a Jacobian $\Bf M$ is not symplectic,
Healy\cite{b:healy} has provided an elegant method for finding a matrix that
is ``close'' to $\Bf M$ and symplectic. The procedure is as follows:
From $\Bf M$ a matrix $\Bf V$ is formed via
\begin{equation}
  \Bf V = \Bf S (\Bf I - \Bf M)(\Bf I + \Bf M)^{-1} 
  \label{e:vsimi}
\end{equation}
where $\Bf S$ is the matrix
\Begineq
  \Bf S = 
  \begin{pmatrix} 
      0 &  1 &  0 &  0 &  0 &  0 \cr
     -1 &  0 &  0 &  0 &  0 &  0 \cr
      0 &  0 &  0 &  1 &  0 &  0 \cr
      0 &  0 & -1 &  0 &  0 &  0 \cr
      0 &  0 &  0 &  0 &  0 & -1 \cr
      0 &  0 &  0 &  0 & -1 &  0 \cr
  \end{pmatrix}
  \label{s0100}
\Endeq
$\Bf V$ is symmetric if and only if $\Bf M$ is symplectic. In any case,
a symmetric matrix $\Bf W$ near $\Bf V$ can be
formed via
\begin{equation}
  \Bf W = \frac{\Bf V + \Bf V^t}{2}
\end{equation}
A symplectic matrix $\Bf F$ is now obtained by inverting \eq{e:vsimi}
\Begineq
  \Bf F = (\Bf I + \Bf S \Bf W) (\Bf I - \Bf S \Bf W)^{-1}
\Endeq

%-----------------------------------------------------------------
\section{Wigglers}
\label{s:wiggler_phys}

As discussed in Section~\ref{s:wig} \bmad\ wiggler elements are split into 
two classes: map type and periodic type.


The map type wigglers are modeled using the paper by Sagan, Crittenden, 
and Rubin\cite{b:scr}. In this model the magnetic field is written as 
a sum of terms $B_i$
\Begineq
  B(x,y,z) = \sum_i B_i(x, y, z; C, k_x, k_y, k_z, \phi_z)
\Endeq 
each term $B_i$ is specified in using 5 numbers: 
$(C, k_x, k_y, k_z, phi_z)$. A term can take one of three forms. The first
form is
\begin{alignat}{4}
  B_x &= -&C &\dfrac{k_x}{k_y} & \sin(\kxx) \sinh(\kyy) \cos(\ksss) \CRNEG
  B_y &=  &C &                 & \cos(\kxx) \cosh(\kyy) \cos(\ksss) \CRNEG
  B_s &= -&C &\dfrac{k_s}{k_y} & \cos(\kxx) \sinh(\kyy) \sin(\ksss) \CRneg
  & \makebox[1pt][l]{with $k_y^2 = k_x^2 + k_s^2$ .} &&&  \label{f1}
\end{alignat}
The second form is
\begin{alignat}{4}
  B_x &=  &C &\dfrac{k_x}{k_y} & \sinh(\kxx) \sinh(\kyy) \cos(\ksss) \CRNEG
  B_y &=  &C &                 & \cosh(\kxx) \cosh(\kyy) \cos(\ksss) \CRNEG
  B_s &= -&C &\dfrac{k_s}{k_y} & \cosh(\kxx) \sinh(\kyy) \sin(\ksss) \CRneg
  & \makebox[1pt][l]{with $k_y^2 = k_s^2 - k_x^2$ ,} &&&  \label{f2}
\end{alignat}
and the third form is
\begin{alignat}{4}
  B_x &=  &C &\dfrac{k_x}{k_y} & \sinh(\kxx) \sin(\kyy) \cos(\ksss) \CRNEG
  B_y &=  &C &                 & \cosh(\kxx) \cos(\kyy) \cos(\ksss) \CRNEG
  B_s &= -&C &\dfrac{k_s}{k_y} & \cosh(\kxx) \sin(\kyy) \sin(\ksss) \CRneg
  & \makebox[1pt][l]{with $k_y^2 = k_x^2 - k_s^2$ .} &&& \label{f3}
\end{alignat}
The relationship between $k_x$, $k_y$, and $k_z$ ensures that Maxwell's equations
are satisfied. Since the field is given by analytic equations, Lie algebraic
techniques can be use to construct Taylor maps to arbitrary order.

%-----------------------------------------------------------------
\section{Radiation Damping and Excitation}
\label{s:radiation}



%-----------------------------------------------------------------
\section{Wakefields}
\label{s:wakefields}



%-----------------------------------------------------------------
\section{Macro Particles}
\label{s:macro}



%-----------------------------------------------------------------
\section{Coupling and Normal Modes}
\label{s:coupling}

The coupling formalism used by \bmad\ is taken from the paper of Sagan
and Rubin\cite{b:coupling}. The main equations are reporduced here.  A
1--turn map $\bfT(s)$ for the transverse 2--dimensional phase space
$\bfx = (x, x', y, y')$ starting and ending at some point $s$ can be
written as
  \Begineq
    \bfT = \bfV \, \bfU \, \bfV\inv 
    , \label{tvuv}
  \Endeq 
where $\bfV$ is symplectic, and $\bfU$ is of the form
  \Begineq
    \bfU = 
    \begin{pmatrix}
      \bfA & \Bf0 \cr 
      \Bf0 & \bfB \cr
    \end{pmatrix}
    . \label{ua00b}
  \Endeq
Since $\bfU$ is uncoupled the standard Twiss analysis can be
proformed on the matrices $\bfA$ and $\bfB$. The normal modes
are labeled $a$ and $b$ and if the 1--turn matrix $\bfT$ is
uncoupled then $a$ corresponds to the horizontal mode and $b$
corresponds to the vertical mode. 

$\bfV$ is written in the form
  \Begineq
    \bfV = 
    \begin{pmatrix}
        \gamma \bfI & \bfC \cr 
        -\bfC^+     & \gamma \bfI \cr
    \end{pmatrix}
    , \label{vgicc1}
  \Endeq
where the symplectic conjugate is 
  \Begineq
    \bfC^+ = 
    \begin{pmatrix}
       C_{22} & -C_{12} \cr 
      -C_{21} & C_{11} \cr
    \end{pmatrix}
    . \label{ccccc}
  \Endeq
Since we demand that $\bfV$ be symplectic we have the condition
  \Begineq               
    \gamma^2 + \, ||\bfC|| = 1
    , \label{gc1}
  \Endeq
and $\bfV\inv$ is given by
  \Begineq
    \bfV\inv = 
    \begin{pmatrix}
      \gamma \bfI & -\bfC \cr 
      \bfC^+ & \gamma \bfI \cr
    \end{pmatrix}
    . \label{vgicc2}
  \Endeq 
$\bfC$ is a measure of the coupling and when $\bfC = \Bf 0$
$\bfT$ is uncoupled. 

It is useful to normalize out the $\beta(s)$ variaion in the the above
analysis. Normalized quantities being denoted by a bar above them. The
normailized normal mode matrix $\Bar\bfU$ is defined by
  \Begineq
    \Bar\bfU = \bfG \, \bfU \, \bfG\inv
    , \label{ugug}
  \Endeq
Where $\bfG$ is given by 
  \Begineq
    \bfG \equiv 
    \begin{pmatrix}
      \bfG_a & \Bf0 \cr 
      \Bf0 & \bfG_b
    \end{pmatrix}
    , \label{gg00g}
  \Endeq  
with 
  \Begineq
    \Bf G_a = 
    \begin{pmatrix}
      \frac{\tstyle 1}{\tstyle \sqrt{\beta_a}} & 0 \cr
      \frac{\tstyle \alpha_a}{\tstyle \sqrt{\beta_a}} & \sqrt{\beta_a}
    \end{pmatrix}
    , \label{g1b0a} 
  \Endeq
with a similar equation for $\Bf G_b$. With this definition the corresponing
$\Bar\bfA$ and $\Bar\bfB$ (cf.~\Eq{ua00b} are just rotation matrices.
The relationship between $\bfT$ and $\Bar\bfU$ is 
  \Begineq
    \bfT = \bfG\inv \, \Bar\bfV \, \Bar\bfU \, \Bar\bfV\inv \, \bfG
    , \label{tgvuv}
  \Endeq
where
  \Begineq
    \Bar\bfV = \bfG \, \bfV \, \bfG\inv
    . \label{vgvg}
  \Endeq
Using \Eq{gg00g}, $\Bar\bfV$ can be written in the form
  \Begineq
    \Bar\bfV = 
    \begin{pmatrix}
      \gamma \bfI & \Bar\bfC \cr -\Bar\bfC^+ & \gamma \bfI
    \end{pmatrix}
    , \label{vgicc3}
  \Endeq
with the normalized matrix $\Bar\bfC$ given by
  \Begineq
    \Bar\bfC = \bfG_a \, \bfC \, \bfG_b\inv
    . \label{cgcg}
  \Endeq

The normal mode coordinates ${\bf a} = (a, a', b, b')$ are related to
the laboratory frame via
  \Begineq
    {\bf a} = \bfV\inv \, {\bf x}
    . \label{avx}
  \Endeq 
In particular the normal mode disperion $\bfeta_a = (\eta_a,
\eta'_a, \eta_b, \eta'_b)$ is related to the laboratory frame
disperion $\bfeta_x = (\eta_x, \eta'_x, \eta_y, \eta'_y)$ via
  \Begineq
    {\bfeta_a} = \bfV\inv \, {\bf eta_x}
    . \label{etaavx}
  \Endeq 
