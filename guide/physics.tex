\chapter{Physics}

%-----------------------------------------------------------------
\section{Units}
\label{s:units}

\bmad\ uses SI (Syst\'eme International) units as shown in
Table~\ref{t:units}.  Note that \mad\ uses different units. For example,
\mad's unit of Particle Energy is GeV not eV.
\begin{table}[h]
\centering
\begin{tabular}{|l|l|} \hline
  {\em Quantity}     & {\em Units}       \\ \hline
  Angles             &    radians        \\ 
  Phase Angles (RF)  &    radians/2$\pi$ \\ 
  Frequency          &    Hz             \\ 
  Current            &    Amps           \\ 
  Kick               &    radians        \\ 
  Length             &    meters         \\ 
  Magnetic Field     &    Tesla          \\ 
  Particle Energy    &    eV             \\ 
  Voltage            &    Volts          \\ \hline
\end{tabular}
\caption{Physical units used by \bmad.}
\label{t:units}
\end{table}


%-----------------------------------------------------------------
\section{Constants}
\label{s:constants}

\bmad\ defines commonly used physical and mathematical constants
shown in Table~\ref{t:constants}.  All symbols use straight SI units
except for \vn{e_mass} and \vn{p_mass} which are provided for
compatibility with \mad.

\begin{table}
\centering
\begin{tabular}{|l|l|l|l|} \hline
  {\em Symbol}   & {\em Value}       & {\em Units} &  {\em Name}     \\ \hline
  pi             & 3.14159265359          &        &                   \\
  twopi          & 2 * pi                 &        &                   \\
  fourpi         & 4 * pi                 &        &                   \\
  sqrt\_2        & 1.4142135623731        &        &                   \\
  m\_electron    & $0.51099906 \pow{6}$   & eV     & Electron mass     \\
  m\_proton      & $0.938271998 \pow{9}$  & eV     & Proton mass       \\
  c\_light       & $2.99792458 \pow{8}$   & m/s    & Speed of light    \\
  r\_e           & $2.8179380 \pow{-15}$  & m      & Electron radius   \\
  r\_p           & $1.5346980 \pow{-18}$  & m      & Proton radius     \\
  e\_charge      & $1.6021892 \pow{-19}$  & C      & Electron charge   \\
  h\_planck      & $6.626196 \pow{-34}$   & J/Hz   & Planck's constant \\
  h\_bar\_planck & $1.054591 \pow{-34}$   & J s    & Planck / $2\pi$   \\
  e\_mass        & $0.51099906 \pow{-3}$  & GeV    & Electron mass     \\
  p\_mass        & $0.938271998$          & GeV    & Proton mass     \\ \hline
\end{tabular}
\caption{Physical and mathematical constants recognized by \bmad.}
\label{t:constants}
\end{table}


%-----------------------------------------------------------------
\section{Magnetic Fields}
\label{s:fields}

Start with the assumption that the local magnetic field has no
longitudinal component (obviously this assumption does not work with,
say, a solenoid).  Following \mad, the vertical magnetic field is
expanded in a Taylor series
\Begineq
  B_y(x, 0) = \sum_n B_n \, \frac{x^n}{n!}
\Endeq
Assuming that the reference orbit is locally straight 
(there are correction terms if the Reference Orbit is locally curved), the 
field up to $3^{rd}$ order is
\begin{alignat}{5}
  B_x &=           &&B_1 y \plus         &&B_2 \, xy       && \plus && \frac{1}{6} B_3 (3x^2 y - y^3) \plus \ldots \\
  B_y &= B_0 \plus &&B_1 x + \frac{1}{2} &&B_2 (x^2 - y^2) && \plus && \frac{1}{6} B_3 (x^3 - 3x y^2) \plus \ldots
\end{alignat}
The normalized integrated multipole $K_nL$ is used when specifying magnetic
multipole components
\Begineq
  K_nL \equiv \frac{c \, L \, B_n}{P_0}
\Endeq
$L \, B_n$ is the integrated multipole component over a length $L$,
and $P_0$ is the reference momentum. Note that $P_0$ is sometimes
written as $B\rho$. This is just an old notation where $\rho$ is the
bending radius of a particle with the reference energy in a field of
strength $B$. The kicks $\Delta p_x$ and $\Delta p_y$ that a
particle experiences going through a multipole field is
\begin{alignat}{5}
  \Delta p_x & = \frac{-L \, B_y}{P_0} \\
             & = -K_0 L \;-\; 
             && K_1 L \, x \plus 
             \frac{1}{2} && K_2 L (y^2 - x^2) && \plus 
             && \frac{1}{6} K_3 L (3x y^2 - x^3) \plus \ldots \nonumber \\
  \Delta p_y & = \frac{L \, B_x}{P_0} \\
             & =     
             && K_1 L \, y \plus 
             && K_2 L \, xy && \plus 
             && \frac{1}{6} K_3L (3x^2 y - y^3) \plus \ldots \nonumber 
\end{alignat}
A positive $K_1L$ quadrupole component gives
horizontal focusing and vertical defocusing. 

If the fields associated with a particular $B_n$ multipole component
are rotated in the $(x, y)$ plane by an angle $\phi_n$ the magnetic
field at a point $(x,y)$ can be expressed in complex notation as
\Begineq
  B_y(x,y) + i B_x(x,y) = 
                \frac{1}{n!} B_n e^{-i(n+1)\phi_n} \, e^{i n \theta} \, r^n 
\Endeq
where $(r, \theta)$ are the polar coordinates of the point $(x, y)$.

Another representation of the magnetic field used by \bmad\ divides
the fields into normal $b_n$ and skew $a_n$ components. In terms of
these components the magnetic field for the $n$\Th\ component is
\Begineq
  \frac{L}{P_0} \, (B_y + i B_x) = (b_n + i a_n) \, (x + i y)^n
\Endeq
The conversion between $(a_n, b_n)$ and $(K_nL, \phi_n)$ is
\Begineq
  b_n + i a_n = \frac{1}{n!} \, K_nL \, e^{-i(n+1)\phi_n}
\Endeq
or
\begin{align}
  K_n L &= n! \, \sqrt{a_n^2 + b_n^2} \\
  \tan[(n+1) \phi_n] &= \frac{-a_n}{b_n}
\end{align}

When the $a_n$ and $b_n$ are associated with a physical element (as
opposed to the $a_n$ and $b_n$ associated with an \vn{AB_Multipole}),
a measurement radius $r_0$ and a scale factor $F$ are used to scale
the $a_n$ and $b_n$ according to the formula
\begin{align}
  a_n &\rightarrow 
        a_n \cdot F \cdot \frac{r_0^{n_\text{ref}}}{r_0^n} \nonumber \\
  b_n &\rightarrow 
        b_n \cdot F \cdot \frac{r_0^{n_\text{ref}}}{r_0^n}
\end{align}
where $r_0$ is set by the \vn{radius} attribute of an element. $F$ and
$n_\text{ref}$ are set automatically depending upon the type of
element as shown in Table~\ref{t:ab}.

Note that the $n = 0$ component of an \vn{AB_Multipole} or \vn{Multipole}
element rotates the reference orbit essentially acting as a zero length bend.
This is not true for multipoles that are associated with 
non-multipole elements.

\begin{table}[h]
\centering
\begin{tabular}{|l|l|l|} \hline
\tt
  {\em Element} & $F$                              & $n_\text{ref}$ \\ \hline
  Kicker        & $\sqrt{{\tt Hkick}^2 + {\tt Vkick}^2}$ & 0 \\
  Hkicker       & Kick                                   & 0 \\
  Vkicker       & Kick                                   & 0 \\
  Rbend         & G * L                                  & 0 \\
  Sbend         & G * L                                  & 0 \\
  Elseparator   & $\sqrt{{\tt Hkick}^2 + {\tt Vkick}^2}$ & 0 \\
  Quadrupole    & K1 * L                                 & 1 \\
  Solenoid      & KS * L                                 & 1 \\
  Sol\_Quad     & K1 * L                                 & 1 \\
  Sextupole     & K2 * L                                 & 2 \\
  Octupole      & K3 * L                                 & 3 \\ \hline
\end{tabular}
\caption{$F$ and $n_\text{ref}$ for various elements.}
\label{t:ab}
\end{table}

%-----------------------------------------------------------------
\section{Taylor Maps}
\label{s:taylor_phys}

A transport map ${\cal M}: {\cal R}^6 \rightarrow {\cal R}^6$ through
an element or a section of a lattice is a function that maps the
starting phase space coordinates $\Bf r(\In)$ to the ending
coordinates $\Bf r(\Out)$
\begin{equation}
  \Bf r(\Out) = {\cal M} \, \Bf r(\In)
\end{equation}
${\cal M}$ is made up of six functions ${\cal M}_i: {\cal R}^6
 \rightarrow {\cal R}$. Each of these functions maps to one of the $r(\Out)$
coordinates. These functions can be expanded in a Taylor
series and truncated at some order. Each Taylor series is in the form
\Begineq
  r_i(\Out) = \sum_{j = 1}^N \, C_{ij} \, \prod_{k = 1}^6 \, r_k^{e_{ijk}}(\In)
\Endeq
Where the $C_{ij}$ are coefficients and the $e_{ijk}$ are integer exponents.
The order of the map is
\Begineq
  \mbox{order} = \max_{i,j} \left( \sum_{k = 1}^6 e_{ijk} \right)
\Endeq

%-----------------------------------------------------------------
\section{Symplectification}
\label{s:symp_method}

If the evolution of a system can be described using a Hamiltonian then
it can be shown that the linear part of any transport map (the Jacobian)
must obey the symplectic condition. If a matrix $\Bf M$ is not symplectic,
Healy\cite{b:healy} has provided an elegant method for finding a symplectic 
matrix that is ``close'' to $\Bf M$. The procedure is as follows:
From $\Bf M$ a matrix $\Bf V$ is formed via
\begin{equation}
  \Bf V = \Bf S (\Bf I - \Bf M)(\Bf I + \Bf M)^{-1} 
  \label{e:vsimi}
\end{equation}
where $\Bf S$ is the matrix
\Begineq
  \Bf S = 
  \begin{pmatrix} 
      0 &  1 &  0 &  0 &  0 &  0 \cr
     -1 &  0 &  0 &  0 &  0 &  0 \cr
      0 &  0 &  0 &  1 &  0 &  0 \cr
      0 &  0 & -1 &  0 &  0 &  0 \cr
      0 &  0 &  0 &  0 &  0 & -1 \cr
      0 &  0 &  0 &  0 & -1 &  0 \cr
  \end{pmatrix}
  \label{s0100}
\Endeq
$\Bf V$ is symmetric if and only if $\Bf M$ is symplectic. In any case,
a symmetric matrix $\Bf W$ near $\Bf V$ can be
formed via
\begin{equation}
  \Bf W = \frac{\Bf V + \Bf V^t}{2}
\end{equation}
A symplectic matrix $\Bf F$ is now obtained by inverting \eq{e:vsimi}
\Begineq
  \Bf F = (\Bf I + \Bf S \Bf W) (\Bf I - \Bf S \Bf W)^{-1}
\Endeq

%-----------------------------------------------------------------
\section{Wigglers}
\label{s:wiggler_phys}

As discussed in Section~\ref{s:wig}, \bmad wiggler elements are split into 
two classes: map type and periodic type.


The map type wigglers are modeled using the method of Sagan, Crittenden, 
and Rubin\cite{b:scr}. In this model the magnetic field is written as 
a sum of terms $B_i$
\Begineq
  B(x,y,z) = \sum_i B_i(x, y, z; C, k_x, k_y, k_z, \phi_z)
\Endeq 
Each term $B_i$ is specified using five numbers: 
$(C, k_x, k_y, k_z, \phi_z)$. A term can take one of three forms: The first
form is
\begin{alignat}{4}
  B_x &= -&C &\dfrac{k_x}{k_y} & \sin(\kxx) \sinh(\kyy) \cos(\ksss) \CRNEG
  B_y &=  &C &                 & \cos(\kxx) \cosh(\kyy) \cos(\ksss) \CRNEG
  B_s &= -&C &\dfrac{k_s}{k_y} & \cos(\kxx) \sinh(\kyy) \sin(\ksss) \CRneg
  & \makebox[1pt][l]{with $k_y^2 = k_x^2 + k_s^2$ .} &&&  \label{f1}
\end{alignat}
The second form is
\begin{alignat}{4}
  B_x &=  &C &\dfrac{k_x}{k_y} & \sinh(\kxx) \sinh(\kyy) \cos(\ksss) \CRNEG
  B_y &=  &C &                 & \cosh(\kxx) \cosh(\kyy) \cos(\ksss) \CRNEG
  B_s &= -&C &\dfrac{k_s}{k_y} & \cosh(\kxx) \sinh(\kyy) \sin(\ksss) \CRneg
  & \makebox[1pt][l]{with $k_y^2 = k_s^2 - k_x^2$ ,} &&&  \label{f2}
\end{alignat}
The third form is
\begin{alignat}{4}
  B_x &=  &C &\dfrac{k_x}{k_y} & \sinh(\kxx) \sin(\kyy) \cos(\ksss) \CRNEG
  B_y &=  &C &                 & \cosh(\kxx) \cos(\kyy) \cos(\ksss) \CRNEG
  B_s &= -&C &\dfrac{k_s}{k_y} & \cosh(\kxx) \sin(\kyy) \sin(\ksss) \CRneg
  & \makebox[1pt][l]{with $k_y^2 = k_x^2 - k_s^2$ .} &&& \label{f3}
\end{alignat}
The relationship between $k_x$, $k_y$, and $k_z$ ensures that Maxwell's equations
are satisfied. Since the field is given by analytic equations, Lie algebraic
techniques can be use to construct Taylor maps to arbitrary order.

%-----------------------------------------------------------------
\section{Radiation Damping and Excitation}
\label{s:radiation}

Emission of synchrotron radiation by a particle can be decomposed into
two parts. The deterministic average radiation emitted produces damping
while the stochastic fluctuating part produces excitation\cite{b:jowett}.

The treatment of radiation damping by \bmad\ essentially follows MAD.
The average change in energy $\Delta E$ of a particle going through a
section of magnet due to synchrotron radiation is
\Begineq
  \frac{\Delta E}{E_0} = -k_d \, (1 + p_z)
\Endeq
where
\Begineq
  k_d \equiv \frac{2 \, r_e}{3} \, \gamma_0^3 \, \ave{g_0^2} \, L_p \,  
  (1 + p_z)
  \label{k2r3g}
\Endeq
$r_e$ is the classical electron radius, $L_p$ is the actual path
length, $\gamma_0$ is the energy factor of an on-energy particle, $1/g_0$
is the bending radius of an on--energy particle, and $\ave{g_0^2}$ is an
average of $g_0^2$ over the actual path.

The energy lost is given by
\Begineq
  \frac{\Delta E}{E_0} = -k_f \, (1 + p_z)
\Endeq
where
\Begineq
  k_f \equiv \left( \frac{55 \, r_e \, \hbar \, c}{24 \, \sqrt{3} \, m_e} \, 
  L_p \, \gamma_0^5 \ave{g_0^3} \right)^{1/2} \, (1 + p_z) \, \xi
  \label{k55rh}
\Endeq
$\xi$ is a Gaussian distributed random number with unit sigma and zero mean.

Using \Eqs{k2r3g} and \eq{k55rh} The total change in $p_z$ can be written as
\Begineq
  \Delta p_z = \frac{\Delta E}{E_0} = -k_E \, (1 + p_z)
\Endeq
where
\Begineq
  k_E = k_d + k_f
\Endeq
Since the radiation is emitted in the forward direction the angles
$x'$ and $y'$ are invariant which leads to the following equations for
the changes in $p_x$ and $p_y$
\begin{align}
  \Delta p_x &= -k_E \, p_x \CRNO
  \Delta p_y &= -k_E \, p_y 
\end{align}

%-----------------------------------------------------------------
\section{Macroparticles}
\label{s:macro}

Note: Wakefield and Macroparticle simulation have just been implemented
in bmad and is still in the testing phase. Use with caution.

A macroparticle\cite{b:transport_appendix} is a bundle of particles
whose distribution is assumed to be Gaussian in shape. A macroparticle
is represented by a centroid position $\bfrbar$ and a $6 \times 6$
$\bfsigma$ matrix which defines the shape of the macroparticle in
phase space. $\sigma_i = \sqrt{\bfsigma(i,i)}$ is the RMS sigma for the $i$\Th
phase space coordinate. For example $\sigma_z = \sqrt{\bfsigma(5,5)}$.

$\bfsigma$ is a real, non-negative symmetric matrix. The equation that
defines the ellipsoid at a distance of $n$--sigma from the centroid is
\Begineq
  (\bfr - \bfrbar)^t \bfsigma\inv (\bfr - \bfrbar) = n
\Endeq
where the $t$ superscript denotes the transpose. Given the sigma matrix
at some point $s = s_1$, the sigma matrix at a different point $s_2$ is
\Begineq
  \bfsigma_2 = \Bf M_{21} \, \bfsigma_1 \, \Bf M_{21}^t
\Endeq
where $\Bf M_{21}$ is the Jacobian of the transport map between points
$s_1$ and $s_2$.

A relativistic charged particle bunch is modeled by dividing it longitudinally
into a series
of slices. Each slice is made up of a number of macroparticles. It is assumed
that the range of the longitudinal positions of the macroparticles of a given
slice do not overlap the ranges of the other slices. 

\bmad has a routine to initialize macroparticles to mirror the initial
distribution as set--up by the LIAR program\cite{b:liar}. The
initialization is as follows: The center of a
slice will be at a longitudinal position $z_j$ given by
\Begineq
  z_j = z_b + \frac{(n_s - 2 \, j + 1) \, \sigma_z \, N_{\sigma z}}{n_s}
\Endeq
where $z_b$ the overall offset of the bunch, 
$n_s$ is the number of slices, $j = 1, \ldots,
n_s$ is the index of the slice, $\sigma_z$ is the RMS bunch length,
and $N_{\sigma z}$ is the number of $\sigma_z$ the slices go out
to. The width $dz_s$ of each slice is
\Begineq
    dz_s = \frac{2 \, \sigma_z \, N_{\sigma z}}{n_s}
\Endeq
The charge associated with each slice is, within a constant factor,
the charge contained within the region between $z_j - dz_s/2$ and $z_j
+ dz_s/2$ assuming a Gaussian distribution.  The charge of all the
slices are multiplied by a factor so that the total charge of the
slices is equal to the input bunch charge.

The initialization of the macroparticles within a slice gives all the
macroparticles the same centroid position except with differing
centroid energies. 
The sigma matrix is the same for all macroparticles and is
determined by the input Twiss parameters:
\begin{align}
  \bfsigma(1,1) &= \epsilon_x \, \beta_x \CRNEG
  \bfsigma(1,2) &= -\epsilon_x \alpha_x  \CRNEG
  \bfsigma(2,2) &= \epsilon_x \, (1 + \alpha_x^2) / \beta_x \CRNEG
  \bfsigma(3,3) &= \epsilon_y \, \beta_y \\
  \bfsigma(3,4) &= -\epsilon_y \alpha_y \CRNEG
  \bfsigma(3,4) &= \epsilon_y \, (1 + \alpha_y^2) / \beta_y \CRNEG
  \bfsigma(i,j) &= 0 \quad \mbox{otherwise} \nonumber
\end{align}
The centroid energy of the $k$\Th macroparticle is
\Begineq
  E_k = E_b + \frac{(n_{mp} - 2 \, k + 1) \, \sigma_E \, N_{\sigma E}}{n_{mp}}
\Endeq
where $E_b$ is the central energy of the bunch, $n_{mp}$ is the number
of macroparticles per slice, $\sigma_E$ is the energy sigma, and
$N_{\sigma E}$ is the number of sigmas in energy that the range of
macroparticle energies cover. The charge of each macroparticle is,
within a constant factor, the charge contained within the energy
region $E_k - dE_{mp}/2$ to $E_k + dE_{mp}/2$ assuming a Gaussian
distribution where the energy width $dE_{mp}$ is
\Begineq
  dE_{mp} = \frac{2 \, \sigma_E \, N_{\sigma E}}{n_{mp}}
\Endeq
The charge of all the macroparticles is adjusted by a constant factor
so that the total charge of the macroparticles within a slice is equal
to the charge associated with the slice.



%-----------------------------------------------------------------
\section{Wakefields}
\label{s:wakefields}

Note: Wakefield and Macroparticle simulation have just been implemented
in bmad and is still in the testing phase. Use with caution.

Wakefield modeling follows the LIAR program\cite{b:liar}. Wakefields
are applied in the center of LINAC accelerating cavities
(\vn{LCavity}). Wakefield effects are divided into short--range
(within a bunch) and long--range (between bunches).

Only the dipole component of the short--range wakefield are
modeled. The short--range longitudinal wakefield component for 
the $i$\Th macroparticle is computed from the equation
\Begineq
  dE_i = \frac{L \, \Wl(0)}{2} |Q_i| +
                  \sum_{j \ne i} \frac{L \, \tWl(dz_{ij})}{2} |Q_j|
\Endeq
where $L$ is the cavity length, $dz_{ij}$ is the longitudinal distance between 
the $i$\Th and $j$\Th macroparticles,
$\Wl$ is the short--range longitudinal wakefield function, and $\tWl$ is 
a modified wakefield function 
\Begineq
  \tWl(dz) = 
  \begin{cases}
    \Wl(0) \cdot \frac{dz + \sigma_{zij}}{2\sigma_{zij}} & 
                                    -\sigma_{zij} < dz < \sigma_{zij} \\
    \Wl(dz)                                            & \text{otherwise}
  \end{cases}
\Endeq
$\tWl$ is used instead of $\Wl$ to avoid simulation artifacts 
is due to the discontinuity of $\Wl$ at $dz = 0$. 
$\sigma_{zij}$ is the combined macroparticle length
\Begineq
  \sigma_{zij} = \sigma_{zi} + \sigma_{zj} + \sigma_{z0}
\Endeq
where $\sigma_{zi}$ and $\sigma_{zj}$ are the longitudinal sizes for
the $i$\Th and $j$\Th particles respectively, and $\sigma_{z0}$ is a
small fudge factor needed when $\sigma_{zi} = \sigma_{zj} = 0$.

The transverse kick $dx'_i$ for the $i$\Th macroparticle due to the 
dipole short--range transverse wakefield is modeled with the equation
\Begineq
  dx'_i = \sum_j |Q_j| \, x_j \, L \Wt(dz_{ij})
\Endeq
with a similar equation for $dy'_i$. $\Wt$ is the transverse short--range
wake function.

%-----------------------------------------------------------------
\section{Coupling and Normal Modes}
\label{s:coupling}

The coupling formalism used by \bmad\ is taken from the paper of Sagan
and Rubin\cite{b:coupling}. The main equations are reproduced here.  A
one--turn map $\bfT(s)$ for the transverse two--dimensional phase space
$\bfx = (x, x', y, y')$ starting and ending at some point $s$ can be
written as
  \Begineq
    \bfT = \bfV \, \bfU \, \bfV\inv 
    , \label{tvuv}
  \Endeq 
where $\bfV$ is symplectic, and $\bfU$ is of the form
  \Begineq
    \bfU = 
    \begin{pmatrix}
      \bfA & \Bf0 \cr 
      \Bf0 & \bfB \cr
    \end{pmatrix}
    . \label{ua00b}
  \Endeq
Since $\bfU$ is uncoupled the standard Twiss analysis can be
performed on the matrices $\bfA$ and $\bfB$. The normal modes
are labeled $a$ and $b$ and if the one--turn matrix $\bfT$ is
uncoupled then $a$ corresponds to the horizontal mode and $b$
corresponds to the vertical mode. 

$\bfV$ is written in the form
  \Begineq
    \bfV = 
    \begin{pmatrix}
        \gamma \bfI & \bfC \cr 
        -\bfC^+     & \gamma \bfI \cr
    \end{pmatrix}
    , \label{vgicc1}
  \Endeq
where the symplectic conjugate is 
  \Begineq
    \bfC^+ = 
    \begin{pmatrix}
       C_{22} & -C_{12} \cr 
      -C_{21} & C_{11} \cr
    \end{pmatrix}
    . \label{ccccc}
  \Endeq
Since we demand that $\bfV$ be symplectic we have the condition
  \Begineq               
    \gamma^2 + \, ||\bfC|| = 1
    , \label{gc1}
  \Endeq
and $\bfV\inv$ is given by
  \Begineq
    \bfV\inv = 
    \begin{pmatrix}
      \gamma \bfI & -\bfC \cr 
      \bfC^+ & \gamma \bfI \cr
    \end{pmatrix}
    . \label{vgicc2}
  \Endeq 
$\bfC$ is a measure of the coupling. 
$\bfT$ is uncoupled if and only if $\bfC = \Bf 0$. 

It is useful to normalize out the $\beta(s)$ variation in the the above
analysis. Normalized quantities being denoted by a bar above them. The
normalized normal mode matrix $\BAR\bfU$ is defined by
  \Begineq
    \BAR\bfU = \bfG \, \bfU \, \bfG\inv
    , \label{ugug}
  \Endeq
Where $\bfG$ is given by 
  \Begineq
    \bfG \equiv 
    \begin{pmatrix}
      \bfG_a & \Bf0 \cr 
      \Bf0 & \bfG_b
    \end{pmatrix}
    , \label{gg00g}
  \Endeq  
with 
  \Begineq
    \Bf G_a = 
    \begin{pmatrix}
      \frac{\tstyle 1}{\tstyle \sqrt{\beta_a}} & 0 \cr
      \frac{\tstyle \alpha_a}{\tstyle \sqrt{\beta_a}} & \sqrt{\beta_a}
    \end{pmatrix}
    , \label{g1b0a} 
  \Endeq
with a similar equation for $\Bf G_b$. With this definition, the corresponding
$\BAR\bfA$ and $\BAR\bfB$ (cf.~\Eq{ua00b} are just rotation matrices.
The relationship between $\bfT$ and $\BAR\bfU$ is 
  \Begineq
    \bfT = \bfG\inv \, \BAR\bfV \, \BAR\bfU \, \BAR\bfV\inv \, \bfG
    , \label{tgvuv}
  \Endeq
where
  \Begineq
    \BAR\bfV = \bfG \, \bfV \, \bfG\inv
    . \label{vgvg}
  \Endeq
Using \Eq{gg00g}, $\BAR\bfV$ can be written in the form
  \Begineq
    \BAR\bfV = 
    \begin{pmatrix}
      \gamma \bfI & \BAR\bfC \cr -\BAR\bfC^+ & \gamma \bfI
    \end{pmatrix}
    , \label{vgicc3}
  \Endeq
with the normalized matrix $\BAR\bfC$ given by
  \Begineq
    \BAR\bfC = \bfG_a \, \bfC \, \bfG_b\inv
    . \label{cgcg}
  \Endeq

The normal mode coordinates ${\bf a} = (a, a', b, b')$ are related to
the laboratory frame via
  \Begineq
    {\bf a} = \bfV\inv \, {\bf x}
    . \label{avx}
  \Endeq 
In particular the normal mode dispersion $\bfeta_a = (\eta_a,
\eta'_a, \eta_b, \eta'_b)$ is related to the laboratory frame
dispersion $\bfeta_x = (\eta_x, \eta'_x, \eta_y, \eta'_y)$ via
  \Begineq
    {\bfeta_a} = \bfV\inv \, {\bfeta_x}
    . \label{etaavx}
  \Endeq 

%-----------------------------------------------------------------
\section{Synchrotron Integrals}
\label{s:synch_ints}


The standard formulas for the synchrotron integrals used to compute 
emittances, the energy spread, etc.,
assum no coupling between the horizontal and vertical
planes\cite{b:helm,b:jowett}. 
With coupling the equations need to be generalized. To simplify matters it
will be still be assumed that the bends are in the horizonal plane. In this
case $I_1$, $I_2$, $I_3$, and $I_5$ are unchanged (but are given below for
completeness). Without proof, the generalized synchrotron integrals are:
  \Begineqs
    I_1 \AND= \oint ds \, G \, \eta_x \CRNO
    I_2 \AND= \oint ds \, G^2 \CRNO
    I_3 \AND= \oint ds \, |G^3| \CRNO
    I_{4a} \AND= \oint ds \, (G^2 + 2K_1) \, G \, \eta_{ax} \label{iseg} \\
    I_{4b} \AND= \oint ds \, (G^2 + 2K_1) \, G \, \eta_{bx} \CRNO
    I_{4z} \AND= \oint ds \, (G^2 + 2K_1) \, G \, \eta_{x} \CRNO
    I_{5a} \AND= \oint ds \, |G^3| \, \calh_a \CRNO
    I_{5b} \AND= \oint ds \, |G^3| \, \calh_b \nonumber
  \Endeqs  
where  $\eta_{ax}$ and $\eta_{bx}$ are the horizontal components of $\eta_a$
and $\eta_b$ respectively. With \Eq{iseg}, the damping partition numbers are
  \Begineqs
    J_a \AND= 1 + \frac{I_{4a}}{I_2} \CRNO
    J_b \AND= 1 + \frac{I_{4b}}{I_2} \label{j1ii} \CR
    J_z \AND= 1 + \frac{I_{4z}}{I_2} \CRNO
  \Endeqs
Since 
  \Begineq          
    \eta_{ax} + \eta_{bx} = \eta_x
    \comma \label{eee}
  \Endeq
Robinson's theorem, $J_a + J_b + J_z = 4$, is satisfied.

\subsection{Evaluation of the Integrals}

The evaluation of $I_1$, $I_2$, $I_3$, and $I_{4z}$ does not depend upon
whether there is coupling or not and is given by Helm et. al\cite{b:helm}. 
Using
the notation of Helm, the evaluation of the other integrals is given below. 

\subsection{Evaluation of $I_{4a}$ and $I_{4b}$}

The relation between the dispersion in eigenmode coordinates and in $x$---$y$
coordinates is (cf.~Sagan and Rubin\cite{b:coupling})
  \Begineq
    \bfeta_a\four = \bV\inv \, \bfeta_x\four
    \comma \label{eve}
  \Endeq
where the superscript (4) is used to distinguish a 4 element vector from a two
element vector (for compactness, the superscripts on the 2 element vectors
will be dropped).

Through a bend were the transfer matrix between two points is of the form
  \Begineq
    \bT_{12} = 
    \begin{pmatrix}
      \bM & 0 \cr 0 & \bN
    \end{pmatrix}                            
    \comma \label{tm00n}
  \Endeq
with
  \Begineq
    \bM = 
    \begin{pmatrix}
      \cos kl & \frac{\dstyle 1}{\dstyle k} \sin kl \cr 
      -k \, \sin kl & \cos kl
    \end{pmatrix}
    \comma \label{mkl1k}
  \Endeq
and
  \Begineq
    k^2 = \frac{1}{\rho^2} + k_1
    \comma
  \Endeq
$k_1$ being the strength of the quadrupole component of the bend.
The propagation of $\bfeta_x\four$ is
  \Begineq
    \bfeta_{x2}\four = \bT_{12} \, \bfeta_{x1}\four + \bfeta_{12}\four 
    \comma \label{etee}
  \Endeq
where $\bfeta_{12}\four$ is the contribution due to the `generation' of
dispersion within a dipole
  \Begineq
    \bfeta_{21}\four = 
    \begin{pmatrix}
      \bfeta_{x12} \cr \Bf 0
    \end{pmatrix} 
    \comma \label{ee0}
  \Endeq
with
  \Begineq
    \bfeta_{x12} = 
    \begin{pmatrix}
      \rho (1 - \cos (s/\rho)) \cr \sin(s/\rho)
    \end{pmatrix}
    \period \label{er1sr}
  \Endeq
$\bV\inv$ propagates as\cite{b:coupling}
  \Begineqs
    \bV_2\inv \AND= \bT_{12} \, \bV_1\inv \, \bT_{12}\inv \CRNO
    \AND= 
    \begin{pmatrix}
      \gamma_1 & -\bM \, \bC_1 \, \bN\inv \cr 
                   \bN \, \bC_1^+ \, \bM\inv & \gamma_1
    \end{pmatrix}
    \period \label{vtvt}
  \Endeqs
Using the above equations gives
  \Begineqs
    \bfeta_{a2} \AND= \bM \, \bfeta_{a1} + \gamma_1 \, \bfeta_{x12} 
      \comma \CRNO
    \bfeta_{b2} \AND= \bN \, \bfeta_{b1} + 
      \bN \, \bC_1^+ \, \bM\inv \, \bfeta_{x12}
      \period \label{emege}
  \Endeqs
The $x$ components of $\bfeta_a$ and $\bfeta_b$ are obtained by inverting
\Eq{eve}. For the $a$ mode
  \Begineqs
    \bfeta_{ax} = \gamma \, \bfeta_{a} 
    \period \label{ege}
  \Endeqs
Also, from \Eq{vtvt}
  \Begineqs
    \gamma_2 = \gamma_1 
    \period \label{gg}
  \Endeqs
Using \Eqs{emege}, \eq{ege}, and \eq{gg} then gives
  \Begineqs
    \bfeta_{ax2} = \gamma_1 \, \bM \, \bfeta_{a1} + 
      \gamma_1^2 \, \bfeta_{x12} 
      \period \label{egmeg}
  \Endeqs
From \Eqs{tm00n}, \eq{etee}, and \eq{ee0} $\bfeta_{x}$ propagates as
  \Begineq
    \bfeta_{x2} = \bM \, \bfeta_{x1} + \bfeta_{x12}
    \period \label{emee}
  \Endeq
Comparing \Eq{egmeg} with \eq{emee} shows that $\bfeta_{ax}$ propagates  like
$\bfeta_x$ except for extra factors of $\gamma_1$. Thus, the integrated
$\eta_{ax}$ can be obtained from a modification of Helm Eq.~14:
  \Begineq
    \int ds \, \eta_{ax} = \gamma_0 \, \eta_{a0} \, \frac{\sin kl}{k} + 
      \gamma_0 \, \eta'_{a0} \, \frac{1 - \cos kl}{k^2} +
      \frac{\gamma_0^2}{\rho} \frac{kl - \sin kl}{k^3}
      \period \label{segek}
  \Endeq
\Eq{segek} can be used to evaluate $I_{5a}$ (cf.~Helm\cite{b:helm}). For
$I_{5b}$ the integral of $\bfeta_{bx}$ can then be obtained using \Eq{eee}
  \Begineq
    \int ds \, \eta_{bx} = \int ds \, \eta_x - \int ds \, \eta_{ax}
    \period
  \Endeq

\subsection{Evaluation of $I_{5a}$ and $I_{5b}$}

To compute $I_5$ we go back to the equation for $\calh$
  \Begineqs
    \calh \AND= \gamma \, \eta^2 + 2 \, \alpha \, \eta \, \eta' + 
      \beta \eta'^2 \CRNO
    \AND= \vdot{\bfeta}{\bS \, \bJ \, \bfeta}
      \comma\label{hge2a}
  \Endeqs
where $[\bA, \, \bB] \equiv \bA^t \bB$, $\bS$ is given by
  \Begineq
    \bS \equiv 
    \begin{pmatrix}
      0 & -1 \cr 1 & 0
    \end{pmatrix}
    \comma
  \Endeq
and $\bJ$ is the Twiss matrix (cf.~Courant and Snyder\cite{b:cs})
  \Begineq
    \bJ \equiv \begin{pmatrix}
      \alpha & \beta \cr -\gamma & -\alpha
    \end{pmatrix}
    \period
  \Endeq
The propagation of $\bJ$ through the bend is given by 
  \Begineqs
    \bJ_{a2} \AND= \bM \, \bJ_{a1}\inv \, \bM\inv \comma \CRNO
    \bJ_{b2} \AND= \bN \, \bJ_{b1}\inv \, \bN\inv
    \period \label{jmjm}
  \Endeqs
In the case were there is no coupling $\calh_x$ would propagate like
  \Begineqs
    \calh_{x2} \AND= \vdot{\bfeta_{x2}}{\bS \, \bJ_{x2} \, \bfeta_{x2}} \CRNO
    \AND= \vdot{\bM \, \bfeta_{x1} + \bfeta_{x12}}
      {\bS \, \bM \, \bJ_{x1} \bM\inv \, (\bM \, \bfeta_{x1} + \bfeta_{x12})}
      \CRNO
    \AND= \vdot{\bfeta_{x1}}{\bS \, \bJ_{x1} \, \bfeta_{x1}} + 2 \, 
      \vdot{\bfeta_{x1}}{\bS \, \bJ_{x1} \, \bM\inv \, \bfeta_{x12}} 
      + \label{hesje1} \\
    \AND\mskip250mu \vdot{\bfeta_{x12}}
      {\bS \, \bM \, \bJ_{x1} \, \bM\inv \, \bfeta_{x12}}
      \nonumber  
  \Endeqs
Where we have used the identity that for arbitrary matrices $\bA$ and $\bB$
  \Begineq
    \vdot{\bA \, \bB}{\bS} = \vdot{\bA}{\bS \, \bA^+}
    \period \label{absas}
  \Endeq
The integration of \Eq{hesje1} is straight--forward, if tedious, and is given by
Helm Eq.~20 (reproduced here for convenience)
  \Begineqs
    \int ds \, \calh_x \AND= \left[ l \, (\gamma_{x0} \, \eta_{x0}^2 + 
      2 \, \alpha_{x0} \, \eta_{x0} \, \eta'_{x0} + 
      \beta_{x0} {\eta'}_{x0}^2) \right] + \CRNO
    \AND\mskip-30mu \frac{2}{\rho} \left[ 
      (\gamma_{x0} \eta_{x0} + \alpha_{x0} \eta'_{x0})
      \frac{\sin kl - kl}{k^3} + 
      (\alpha_{x0} \eta_{x0} + \beta_{x0} \eta'_{x0})
      \frac{1 - \cos kl}{k^2} \right] + \label{shlgn1} \\
    \AND\mskip-30mu \frac{1}{\rho^2} \left[
      \gamma_{x0} \frac{3kl - 4\sin kl + \sin kl \, \cos kl}{2k^5} -
      \alpha_{x0} \frac{(1 - \cos kl)^2}{k^4} +
      \beta_{x0} \frac{kl - \cos kl \, \sin kl}{2k^3} \right] \nonumber
  \Endeqs
The 3 terms in \Eq{shlgn1} correspond to the integration of the 3 terms in
\Eq{hesje1}. With coupling, the propagation of $\calh_a$ is obtained with the
help of \Eqs{emege}, \eq{hge2a}, and \eq{jmjm} to be
  \Begineqs
    \calh_{a2} \AND= 
      \vdot{\bfeta_{a1}}{\bS \, \bJ_{a1} \, \bfeta_{a1}} + 2 \, \gamma_1 \,
      \vdot{\bfeta_{a1}}{\bS \, \bJ_{a1} \, \bM\inv \, \bfeta_{x12}} 
      + \label{hesje2} \\
    \AND\mskip250mu \gamma_1^2 \vdot{\bfeta_{x12}}
      {\bS \, \bM \, \bJ_{a1} \, \bM\inv \, \bfeta_{x12}}
      \nonumber  
  \Endeqs
This is similar to \Eq{hesje1} with the addition of some factors of $\gamma_1$.
The integration of $\calh_a$ is thus obtained from \Eq{shlgn1} by inspection
  \Begineqs
    \int ds \, \calh_a \AND= \left[ l \, (\gamma_{a0} \, \eta_{a0}^2 + 
      2 \, \alpha_{a0} \, \eta_{a0} \, \eta'_{a0} + 
      \beta_{a0} {\eta'}_{a0}^2) \right] + \CRNO
    \AND\mskip-30mu \frac{2 \gamma_0}{\rho} \left[ 
      (\gamma_{a0} \eta_{a0} + \alpha_{a0} \eta'_{a0})
      \frac{\sin kl - kl}{k^3} + 
      (\alpha_{a0} \eta_{a0} + \beta_{a0} \eta'_{a0})
      \frac{1 - \cos kl}{k^2} \right] + \\
    \AND\mskip-30mu \frac{\gamma_0^2}{\rho^2} \left[
      \gamma_{a0} \frac{3kl - 4\sin kl + \sin kl \, \cos kl}{2k^5} -
      \alpha_{a0} \frac{(1 - \cos kl)^2}{k^4} +
      \beta_{a0} \frac{kl - \cos kl \, \sin kl}{2k^3} \right] \nonumber
  \Endeqs
For $\calh_b$ \Eqs{emege}, \eq{hge2a}, and \eq{jmjm} give
  \Begineqs
    \calh_{b2} \AND= 
      \vdot{\bfeta_{b1}}{\bS \, \bJ_{b1} \, \bfeta_{b1}} + 2 \, 
      \vdot{\bfeta_{b1}}{\bS \, \bJ_{b1} \, \bC_1^+ \bM\inv \, \bfeta_{x12}} 
      + \\
    \AND\mskip250mu \vdot{\bfeta_{x12}}
        {\bS \, \bM (\bC_1 \, \bJ_{b1} \, \bC_1^+) \bM\inv \, \bfeta_{x12}}
        \nonumber
  \Endeqs      
Again the integration is straight--forward and gives
  \Begineqs
    \int ds \, \calh_b \AND= \left[ l \, (\gamma_{b0} \, \eta_{b0}^2 + 
      2 \, \alpha_{b0} \, \eta_{b0} \, \eta'_{b0} + 
      \beta_{b0} {\eta'}_{b0}^2) \right] + \CRNO
    \AND\mskip-30mu \frac{2}{\rho} \left[ 
      (m_1 c_{22} - m_2 \, c_{21}) \, \frac{\sin kl - kl}{k^3} + 
      (m_2 c_{11} - m_1 \, c_{12}) \, \frac{1 - \cos kl}{k^2} \right] + \\
    \AND\mskip-30mu \frac{1}{\rho^2} \left[
      \gamma_\eff \frac{3kl - 4\sin kl + \sin kl \, \cos kl}{2k^5} -
      \alpha_\eff \frac{(1 - \cos kl)^2}{k^4} +
      \beta_\eff \frac{kl - \cos kl \, \sin kl}{2k^3} \right] \nonumber
  \Endeqs
where
  \Begineqs
    m_1 \AND\equiv \gamma_{a0} \eta_{a0} + \alpha_{a0} \eta'_{a0} 
      \comma \CRNO
    m_2 \AND\equiv \alpha_{a0} \eta_{a0} + \beta_{a0} \eta'_{a0} 
      \comma 
  \Endeqs
and the effective Twiss parameters are defined by
  \Begineq
    \bJ_\eff \equiv \bC_0 \, \bJ_{b0} \, \bC_0^+
  \Endeq
which when multiplied out give
  \Begineqs
    \beta_\eff \AND= c_{11}^2 \, \beta_{b0} - 
      2 \, c_{11} \, c_{12} \, \alpha_{b0} + c_{12}^2 \, \gamma_{b0} \CRNO
    \alpha_\eff \AND= -c_{21} \, c_{11} \, \beta_{b0} + 
      (c_{11} \, c_{22} + c_{12} \, c_{21}) \, \alpha_{b0} - 
      c_{12} \, c_{22} \, \gamma_{b0} \\
    \gamma_\eff \AND= c_{21}^2 \, \beta_{b0} - 
      2 \, c_{21} \, c_{22} \, \alpha_{b0} + c_{22}^2 \, \gamma_{b0}
  \Endeqs
