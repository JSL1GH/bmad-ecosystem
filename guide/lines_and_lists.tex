\chapter{Beam Lines, Replacement Lists, and Superposition}

To \bmad\ a ``lattice'' is the sequence of physical elements that is to
be studied. The lattice is constructed using what are know as Beam Lines
and Replacement Lists. Beam Lines are further subdivided into Lines with
and without replacement arguments. This essentially corresponds to the
\mad\ definition of Lines and Lists. There can be multiple Beam Lines
and Replacement Lists defined in a lattice file and Lines and Lists can
be nested inside other Lines and Lists. The particular Line that defines
the lattice to be analyzed by \bmad\ is selected by the \vn{use}
statement. For example
\begin{example}
  use, my_line
\end{example}
would pick the Line \vn{my_line} for analysis. 
Note that the names of the elements in the
lattice are always converted to upper case.

%-----------------------------------------------------------------------------
\section{Beam Lines without Arguments}
A Beam Line without arguments has the format
\begin{example}
  label: LINE = (member1, member2, ...)
\end{example}
where \vn{member1}, \vn{member2}, etc. are either elements, other Beam
Lines or Replacement Lists, or sublines enclosed in parentheses.
Example:
\begin{example}
  line1: line = (a, b, c)
  line2: line = (d, line1, e)
  use, line2
\end{example}
This example shows how an Line member can refer to another Beam Line.
This is helpful if the same sequence of elements appears repeatedly in
the lattice. When \vn{line2} is expanded to form the lattice the
definition of \vn{line1} will be inserted in to produce the following
lattice for analysis
\begin{example}
  (d, a, b, c, e)
\end{example}

A member that is a Line or List can be reflected 
(elements taken in reverse order) if
a negative sign is put in front of it. For example:
\begin{example}
  line1: line = (a, b, c)
  line2: line = (d, -line1, e)
\end{example}
\vn{line2} when expanded gives
\begin{example}
  (d, c, b, a, e)
\end{example}
Reflecting a subline will also reflect any sublines of the subline. For
example:
\begin{example}
  line0: line = (y, z)
  line1: line = (line0, b, c)
  line2: line = (d, -line1, e)
\end{example}
\vn{line2} when expanded gives
\begin{example}
  (d, c, b, z, y, e)
\end{example}

A repetition count, which is an integer followed by an asterisk, 
means that the member is
repeated. For example
\begin{example}
  line1: line = (a, b, c)
  line2: line = (d, 2*line1, e)
\end{example}
\vn{line2} when expanded gives
\begin{example}
  (d, a, b, c, a, b, c, e)
\end{example}
Repetition count can be combined with reflection. For example
\begin{example}
  line1: line = (a, b, c)
  line2: line = (d, -2*line1, e)
\end{example}
\vn{line2} when expanded gives
\begin{example}
  (d, c, b, a, c, b, a, e)
\end{example}
Instead of the name of a Line, subline members can also be given as an explicit 
list using parentheses. For example, the previous example could be rewritten as
\begin{example}
  line2: line = (d, -2*(a, b, c), e)
\end{example}

%-----------------------------------------------------------------------------
\section{Beam Lines with Replaceable Arguments}

Beam lines can have an argument list using the following syntax
\begin{example}
  label: LINE(dummy_arg1, dummy_arg2, ...) = (member1, member2, ...)
\end{example}
The dummy arguments are replaced by the actual arguments when the Line is used
elsewhere. For example:
\begin{example}
  line1(DA1, DA2): line = (a, DA2, b, DA1)
  line2: line = (h, line1(y, z), g)
\end{example}
When \vn{line2} is expanded the actual arguments of \vn{line1}, in this
case \vn(y, z), replaces the dummy arguments \vn{(DA1, DA2)} to give for
\vn{line2}
\begin{example}
  (h, a, z, b, y, g)
\end{example} 
Unlike \mad\, Beam Line actual arguments can only be elements or Beam Lines. 
Thus the following is not allowed
\begin{example}
  line2: line = (h, line1(2*y, z), g)   ! NO: 2*y NOT allowed as an argument.
\end{example}

%-----------------------------------------------------------------------------
\section{Replacement Lists}

When a lattice is expanded, all the lattice members that correspond to a 
name of a Replacement List 
are replaced successively, by the members
in the Replacement List. The general syntax is
\begin{example}
  label: LIST = (member1, member2, ...)
\end{example}
For example:
\begin{example}
  list1: list = (a, b, c)
  line1: line = (z1, list1, z2, list1, z3, list1, z4, list1)
  use, line1
\end{example}
When the lattice is expanded the first instance of \vn{list1} in
\vn{line1} is replaced by \vn{a} (which is the first element of
\vn{list1}), the second instance of \vn{list1} is replaced by \vn{b},
etc. If there are more instances of \vn{list1} in the lattice then
members of \vn{list1}, the replacement starts at the beginning of
\vn{list1} after the last member of \vn{list1} is used. In this case the
lattice would be
\begin{example}
  (z1, a, z2, b, z3, c, z4, a)
\end{example}
Unlike \mad\, members of a replacement list can only be simple elements 
without reflection or repetition count and not other Lines or Lists. 
For example the following is not allowed:
\begin{example}
  list1: list = (2*a, b)  ! NO: No repetition count allowed.
\end{example}

%-----------------------------------------------------------------------------
\section{Superposition}
\label{s:super}

In practice the field at a particular point in the lattice may be due
to more than one physical element. A common example is a quadrupole
inside a solenoid. \bmad\ has a mechanism to handle some of these
cases using what is called ``superposition''. A simple example shows
how this works
\begin{example}
  q: quad, l = 10
  d: drift, l = 4
  s: solenoid, l = 6, superimpose, ref = q, ref_end
  lat: line = (q, d)
  use, lat
\end{example}
The \vn{superimpose} attribute of \vn{s} superimposes the \vn{s}
solenoid over the lattice \vn{(q, d)}. The placement of \vn{s} is such
that the center of \vn{s} coincides with the end of \vn{q} (more on
how superimposed elements get placed later). Now if one looks at a
list of lattice elements one would find:
\begin{example}
        Element   Key         Length
  1)    q{\B}        Quadrupole  7
  2)    q{\B}s       Sol_quad    3
  3)    s{\B}1       Solenoid    3
  4)    d{\B}        Drift       1
\end{example}
What \bmad\ has done is to split the original elements \vn{(q, d)} at
the edges of \vn{s}.  The first element \vn{q\B} is the part of \vn{q}
that is outside of \vn{s}. Since this is only part of \vn{q} \bmad\
has put a \vn{\B} in the name so that there will be no confusion
(\vn{\B} has no special meaning other than the fact that \bmad\ uses
it for mangling names). The next element, \vn{q{\B}s}, is the part of
\vn{q} that is inside \vn{s}. \vn{q{\B}s} is a combination
solenoid/quadrupole element as one could expect. \vn{s{\B}1} is the part
of \vn{s} that is outside \vn{q} so this element is just a
solenoid. Finally, \vn{d\B} is the rest of the drift outside \vn{s}.

With the lattice broken up like this \bmad\ has constructed something
that can be easily analyzed. However, the original elements \vn{q} and
\vn{s} still exist within the lattice because of the following: The
lattice is actually broken up into two parts. The first part, are the
elements that \bmad\ uses for any analysis (tracking, Twiss parameter
calculations, etc.).  In the example this first part (called the
``regular'' part of the lattice) is the 4 elements listed above. The
second part (called the ``lord'' section) is all those elements who
have been cut up via superposition (along with group and overlay
elements discussed in Chapter~\ref{c:groups_and_overlays}). What is
the purpose of this second list? \bmad\ keeps a record of how
superpositions were formed. Thus from a programming standpoint \bmad\
makes it simple if one, say, wants to change the \vn{k1} strength of
\vn{q} to make the appropriate changes to the \vn{k1} strength of
\vn{q\B} and \vn{q{\B}s}.

It does not matter which element is superimposed. Thus, in the above
example, \vn{s} could have been put in the Beam Line (with a drift
before it) and \vn{q} could then have been superimposed on top and the
result would have been the same (except that the split elements could
have a different name). However, superpositions are restricted in that
\bmad\ may not have an appropriate element for the superimposed
fields. For example, a solenoid can not be superimposed over an
octupole.  If a zero length element, such as a marker, is superimposed
with some other element (or vice versa) the element is just split in
two. For example:
\begin{example}
  q: quad, l = 10
  m: marker, superimpose, offset = 6
  lat: line = (q)
  use, lat
\end{example}
The resulting lattice (first part) would be
\begin{example}
        Element   Key           Length
  1)    q{\B}1       Quadrupole    6
  2)    m         Marker        0
  3)    q{\B}2       Quadrupole    4
\end{example}
and the second part of the lattice would have the \vn{q} element.
 
The placement of a superimposed element is determined by three
factors: A point on the superimposed element, a reference point in the
lattice line, and an offset between the points. The attributes that
determine these three quantities are:
\begin{example}
  ref = <element name in lattice>
  offset = <length>      (default = 0)
  ref_beginning
  ref_center             (default)
  ref_end
  ele_beginning
  ele_center             (default)
  ele_end
\end{example}
\vn{ele_beginning} \vn{ele_center} \vn{ele_end} makes the point on the
superimposed element the beginning (``left'') edge, the center, or the
end (``right'') edge respectively. If neither of these attributes are
given the default is to use the element center.


