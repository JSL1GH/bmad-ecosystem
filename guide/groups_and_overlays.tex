\chapter {Groups and Overlays: Elements Controlling Other Elements}

It is possible to have elements controlling the attributes of other elements.
These ``lord'' elements are meant to mimic the effect of changing a knob in
the control room. For example, a lord element can be used to simulate the
effect of a power supply that controls the quadrupole strengths of a gang of
magnets. A lord element can also simulate a girder that ties together the positions
of a group of elements. There are two types of lord elements (besides what are
called superposition lords which are discussed in \ref{s:super}): Groups are
used to make variations in attributes. For example, to simulate the action
of a control room knob that changes the tune, a group can be used to vary the
strength of selected quads in a specified manner. Overlays, on the other hand,
set the value (not a change in) the attributes they control. 

%-----------------------------------------------------------------------------
\section{Overlay Elements}
\label{s:overlay}

An \vn{overlay} element is used to control the attributes of other elements. 
For example: 
\begin{example}
  over1: overlay = {a\_ele, b\_ele/2.0}, hkick = 0.003
  over2: overlay = {b\_ele}, hkick
  over2[hkick] = 0.9
  a\_ele: quad, hkick = 0.05, ...
  b\_ele: rbend, ...
  this\_line: line = ( ... a_ele, ... b_ele, ... )
  use, this\_line
\end{example}

In the example the overlay \vn{over1} controls the \vn{hkick} attribute of 
the "slave" elements \vn{a_ele} and \vn{b_ele}. \vn{over2} controls the hkick attribute of 
just \vn{b_ele}. \vn{over1} has a \vn{hkick} value of 0.003 and \vn{over2} has been assigned 
a value for \vn{hkick} of 0.9. 

There are coefficients associated with the control of a slave element. 
The default coefficient is 1.0. To specify a coefficient use a slash "/" 
after the element name followed by the coefficient. In the above example 
the coefficient for the control of \vn{b_ele} from \vn{over1} is 2.0 
and for the others the default 1.0 is used. thus 
\begin{example}
  a_ele[hkick] = over1[hkick]
               = 0.003
  b_ele[hkick] = over2[hkick] + 2 * over1[hkick] 
               = 0.906
\end{example}

An \vn{overlay} will control all elements of a given name. 
Thus, in the above example, if there are multiple elements in \vn{this_line} with 
the name \vn{b_ele} then the \vn{over1} and \vn{over2} overlays will control the hkick
attribute of all of them. 

Note: Overlays completely determine the value of the attributes that are controlled 
by the overlay. in the above example, the hkick of 0.05 assigned directly 
to \vn{a_ele} is overwritten by the overlay action of \vn{over1}. 

The default value for an overlay is 0 so for example
\begin{example}
  over3: overlay = {c\_ele}, k1
\end{example}
will make \vn{c_ele[k1]} = 0. Overlays can also control more than one type of attribute
as the following example shows
\begin{example}
  over4: overlay = {this\_quad[k1]/3.4, this\_sextupole[k2], ...}, hkick
\end{example}


%-----------------------------------------------------------------------------
\section{Group Elements}
\label{s:group}
 
\vn{group} is like \vn{overlay} in that a \vn{group} element controls the 
attribute values of other ``slave'' elements. Unlike an \vn{overlay}, however, 
a \vn{group} element is used to control changes, not the absolute value. 
In addition, a \vn{group} element can control an elements position and 
length using the special attributes
\begin{example}
  accordion\_edge
  symmetric\_edge  
  start_edge
  end\_edge
\end{example}
The attributes of a group are
\begin{example}
  command         
  old\_command     
  coef            
  type            ! See section \ref{s:string}
  alias           ! See section \ref{s:string}
  descrip         ! See section \ref{s:string}
\end{example}
For example
\begin{example}
  q10: quad, l = ...
  d1: drift, l = ...
  d2: drift, l = ...
  this\_line: line = (... d1, q10, d2, q11, ...)

  gr1: group = {q10}, s_offset
  gr1[old\_command] = 0.4
  gr1[command] = 0.6
  gr1[coef] = 100

  gr2: group = {q10}, start\_edge = 0.1
  gq: group = {q10, q11/-1}, k1
\end{example}

In this example the \vn{group} element \vn{gr1} can be used by a program to 
control the longitudinal position of \vn{q10}. similarly \vn{gr2} controls the 
placement of the starting edge of \vn{q10} (the edge with the minimum s distance). 
in this case the lengths of \vn{d1} and \vn{q10} are varied in such a way so that the 
total length of \vn{this_line} is kept constant. 

\vn{accordion_edge} varies the edges of an element so that the center of the 
element is fixed but the length varies. with \vn{accordion_edge} a change of, 
say, 0.1 in the \vn{group} moves both edges of the element by 0.1 meters 
so that the length of the element changes by 0.2 meters. \vn{symmetric_edge}, 
\vn{accordion_edge}, \vn{start_edge} and \vn{end_edge} keep the total length of the 
lattice invariant. 

Notes: 
\begin{Itemize}
\item	Like \vn{overlay}s, coefficients can be specified for the individual 
elements under \vn{group} control. in the above example, the \vn{gq} \vn{group} 
controls the 2 quads in an anti-symmetric manner. 
\item	Like overlays, \vn{group}s can control more than one type of attribute. 
see the example above in the overlay section. 
\item	Unlike overlays, values are assigned to \vn{group} elements using the 
command attribute. the old\_command attribute sets the starting position for 
the \vn{group}. in the above example, the effect of \vn{gr1} initially is to 
move the position of q10 0.2 meters (= 0.6 - 0.4). 
\item	The coef attribute for a \vn{group} has no meaning within bmad and is 
used for communication with calling programs (for example, to define the 
conversion to data base computer units). 
\item	When a lattice file is read in then command values for any groups are 
always applied last. this is independent of the order that they appear in the file. 
\end{Itemize}
Example:
\begin{example} 
  gr: group = {q1}, k1 
  gr[command] = 0.34 
  q1[k1] = 0.57
\end{example}

in this example the value of q1[k1] would be 0.91 = 0.34 + 0.57. 




