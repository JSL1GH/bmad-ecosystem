\chapter {Groups and Overlays: Elements Controlling Other Elements}
\label{c:groups_and_overlays}

It is possible to have elements controlling the attributes of other elements.
These ``lord'' elements are meant to mimic the effect of changing a knob in
the control room. For example, a lord element can be used to simulate the
effect of a power supply that controls the quadrupole strengths of a gang of
magnets. A lord element can also simulate a girder that ties together the positions
of a group of elements. There are two types of lord elements (besides what are
called superposition lords which are discussed in \ref{s:super}): Groups are
used to make variations in attributes. For example, to simulate the action
of a control room knob that changes the tune, a group can be used to vary the
strength of selected quads in a specified manner. Overlays, on the other hand,
set the value (not a change in) the attributes they control. A \vn{group} or 
\vn{overlay} can control other \vn{group} and \vn{overlay} elements. There is no
limit to the number of levels of a control hierarchy.

%-----------------------------------------------------------------------------
\section{Overlay Elements}
\label{s:overlay}

An \vn{overlay} element is used to control the attributes of other elements. 
For example: 
\begin{example}
  over1: overlay = {a\_ele, b\_ele/2.0}, hkick = 0.003
  over2: overlay = {b\_ele}, hkick
  over2[hkick] = 0.9
  a\_ele: quad, hkick = 0.05, ...
  b\_ele: rbend, ...
  this\_line: line = ( ... a_ele, ... b_ele, ... )
  use, this\_line
\end{example}

In the example the overlay \vn{over1} controls the \vn{hkick} attribute of 
the "slave" elements \vn{a_ele} and \vn{b_ele}. \vn{over2} controls the hkick attribute of 
just \vn{b_ele}. \vn{over1} has a \vn{hkick} value of 0.003 and \vn{over2} has been assigned 
a value for \vn{hkick} of 0.9. 

There are coefficients associated with the control of a slave element. 
The default coefficient is 1.0. To specify a coefficient use a slash "/" 
after the element name followed by the coefficient. In the above example 
the coefficient for the control of \vn{b_ele} from \vn{over1} is 2.0 
and for the others the default 1.0 is used. thus 
\begin{example}
  a_ele[hkick] = over1[hkick]
               = 0.003
  b_ele[hkick] = over2[hkick] + 2 * over1[hkick] 
               = 0.906
\end{example}

An \vn{overlay} will control all elements of a given name. 
Thus, in the above example, if there are multiple elements in \vn{this_line} with 
the name \vn{b_ele} then the \vn{over1} and \vn{over2} overlays will control the hkick
attribute of all of them. 

Note: Overlays completely determine the value of the attributes that are controlled 
by the overlay. in the above example, the hkick of 0.05 assigned directly 
to \vn{a_ele} is overwritten by the overlay action of \vn{over1}. 

\noindent The default value for an overlay is 0 so for example
\begin{example}
  over3: overlay = {c\_ele}, k1
\end{example}
will make \vn{c_ele[k1]} = 0. Overlays can also control more than one type of attribute
as the following example shows
\begin{example}
  over4: overlay = {this\_quad[k1]/3.4, this\_sextupole[k2], ...}, hkick
\end{example}


%-----------------------------------------------------------------------------
\section{Group Elements}
\label{s:group}
 
\vn{group} is like \vn{overlay} in that a \vn{group} element controls
the attribute values of other ``slave'' elements.  A \vn{group}
element is used to make changes in value. This is unlike an
\vn{overlay} which sets a specific value directly. An example will
make this clear
\begin{example}
  gr: group = {q1}, k1 
  gr[command] = 0.34 
  q1, quad, l = ...
  q1[k1] = 0.57
\end{example}
In this example the group \vn{gr} controls the \vn{k1} attribute of
the element \vn{q1}. Unlike overlays, values are assigned to group
elements using the \vn{command} attribute.  When a lattice file is
read in then command values for any groups are always applied
last. This is independent of the order that they appear in the file.
Thus in this example the value of q1[k1] would be $0.91 = 0.57 + 0.34$.
When the changes are made to the slave attributes the value of
\vn{command} is stored in the \vn{group}'s \vn{old_command} attribute.
After the lattice is read in a program can change the \vn{gr[command]}
attribute and this change will be added to the value of
\vn{q1[k1]}. The bookkeeping routine that transfers the change from
\vn{gr[command]} to \vn{q1[k1]} doesn't care what the current value of
\vn{q1[k1]} is. It only knows it has to change it by the change in
\vn{gr[command]}.

A \vn{group} can be used to control an elements position and length using the attributes
\begin{example}
  accordion\_edge  ! Element grows or shrinks symmetrically
  start_edge       ! Varies element's starting edge s-position
  end\_edge        ! Varies element's ending edge s-position
  symmetric\_edge  ! Varies element's overall s-position. Constant length.
  s\_offset        ! Same as symmetric_edge
\end{example}
In all cases the total length of the lattice is kept invariant.
\vn{accordion_edge} varies the edges of an element so that the center
of the element is fixed but the length varies. with
\vn{accordion_edge} a change of, say, 0.1 in a \vn{group}'s
\vn{command} attribute moves both edges of the element by 0.1 meters
so that the length of the element changes by 0.2 meters. To keep the
total lattice length invariant the lengths of the elments to either
side are varied accordingly.
For example
\begin{example}
  q10: quad, l = ...
  q11: quad, l = ...
  d1: drift, l = ...
  d2: drift, l = ...
  this\_line: line = (... d1, q10, d2, q11, ...)
  gr2: group = {q10}, start\_edge = 0.1
\end{example}
This last line that defines \vn{gr2} is just a shorthand notation for
\begin{example}
  gr2: group = {q10}, start\_edge 
  gr2[command] = 0.1
\end{example}
The effect will be to lengthen the length of \vn{q10} and shorten the
length of \vn{d1}.

The full list of attributes of a group are
\begin{example}
  command         
  old\_command     
  coef            
  type            ! See section \ref{s:string}
  alias           ! See section \ref{s:string}
  descrip         ! See section \ref{s:string}
\end{example}
The \vn{coef} attribute is not used by any \bmad\ routine. It is
defined for individual programs to store, say, a needed conversion
factor.

Like \vn{overlay}s, coefficients can be specified for the individual
elements under a \vn{group}'s control and \vn{group}s can control more
than one type of attribute. For example
\begin{example}
  gr3: group = {q1[k1]/-1.0, q2[tilt], oct1/-2.0}, k3
  gr3[command] = 2.0
  gr3[old_command] = 1.5
\end{example}
In this example \vn{gr3} controls 3 attributes of 3 different
elements.  The change in \vn{gr3} when the lattice is read in is $0.5
= 2.0 - 1.5$.  this 0.5 change will change \vn{q1[k1]} by $-0.5 = -1
\times 0.5$, \vn{q2[tilt]} will change by 0.5 and \vn{oct1[k3]} will
change by $-1.0 = -2.0 * 0.5$.






