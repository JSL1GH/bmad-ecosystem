\documentclass[11pt]{article}
%%\documentclass{book}
\usepackage{geometry}            % See geometry.pdf to learn the layout options. There are lots.
\usepackage{xspace}
\geometry{letterpaper}           % ... or a4paper or a5paper or ... 
%\geometry{landscape}            % Activate for for rotated page geometry
%\usepackage[parfill]{parskip}   % To begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{alltt}
%\usepackage{epstopdf}
%\DeclareGraphicsRule{.tif}{png}{.png}{`convert #1 `dirname #1`/`basename #1 .tif`.png}
\usepackage[T1]{fontenc}   % so _, <, and > print correctly in text.
\usepackage[strings]{underscore}    % to use "_" in text

\usepackage{hyperref}

%---------------------------------------------------------------------------------

\newcommand{\bbup}{\texttt{BBU_PROGRAM}\xspace}
\newcommand\ttcmd{\begingroup\catcode`\_=11 \catcode`\%=11 \dottcmd}
\newcommand\dottcmd[1]{\texttt{#1}\endgroup}
\newcommand{\Begineq}{\begin{equation}}
\newcommand{\Endeq}{\end{equation}}
\newcommand{\fig}[1]{Figure~\ref{#1}}
\newcommand{\vn}{\ttcmd}           
\newcommand{\Th}{$^{th}$\xspace}
\newcommand{\Newline}{\hfil \\}

\newlength{\dPar}
\newlength{\ExBeg}
\newlength{\ExEnd}
\setlength{\dPar}{1.5ex}
\setlength{\ExBeg}{-\dPar}
\addtolength{\ExBeg}{-0.5ex}
\setlength{\ExEnd}{-\dPar}
\addtolength{\ExEnd}{-0.0ex}

\newenvironment{example}
  {\vspace{\ExBeg} \begin{alltt}}
  {\end{alltt} \vspace{\ExEnd}}

%---------------------------------------------------------------------------------

\setlength{\textwidth}{6.25in}
\setlength{\hoffset}{0.0in}
\setlength{\oddsidemargin}{0.25in}
\setlength{\evensidemargin}{0.0in}
\setlength{\textheight}{8.5in}
\setlength{\topmargin}{0in}

\setlength{\parskip}{\dPar}
\setlength{\parindent}{0ex}

%---------------------------------------------------------------------------------

\title{ {\bbup}: Simulation of the Beam Breakup Instability}
\author{J.A. Crittenden, D. Sagan}
\date{September 20, 2010}

\begin{document}
\maketitle

%------------------------------------------------------------------
\section{Introduction} 

\bbup is a program which simulates the beam breakup
instability~\cite{ref:Hoffstaetter04}. The beam breakup instability
occurs when a particle beam is recirculated through a cavity as in an
Energy Recovery Linac. The bunches of the beam are kicked by the
wakefields in a cavity and this kick generates an orbit distortion so
that when the bunches return to the cavity, their off-axis orbit
through the cavity will create additional wake fields. Given the right
conditions, this regenerative feedback can lead to instabilities.
\bbup works by direct simulation. A train of bunches is tracked though 
a lattice and the wakefields and orbit can be monitored.

%------------------------------------------------------------------------
\section{Simulation technique}

In order to correctly calculate the HOM fields, bunches are tracked
through a given cavity in the correct time order. That is, \bbup
``simultaneously'' tracks a sequence of bunches that fill the lattice,
starting and stopping bunches as appropriate to make sure that the
bunches going through a cavity are tracked in the correct order.

In \bbup, time ($t$) is measured in ``\vn{turns}'' (Abbreviated
``\vn{T}''). One turn is the time it takes a bunch to travel from the
start of the lattice to the end. At the start of a simulation, at time
equal zero, the HOM power in the cavities is set to zero. Bunches are
then started at the beginning of the lattice and tracked through to
the end. To minimize computation time, a single particle is used to
represent each bunch. 

Bunches that are initialized at a time between 0 and 1T are given a
random transverse offset. The offset distribution is Gaussian in shape
and the sigma is determined by the parameter
\vn{bbu_param%init_particle_offset} (see below). After the zeroth turn
period (which is the period ($0 \le t \le 1T$) , bunches will be
initialized with zero transverse offset. In the second turn period
($2T \le t \le 3T$), the averaged ``maximum field strength'',
$V_{max}(2)$ which is the field strength of the strongest HOM mode in
all the cavities, is taken as a baseline to determine whether the
fields are growing or decaying. At the end of the simulation, after a
set number of turn periods $n$, the beam is declared stable or
unstable depending upon whether the ratio $V_{max}(n-1)/V_{max}(2)$ is
less than or greater than 1. Additionally, in order to shorten the
computation time, if $V_{max}(m)/V_{max}(2)$ for some turn period $m$
is lower then a user defined limit, the simulation is aborted and the
beam is declared to be stable. If $V_{max}(m)/V_{max}(2)$ goes
above a user defined upper limit, the simulation is aborted and the beam is
declared to be unstable.

%------------------------------------------------------------------
\subsection{Main input file} 

When \bbup is run, \bbup first reads the \vn{main input file}.
The main input file can be specified on the command line invoking {\bbup}.
If not given, the default name for the main input file is ``\vn{bbu.init}''.
Example main input file:
\begin{example}
&bbu_params
  bbu_param%lat_file_name = 'erl.lat'       ! Bmad Lattice file name.
  bbu_param%bunch_freq = 1.3e9              ! Bunch-to-bunch frequency in Hz.
  bbu_param%init_particle_offset = 1e-8     ! Initial particle offset sigma.
  bbu_param%limit_factor = 2                ! Simulation unstable limit.
  bbu_param%simulation_turns_max = 11       ! Simulation time.
  bbu_param%hybridize = T                   ! Combine non-hom elements in the simulation?
  bbu_param%keep_overlays_and_groups = F    ! Keep when hybridizing?
  bbu_param%keep_all_lcavities = F          ! Keep when hybridizing?
  bbu_param%current = 20e-3                 ! Starting current (amps).
  bbu_param%rel_tol = 1e-2                  ! Final threshold current accuracy.
  bbu_param%write_hom_info = T  
  bbu_param%drscan = F                      ! Do DR scan as in PRSTAB 7 (2004) Fig. 3?
  bbu_param%elname = 'T1'                   ! Element to step length for DRSCAN.
  bbu_param%nstep = 50                      ! Number of steps for DRSCAN.
  bbu_param%begdr = 5.234                   ! Beginning DR value for DRSCAN.
  bbu_param%enddr = 6.135                   ! End DR value for DRSCAN.
  bbu_param%use_interpolated_threshold = T
  bbu_param%nrep = 10                       ! Threshold or stable orbit calculation reps.
  bbu_param%ran_seed = 0                    ! Set specific seedd (0 uses system clock).
  bbu_param%ran_gauss_sigma_cut = 3         ! Limit ran_gauss values to within N sigma.
  bbu_param%stable_orbit_anal = F           ! Write out cavity orbit data.
/
\end{example}
Fortran namelist input is used.
The namelist begins on the line starting with \vn{"\&bbu_params"}
and ends with the line containing the slash \vn{"/"}. Anything outside
of this is ignored. Within the namelist, anything after an exclamation
mark \vn{"!"} is ignored including the exclamation mark. 

  \begin{description}
  \item[\vn{lat_file_name}] \Newline
The \vn{lat_file_name} parameter specifies the lattice file to be
used.  Lattices are in Bmad standard format~\cite{ref:bmad}. In order
to simulate BBU, \vn{multipass} lines which contain \vn{lcavity}
elements must be specified in the lattice. The long range wakes in the
\vn{lcavity} elements are responsible for the BBU instability. See
the Bmad manual for more details.
  \item[\vn{bunch_freq}] \Newline
The \vn{bunch_freq} is the bunch-to-bunch frequency in Hz.
  \item[\vn{init_particle_offset}] \Newline
This is the $1\sigma$ half width, in meters, of the distribution of
the initial transverse coordinates for bunches initialized during the
zeroth turn period.
  \item[\vn{limit_factor}] \Newline
If the ratio $V_{max}(m)/V_{max}(2)$ goes above \vn{limit_factor} the
beam is declared unstable and if $V_{max}(m)/V_{max}(2)$ goes below
\vn{1/limit_factor} the beam is declared stable.
  \item[\vn{simulation_turns_max}] \Newline
The \vn{simulation_turns_max} parameter sets the duration of the simulation.
  \item[\vn{hybridize}] \Newline
Hybridization is the process of combining all the elements between
two cavities into one element. Tracking through a hybridized element
is done using linear transport. This speeds up the calculation but
there is a possible loss of accuracy.
  \item[\vn{keep_overlays_and_groups}] \Newline

  \item[\vn{keep_all_cavities}] \Newline
When hybridizing, if \vn{keep_all_cavities} is set to False, then
\vn{lcavity} elements that do not have HOM elements will be
hybridized. If \vn{lcavity} elements without HOMs are hybridized, this
will speed up the simulation but can possibly lead to inaccurate
results.
  \item[\vn{current}] \Newline
  \item[\vn{write_hom_info}] \Newline
If this parameter is set true, the HOM parameters are written to the
main output file.
  \item[\vn{drscan}] \Newline
If enabled, the threshold current is calculated for over the range in return times
corresponding to the range from \vn{begdr} to \vn{enddr} in  \vn{nstep} steps,
lengthening the \vn{elname} element in the lattice accordingly. If the toy lattice
of Ref.~\cite{ref:Hoffstaetter04} (see the Appendix) is used, then its Fig.~3 is reproduced.
  \item[\vn{nrep}] \Newline
The BBU threshold current calculations are repeated \vn{nrep} times. This is useful
to estimate the effect of randomizing the HOM frequencies, since they are re-randomized for
each calculation.
  \item[\vn{ran_seed}] \Newline
Random number see used in by the random number generator. If set to 0, the system clock
will be used. That is, if set to 0, the output results will vary from run to run. 
  \item[\vn{ran_gauss_sigma_cut}] \Newline
Any randomized values in the lattice, such as HOM frequency spread or position jitter
are limited to a maximum deviation of \vn{ran_gauss_sigma_cut} rms deviations. 
  \item[\vn{stable_orbit_anal}] \Newline
If this parameter is set true, then the output files \tt{stable_orbit.out} and \tt{hom_voltage.out}
are written for each bunch train passage and each repetition, allowing the orbit deviations
and HOM loading to be analyzed as the equilibrium level is reached.

\end{description}
%------------------------------------------------------------------
\section{Output files} 

%------------------------------------------------------------------
\subsection{Main output file}
The standard output stream contains information on the progression of the job,
including a calculation of total elapsed wall clock time at the end.
\subsection{\tt{drscan.out}}
For each successive BBU threshold calculation convergence, a line is written
to \tt{drscan.out} containing the {tr\/tb} variable~\cite{ref:Hoffstaetter04},
the analytic approximation to the threshold current, and the result for the
threshold current, in standard format.
\subsection{\tt{rep.out}}
The output file \tt{rep.out} contains one line per threshold calculation which
consists of the repetition number, the threshold current, and the index number, the 
ring position, the input file HOM frequency, the HOM frequency used after randomization,
the input file \tt{R/Q} value, the HOM Q value, and the HOM polarization angle.
The format is \tt{(i6,e14.6,2i7,6(e14.6,1x))}.
\subsection{\tt{hom_voltage.out}}
The stable orbit analysis proceeds at a fixed current without iteration, calculating
the for multiple bunch train passages the voltages excited in the HOM elements and
the resulting orbit distortions. The output file \tt{hom_voltage.out} contains one
line for each train passage the reptition number, the passage number, the sum over HOM
elements of the greatest HOM voltage excited by any of the HOM modes in that element,
the total number of contributions to that HOM voltage, and the HOM voltage gain factor which
would be used in a threshold current convergence calculation.
The format is \tt{(2i10,e13.6,x,i8,x,e15.6)}. The successive values of this sum over
maximum HOM voltages can be used to estimate when the equilibrium loading condition has
been reached for this value of the beam current.
\subsection{\tt{stable_orbit.out}}
The stable orbit analysis also writes output for each HOM element for each bunch train passage to
the file \tt{stable_orbit.out}. This line contains the HOM element ordinal number, the HOM
arrival time, its maximum HOM voltage, the HOM frequency, the \tt{R/Q} value, the Q value, and five
statistical variables characterizing the orbit distortion: the number of orbits analyzed, the average orbit distortion, the rms orbit distortion, the minimum orbit distortion and the maximum orbit distortion. The latter five variables are repeated six times for each of the six coordinates of the orbit: x, px, y, py, z, and ${\delta}$. The format is \tt{(i10,5(1x,e15.8),i10/,4(6(1x,e15.6)/))}.
%------------------------------------------------------------------
\section{Appendix}
The BBU threshold calculations produced by setting the parameter \vn{drscan}
true and using the default values of \vn{begdr}, \vn{enddr} and \vn{nstep} reproduce
the results of Fig.~3 of Ref.~\cite{ref:Hoffstaetter04}, writing them to
the output file \tt{drscan.out} when the following Bmad lattice file is used:\\\\*[5mm]
\parbox{\textwidth}{
\tt{
parameter[lattice] = "PRSTAB 7, 2004 Toy Lattice"\\
betaa=20\\
betab=20\\
alphaa=0\\
alphab=0\\
beginning[beta_a]  =    betaa\\
beginning[alpha_a]=   alphaa\\
beginning[beta_b] =    betab\\
beginning[alpha_b] =   alphab\\
beginning[e_tot] = 5e9\\
parameter[lattice_type] = linear_lattice\\
rfw: lcavity, l = 0, gradient = 0.0, lr_wake_file="prstab2004.dat",\\ 
lr_freq_spread=0.0E-3, rf_frequency = 1.3e9\\
m1: match, beta_a1=betaa, alpha_a1=alphaa, beta_b1=betab, alpha_b1=alphab, dphi_a=1, dphi_b=1, l=1.269, match_end=.true.\\
m12=-5e9*1.0e-6\\
t1: Taylor, {1:   m12,  0 1 0 0 0 0}, l=1.269\\
simple: line[multipass] = (rfw, t1)\\
dual: line = (simple,simple)\\
use, dual
}
}
\vskip 5mm
%\minipage{\textwidth}{
The required HOM parameter file \tt{prstab2004.dat} is\\*[5mm]
\tt{\begin{verbatim}
          Frequency           R/Q           Q         n     Polarization_Angle
           [Hz]           [Ohm/m^(2n)]                        [Radians/2pi]

&long_range_modes
 lr(1) =     2.0e9            8.78e4        10000     1        0.0
/
\end{verbatim}
}
%}
%------------------------------------------------------------------
\begin{thebibliography}{9}


\bibitem{ref:Hoffstaetter04} G.H.~Hoffstaetter, I.V.~Bazarov, \emph{
Beam-Breakup Instability Theory for Energy Recovery Linacs},
Phys.~Rev.~ST-AB {\bf 7}, 054401 (2004)

\bibitem{ref:bmad}
D. Sagan, {\em Bmad: A Relativistic Charged Particle Simulation Library},
Nuc. Instrum. \& Methods {\bf A558}, 356 (2006).
The Bmad manual can be obtained at {\tt http://www.lepp.cornell.edu/{$\sim$}dcs}

\end{thebibliography}
\end{document}  
