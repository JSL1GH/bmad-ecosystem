\documentclass[11pt,openany]{article}
\usepackage{tocloft}
\usepackage{geometry}            % See geometry.pdf to learn the layout options. There are lots.
\usepackage{xspace}
\geometry{letterpaper}           % ... or a4paper or a5paper or ... 
%\usepackage[parfill]{parskip}   % To begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{alltt}
\usepackage[T1]{fontenc}   % so _, <, and > print correctly in text.
\usepackage[strings]{underscore}    % to use "_" in text
\usepackage[pdftex,colorlinks=true]{hyperref}

%---------------------------------------------------------------------------------

\newcommand{\sref}[1]{$\S$\ref{#1}}
\newcommand{\srthree}{\texttt{Synrad3D}\xspace}
\newcommand\ttcmd{\begingroup\catcode`\_=11 \catcode`\%=11 \dottcmd}
\newcommand\dottcmd[1]{\texttt{#1}\endgroup}
\newcommand{\Begineq}{\begin{equation}}
\newcommand{\Endeq}{\end{equation}}
\newcommand{\fig}[1]{Figure~\ref{#1}}
\newcommand{\vn}{\ttcmd}           
\newcommand{\Th}{$^{th}$\xspace}
\newcommand{\Newline}{\hfil \\}
\newcommand{\Bf}[1]{{\bf #1}}
\newcommand{\bfr}{\Bf r}
\newcommand{\stilde}{{\widetilde s}}

\newcommand{\bearray}{\begin{eqnarray}}
\newcommand{\eearray}{\end{eqnarray}}
\newcommand{\be}{\begin{equation}}
\newcommand{\ee}{\end{equation}}
\newcommand{\bearraynn}{\begin{eqnarray*}}
\newcommand{\eearraynn}{\end{eqnarray*}}
\newcommand{\benn}{\begin{displaymath}}
\newcommand{\eenn}{\end{displaymath}}
\newcommand{\eq}[1]{{Eq.~(\ref{#1})}}
\newcommand{\eqs}[2]{{Eqs.~(\ref{#1}--\ref{#2})}}
 
\newcommand{\pder}[2]{\frac{\partial {#1}}{\partial {#2}}}
\newcommand{\ppder}[3]{\frac{\partial^2 {#1}}{\partial {#2}\,\partial {#3}}}
\newcommand{\pdder}[2]{\frac{\partial^2 {#1}}{\partial {#2}^2}}
 
\newcommand{\der}[2]{\frac{d {#1}}{d {#2}}}
\newcommand{\dder}[2]{\frac{d^2 {#1}}{d {#2}^2}}

\newcommand{\ket}[1]{|{#1}\rangle}
\newcommand{\bra}[1]{\langle{#1}|}
\newcommand{\braket}[2]{\langle{#1}|{#2}\rangle}
\newcommand{\comm}[2]{[{#1},{#2}]}
 
\newcommand{\e}{{\rm e}}
 
\newcommand{\ie}{ie}
\newcommand{\eg}{eg}
\newcommand{\cf}{cf}
\newcommand{\half}{{\mbox{$\frac{1}{2}$}}}
\newcommand{\bm}[1]{\mathbf{#1}}
 
\newcommand{\unit}[1]{~\mbox{$\rm #1$}}

\newlength{\dPar}
\newlength{\ExBeg}
\newlength{\ExEnd}
\setlength{\dPar}{1.5ex}
\setlength{\ExBeg}{-\dPar}
\addtolength{\ExBeg}{-0.5ex}
\setlength{\ExEnd}{-\dPar}
\addtolength{\ExEnd}{-0.0ex}

\newenvironment{example}
  {\vspace{\ExBeg} \begin{alltt}}
  {\end{alltt} \vspace{\ExEnd}}

%---------------------------------------------------------------------------------

\setlength{\textwidth}{6.25in}
\setlength{\hoffset}{0.0in}
\setlength{\oddsidemargin}{0.25in}
\setlength{\evensidemargin}{0.0in}
\setlength{\textheight}{8.5in}
\setlength{\topmargin}{0in}

\setlength{\parskip}{\dPar}
\setlength{\parindent}{0ex}

\setlength\cftparskip{0pt}
\setlength\cftbeforesecskip{3pt}
\setlength\cftaftertoctitleskip{15pt}

%---------------------------------------------------------------------------------

\title{ \srthree Photon Tracking Program}
\author{G. Dugan, D. Sagan}
\date{November 24, 2015}

%---------------------------------------------------------------------------------

\begin{document}
\maketitle

\pdfbookmark[1]{Contents}{Contents}
\tableofcontents

%------------------------------------------------------------------
\section{Introduction} 
\label{s:intro}

\srthree is a program which simulates the production and scattering of
synchrotron radiation generated by an electron beam in a high energy
machine. The program was written by David Sagan and the photon
scattering model was developed by Gerry Dugan, both of Cornell
University.

\srthree is built atop the the Bmad software library
\cite{b:bmad}. The Bmad library, developed at Cornell, has been
developed for modeling relativistic charged particles in storage rings
and Linacs, as well as modeling photons in x-ray beam lines.

The motivation for developing \srthree was to estimate the energy and
position distribution of where SR photons are absorbed. This is a
critical input to codes which model the growth of electron clouds.
\srthree has also been used to model radiation mask efficiency.
\srthree includes scattering from the vacuum chamber walls, based on
X-ray data from an LBNL database~\cite{b:henke} for the smooth-surface
reflectivity, and an analytical model~\cite{b:beckmann,b:ogilvy} for
diffuse scattering from a surface with finite roughness. \srthree can
handle a wide variety of vacuum chamber profiles. \srthree also
handles a wide variety of machines including machines whose geometry
is not planar and machines using electrons or positrons as well as
machines using protons or antiprotons.

\srthree is not to be confused with an older program called
\vn{Synrad}. The \vn{Synrad} program is used for calculating wall
heating from the primary beam. \vn{Synrad} only tracks photons in the
horizontal plane and does not simulate the scattering of the photons
from the wall. The advantage of \vn{Synrad} is that it is fast and
directly gives wall heating numbers. The advantage of \srthree is that
it tracks photons in three dimensions and it does simulate scattering.

%------------------------------------------------------------------
\section{Running \srthree} 
\label{s:run}

Syntax for invoking \srthree:
\begin{example}
  synrad3d \{options\} \{<master_input_file_name>\}
\end{example}
Examples:
\begin{example}
  synrad3d my_input_file.init
  synrad3d -plot xy  my_input_file.init
\end{example}

The \vn{<master_input_file_name>} optional argument is used to set the
master input file name. The default is ``\vn{synrad3d.init}''. 

The command line options for \srthree are:
\begin{example}
  -plot <what>  ! For viewing diagnostic plots.
  -test <what>  ! For generating diagnostic files.
\end{example}

The \vn{-plot <what>} option is used for diagnostic purposes. When the
\vn{-plot} option is used, no photon tracking is done and instead a
plot window is displayed and \srthree will ask for the appropriate
parameters for making a plot. One of four types of plots is chosen by
the setting of \vn{<what>}:
\begin{example}
  -plot reflect ! Plot photon reflection probability curves.
  -plot xy      ! Plot cross-sections in the x-y plane.
  -plot xs      ! Plot cross-section in the x-s plane.
  -plot ys      ! Plot cross-section in the y-s plane.
\end{example}

The \vn{-plot reflect} option is for viewing photon reflection
probability curves. The \vn{-plot xy} option is for viewing of wall
cross-sections in the $x$-$y$ plane at any point in the machine. The
\vn{-plot xs} option plots the wall outline in the $x$-$s$ plane at $y
= 0$. The \vn{-plot ys} option plots the wall outline in the $y$-$s$
plane at $x = 0$.

When plotting $x$-$y$ cross-sections, symbols
will be drawn at the vertex points \vn{v(i)} that define the
cross-section.

The \vn{-test <what>} option is for generating diagnostic
files:
\begin{example}
  -test diffuse_reflection     ! \sref{s:test.diffuse}
  -test specular_reflection    ! \sref{s:test.specular}
\end{example}

In \vn{-test diffuse_reflection} mode, \srthree simulates a set of photons
reflected at a wall with all photons having the same incoming angle
and energy. See \sref{s:test.diffuse} for more details.

In \vn{-test specular_reflection} mode, specular reflection is tested
by simulating a single specular reflection from given photon
starting positions. See \sref{s:test.specular} for more details.

%------------------------------------------------------------------------
\section{Simulation Technique and Physics Models}
\subsection{Overview} 

The \srthree program uses the Monte Carlo method for photon
generation, scattering, and absorption calculations.

For photon generation, a section of the machine (which may be the
complete machine) is designated for photon generation.  The total
number of photons generated is set by the user. \srthree calculates
how many photons need to be generated within each machine
element. Both circular and ``linear'' (that is, non-circular) machines
can be simulated.  In both cases, the orbit of the charged particle
beam, which may be non-zero, sets the centroid position and angular
orientation of the generated photons. The local bending field at the
beam orbit is used to determine the photon spectrum. Thus, for
example, radiation for an offset beam in a quadrupole is included.

The photon is tracked from the point of origin to
the point at which it hits the vacuum chamber wall. The angle of
incidence relative to the local normal to the vacuum chamber is
computed. A scattering probability is computed, based on this angle
and the photon's energy. Depending on the value of this probability,
the photon is either absorbed at this location, or scattered. If it is
scattered, the scattering is taken to be elastic. That is, photon
energy does not change. This ignores any florescence. Surface
roughness, on the other hand is taken into account so there is a
diffuse component to the scattering.

The photon is then tracked to the next encounter with the vacuum
chamber wall, and the probability of scattering is again
computed. This process continues until the photon is absorbed.

%------------------------------------------------------------------
\subsection{Photon Generation}

Photon generation is based on the standard synchrotron radiation
formulas, applicable for dipoles quadrupoles, and wigglers. The
radiation is assumed to be incoherent, so this program cannot treat
undulator radiation. Polarization of the photon is ignored.

\srthree slices up each element longitudinally
and generates photons from each slice. The number of photons generated
in a slice weighted by the local probability of photon emission which
depends on the local orbit curvature.

Both circular and ``linear'' (that is, non-circular) machines can be
simulated.  In both cases, the orbit of the charged particle beam,
which may be non-zero, sets the centroid position and angular
orientation of the generated photons. Photon generation is based upon
the local field along the beam orbit. Thus, for example, off-axis
photons in a quadrupole will produce radiation. The beam orbit is
calculated from such things as the settings of steering elements,
element misalignments, etc. as given in the lattice file. For circular
machines, the beam orbit is the closed orbit. For linear machines, the
starting beam position as set in the lattice file is used in the orbit
calculation.

When a photon is generated at a given longitudinal position, the
beam's emittances and centroid are used so that the resulting photon
distribution mirrors the Gaussian positional distribution of the beam.
Horizontal/vertical coupling is taken into account in this
calculation. The photon energy distribution will be the standard
energy spectrum of photons generated in a bend.

A photon's initial angular orientation is generated by first using a
random number generator to generate an angular orientation using a
probability function that corresponds to the beam's angular
distribution. To this orientation, an angular offset out of the plane
of the bend is added where the offset is calculated using a random
number generator with a probability distribution based on the standard
angular spectrum of photons generated in a bend. There is no angular
offset added to the angle in the plane of the bend. The generated
photons will have the proper correlation between photon energy and
photon angle. Note that the bending plane of the charged particle beam
need not be horizontal. For example, the bend plane orientation for an
offset beam in a quadrupole will depend upon the offset.

%------------------------------------------------------------------
\subsection{Photon Scattering} 

  \begin{figure}
  \centering
  \includegraphics[width=6in]{specular-probability.pdf}
  \caption[Specular reflection probability vs. photon energy and angle]
{\label{f:spec.prob}
Specular reflection probability~\cite{b:beckmann}, vs. photon energy
and angle, for an rms surface roughness of 200 nm.}
  \end{figure}
   
Simulated photons are tracked until they hit the wall, where the
probability of being scattered, and the scattering angle, are
determined by their energy and angle of incidence.  This section
describes the scattering model.

Generally, the probability of specular reflection of a photon from a
rough surface depends on the the rms surface roughness $\sigma$, the
photon wavelength $\lambda$, and the grazing angle. An explicit
formula for this probability is~\cite{b:beckmann}
   \begin{equation}
P_{\textrm{spec}}=\textrm{e}^{-g(x,x)},
\end{equation}
in which
   \begin{equation}
g(x,y)=\frac{4\pi^{2}\sigma^{2}(x+y)^{2}}{\lambda^{2}}
  \end{equation}
where $x$ is the cosine of the incident polar angle, and $y$ is the
cosine of the scattered polar angle. For a typical technical vacuum
chamber surface, the rms surface roughness $\sigma \gtrsim 200$ nm is
greater than most of the X-ray wavelengths of interest, for all except
the lowest energy photons. In this regime, except at very small
grazing angles, diffuse scattering from the surface dominates over
specular reflection. This is illustrated in Fig.~\ref{f:spec.prob}.
The theory of diffuse scattering of electromagnetic waves from random
rough surfaces is a well-developed subject, and is covered in detail
in references \cite{b:beckmann} and \cite{b:ogilvy}. The model we use
assumes a Gaussian distribution for both the surface height variations
(rms $\sigma$) and for the transverse distribution (equal in both
transverse directions, with autocorrelation coefficient $T$).

  \begin{figure}
  \centering
  \includegraphics[width=4.5in]{Daphne-fit-5-deg}
  \caption{\label{f:Daphne.fit.5.deg}
   Diffuse scattering at 5 deg from a surface layer on an aluminum substrate: comparison of data and model}
   \includegraphics[width=4.5in]{Daphne-fit-45-deg}
   \caption{\label{f:Daphne.fit.45.deg}
   Diffuse scattering at 45 deg from a surface layer on an aluminum substrate: comparison of data and model}
   \end{figure}

  \begin{figure}
  \includegraphics[width=4.5in]{Daphne-fit-85-deg}
   \caption{\label{f:Daphne.fit.85.deg}
   Diffuse scattering at 85 deg from a surface layer on an aluminum substrate: comparison of data and model}
  \includegraphics[width=6in]{Smooth-surface-reflectivity}
   \caption[Smooth surface reflectivity for a 10 nm C film on Al substrate]
   {\label{f:Smooth.surface.reflectivity}
   Smooth surface reflectivity for a 10 nm C film on Al substrate: from \cite{b:henke}}
  \centering
   \end{figure}

      \begin{figure}
  \centering
  \includegraphics[width=6in]{Diffuse-out-of-plane-30ev}
   \caption{   \label{f:Diffuse.out.of.plane.30ev}
   Diffuse scattering out-of-plane angular distributions for 30 eV photons}
 \includegraphics[width=6in]{Diffuse-polar-30ev}
   \caption{   \label{f:Diffuse.polar.30ev}
   Diffuse scattering polar angular distributions for 30 eV photons}
   \end{figure}

  \begin{figure}
  \centering
  \includegraphics[width=6in]{Diffuse-polar-HE}
   \caption{   \label{f:Diffuse.polar.HE}
    Diffuse scattering polar angular distributions for high energy photons}
  \centering
  \includegraphics[width=6in]{Diffuse-out-of-plane-HE}
   \caption{   \label{f:Diffuse.out.of.plane.HE}
   Diffuse scattering out-of-plane angular distributions for high energy photons}
   \end{figure}
   
The most general expression for the diffusely scattered power is
complex, and involves an infinite sum.  However, the expression
simplifies substantially in the limit $g(x,y)\gg 1.$ For very rough
surfaces corresponding to technical vacuum chambers, for which
typically $\sigma \gg \lambda$, this condition is satisfied over much
of the region of interest. In this limit, the diffusely scattered
power per unit solid angle is given by
  \begin{equation}
  \frac{d P_{\textrm{diff}}}{d \Omega} = P_{0}\frac{\left<R\right>}{4\pi y}
  \frac{(1+xy)^{2}}{(x+y)^{4}}\tau^{2}\textrm{e}^{-\frac{(2-x^{2}-y^{2})
  \tau^{2}}{4(x+y)^{2}}}(1-a\cos\phi)^{2}\textrm{e}^{b\cos\phi},
  \label{Eq.diffuse.power}
  \end{equation}
with
   \begin{align}
   a&=\frac{h(x,y)}{1+xy}, \\
   b&=\frac{2h(x,y)\tau^{2}}{4(x+y)^{2}}, \\
   h(x,y)&=\sqrt{1-(x^{2}+y^{2})+x^{2}y^{2}}.
   \end{align}
In this expression, $P_{0}$ is the incident power, and
$\left<R\right>$ is the smooth-surface reflectivity, which is
determined by the atomic structure of the surface material. $\phi$ is
the scattering angle out of the plane of incidence. Note that the
relative power depends on the ratio $\tau=T/\sigma$, and not on the
$T$ or $\sigma$ separately.

The smooth-surface reflectivity $\left<R\right>$ depends on the atomic
structure of the surface materials (including any thin layers which
may be deposited on the surface). The surface roughness parameters
$\sigma$ and $T$ depend on the geometry of the surface deviations from
a perfect plane. These parameters may be determined from inspection of
the vacuum chamber surface, for example, using an atomic force
microscope.

To derive a working model for the smooth surface reflectivity and the
surface parameters for a typical vacuum chamber surface, we have
relied on measurements~\cite{b:mehne} of X-ray scattering
from an aluminum vacuum chamber surface made at \vn{DAPHNE}. For
these measurements, the rms surface roughness of the sample was
reported to be 200 nm.

The theory of diffuse scattering discussed above has been used,
together with smooth surface reflectivity results taken from an X-ray
database~\cite{b:henke}, to predict the scattering and compare with
the measurements. From these comparisons, the best-fit value for the
transverse autocorrelation parameter, $T$, was found to be 5500 nm. As
discussed by Dugan and Sagan\cite{b:synrad3d},
it was found that the smooth-surface reflectivity
corresponding to a 10 nm carbon film on an aluminum substrate was
needed to fit the data. The assumption of an aluminum oxide surface
film was not consistent with the data. The data and the corresponding
fits are shown in Fig.~\ref{f:Daphne.fit.5.deg},
\ref{f:Daphne.fit.45.deg}, and \ref{f:Daphne.fit.85.deg}.

With the smooth-surface reflectivity determined, and the surface
parameters established, the scattering model in \srthree is
completely determined. The model currently in use has a smooth-surface
reflectivity illustrated in
Fig.~\ref{f:Smooth.surface.reflectivity}. Diffuse
scattering distributions for 30 eV photons are shown in
Fig.~\ref{f:Diffuse.polar.30ev} and
Fig.~\ref{f:Diffuse.out.of.plane.30ev}. At this low photon
energy, the approximation $g(x,y)\gg 1$ does not hold in general, and
the full diffuse scattering formalism is used to compute these
distributions. Diffuse scattering distributions for high energy
photons, for which $g(x,y)\gg 1$ are shown in
Fig.~\ref{f:Diffuse.polar.HE} and
Fig.~\ref{f:Diffuse.out.of.plane.HE}. These distributions
have been computed from Eq.~\ref{Eq.diffuse.power}.

%------------------------------------------------------------------
\section{Master Input File} 
\label{s:master}

%------------------------------------------------------------------
\subsection{Fortran Namelist}
\label{s:namelist}

Fortran namelist syntax is used for parameter input by \srthree. The
general form of a namelist is
\begin{example}
  &<namelist_name>
    <var1> = ...
    <var2> = ...
    ...
  /
\end{example}
The tag \vn{"\&<namelist_name>"} starts the namelist where
\vn{<namelist_name>} is the name of the namelist. The namelist ends
with the slash \vn{"/"} tag. Anything outside of this is
ignored. Within the namelist, anything after an exclamation mark
\vn{"!"} is ignored including the exclamation mark. \vn{<var1>},
\vn{<var2>}, etc. are variable names. Example:
\begin{example}
  &place section =   0.0, "arc_std", "elliptical", 0.045, 0.025 /
\end{example}
here \vn{place} is the namelist name and \vn{section} is a
variable name.  Notice that here \vn{section} is a ``structure'' which
has five components -- a real number, followed by two strings,
followed by two real numbers.

Everything is case insensitive except for quoted strings.

Logical values are specified by \vn{True} or \vn{False} or can be
abbreviated \vn{T} or \vn{F}. Avoid using the dots (periods) that one
needs in Fortran code.

%------------------------------------------------------------------
\subsection{Example Master Input File} 
\label{s:master.example}

The master input file can be specified on the command line invoking \srthree.
If not given, the default name for the master input file is ``\vn{synrad3d.init}''.

Fortran namelist syntax is used (\sref{s:namelist}). Example master input file:
\begin{example}
  &synrad3d_parameters
    ix_ele_track_start   = 1      ! Radiation region start lattice element.
    ix_ele_track_end     = 912    ! Radiation region end lattice element.
    photon_direction     = 1      ! 1 = Forward generation, -1 = Backward generation.
    num_photons          = 50000  ! Nominal number of unfiltered photons generated. 
    num_photons_per_pass = -1     ! Number of photons generated per pass. -1 = Use num_photons.
    ds_step_min          = 0.01   ! Photons are generated at discrete points. 
                              ! Multiple photons can be generated at each point.
                              ! This is minimum distance between points.
    emit_a       = -1         ! Horizontal emit. Meters. If < 0 -> Calc from lattice.
    emit_b       = 7.52E-11   ! Vertical emit.  Meters. If < 0 -> Calc from lattice.
    sig_e        = -1         ! Sig_E/E. If < 0 -> Calc from lattice.

    lattice_file = "../lattice/cesr/bmad/bmad_6wig_8nm_2085.lat" 
    wall_file    = "synrad3d.wall"   ! Vacuum chamber wall file.
    dat_file     = "synrad3d.dat"    ! Output data file.
    wall_hit_file = ""               ! Photon wall hit data file.
    lat_ele_file  = ""               ! Write lattice element data file.

    random_seed = 123456             ! 0 -> Use sys clock.
    e_init_filter_min = -1           ! Min energy filter param.
    e_init_filter_max = -1           ! Max energy filter param.
    e_filter_min = -1                ! Min energy filter param.
    e_filter_max = -1                ! Max energy filter param.
    s_filter_min = -1                ! Min S position filter param.
    s_filter_max = -1                ! Max S position filter param.
    photon_start_input_file  = ""    ! File for initializing the photons
    photon_start_output_file = ""    ! File recording photon start positions
    num_ignore_generated_outside_wall = 0    !
    turn_off_kickers_in_lattice = F          ! Zero the closed orbit?
    surface_roughness_rms       = -1         ! Surface roughness for diffuse scattering.
    roughness_correlation_len   = -1         ! Surface roughness correlation length.
    surface_reflection_file     = ""         ! File for specifying default reflection probabilities.
    sr3d_params%diffuse_scattering_on = T    ! For testing the effect of diffuse scattering.
    sr3d_params%ds_track_step_max     = 3    ! Photon propagation step size 
    sr3d_params%dr_track_step_max     = 0.1  ! Photon propagation step size 
    sr3d_params%allow_reflections     = T    ! For testing purposes.
    sr3d_params%allow_absorption      = T    ! For testing purposes.
  /
\end{example}

  \begin{description}
  \item[\vn{ix_ele_track_start}, \vn{ix_ele_track_end}] \Newline
The parameters \vn{ix_ele_track_start} and \vn{ix_ele_track_end} establish
the region where radiation is produced. These are the index numbers of 
elements in the lattice. The radiation region boundary is taken to be at
the exit end of the elements so no radiation is produced in the element
with index \vn{ix_ele_track_start}. If \vn{ix_ele_track_end} is negative,
the end of the radiation region is taken to be end of the lattice.
If \vn{ix_ele_track_end} is positive and less than \vn{ix_ele_track_start},
the track region will be from \vn{ix_ele_track_start} through the
end of the lattice and from the beginning of the lattice to \vn{ix_ele_track_end}.
  \item[\vn{photon_direction}] \Newline
The \vn{photon_direction} parameter determines in what direction the photons
are traveling when initially created. A value of \vn{+1} indicates the photons
are created traveling in the $+s$ direction and a value of \vn{-1} indicates
that the photons are created in the $-s$ direction.
  \item[\vn{num_photons}] \Newline
\vn{num_photons} establishes the minimum number of ``unfiltered''
photons that need to be generated before \srthree will stop the
simulation. The minimum number is actually 0.9 * \vn{num_photons}. See
below for more details. An unfiltered photon is a photon that passes
all filter requirements.  
  \item[\vn{num_photons_per_pass}] \Newline
\vn{num_photons_per_pass} sets the number of photons generated per
``pass''.  A ``pass'' is the act of generating photons throughout the
radiation production region. If \vn{num_photon_per_pass} is negative
(the default), the number of photons generated per pass is taken from
the value of \vn{num_photons}.
  \item[\vn{ds_step_min}] \Newline
This parameter establishes the minimum distance to track the particle beam between emission
points. The thought was that if \srthree decided to make very small steps  between emission
points, this might slow the calculation down. This has not been tested. This parameter
does not influence photon tracking.
  \item[\vn{emit_a}, \vn{emit_b}, \vn{sig_e}] \Newline
These parameters set the particle beam size and so will affect the starting coordinates of
the photons. A negative set of any of these parameters will result in \srthree 
using the value for the parameter from a calculation of the synchrotron radiation integrals.
  \item[\vn{lattice_file}] \Newline
This file defines the machine optics. The lattice file format may be
the Bmad format or, if the \vn{lattice_file} string is prefixed by
\vn{``xsif::''}, may be in xsif format. See the Bmad manual for more details.
  \item[\vn{wall_file}] \Newline
This string gives the name of the vacuum chamber wall definition
file. See \sref{s:wall.file} for more details.
  \item[\vn{dat_file}] \Newline
This string gives the name of the output data file (\sref{ss:main.out}).
See below for more details.
  \item[\vn{surface_roughness_rms}] \Newline
This parameter sets the surface roughness RMS in meters for the
default surface (\sref{s:dflt.reflect}). This is used for diffuse
scattering.  If negative (the default), the value 200~nm will be used.
  \item[\vn{roughness_correlation_len}] \Newline
This parameter sets the surface roughness correlation length in meters
for the default surface (\sref{s:dflt.reflect}).  This is used for
diffuse scattering.  If negative (the default), the value of
5.5~$\mu$m will be used.
  \item[\vn{surface_reflection_file}] \Newline
To change the default reflection probability curves used in the simulation, a 
\vn{surface_reflection_file} can be used. See \sref{s:reflect.file} for details
on the syntax of such a file.
  \item[\vn{sr3d_params\%allow_reflections}] \Newline
This parameter, if set False, will cause \srthree to stop tracking a given photon once
it hits the chamber wall. This can be used to generate data on where the primary photons are striking.
  \item[\vn{sr3d_params\%diffuse_scattering_on}] \Newline
This parameter can be used to test whether diffuse scattering is important. If set to \vn{False},
photons will always be specularly reflected.
  \item[\vn{sr3d_params\%allow_absorption}] \Newline
This parameter, if set False, will cause \srthree suppress absorption
and to always reflect photons when they hit the chamber wall. This
parameter is only used for testing purposes.
  \item[\vn{sr3d_params\%ds_track_step_max}, \vn{sr3d_params\%dr_track_step_max}] \Newline
These parameters determine the maximum distance a photon is tracked in
a given ``step'' see \sref{s:track} for more details.
  \item[\vn{wall_hit_file}] \Newline
This string, if not blank, will create a data file listing the points
where the photons hit the wall including all the reflection
points. This will be in addition to the regular output file.  See
\sref{ss:reflection.file} for more details.
  \item[\vn{lat_ele_file}] \Newline
This string, if not blank, will create a data file listing  the lattice
elements within the emission region. For each element the following are given. 
  \begin{enumerate}
  \item
    The element name
  \item
    The element type (quadrupole, etc.)
  \item
    Longitudinal position at the exit end of the element
  \item
    Element length.
  \item
    $I_0$ radiation integral through the element.
  \item
    The nominal (not actual) number of photons to be generated based upon the $I_0$ integral,
    the total $I_0$ integral, and the setting of \vn{num_photons}
  \item
    The longitudinal step size between photon emission points.
  \end{enumerate}

  \item[\vn{random_seed}] \Newline
Random number seed used in by the random number generator. If set to 0, the system clock
will be used. That is, if set to 0, the output results will vary from run to run. 
  \item[\vn{e_init_filter_min}, \vn{e_init_filter_max}] \Newline
Minimum and maximum initial energy filter values. A negative filter value
indicates that the particular filter is not used. See below.
  \item[\vn{e_filter_min}, \vn{e_filter_max}] \Newline
Minimum and maximum energy filter values. A negative filter value
indicates that the particular filter is not used. See below.
  \item[\vn{s_filter_min}, \vn{s_filter_max}] \Newline
Minimum and maximum longitudinal position filter values of the final
photon position. A negative filter value indicates that the particular
filter is not used. See below.
  \item[\vn{photon_start_output_file}] \Newline
This string, if not blank, will cause \srthree to create an output
file, with a name given by the value of \vn{photon_start_output_file},
of the photon starting positions along with the state of the random
number generator. Note: If \vn{photon_start_input_file} is set,
\vn{photon_start_output_file} will be ignored (no output file is
generated). Also note that the file will have the starting coordinates
of all photons generated, not just the photons that pass any filtering
tests. Thus, if any of the filter parameters are set, the size of the
file may be very large. See below for the syntax of this file.
  \item[\vn{photon_start_input_file}] \Newline
If not blank, the file named by \vn{photon_start_input_file}
will be read by \srthree and used to initialize photon
starting positions. See \sref{ss:photon.start} for the syntax of this file.
The state of the random number generator at the time of a photon's
initialization can also be specified in the file. In this case, the
random number generator state will also be set along with the state of
the photon. This is useful for diagnostic purposes when one wishes to
compare the results of different versions of the \srthree program. The
syntax for this file is the same as the syntax used to generate the
\vn{photon_start_output_file}. See below for the syntax of this file.
  \item[\vn{num_ignore_generated_outside_wall}] \Newline
Photons may be generated outside of the beam chamber for various
reasons. For example, the beam chamber can be too small or the closed
orbit may lie near or outside the chamber. Another possibility is that
the beam emittance is large enough so that, from time-to-time, a
photon generated at large amplitude will be generated outside the
wall. \srthree will ignore photons generated outside the wall, and
generate another one at the same longitudinal position, up to the
number set by \vn{num_ignore_generated_outside_wall}. If the number of
photons generated outside the wall exceeds this number, \srthree will
print an error message and stop.
  \item[\vn{turn_off_kickers_in_lattice}] \Newline
If \vn{turn_off_kickers_in_lattice} is set to True (the default is
False), then all kicks from steering elements in the lattice will be zeroed.

\end{description}

The six "filter" parameters are:
\begin{example}
  e_init_filter_min   ! min initial energy filter.
  e_init_filter_max   ! max initial energy filter.
  e_filter_min        ! min energy filter.
  e_filter_max        ! max energy filter.
  s_filter_min        ! min longitudinal position filter.
  s_filter_max        ! max longitudinal position filter.
\end{example}
A filter parameter is "unset" if its value is negative and is "set"
otherwise.  \srthree can run in "filtered" or "unfiltered"
mode. Unfiltered mode occurs when none of the filter parameters have
have been set. In this mode, all photons generated are recorded in
the output file.

In filtered mode, with at least one of the filter parameters set,
photons that do not satisfy the set filter values are discarded. The
\vn{e_init_filter_min} and \vn{e_init_filter_max} parameters are 
compared against the initial photon energy, and the other four
filter parameters are compared against the final photon position and
energy. The s-filter can wrap around $s = 0$: That is,
if both \vn{s_filter_min} and \vn{s_filter_max} have been set,
and \vn{s_filter_min} is {\em greater} than \vn{s_filter_max}, the region
for keeping a photon is from \vn{s_filter_min} through the end of the
lattice along with the region from the start of the lattice to
\vn{s_filter_max}.

\srthree will generate a set of approximately
\vn{num_photons_per_pass} photons in the radiation production region.
This is called a ``pass''.  After any filtering, \srthree will check
to see if the number of unfiltered photons is at least 0.9 *
\vn{num_photons}. If so, photon generation will stop. If not enough
photons have been generated, \srthree will generate another
\vn{num_photons_per_pass}, and so on, until at least 0.9 *
\vn{num_photons} unfiltered photons have been generated.

%------------------------------------------------------------------
\section{Vacuum Chamber Definition File} 
\label{s:wall.file}

The vacuum chamber is defined in the \vn{wall_file}. The name of the \vn{wall_file} is
specified in the master input file \sref{s:master}. The syntax for specifying the vacuum
chamber follows Fortran namelist input as explained in \sref{s:namelist}.

%------------------------------------------------------------------
\subsection{Sub-Chambers and Cross-Sections}
\label{s:sub.chambers}

\begin{figure}[tb]
\begin{center}
\includegraphics[width=6in]{vac-pipe.pdf} \caption[The vacuum chamber is the union of a
number of sub-chambers.]{The vacuum chamber is the union of a number of sub-chambers.
This figure illustrates this showing two sub-chambers -- one colored green and the other
collored red. A photon is considered within the vacuum chamber if, and only if, it is
inside at least one of the sub-chambers.}
\label{f:vac-chamber}
\end{center}
\end{figure}

The shape of the vacuum chamber is described by a number of ``sub-chambers'' (the reason
for this will be made clear below). This is illustrated in \fig{f:vac-chamber}. The entire
vacuum chamber is the union of all the sub-chambers. That is, a photon is considered
within the vacuum chamber if, and only if, it is inside at least one of the
sub-chambers. It is perfectly fine for sub-chambers to overlap one another. In fact,
some overlap is desirable to prevent abutting sub-chambers from appearing to be separated
due to round-off errors in the calculation.

\begin{figure}[tb]
\begin{center}
\includegraphics[width=6in]{chamber-wall.pdf}
\caption{A sub-chamber is defined by a number of cross-sectional slices.}
\label{f:chamber.wall}
\end{center}
\end{figure}

Each sub-chamber is defined by specifying the chamber cross-section at
a number of longitudinal positions. As illustrated in
\fig{f:chamber.wall}. Each cross-section is specified using a namelist
named \vn{place}. The general form of a \vn{place} namelist is:
\begin{example}
  &place 
    section = <s>, "<section_name>", "<section_id>" 
    surface = "<surface_name>", <is_local?>
  /
\end{example} 
The optional \vn{surface} variable is explained in \sref{ss:surface}.
Example:
\begin{example}
  &place section =   0.0, "arc_std", "beam:dipole_shape" /
  &place section =  74.3, "Near_IR"  "left_ante:chamA@START" /
  &place section =  82.9, "wig1",    "left_ante:chamB@END"
  &place section =  91.1, "IR1",     "rectang" /
\end{example}

The \vn{<s>} values for the cross-sections of a given sub-chamber must
be in increasing order and there must be one sub-chamber that has a
cross-section at \vn{<s>} = 0. If the last cross-section of a given
sub-chamber has \vn{<s>} greater than the end of the lattice, the
\vn{<s>} value will be reduced to the value at the end of the lattice.

The \vn{<section_name>} is a descriptive name that can be, for example,
used in plotting. The \vn{<section_name>} is ignored for any calculation.
The \vn{<section_name>} may be blank.

The \vn{<section_id>} identifies the section. The general format for 
\vn{<section_id>} is:
\begin{example}
  <sub_chamber_id>:<shape_id>@<stop-pt?>
\end{example}
For example, if a section is placed like:
\begin{example}
  &place section =  74.3, "Near_IR"  "left_ante:chamA@START" /
\end{example}
the \vn{<sub_chamber_id>} component is \vn{"left_ante"}, the
\vn{<shape_id>} component is \vn{"chamA"}, and the \vn{<stop-pt?>}
component is \vn{"START"}. The \vn{<shape_id>} must always be present
but \vn{<sub_chamber_id>} and \vn{<stop-pt?>} may be omitted. If
\vn{<sub_chamber_id>} is omitted, the colon after the
\vn{<sub_chamber_id>} may be omitted too. If \vn{<stop-pt?>} is
omitted, the ampersand before the \vn{<stop-pt?>} may be omitted too.

The \vn{<sub_chamber_id>} component specifies which sub-chamber is
being specified.  If \vn{<sub_chamber_id>} is omitted, the sub-chamber
name is blank. For example, \vn{":chamC@"}, which is equivalent to
\vn{"chamC"}, is associated with the sub-chamber whose name is
blank. Omitting the \vn{<sub_chamber_id>} can always be done if there
is only one sub-chamber.

The \vn{<stop-pt?>} component specifies if a sub-chamber is beginning
or ending at a certain longitudinal position. If present,
\vn{<stop-pt?>} must be:
\begin{example}
  "START" or
  "END"
A sub-chamber begins with the section with \vn{<stop-pt?>} set to \vn{"START"}
and ends with the section with \vn{<stop-pt?>} set to \vn{"END"}. Example:
\begin{example}
  &place section =    5, "", "left_ante:chamB@END"
  &place section =  174, ""  "left_ante:chamA@START" /
  &place section =  182, "", "left_ante:chamB@END"
  &place section =  936, ""  "left_ante:chamA@START" /
\end{example}
In this case there are actually two sub-chambers, both named
\vn{"left_ante"}.  The one sub-chamber begins at $s = 174$~meters and
ends at 182~meters.  The second sub-chamber begins at $s =
936$~meters, wraps around the end of the lattice back to the
beginning, and ends at 245~meters. This is the only case where
different sub-chambers can share the same name. Sub-chambers that
overlap longitudinally may not share the same name. That is, for every
\vn{"START"} there must be an \vn{"END"} and following is not allowed
since there is overlap:
  &place section =  173, ""  "left_ante:chamA@START" /
  &place section =  174, ""  "left_ante:chamA@START" /
  &place section =  182, "", "left_ante:chamB@END"
  &place section =  183, "", "left_ante:chamB@END"
\end{example}
A sub-chamber does not have to have a beginning and an ending. In this
case, the sub-chamber extends along the entire length of the machine.

The \vn{<shape_name>} component of \vn{<section_id>} identifies the
exact shape of the cross-section. The \vn{<shape_name>} is matched
with a \vn{shape_def} namelist of the same name. The \vn{shape_def}
namelist has the format:
\begin{example}
  &shape_def
    name = <shape_name>           ! Name of this shape.
    r0 = <x_center>, <y_center>   ! Center of section.
    absolute_vertices = <T/F>     ! Vertex nums relative to r0 or abs? Default = F.
    v(1) = <x1> <y1> <radius_x1> <radius_y1> <tilt1>
    v(2) = <x2> <y2> <radius_x2> <radius_y2> <tilt2>
    v(3) = <x3> <y3> <radius_x3> <radius_y3> <tilt3>
    ... etc ...
  /
\end{example}
Example:
\begin{example}
  ! Anything outside the namelists is ignored.
  &place section =  65.7, "Near_IR" "rectangular1" /
  &place section =  74.3, "Arc"     "dipole_shape" /
  &place section = 100.3, "Arc"     "dipole_shape" /

  &shape_def
    name = "rectangular1"
    v(1) =  0.045,  0.025
  /
  &shape_def
    name = "dipole_shape"
    v(1) =  0.045,  0.025, 0.3, 0.9
    v(2) = -0.045,  0.025
    v(3) = -0.045,  0.025, 0.3, 0.9
    v(4) = -0.045,  0.025
  /
\end{example}
There are three \vn{place} namelists in this example.  The first
\vn{place} namelist refers to the first \vn{shape_def} namelist whose
name is \vn{"rectangular1"}. The other two \vn{place} namelists
refer to the second \vn{shape_def} namelist named \vn{"dipole_shape"}.
As seen in this example, multiple \vn{place}s may refer to the
same \vn{shape_def}.

For a \vn{shape_def} namelist, the \vn{name} labels the shape for use
by a \vn{place} namelist.  A \vn{shape_def} is specified by a
``central point'' $r_0$ and a list of connected vertices. Each vertex
is specified by it's $(x, y)$ coordinates that are with respect to
$r_0$ except if \vn{absolute_vertices} is set to \vn{True} in which
case the vertex numbers are absolute. The vertices must ``wind''
counter-clockwise around the central point. That is, if $(x, y)$
coordinates of the vertices are expressed in terms of polar $(r,
\theta)$ coordinates with respect to the central point, the vertices
must be in order of increasing $\theta$. If all the vertex points have
non-negative $y$ values, it is assumed that the gen_shape is symmetric
with respect to the $x$-axis and that only half the vertex points are
being specified. If all the vertex points have both non-negative $x$
and $y$ values, it is assumed that the gen_shape is symmetric with
respect to both the $x$ and $y$ axes.

Between vertices, the wall is assumed to be a straight line except if
a \vn{<radius_x>} is given. If \vn{<radius_x>} is set to a non-zero
value for a given vertex, the wall segment between that vertex and the
vertex before it is the arc of a circle with the given radius. If, in
addition, \vn{<radius_y>} is given, the arc will be a section of an
ellipse.  If, in addition to \vn{<radius_x>} and \vn{<radius_y>},
\vn{<tilt>} is given, then the ellipse will be tilted.

If \vn{<radius_x>} is positive, the arc of the wall is convex. If it
is negative, the arc is concave. Note that when the wall cross-section
is concave, there can be problems with the photon tracking. See
\sref{s:track} for more details.

In the example above, the cross-section at $s = 65.7$~meters is a
\vn{gen_shape} whose definition is given by the \vn{shape_def}
with name ``\vn{rectangular1}''.  This \vn{shape_def} defines a rectangle
with half width 0.045~meters and half height 0.025~meters.

In the above example, ``the \vn{dipole_shape}'' shape is similar to
the \vn{rectangular1} shape except the right and left sides are
sections of an ellipse.

%------------------------------------------------------------------
\subsection{Multi-Section Cross-Section}
\label{ss:multi.sec}

The \vn{multi-section} cross-section is not actually a single
cross-section but a repeating pattern of cross-sections. The basic
repeat pattern is specified by a \vn{multi_place} namelist of
the form
\begin{example}
  &multi_place
    name = "<multi_name>"
    section(1) = 0.0,  "<section0_name>", "<section0_id>", ...
    section(2) = <s1>, "<section1_name>", "<section1_id>", ...
    section(3) = <s2>, "<section2_name>", "<section2_id>", ...
    ...
  /
\end{example}
The syntax for any of the \vn{section(n)} sections is the same as
described above for \vn{rectangular}, \vn{elliptical}, and \vn{gen_shape}.
shapes. The first section, \vn{section(1)}, must
have \vn{<s0>} set to 0 and the \vn{<s>} of the other cross-sections
represent an offset from this 0\Th section. The last
\vn{section(N)} section must have \vn{<sectionN_name>} set to one of
\begin{example}
  open
  closed
\end{example}
and the last \vn{section(N)} must have \vn{<sectionN_id>} set to
\begin{example}
  end_marker
\end{example}
This last ``\vn{end_marker}'' section is not a real cross-section but
simply serves as a marker for the end of the basic repeat pattern. The
significance of the \vn{<sectionN_name>} of the \vn{end_marker} section is
discussed below. Example:
\begin{example}
  &multi_place
    name = "zig_zag"
    section(1) = 0.000, "in_zig",  "ellipse1",
    section(2) = 0.002, "out_zag", "ellipse2",
    section(3) = 0.003, "open",  "end_marker"
  /
\end{example}
Here the basic repeat pattern is 0.003 meters long and is made up of
two cross-sections called \vn{in_zig} and \vn{out_zag}.

To position a series of cross-sections, a \vn{place} namelist is used
general syntax for this is:
\begin{example}
  &place 
    section = <s>, "<section_name>", "<section_id>", <repeat_count> 
    surface = "<surface_name>", <is_local?>
  /
\end{example} 
The optional \vn{surface} variable is explained in \sref{ss:surface}.

\vn{<s>} is the longitudinal starting position of the series of
cross-sections, \vn{<section_name>} is not used but must be present to
keep the format the same as other \vn{place}s. The cross-sections in the
\vn{multi_place} namelist will be repeated \vn{<repeat_count>}
times when the sub-chamber wall is constructed. Example:
\begin{example}
  &place section = 10.0, "", "zig_zag", 1000 /
\end{example}
With this \vn{place}, coupled with the \vn{multi_place}
example above, an \vn{in_zig} cross-section will be placed at $s =
10$~meters at the starting point. The basic pattern will repeat 1000
times and the series of cross-sections will be:
\begin{example}
     S       Name
  10.000     in_zig
  10.002     out_zag
  10.003     in_zig
  10.005     out_zag
  ...
  12.997     in_zig
  12.999     out_zag
\end{example}
Since the \vn{end_marker} section is ``open'', the basic pattern is
repeated exactly 1000 times and there will be 2 * 1000
cross-sections. If the \vn{end_marker} section is ``closed'', an extra
\vn{section(1)} cross-section would be added at the end to make the
ending cross-section the same as the beginning cross-section. In this
case, if the \vn{end_marker} section is set to ``closed'', a
\vn{in_zig} cross-section would be added at $s = 13.000$~meters.

  \begin{figure}
  \centering
  \includegraphics[width=6in]{fast-chamber.pdf}
  \caption[Illustrating a fast sub-chamber residing within another sub-chamber.]
{\label{f:fast} A fast sub-chamber (gree) with few cross-sections resides within another
sub-chamber with many cross-sections (blue) enabling \srthree to speed up tracking. The
two sub-chambers have been cut in the illustration to better show the geometry.}
  \end{figure}

%------------------------------------------------------------------
\subsection{Fast Sub-Chamber}
\label{s:fast}

In regions where there are many of cross-sections, which can easily happen when a
multi-section (\sref{ss:multi.sec}) is used, the computation time for photon tracking may
become large due to the necessity of stopping the photon at each cross-section to check
whether the photon has crossed the sub-chamber boundary. This can be ameliorated by
defining a ``fast'' sub-chamber to track through. This fast sub-chamber has only a few
cross-sections and is nested inside the sub-chamber with the large number of
cross-sections. This is illustrated in \fig{f:fast}.
\srthree will use the fast sub-chamber for tracking when ever possible
(\sref{s:track}). 

To designate a fast sub-chamber, prepend the string ``\vn{FAST_}'' to the name of the
sub-chamber with the large number of cross-sections.  For example, for a sub-chamber named
\vn{"main"}, the name of the fast sub-chamber would be \vn{"FAST_main"}. Only one fast
sub-chamber may be associated with a given sub-chamber.

A fast sub-chamber may extend beyond the sub-chamber it is associated with. The entire
vacuum chamber is the union of all sub-chambers including the fast ones. That is, in terms
of defining the vacuum chamber, fast sub-chambers are no different than non-fast ones.

%------------------------------------------------------------------
\subsection{Sub-Chamber Wall Interpolation} 
\label{s:wall}

Once a set of sub-chamber cross-sections have been defined, the
cross-section of the sub-chamber at a given longitudinal position is
computed using linear interpolation. 

For a given sub-chamber, and 
at a given $s$ position, the $r, \theta$ coordinate system in the
transverse $x, y$ plane is defined with respect to an origin
$\bfr_O(s)$ given by a linear interpolation of the origins of the
cross-sections to either side of the given $s$ position. Let $s_1$
denote the position of the cross-section just before $s$ and $s_2$
denote the position of the cross-section just after $s$. Let
$\bfr_{01}$ be the $(x_0, y_0)$ origin defined for the cross section
at $s_1$ and $\bfr_{02}$ be the $(x_0, y_0)$ origin defined for the
cross section at $s_2$. Then
\Begineq
  \bfr_O(s) = (1 - \stilde) \, \bfr_{01} + \stilde \, \bfr_{02}
\Endeq
where 
\Begineq
  \stilde \equiv \frac{s - s_1}{s_2 - s_1}
\Endeq

Let $r_{c1}(\theta)$ and $r_{c2}(\theta)$ be the radiusus of the
sub-section boundary as a function of $\theta$ for the cross-sections
at $s = s_1$ and $s = s_2$ respectively. The sub-section boundary
$r_c(\theta, s)$ at any point $s$ between $s_1$ and $s_2$ is then
defined by the equation
\Begineq
  r_c(\theta, s) = (1 - \stilde) \, r_{c1}(\theta) + \stilde \, r_{c2}(\theta)
\Endeq

A photon at $(r,\theta, s)$ is inside the sub-chamber if
\Begineq
  r < r_w(\theta, s)
\Endeq

%------------------------------------------------------------------
\subsection{Sub-Chamber Wall and Patch Elements}
\label{ss:patch}

A \vn{patch} element, which shifts the reference coordinate system
complicates the calculation of where a photon hits the wall. The Bmad
manual has a full explanation but the essential factor is that, since
the reference orbit is discontinuous in a patch, to avoid a
discontinuity in the sub-chamber wall, wall interpolation is done using
the global reference system. This can lead to non-intuitive behavior
when the region between two wall sections contains both a bend and a
patch since, without the patch, the center of the sub-chamber follows the
curved reference orbit but with the patch the sub-chamber wall center
follows a straight line between the wall sections.

To avoid this non-intuitive behavior, if a region between wall sections
contains both a patch and a bend, extra sections will be added to
eliminate this situation.

To simplify matters, \srthree does not allow wall cross-sections to be
defined whose longitudinal position overlaps any \vn{patch} element.

%------------------------------------------------------------------
\subsection{Old Wall Format}
\label{s:old.wall}

Originally, \srthree did not have the concept of sub-chambers. That is,
there was only one chamber and that chamber was allowed to be concave.
This was problematical, as discussed above, and motivated the
development of the sub-chamber concept. This section discusses the old
format to facillitate conversion from the old format to the new.

\begin{example}
  &section_def section =   0.0, "arc_std", "elliptical", 0.045, 0.025 /
  &section_def section =  74.3, "Near_IR"  "gen_shape:dipole_shape",  /
  &section_def section =  82.9, "wig1",    "rectangular", 0.045, 0.025 /
  &section_def section =  91.1, "IR1",     "rectangular", 0.045, 0.025, 
                                                       -1, -1, 0.08, 0.01 /
\end{example}


The \vn{<section_id>} can have one of five values:
\begin{example}
  elliptical                   
  rectangular                  
  gen_shape:<shape_name>       
  multi_section:<shape_name>   
\end{example}
Historically, the \vn{elliptical} and \vn{rectangular} shapes where
developed first. The \vn{gen_shape} was developed later and is a
generalization of the original two shapes. The \vn{elliptical} and
\vn{rectangular} cross-sections are explained in the next
section. \vn{Gen_shape} is explained in the
section after and \vn{multi_section} is explained in the section
after that.


\begin{figure}[tb]
\begin{center}
\includegraphics[width=6in]{chamber.pdf}
\caption{Example vacuum chamber cross-section for an \vn{elliptical} 
chamber with an antechamber on the $+x$ side of the chamber and an
aperture on the $-x$ side.}
\label{f:chamber}
\end{center}
\end{figure}

An example \vn{elliptical} cross-section is shown in
\fig{f:chamber}. The format for an \vn{elliptical} or \vn{rectangular}
cross-section is
\begin{example}
  &section_def 
    section = <s>, <section_name> <section_id>, <width2>, <height2>, <width2_plus>, 
              <ante_height2_plus>, <width2_minus>, <ante_height2_minus> /
    surface = "<surface_name>", <is_local?>
\end{example}
The first five parameters -- \vn{<s>}, \vn{<section_name>}
\vn{<section_id>}, \vn{<width2>}, and \vn{<height2>} -- must be
specified. Values for the other parameters are optional and default to
the ``unset'' value of -1.

The optional \vn{surface} variable is explained in \sref{ss:surface}.

For \vn{elliptical} or \vn{rectangular} shapes, the
parameters needed to specify the chamber are:
\begin{example}
  <s>                   ! Longitudinal position
  <section_name>        ! Descriptive Name of the cross-section.
  <section_id>          ! Either "elliptical" or "rectangular"
  <width2>              ! Half width ignoring antechamber.
  <height2>             ! Half height ignoring antechamber.
  <width2_plus>         ! Distance from pipe center to +x side edge.
  <ante_height2_plus>   ! Antechamber half height on +x side of the wall
  <width2_minus>        ! Distance from pipe center -x side edge.
  <ante_height2_minus>  ! Antechamber half height on -x side of the wall
\end{example}

For both \vn{"rectangular"} and \vn{"elliptical"} shapes, \vn{<width2>}
and \vn{<height2>} define the half-height and half-width of the shape.

Antechambers on the $+x$ side and/or $-x$ side of the chamber can be
added to the basic shape. On the $+x$ side, an antechamber is formed
if the \vn{<ante_height2_plus>} parameter is set to a positive value. If
\vn{<ante_height2_plus>} is set to a positive value, as shown in
\fig{f:chamber}, the parameter \vn{<width2_plus>} specifies the
horizontal distance from the chamber center to the far end of the $+x$
side antechamber. In this case, the value of \vn{<width2_plus>} must be
large enough so that the antechamber far wall does not stick back into
the basic shape. For a rectangular shape, this translates to
\vn{<width2_plus>} being larger than \vn{<width2>}. Similarly, if
\vn{<ante_height2_minus>} is set to a positive value, an antechamber is
formed on the $-x$ side.  In this case, \vn{<width2_minus>} is the
(positive) horizontal distance from the chamber center to the far end
of the $-x$ antechamber.

If \vn{<ante_height2_plus>} is not set, a set of \vn{<width2_plus>}
defines an aperture on the $+x$ side of the chamber. In this case, the
value of \vn{<width2_plus>} must be less than the value of
\vn{<width2>}. Similarly, if \vn{<ante_height2_minus>} is not set, a set of
\vn{<width2_minus>} defines an aperture on the $-x$ side of the chamber.
A $-x$ aperture is shown in \fig{f:chamber}.

Example:
\begin{example}
  ! Anything outside the namelists is ignored.
  &section_def section =   0.0, "arc_std", "elliptical", 0.045, 0.025 /
  &section_def section =  82.9, "wig1",    "rectangular", 0.045, 0.025 /
  &section_def section =  91.1, "IR1",     "rectangular", 0.045, 0.025, 
                                                         -1, -1, 0.08, 0.01 /
\end{example}


Prescription for converting:
\begin{enumerate}
\item If there are \vn{\&section_def} namelists that use rectangular or elliptical shapes. 
      That is, no "gen_shape:..." is present then the appropriate \vn{\&shape_def} namelists will have to be created. 
      If the shape is not convex, the shape will need to be split into sub-chambers.
\item rename: "gen_shape:..." to "..." in \vn{\&section_def} namelists. 
      If the shape is not convex, the shape will need to be split into sub-chambers.
\item If present, remove ``ix_vertex_ante'' and ``ix_vertex_ante2'' lines from \vn{\&gen_shape_def} .
\item rename: ``\vn{\&section_def}'' to ``\vn{\&place}''.
\item rename: ``\vn{\&gen_shape_def}'' to ``\vn{\&shape_def}''.
\item If a \vn{shape_def} has a name that has a colon ``:'', replace this by some other character.
\end{enumerate}

%------------------------------------------------------------------
\subsection{Chamber Surface Reflectivity}
\label{ss:surface}

By default, the photon reflectivity of the vacuum chamber wall is
based on the reflectivity of a 10 nm C film on an Al substrate.
This default can be changed by setting the following parameters
in the master input file (\sref{s:master}):
\begin{example}
    surface_reflection_file
    surface_roughness_rms
    roughness_correlation_len 
\end{example}

If the chamber wall is made up of sections of differing material,
additional surface types can be defined using \vn{surface_def}
namelists in the chamber wall file. The syntax for this namelist is
\begin{example}
  &surface_def
    name = "<surface_name>"
    reflectivity_file = "<file_name>"
  / 
\end{example}
\vn{name} is an identification name and \vn{reflectivity_file} is a file
that specifies the surface reflectivity (\sref{s:reflect.file}).

To associate a particular material with a particular region of the
chamber wall, the optional \vn{surface} variable is set for the
\vn{place} namelist (\sref{s:sub.chambers}), at the downstream
(maximal $s$) end of the region of interest. The syntax is:
\begin{example}
  &place
    section = ...
    surface  = "<surface_name>", <is_local?>
  /
\end{example}
The \vn{<surface_name>} must match the \vn{<surface_name>} of a
\vn{surface_def} namelist. The one exception is if \vn{<surface_name>}
is set to
\begin{example}
  ABSORBER
\end{example}
In this case the surface is a perfect absorber.

If \vn{<is_local?>} is \vn{True}, then the
surface material only spans the region from the previous cross-section
to this one. If \vn{<is_local?>} is \vn{False} or not present, the
surface material spans from the closest previous cross-section where
there is a \vn{surface} variable set to this cross-section.  If a
\vn{place} is a \vn{multi_section} cross-section
(\sref{ss:multi.sec}), and \vn{<is_local?>} is \vn{True} then the
material only spans the multi_section region.

Example:
\begin{example}
  &place section = 0.0, "elliptical", ... /
  &place section = 1.0, "elliptical", ... /
  &place 
    section = 3.0, "elliptical", ... /
    surface = "ss", True
  /
  &place
    section = 5.0, "multi_section:ms", ...
    section = "ni", True
  /
  &place
    section = 7.0 "elliptical", ...
    surface = "cu"
  /
  &place 10.0 section = ... /

  &surface_def
    name = "ss"
    reflectivity_file = "ss_burnished.reflect"
  /
\end{example}
Assuming the multi_section spans the region from 5~meters to 6~meters,
the materials associated with different regions of the chamber are:
\begin{example}
 S_begin    Surface    S_end
 -------    -------    -----
   0.0         cu       1.0
   1.0         ss       3.0
   3.0         cu       5.0
   5.0         ni       6.0
   6.0         cu       7.0
   7.0       default   10.0
\end{example}

%------------------------------------------------------------------
\subsection{Photon Tracking}
\label{s:track}

\begin{figure}[tb]
\begin{center}
\includegraphics[width=6in]{chamber-problem.pdf}
\caption{A) A convex cross-section can lead to problems with linear interpolation.
since it is assumed that if the beginning and ending points are inside the chamber 
the entire track is inside the chamber. The track shown violates this assumption.
B) With linear interpolation, convex cross-sections are not a guarantee that 
intermediate cross-sections are convex. B1 and B3 are the defined cross sections 
at $s = 0$ and $s = 1$ respectively. These cross sections are ellipses with 5:1 
aspect ratio. The interpolated cross-section B2 at $s = 0.5$ is seen to be concave.}
\label{f:convex-chamber}
\end{center}
\end{figure}

When a photon is created, \srthree checks to see if the photon is
within any sub-chambers. If the photon is not within any sub-chamber,
that is, if it is outside the vacuum chamber wall, \srthree will
generate an error message if the number of photons that have been
generated up to this point exceed
\vn{num_ignore_generated_outside_wall}. If the created photon is
within some sub-chamber, the photon will be tracked through that
sub-chamber until it reaches the edge of the sub-chamber. 

When the photon reaches the edge of the sub-chamber it is going
through, \srthree checks if there is a suitable alternative
sub-chamber to switch to. A suitable sub-chamber is any sub-chamber
the the photon is within or a sub-chamber where the photon is at the
edge and has velocity directed inward.

If there is a suitable alternative, \srthree will ``transfer'' the
photon to the alternative sub-chamber and keep tracking. If there is
no suitable alternative then the photon has hit the wall.

The exception to the above process happens when there is a suitable
``fast'' chamber (\sref{s:fast}). In this case, the photon may be
switched from a sub-chamber to the associated fast sub-chamber even
before the photon has reached the edge of the non-fast sub-chamber.

Photons are tracked in ``steps''. A step consists of propagating a
photon from it's current position to some new position that is a
certain distance away. The length to propagate the photon in a given
step is determined by a number of factors. Maximum lengths are set by
the input parameters 
\begin{example}
  sr3d_params%ds_track_step_max
  sr3d_params%dr_track_step_max
\end{example}
These set longitudinal (\vn{%ds_track_step_max}) and transverse
(\vn{%dr_track_step_max}) distances. Additionally, a single step will
always be terminated at, and never cross over, a defined cross-section
plane. steps will also be terminated at the boundaries of bend magnets
and at the point in a bend where a trajectory is closest to the center
of the bending radius.

After a step, the new photon position is checked to see if it is still
inside the sub-chamber. If it is not, the point where it has crossed
the sub-chamber wall is calculated via a root finding algorithm.

If the new photon position is inside the sub-chamber, there is still the
question as to whether the photon trajectory between the beginning
step point and the end step point is inside the sub-chamber. \srthree
assumes that the sub-chamber is ``locally convex''. That is, given the two
end points of a step with points inside the sub-chamber, it is assumed
that the line drawn between these two points never touches or goes
outside the sub-chamber. This locally convex assumption will be true if
every cross-section $r_w(\theta, s)$ for fixed $s$ is convex where $s$
is in the range of longitudinal $s$ positions covered by the step in
question.

The problem of a concave cross-section is shown in
Fig.~\ref{f:convex-chamber}A. Furthermore, even if two cross-sections are
themselves convex, an intermediate cross-section can be concave as
shown in Fig.~\ref{f:convex-chamber}B. How much of a problem the
possibility that \srthree will not detect some photons leaving and
then entering the chamber will, of course, depend upon the chamber
geometry and what is being calculated. One way to treat this is to
reduce the track step length limits:
\begin{example}
    sr3d_params%ds_track_step_max
    sr3d_params%dr_track_step_max
\end{example}
This will reduce the possibility of mis-tracking at the cost of
increased computation time.  If the results do not change significantly
when the track limits are reduced, this is good evidence that the 
results are valid.

%------------------------------------------------------------------
\subsection{photon\_start\_input\_file}
\label{ss:photon.start}

The \vn{photon_start_input_file} file is used to specify starting positions
for the photons. This is done typically for debugging purposes.

The \vn{photon_start_input_file} file contains a number of
\vn{\&start} namelists. One for each photon starting position. The
format for a \vn{\&start} namelist is:
\begin{example}
  &start
    orbit%vec = <x>, <vx/c>, <y>, <vy/c>, <s>, <vz/c>  ! Photon position
    orbit%p0c = <ev>                                ! Photon energy
    ran_state = <random_state_struct>
    random_seed = <num>
  /
\end{example}
The \vn{<s>} component of \vn{orbit%vec} is the longitudinal distance
from the start of the lattice.  If needed, The \vn{ran_state} and
\vn{random_see} parameters can be used to initialize the random number
generator.

The magnitude of the velocity, $\sqrt{v_x^2+v_y^2+v_z^2}/c$ must be 1.

%------------------------------------------------------------------
\subsection{Surface Reflection File}
\label{s:reflect.file}

A surface reflectivity file is used to redefine the default chamber
wall surface reflectivity (By setting \vn{surface_reflection_file}
in the master input file (\sref{s:master})) or to define the
surface reflectivity for a particular wall material (\sref{ss:surface}).

The probability for a photon reflecting from a wall is dependent upon
the grazing angle and the photon energy. For a given graze angle and
photon energy, there are two reflection probabilities called
\vn{p_reflect} and \vn{rel_p_specular} These determine the
probabilities that the photon will be reflected either diffusely or
specularly, or that the photon will be absorbed. In particular
\begin{example}
  probability of absorption          = 1 - p_reflect
  probability of reflection          = p_reflect
  probability of specular reflection = p_reflect * rel_p_specular
  probability of diffuse reflection  = p_reflect * (1 - rel_p_specular)
\end{example}
Generally, \vn{p_reflect} will be near unity at small
grazing angles and fall off with increasing angle. At the smaller
photon energies ($E \lesssim 100 \, \mbox{eV}$), the reflection
probabilities will still be substantial at grazing angles of
10~degrees or more. At the larger photon energies ($E \gtrsim 1000 \,
\mbox{eV}$), The reflection probabilities are quite peaked and are
small above a few degrees.

\vn{rel_p_specular} is given by Equations (1) and (2) in Reference
\cite{b:synrad3d} and so \vn{rel_p_specular} is not specified in a
reflection file.

In the reflection probability file, the reflection probability \vn{p_reflect} is
specified at a number of different angles and energies. \srthree will
interpolate as needed. Reflections probabilities are specified over
some energy range from $E_{min}$ to $E_{max}$. If a photon has an
energy below $E_{min}$, reflection probability is taken to be the same
as the probability at $E_{min}$. If a photon has an energy $E_p$ that
is above $E_{max}$, it is assumed that the reflection probability is
the same as the reflection probability at energy $E_{max}$ and angle
$\theta_g(\mbox{eff}) = \theta_g * E_p / E_{max}$ where $\theta_g$ is the
photon grazing angle. If $\theta_g(\mbox{eff})$ is grater than 90~degrees,
90~degrees is used for $\theta_g(\mbox{eff})$.

For specifying the reflection probabilities, the energy range from
$E_{min}$ to $E_{max}$ is broken up into a number of ``tables'' each
covering some energy interval. The tables are ordered in increasing
energy so that table 1 starts from $E_{min}$ and the last table goes
up to $E_{max}$. The energy intervals for the tables abut one another
so that the upper energy of one table is the lower energy of the next.
Each table specifies the reflection probabilities at a number of
energies $E_i, i = 1, \ldots, N_E$ and a number of grazing angles
$\theta_j, j = 1, \ldots, N_\theta$. The energies $E_i$ must be
equally spaced and in ascending order but the grazing angles
$\theta_j$ do not only have to be in ascending order with $\theta_1 =
0$ and $\theta_{N_\theta} = 90$. Except for the restriction that the
energy intervals of the tables abut one another, the tables are
independent in the sense that, for example, the spacing between the
$E_i$, the particular $\theta_j$ chosen, etc. can vary from table to
table. The reason for having multiple tables is for compactness. That
is, the particular choice of the spacing between the $E_i$ and the
particular $theta_j$ chosen can be optimized for each energy interval
to give the maximum accuracy with the least amount of input data.

The probability file must start with a namelist named \vn{general}
that specifies the number of tables and roughness numbers. Example:
\begin{example}
  &general
    n_table = 5    ! 5 tables
    surface_roughness_rms      = 200e-9   ! meters
    roughness_correlation_len  = 5.5e-6   ! meters
  /
\end{example}

Next, each table is specified in turn starting from the table for the
lowest energy interval. A table is specified starting with a
\vn{table} namelist. Example:
\begin{example}
  &table
    energy_min    =  600 ! eV
    energy_max    = 1400 ! eV
    energy_delta  =   20 ! eV
    angles =  0.0, 0.4, 0.8, 1.0, 1.5, 2.0, 3.0, 4.0, 90.0
  /
\end{example}
In this example, the energy range is from 600 eV to 1400 eV in steps
of 20 eV and the reflection probability is specified at 9 different
grazing angles. For each energy ``row'', \vn{p_reflect} is
specified by a \vn{row} namelist. Example:
\begin{example}
  &row
    ix_row = 2   ! 620 eV
    p_reflect =  1.00, 0.941, 0.882, 0.852, 0.771, 0.669, 0.514, 0.056, 0.0
  /
\end{example}
There must one \vn{row} namelist for each energy value in the
table. For this example there would be 41 \vn{row} namelists. The
\vn{row} namelists must be in order of increasing energy and each
\vn{row} namelist has a \vn{ix_row} component which must be set to
\vn{1} for the first \vn{row} namelist, \vn{2} for the second,
etc. \srthree uses \vn{ix_row} as a sanity check when reading in
the table. The \vn{p_reflect} component of the
\vn{row} namelist give the reflection probabilities at the $N_\theta$
angle points.

%------------------------------------------------------------------
\section{Output Files} 

%------------------------------------------------------------------
\subsection{Main Output File}
\label{ss:main.out}

The format of the \vn{dat_file} (whose name is specified in the master
input file (\sref{s:master})) is as follows:

The first line in the file gives the \vn{photon_number_factor}.
If $N_{\gamma}$ is the total number of photons per beam particle
emitted in one revolution, then the \vn{photon_number_factor} $F$ in a simulation
run containing $N_{sim}$ photons is defined as $F = N_{\gamma}/N_{sim}.$
Thus, if a simulation run is done using $N_{sim}$ photons, and $N_L$
is the number of photon absorption sites in a longitudinal region of
length $L$, then the average number of photons per beam particle per
unit length absorbed in this region is $(N_L/L)\times F.$ This number
is needed as input for electron cloud simulation programs.


The next 20 lines of data file echo the information provided in the
file \vn{synrad3d.init}.

After the first 21 lines of header information, \vn{dat_file} contains
six lines for each photon generated. An example of the output
generated for two photons is shown below.
\begin{example}
       1       2     71.52  ! index, n_wall_hits, eV
    0.000542    0.000037   -0.000073    0.000080       9.015    1.000000  ! Start position
    0.015165    0.004010    0.023538    0.017410      18.661    0.999840  ! End position
    7.906054  ! photon_track_len
    0.001911  ! photon_track_len - ds_beam
      37   DRIFT             ! Lat ele index and class
       2       1     11.25  ! index, n_reflect, eV
   -0.000604   -0.000046    0.000003    0.000826       9.036    1.000000  ! Start position
    0.013187   -0.004171   -0.023902   -0.009377      15.524    0.999947  ! End position
    9.968419  ! photon_track_len
    0.001770  ! photon_track_len - ds_beam
      36   SBEND             ! Lat ele index and class
\end{example}
The first line gives the photon index number, the number of times the
photon struck the vacuum chamber (including the final hit where it is
adsorbed), the photon energy (in eV)

In the second line, the initial position of the generated photon is
given. The six numbers are $x$ (m), $v_x/c$, $y$ (m), $v_y/c$, $s$
(m), and $v_s/c.$ $x$ is the horizontal position (direction along the
local normal to the closed orbit, in the bend plane, zero on the
closed orbit, positive to the outside of the machine, ), $y$ is the
vertical position (direction perpendicular to the bend plane, zero on
the closed orbit, positive up), and $s$ is the longitudinal position
(direction tangent to the closed orbit, zero at the beginning of the
lattice, positive in the direction of motion of the beam).

The third line gives the position of the point at which the photon is absorbed.

The fourth line gives how far the photon traveled.

The fifth line gives how far the photon traveled relative to how far the beam traveled.

The sixth line gives the lattice element index and element type for
the longitudinal position at which the photon is absorbed. This is
provided so that the photon hits can be sorted by magnetic environment
(e.g., drift, sbend, wiggler, etc.)  

The same information is outputted as a table in a file whose name is
the same as \vn{dat_file} with a ``_table'' suffix appended.

%------------------------------------------------------------------
\subsection{Photon Reflection File}
\label{ss:reflection.file}

If the switch \vn{wall_hit_file} is non-blank, an additional output
file is generated, which contains more detailed information. An
example of the output is shown below. (This
example is not for the same run as in the previous section).
\begin{example}
 *********************************************
       1       0     825.0
    0.000163   -0.001690   -0.000078    0.000084  761.691897    1.000000
 *********************************************
       1       1     825.0
    0.044902    0.035208    0.001647    0.000084   13.729227    0.999381
               -0.034247               -0.008171                0.999381
    0.9930    0.1180    0.0000              0.034972    0.409532
 *********************************************
       2       0      59.0
   -0.000135   -0.002640    0.000010    0.000995  761.701478    1.000000
 *********************************************
       2       1      59.0
   -0.037269   -0.002640    0.014011    0.000995    7.332935    1.000000
                0.000462               -0.002783                1.000000
   -0.6345    0.7729    0.0000              0.002444    0.983416
 *********************************************
       2       2      59.0
    0.044491    0.037193   -0.003750   -0.002783   13.714673    0.999308
               -0.033444                0.016510                0.999308
    0.9647   -0.2635    0.0000              0.036612    0.766948
 *********************************************
       2       3      59.0
   -0.008275   -0.030089    0.024574    0.016510   15.429119    0.999414
               -0.026051               -0.022345                0.999414
   -0.1034    0.9946    0.0000              0.019532    0.870489
 *********************************************
       2       4      59.0
    0.010349    0.043049   -0.024330   -0.022345   17.617477    0.998827
                0.035823                0.032699                0.998827
    0.1302   -0.9915    0.0000              0.027758    0.819663
\end{example}
Individual entries are separated by a row of asterisks. Each entry
corresponds to a photon striking the vacuum chamber except the
``zeroth'' entry for a given photon gives the emission point
parameters. There will be at least two entries for each photon.

The format of and entry is:
\begin{example}
  photon_index  wall_hit_index  photon_energy
  x_before  v_x_before  y_before  v_y_before  s_before  v_s_before
            v_x_after             v_y_after             v_s_after
  perp_x   perp_y   perp_z        cos_perp    reflectivity
\end{example}
The \vn{photon_index} is the same index as in the main output file.
The \vn{wall_hit_index} starts at 0 for the emission point entry and
increases up to the value for \vn{n_wall_hits} in the main file.
The \vn{photon_energy} will be the same as in the main file.

The second line gives the 6-coordinate position of the photon as it
strikes the chamber (same conventions as given in the previous
section) except that the zeroth entry gives the emission point
coordinates.

Except for the zeroth entry, there is a third line and fourth
line. The third line gives the values for $v_x, v_y, v_z$ after the
reflection. For the last entry of a given photon, this line gives the
values of $v_x, v_y, v_z$ that the photon would have had had it been
reflected.

The first three numbers on the fourth line give the orientation of the
vector normal to the chamber surface at the hit point. The fourth number
is $\cos{\theta_\perp}$, the angle
relative to the surface normal with which the photon strikes the
wall. The grazing angle is $\theta_g=\pi/2-\theta_\perp$. The last
real number on the fourth line is the probability of reflection, computed
from the X-ray data for the given grazing angle and photon energy.

If the photon is ``adsorbed'' due to reflections being disallowed, the
third and fourth lines will have zeros.

In the example given above, the first photon is absorbed at the first
encounter with the vacuum chamber and the second photon is reflected 3
times, before being adsorbed on the fourth hit.

Note: If the beam emittances are zero, photons will be generated on
the central orbit. If there are no steerings powered, the central
orbit will be the zero orbit and in this case all photons will start
with $x$ = $px$ = $y$ = 0.

%------------------------------------------------------------------
\section{Test Modes}
\label{s:test}

Test modes are used to generate diagnostic data files. Test modes are
specified using the \vn{-test <what>} option on the command line
(\sref{s:run}). 
\begin{example}
  -test diffuse_reflection     ! \sref{s:test.diffuse}
  -test specular_reflection    ! \sref{s:test.specular}
\end{example}

These test modes are explained below

%------------------------------------------------------------------
\subsection{Diffuse Reflection Test Mode}
\label{s:test.diffuse}

Diffuse reflection test mode (\sref{s:run}), invoked using the
\vn{-test diffuse_reflection} option on the command line, is used for
studying the diffuse scattering distribution.  The simulation involves
scattering photons at a given incident angle and energy and recording
the output angles in a file. 

The parameters used for the test are read
in from the master input file specified on the command line
(\sref{s:run}). The namelist used for the input parameters for the
reflection test is called \vn{diffuse_reflection_test}.  Example:
\begin{example}
  &diffuse_reflection_test
    graze_angle_in              = 2.3      ! Incident grazing angle in degrees
    energy                      = 100      ! eV
    surface_roughness_rms       = -1       ! Surface roughness for diffuse scattering.
    roughness_correlation_len   = -1       ! Surface roughness correlation length.
    n_photons                   = 1000     ! Number of reflections simulated
    surface_reflection_file     = ""       ! File for specifying reflection probabilities.
    random_seed                 = 0        ! Random number seed.
    output_file                 = ""       ! Default is "test_diffuse_reflection.dat"
  /
\end{example}
The \vn{graze_angle_in} is the incident grazing angle in degrees and
\vn{energy} in the photon energy in eV. \vn{n_photons} are the number
of reflections to simulate, and \vn{output_file} is the name of the
output data file. The default data file name is
"test_diffuse_reflection.dat". The other parameters are explained in
\sref{s:master}.

\vn{random_seed} is the random number seed used in by the random
number generator. If set to 0, the system clock will be used. That is,
if set to 0, the output results will vary from run to run.

The output contains a header with the input parameters a then
\vn{n_photon} lines. Each line is of the form:
\begin{example}
  theta_out  phi_out
\end{example}
where \vn{theta_out} is the polar angle of the reflected photon in
radians. That is, \vn{theta_out} = 0 means the photon is traveling
perpendicular to the surface. The \vn{phi_out} angle is the azimuthal
angle in radians. That is, \vn{phi_out} is zero when the incident and
reflected rays are in the same plane.

%------------------------------------------------------------------
\subsection{Specular Reflection Test Mode}
\label{s:test.specular}

Specular reflection test mode (\sref{s:run}), invoked using the
\vn{-test specular_reflection} option on the command line, is used for
studying specular (angle in = angle out) reflections. The simulation
here is done by simulating a single specular reflection from a set of
given photon starting positions. The initial and final photon position
and velocity are recorded in an output file.

The parameters used for the test are read
in from the master input file specified on the command line
(\sref{s:run}). The namelist used for the input parameters for the
reflection test is called \vn{specular_reflection_test}.  Example:
\begin{example}
  &specular_reflection_test
    photon_start_input_file = "photon.start"  ! Photon starting positions
    lattice_file            = "lat.bmad"      ! Lattice file
    wall_file               = "synrad3d.wall" ! Wall definition file
    output_file             = ""     ! Default is "test_specular_reflection.dat"
  /
\end{example}

The \vn{photon_start_input_file} is the file of initial photon
positions. The format of this file is given in \vn{ss:photon.start}.
Note that for the specular test, the photon energy and the random
number generator state do not affect the results and do not have to be
set. Also: The if the magnitude of the velocity
$\sqrt{v_x^2+v_y^2+v_z^2}/c$ is not too far off from 1 then \srthree
will renormalize so that $\sqrt{v_x^2+v_y^2+v_z^2}/c$ will be 1.

\vn{lattice_file} give the name of the lattice.  The lattice file
format may be the Bmad format or, if the \vn{lattice_file} string is
prefixed by \vn{``xsif::''}, may be in xsif format. See the Bmad
manual for more details.

The \vn{wall_file} gives the name of the vacuum chamber will
definition file. See \sref{s:wall.file} for more details.

The \vn{output_file} gives the name of the output data file.
See \sref{ss:reflection.file} for details of the syntax for this file.

%------------------------------------------------------------------
\appendix
\section{Diffuse Scattering Formalism}

This appendix presents the details of the formalism used to describe
diffuse scattering. The basic approach is to use scalar Kirchoff
diffraction theory as originally formulated by
Beckmann~\cite{b:beckmann} to describe the angular distribution of
power scattered from a surface with a normally distribution variation
in heights, with rms $\sigma$, and with a transverse autocorrelation
length $T$.

In the material below, we present a derivation of the results from
scalar Kirchoff diffraction theory, starting from expression from
Jackson. For the case of a smooth surface, the expressions for the
scattered field and power can be derived which agree with Jackson's
formulas.

For a rough surface, we use these expressions, following the
methodology of Beckmann, to derive results for the mean value of the
scattered power. We have done this for both a Gaussian and an
exponential transverse autocorrelation function.

These expressions agree with Beckmann's for the Gaussian
autocorrelation function. (Beckmann does not consider the exponential
function).

Finally, the scattered power expressions are used to derive cumulative
distribution functions. These functions are used in \srthree to choose
outgoing scattering angles from a rough vacuum chamber surface

%------------------------------------------------------------------
\subsection{General Scalar Theory} 

The notation and terminology are taken from \cite{b:beckmann},
Chap. 3.
From~\cite{b:jackson}, p. 491 Eq. 10.108:
Kirchoff integral (scalar)
  \begin{equation}
\psi(\bm{x})=-\frac{\e^{\imath k r}}{4\pi r}
\int d\bm{a'}\e^{-\imath\bm{k}\cdot\bm{x'}}
\left(\bm{n}\cdot\nabla'\psi(\bm{x'})+\imath\bm{k}\cdot\bm{n}\psi(\bm{x'})\right)
  \end{equation}
Re-written in Beckmann notation:
  \begin{equation}
E_{2}(\bm{\bm{R_{0}}})=
-\frac{\e^{\imath k R_{0}}}{4\pi R_{0}}
\int dS\e^{-\imath\bm{k_{2}}\cdot\bm{r}}\left(\bm{n}\cdot\nabla E_{1}(\bm{r})+
\imath\bm{k_{2}}\cdot\bm{n}E_{1}(\bm{r})\right)
  \end{equation}
From~\cite{b:beckmann} p 19 (8): Helmholtz integral
  \begin{equation}
E_{2}(P)=\frac{1}{4\pi}\int_{S}\left(E_{1}\pder{\psi}{n}-\psi\pder{E_{1}}{n}\right)dS
  \end{equation}
  \begin{equation}
\psi=\frac{\e^{\imath k_{2}R_{0}-\imath\bm{k}_{2}\cdot\bm{r}}}{R_{0}}.
  \end{equation}
  \begin{equation}
\pder{\psi}{n}=-\imath\bm{k_{2}}\cdot\bm{n}\psi
  \end{equation}
So
  \begin{equation}
E_{2}(P)=\frac{\e^{\imath k_{2}R_{0}}}{4\pi R_{0}}
\int_{S}\e^{-\imath\bm{k}_{2}\cdot\bm{r}}\left(-\imath\bm{k_{2}}\cdot\bm{n}E_{1}-\pder{E_{1}}{n}\right)dS
  \end{equation}
Same as Jackson result. Evaluate:
  \begin{equation}
E_{1}=RE_{0}\e^{\imath\bm{k}_{1}\cdot\bm{r}}
  \end{equation}
  \begin{equation}
\pder{E_{1}}{n}=E_{0}R\e^{\imath\bm{k}_{1}\cdot\bm{r}}\imath\bm{k'_{1}}\cdot\bm{n}
  \end{equation}
Here $R$ is the smooth-surface \emph{field} reflection
coefficient. Note: for the field on the surface, \cite{b:beckmann} uses the
incident field amplitude, plus the scattered field, (incident
multiplied by $R$, the Fresnel field reflection coefficient), in the
Kirchoff integral.  From \cite{b:jackson}, it seems that we should use just
the scattered field, so that's what is used here. In \cite{b:beckmann} ,
although the incident field piece is carried through the derivation,
it cancels out in the final answer. So neglecting it from the
beginning gives the same result as in \cite{b:beckmann}.

$R$ depends on the incident photon energy and the incident angle
$\theta_{1}$. For a rough surface, the incident angle varies over the
surface and so $R$ cannot be taken out of the Kirchoff integral. The
conventional treatment (from~\cite{b:beckmann}) is to ignore this point, and
treat $R$ as a constant, evaluated at $\theta_{1}$.  Since the angular
dependence of $R$ is known, a somewhat better approximation would be
to use the average value of $R$, averaged over the stochastic
distribution of slopes of the rough surface. This point is discussed
further below.

Note that the reflected field on the surface has the phase factor
$\e^{\imath\bm{k}_{1}\cdot\bm{r}}$, since it is determined by the
incident field times $R$. However, its gradient involves the vector
$\bm{k'}_{1}$, a vector in the direction of the reflected wave from
the local surface. If the local surface normal is $\bm n$, and the
polar angle of the incident wave relative to $\bm n$ is $\alpha$, then
  \begin{equation}
\bm {k_{1}}=\bm {k_{1,p}}-\bm{n}k\cos{\alpha}
  \end{equation} 
  \begin{equation}
\bm {k'_{1}}=\bm
{k_{1,p}}+\bm{n}k\cos{\alpha}
  \end{equation} So
  \begin{equation}
\bm{k'_{1}}\cdot\bm{n}=-\bm{k_{1}}\cdot\bm{n}.
  \end{equation}
and 
  \begin{equation}
\bm
{k'_{1}}=\bm {k_{1}}+2\bm{n}k\cos{\alpha}=\bm
{k_{1}}-2(\bm{n}\cdot\bm{k_{1}})\bm{n}
  \end{equation}
Plug into Helmholtz integral  and use
  \begin{equation}
E_{1}\pder{\psi}{n}=-\imath\bm{k_{2}}\cdot\bm{n}RE_{0}
\frac{\e^{\imath k_{2}R_{0}}}{R_{0}}\e^{\imath(\bm{k}_{1}-\bm{k_{2}})\cdot\bm{r}}
  \end{equation}
and
  \begin{equation}
\psi\pder{E_{1}}{n}=-RE_{0}\frac{\e^{\imath k_{2}R_{0}}}{R_{0}}\imath\bm{k_{1}}\cdot\bm{n}
\e^{\imath(\bm{k}_{1}-\bm{k_{2}})\cdot\bm{r}}
  \end{equation}
to get
  \begin{equation}
E_{2}(P)=\imath E_{0}\frac{\e^{\imath k_{2}R_{0}}}
{4\pi R_{0}}\int\int_{S}\e^{\imath(\bm{k}_{1}-\bm{k_{2}})\cdot\bm{r}}R
\left((\bm{k_{1}}-\bm{k_{2}})\cdot\bm{n}\right)dS
  \end{equation}
or, using
  \begin{equation}
\bm{v}=\bm{k_{1}}-\bm{k_{2}}
  \end{equation}
  \begin{equation}
E_{2}(P)=\imath E_{0}\frac{\e^{\imath k_{2}R_{0}}}{4\pi R_{0}}
\int\int_{S}\e^{\imath\bm{v}\cdot\bm{r}}R\bm{v}\cdot\bm{n}dS
  \end{equation}
in which
  \begin{eqnarray}
\bm{k_{1}} &=& k\left(-\cos{\theta_{1}}\bm{\hat z}+
  \sin{\theta_{1}}\bm{\hat x}\right) \\
\bm{k_{2}} &=& k\left(\cos{\theta_{2}}\bm{\hat z}+
  \sin{\theta_{2}}\cos{\phi}\bm{\hat x}+\sin{\theta_{2}}\sin{\phi}\bm{\hat y}\right) \\
\bm{v} &=& k(\sin{\theta_{1}}-\sin{\theta_{2}}\cos{\phi})\bm{\hat x}-
k(\cos{\theta_{1}}+\cos{\theta_{2}})\bm{\hat z}-k\sin{\theta_{2}}\sin{\phi}\bm{\hat y}
  \end{eqnarray}

The equation of the surface is
  \begin{equation}
z=\xi(x,y).
  \end{equation}
The normal vector (not a unit vector) is given by
  \begin{equation}
\bm{N}=\bm{\hat z}-\pder{\xi(x,y)}{x}\bm{\hat x}-
\pder{\xi(x,y)}{y}\bm{\hat y}=\bm{\hat z}-\tan\beta_{x}\bm{\hat x}-\tan\beta_{y}\bm{\hat y}.
  \end{equation}
Normalizing,
  \begin{equation}
N^{2}=1+\tan^{2}\beta_{x}+\tan^{2}\beta_{y}
  \end{equation}
So
  \begin{equation}
\bm{n}=\bm{N}/N=\frac{\bm{\hat z}-\tan\beta_{x}\bm{\hat x}-\tan\beta_{y}\bm{\hat y}}{N}
  \end{equation}
and
  \begin{equation}
\bm{r}=x\bm{\hat x}+y\bm{\hat y}+\xi(x,y)\bm{\hat z}.
  \end{equation}
  \begin{equation}
\bm{v}\cdot\bm{n}=\frac{-v_{x}\tan{\beta_{x}}-v_{y}\tan{\beta_{y}}+v_{z}}{N}
  \end{equation}
  \begin{equation}
\bm{v}\cdot\bm{r}=v_{x}x+v_{y}y+v_{z}\xi(x,y)
  \end{equation}

The surface area is
  \begin{eqnarray}
dS &=& \sqrt{1+\pder{\xi(x,y)}{x}^{2}+\pder{\xi(x,y)}{y}^{2}}dxdy=Ndxdy \\
\bm{v}\cdot\bm{n}dS &=& dxdy(-v_{x}\tan{\beta_{x}}-v_{y}\tan{\beta_{y}}+v_{z}) \\
\int_{S}dS\e^{\imath\bm{v}\cdot\bm{r}}R\bm{v}\cdot\bm{n} &=&
\int dx dy\e^{\imath( v_{x}x+v_{y}y+v_{z}\xi(x,y))}R'(-v_{x}\pder{\xi(x,y)}{x}-v_{y}\pder{\xi(x,y)}{y}+v_{z}) \\
E_{2}(P) &=& \imath E_{0}\frac{\e^{\imath k_{2}R_{0}}}{4\pi R_{0}}
\int dx dy\e^{\imath( v_{x}x+v_{y}y+v_{z}\xi(x,y))} \\
  && \qquad R(-v_{x}\pder{\xi(x,y)}{x}-v_{y}\pder{\xi(x,y)}{y}+v_{z}) \nonumber
  \end{eqnarray}

%------------------------------------------------------------------
\subsection{Scalar Theory: Smooth Surface Field}

If the surface is perfectly smooth, then $\xi(x)=\xi'(x)=0$ and we have
\begin{eqnarray}
E_{2}(P)&=&\imath  E_{0}\frac{\e^{\imath k_{2}R_{0}}}{4\pi R_{0}}v_{z}
\int dx dy\e^{\imath v_{x}x+v_{y}y}R
\end{eqnarray}

The reflection coefficient $R$ is a function of the local angle of
incidence, which varies over the surface.  So it cannot be taken out
of the integral. However, we can replace it with an average value over
the surface $\left<R\right>$, which is considered to be constant. Then
we have 
  \begin{eqnarray} E_{2}(P)&=&\imath E_{0}\frac{\e^{\imath
k_{2}R_{0}}}{4\pi R_{0}}v_{z}\left<R\right>\int rdr d\phi\e^{\imath
r(v_{x}\cos\phi+v_{y}\sin\phi)}
  \end{eqnarray}
Using
  \begin{equation}
\int d\phi\e^{\imath r(v_{x}\cos\phi+v_{y}\sin\phi)}=2\pi J_{0}(r\sqrt{v_{x}^{2}+v_{y}^{2}}),
  \end{equation}

and

   \begin{equation}
\int_{0}^{a}rdrJ_{0}(r\sqrt{v_{x}^{2}+v_{2}^{2}})=
\frac{aJ_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{\sqrt{v_{x}^{2}+v_{y}^{2}}},
  \end{equation}
 
 in which the area of the surface of integration is $A=\pi a^{2}.$ Then

\begin{eqnarray}
E_{2}(P)&=&\imath  E_{0}\frac{\e^{\imath k_{2}R_{0}}}{4\pi R_{0}}v_{z}\left<R\right>\frac{2\pi aJ_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{\sqrt{v_{x}^{2}+v_{y}^{2}}}\\
&=&\imath  Av_{z}\left<R\right>E_{0}\frac{\e^{\imath k_{2}R_{0}}}{2\pi R_{0}}\frac{J_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{a\sqrt{v_{x}^{2}+v_{y}^{2}}}\end{eqnarray}

in which 
  \begin{equation}
v_{z}=-k(\cos{\theta_{1}}+\cos{\theta_{2}})
  \end{equation}
and

  \begin{equation}
v_{x}^{2}+v_{y}^{2}=k^{2}\left((\sin\theta_{1}-
\sin\theta_{2}\cos{\phi})^2+(\sin\theta_{2}\sin\phi)^{2}\right)=k^{2}
\left(\sin\theta_{1}^{2}+\sin\theta_{2}^{2}-2\cos\phi\sin\theta_{1}\sin\theta_{2}\right)
  \end{equation}

This agrees with~\cite{b:jackson}, pg. 494, equation before 10.119.  

%------------------------------------------------------------------
\subsection{Scalar Theory: Power Computation}

According to~\cite{b:jackson}, the consistent way to use this scalar
quantity to compute the power is to use the relation

  \begin{equation}
\der{P_{2}}{\Omega}=\frac{R_{0}^{2}}{2Z_{0}}|E_{2}(P)|^{2}
  \end{equation}

Thus
  \begin{equation}
\der{P_{2}}{\Omega}=\frac{A(\pi a^{2})v_{z}^{2}\left<R\right>^{2}E_{0}^{2}}{(2Z_{0})4\pi^{2}}\left|\frac{J_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{a\sqrt{v_{x}^{2}+v_{y}^{2}}}\right|^{2}
  \end{equation}

The total power power in the incoming field incident on the area A is

  \begin{equation}
P_{0}=\frac{A}{2Z_{0}}|\bm{\hat z}\cdot\bm{\hat k_{1}}||\bm E_{0}|^{2}=\frac{A\cos\theta_{1}}{2Z_{0}}E_{0}^{2}
  \end{equation}

so

\begin{eqnarray}
\der{P_{2}}{\Omega}&=&\frac{P_{0}(\pi a^{2})v_{z}^{2}\left<R\right>^{2}}{4\pi^{2}\cos\theta_{1}}\left|\frac{J_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{a\sqrt{v_{x}^{2}+v_{y}^{2}}}\right|^{2}\\
&=&\frac{P_{0}(ka)^{2}(\cos\theta_{1}+\cos\theta_{2})^{2}\left<R\right>^{2}}{4\pi\cos\theta_{1}}\left|\frac{J_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{a\sqrt{v_{x}^{2}+v_{y}^{2}}}\right|^{2}
\end{eqnarray}

This agrees with \cite{b:jackson}, pg. 494, equation 10.119.  (except
for the extra factor of the reflection coefficient squared).

%------------------------------------------------------------------
\subsubsection{Scalar Theory: Rough Surface Field}

For a rough surface, we use the following relations to simplify the field equation:
  \begin{equation}
f(x)=\e^{\imath (ax+b\xi(x,y))},
  \end{equation}
then
  \begin{equation}
\der{f}{x}=ib\pder{\xi(x,y)}{x}f+iaf,
  \end{equation}
  \begin{equation}
\pder{\xi(x,y)}{x}f=-\frac{a}{b}f+\frac{1}{ib}\der{f}{x}
  \end{equation}
So
  \begin{equation}
\int dx\pder{\xi(x,y)}{x}f=-\frac{a}{b}\int dx f+\frac{1}{ib}f
  \end{equation}

Thus
  \begin{equation}
\int dx\pder{\xi(x,y)}{x}\e^{\imath v_{x}x}\e^{\imath v_{z}\xi(x,y)}=-\frac{v_{x}}{v_{z}}\int dx \e^{\imath v_{x}x}\e^{\imath v_{z}\xi(x,y)}+\frac{1}{iv_{z}}\e^{\imath v_{x}x}\e^{\imath v_{z}\xi(x,y)}
  \end{equation}

Similarly
  \begin{equation}
\int dy\pder{\xi(x,y)}{y}\e^{\imath v_{y}y}\e^{\imath v_{z}\xi(x,y)}=-\frac{v_{y}}{v_{z}}\int dx \e^{\imath v_{y}y}\e^{\imath v_{z}\xi(x,y)}+\frac{1}{iv_{z}}\e^{\imath v_{y}y}\e^{\imath v_{z}\xi(x,y)}
  \end{equation}

So
\begin{eqnarray}
E_{2}(P)&=&\imath E_{0}\frac{\e^{\imath k_{2}R_{0}}}{4\pi R_{0}}\int dx dy\e^{\imath( v_{x}x+v_{y}y+v_{z}\xi(x,y))}R(-v_{x}\pder{\xi(x,y)}{x}-v_{y}\pder{\xi(x,y)}{y}+v_{z})
)\\
&=&\imath E_{0}\frac{\e^{\imath k_{2}R_{0}}}{4\pi R_{0}}\frac{1}{v_{z}}\int dx dy\e^{\imath( v_{x}x+v_{y}y+v_{z}\xi(x,y))}R(v_{x}^{2}+v_{y}^{2}+v_{z}^{2})
\end{eqnarray}

plus boundary terms.

Using
$$v_{x}^{2}+v_{y}^{2}+v_{z}^{2}=2k^{2}\left(1+\cos\theta_{1}\cos\theta_{2}-\sin\theta_{1}\sin\theta_{2}\cos\phi\right).$$

the field equation is

\begin{eqnarray}
E_{2}(P)&=&-\imath kE_{0}\frac{\e^{\imath k_{2}R_{0}}}{4\pi R_{0}}\frac{2\left<R\right>\left(1+\cos\theta_{1}\cos\theta_{2}-\sin\theta_{1}\sin\theta_{2}\cos\phi\right)}{(\cos{\theta_{1}}+\cos{\theta_{2}})}\int dx dy\e^{\imath( v_{x}x+v_{y}y+v_{z}\xi(x,y))}
\end{eqnarray}

We have neglected the boundary terms here, following
~\cite{b:beckmann}. However, as noted in \cite{b:ogilvy}, p. 82, this is a
mistake, for the specular power, although it is correct for the
diffuse power. Since we are really only interested in the diffuse
power here, we have continued to neglect these terms below. So the
results for the specular power from the rough surface given below are
incorrect. However, the diffuse power results should be OK.

%------------------------------------------------------------------
\subsection{Scalar Theory: Rough Surface Power} 

The power is

\begin{eqnarray}
\der{P_{2}}{\Omega}&=&\frac{R_{0}^{2}}{2Z_{0}}\left<|E_{2}(P)|^{2}\right>=\\
&&k^{2}E_{0}^{2}\frac{\left<R\right>^{2}}{(2Z_{0})4\pi^{2}}\frac{F_{0}(\theta_{1},\theta_{2},\phi)}{(\cos{\theta_{1}}+\cos{\theta_{2}})^{2}}\times\\
&&\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>\\
&=&P_{0}\frac{k^{2}\left<R\right>^{2}}{4\pi^{2}A\cos\theta_{1}}\frac{F_{0}(\theta_{1},\theta_{2},\phi)}{(\cos{\theta_{1}}+\cos{\theta_{2}})^{2}}\times\\
&&\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>\end{eqnarray}
in which the brackets specify an ensemble average over the random variable $\xi(x,y)$, and

$$F_{0}(\theta_{1},\theta_{2},\phi)=\left(1+\cos\theta_{1}\cos\theta_{2}-\sin\theta_{1}\sin\theta_{2}\cos\phi\right)^{2}.$$

This average can be expressed in terms of the one-dimensional characteristic function $\chi(v_{z}),$

$$\chi(v_{z})=\left<e^{\imath v_{z}\xi}\right>=\int dz w(z) \e^{\imath v_{z}z},$$

and its distribution function $w(z)$, and the two-dimensional characteristic function $\chi_{2}(v_{z}, -v_{z}),$

$$\chi_{2}(v_{z},-v_{z})=\left<e^{\imath v_{z}(\xi-\xi')}\right>=\int dz_{1} dz_{2} W(z_{1},z_{2}) \e^{\imath v_{z}(z_{1}-z_{2})}.$$
 and its 2D distribution function
 $W(z_{1},z_{2})$.
 
 Thus,
 
 $$\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>=\int dx dydx'dy'\chi_{2}(v_{z},-v_{z})\e^{\imath( v_{x}(x-x')+v_{y}(y-y'))}.$$

 For a Gaussian distribution of surface fluctuations in the normal direction, the one-dimensional distribution function is
 $$w(z)=\frac{1}{\sqrt{2\pi\sigma^{2}}}\e^{-\frac{z^{2}}{2\sigma^{2}}}.$$
 
 Its characteristic function is
 $$\chi(v_{z})=\e^{-\frac{\sigma^{2}v_{z}^{2}}{2}}.$$
 The two-dimensional distribution function is
  $$W(z_{1},z_{2})=\frac{1}{2\pi\sigma^{2}\sqrt{1-C^{2}}}\e^{-\frac{z_{1}^{2}-2Cz_{1}z_{2}+z_{2}^{2}}{2\sigma^{2}(1-C^{2})}}.$$
  Its characteristic function is
 $$\chi_{2}(v_{z},-v_{z})=\e^{-\sigma^{2}v_{z}^{2}(1-C)}.$$
 %%%%%%%%%%%%
  \paragraph{General autocorrelation functions}

 For a general autocorrelation function $C(\tau/T)$
 with $T$ a constant and $\tau^{2}=(x-x')^{2}+(y-y')^{2},$
 
 we have
\begin{eqnarray}
\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>&=&\\
\int dx dydx'dy'\e^{-g(1-C(\tau/T))}\e^{\imath( v_{x}(x-x')+v_{y}(y-y'))}\end{eqnarray}

in which
$$g=\sigma^{2}v_{z}^{2}$$.

Define

$$u_{x}=1/\sqrt{2}(x-x'),\;\;w_{x}=1/\sqrt{2}(x+x'),\;\;u_{y}=1/\sqrt{2}(y-y'),\;\;w_{y}=1/\sqrt{2}(y+y'),$$
$$x=1/\sqrt{2}(u_{x}+w_{x}),\;\;x'=1/\sqrt{2}(w_{x}-u_{x}),\;\;y=1/\sqrt{2}(u_{y}+w_{y}),\;\;y'=1/\sqrt{2}(w_{y}-u_{y}),$$

then

\begin{eqnarray}
\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>&=&\\
\int dw_{x}dw_{y}\int du_{x} du_{y}\e^{-g(1-C(\sqrt{2}r/T))}\e^{\sqrt{2}\imath( v_{x}u_{x}+v_{y}u_{y})}\end{eqnarray}
 in which
 $$r^{2}=u_{x}^{2}+u_{y}^{2}.$$

Boundary of integration:
$$x^{2}+y^{2}=a^{2}\;\;x'^{2}+y'^{2}=a^{2}$$
$$(u_{x}+w_{x})^{2}+(u_{y}+w_{y})^{2}=2a^{2}\;\;(u_{x}-w_{x})^{2}+(u_{y}-w_{y})^{2}=2a^{2}$$

so
$$w_{y}=\pm\frac{u_{x}\sqrt{2a^{2}-u_{x}^{2}-u_y^{2}}}{\sqrt{u_{x}^{2}+u_{y}^{2}}}$$
and
 the integral is
$$\int du_{x} \int du_{y}\e^{-g(1-C(\sqrt{2}r/T))}\e^{\sqrt{2}\imath( v_{x}u_{x}+v_{y}u_{y})}\int_{-\frac{u_{x}\sqrt{2a^{2}-u_{x}^{2}-u_y^{2}}}{\sqrt{u_{x}^{2}+u_{y}^{2}}}}^{\frac{u_{x}\sqrt{2a^{2}-u_{x}^{2}-u_y^{2}}}{\sqrt{u_{x}^{2}+u_{y}^{2}}}} dw_{y}\int_{-u_{x}-\sqrt{2a^{2}-(u_{y}+w_{y})^{2}}}^{-u_{x}+\sqrt{2a^{2}-(u_{y}+w_{y})^{2}}}dw_{x}$$

The argument is that because of the rapid falloff of the integrand with $u_{x}$ and $u_{y}$, only a small region around 0, of order $T\ll a$ contributes for $u_{x}$ and $u_{y}$. Thus we can approximate the integrals on $w_{x}$ and $w_{y}$ as follows:

\begin{eqnarray}
\int du_{x} \int du_{y}\e^{-g(1-C(\sqrt{2}r/T))}\e^{\sqrt{2}\imath( v_{x}u_{x}+v_{y}u_{y})}\int_{-a\sqrt{2}}^{a\sqrt{2}}dw_{y}\int_{-\sqrt{2a^{2}-w_{y}^{2}}}^{\sqrt{2a^{2}-w_{y}^{2}}}dw_{x}&=&\\
2\pi a^{2}\int du_{x} \int du_{y}\e^{-g(1-C(\sqrt{2}r/T))}\e^{\sqrt{2}\imath( v_{x}u_{x}+v_{y}u_{y})}\end{eqnarray}


The limits on the integral for $u_{x}$ and $u_{y}$ can be extended to infinity and we have, approximately,

\begin{eqnarray}
\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>&=&\\
2\pi a^{2}\int_{0}^{2\pi} d\phi\int_{0}^{\infty} r dr\e^{-g(1-C(\sqrt{2}r/T))}\e^{\sqrt{2}\imath r(v_{x}\cos\phi+v_{y}\sin\phi)}\end{eqnarray}

Then we can use

$$\int_{0}^{2\pi} d\phi\e^{\sqrt{2}\imath r(v_{x}\cos\phi+v_{y}\sin\phi)}=2\pi J_{0}(\sqrt{2}r\sqrt{v_{x}^{2}+v_{y}^{2}}),$$

to get

\begin{eqnarray}
\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>&=&\\
4\pi A\int_{0}^{\infty} r dr\e^{-g(1-C(\sqrt{2}r/T))} J_{0}(\sqrt{2}r\sqrt{v_{x}^{2}+v_{y}^{2}})\end{eqnarray}

 in which $A=\pi a^{2}.$

%------------------------------------------------------------------
\subsection{Probability Distributions}

The differential probability, normalized to the total power, may be interpreted as the joint probability distribution of a photon scattering at an angle $\theta_{2}$ and $\phi$.  Thus, the diffuse scattering joint probability distribution is

\begin{eqnarray}
P(x,\phi)&=&N_{0}\der{P_{2}}{\Omega}\end{eqnarray}

The normalization factor $N_{0}$ is introduced, so that

$$1=\int_{0}^{2\pi}d\phi\int_{0}^{1}dxP(x,\phi).$$


The marginal probability distribution in $x$ is
$$P_{x}(x)=\int_{0}^{2\pi}d\phi P(x,\phi)$$

This is the probability distribution in $x$, irrespective of $\phi.$

The marginal probability distribution in $\phi$ is
$$P_{\phi}(\phi)=\int_{0}^{1}dxP(x,\phi)$$

This is the probability distribution in $\phi$, irrespective of $x$

The conditional probability in $x$ is 
$$P(x|\phi)=\frac{P(x,\phi)}{P_{\phi}(\phi)}$$

This gives the probability that, given a specific value of $\phi$, $x$ occurs. 

The conditional probability in $\phi$ is 
$$P(\phi|x)=\frac{P(x,\phi)}{P_{x}(x)}$$

This gives the probability that, given a specific value of $x$, $\phi$ occurs. 


To sample from the joint probability distribution $P(x,\phi)$, first
sample from the marginal probability distribution in $x$. Form the
marginal cumulative distribution function in $x$:

$$C(x)=\frac{\int_{0}^{x}dx'P_{x}(x')}{\int_{0}^{1}dx'P_{x}(x')}$$

Since the form of $P(x)$ does not admit doing the integral
analytically, we fit the function to a series of $N$ Chebyshev
polynomials $T_{n}(x)$:

$$P(x)=\sum_{n=0}^{n=N}C_{n}T_{n}(x)$$

This works well since, typically, the distribution $P(x)$, while
peaked near $\cos\theta_{1}$, is relatively broad, not sharply
peaked. The integrals of Chebyshev polynomials can be done
analytically:

$$\int_{0}^{x}dx'T_{n}(x')=S_{n}(x),$$

so
$$C(x)=\frac{\sum_{n=0}^{n=N}C_{n}S_{n}(x)}{\sum_{n=0}^{n=N}C_{n}S_{n}(1)}$$

Choose a random number $R_{1}$ between 0 and 1, set $R_{1}=C(x)$ and
find $x$.  This is done numerically, using the Newton-Raphson method.

Then, given this $x$, form the conditional probability distribution in $\phi$:

$$C_{\phi}=\int_{0}^{\phi}d\phi'P(\phi'|x)=\frac{1}{P_x(x)}\int_{0}^{\phi}d\phi'P(x,\phi')$$

Choose a random number $R_{2}$ between 0 and 1, set $R_{2}=C(\phi)$
and find $\phi$, again using the Newton-Raphson method.


%------------------------------------------------------------------
\subsection{Gaussian Autocorrelation}

 For a Gaussian autocorrelation function, we have
 $$C(\tau/T)=\e^{-\tau^{2}/T^{2}},$$
 so
 $$C(\sqrt{2}r/T)=\e^{-2r^{2}/T^{2}},$$

 and
 
 \begin{eqnarray}
\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>&=&\\
4\pi A\int_{0}^{\infty} r dr\e^{-g(1-\e^{-2r^{2}/T^{2}})} J_{0}(\sqrt{2}r\sqrt{v_{x}^{2}+v_{y}^{2}})\end{eqnarray}
 
For $g\gg 1$, the falloff with $r$ is extremely rapid and we can approximate

$$1-\e^{-2r^{2}/T^{2}}\approx 2r^{2}/T^{2}$$

Then we have
\begin{eqnarray}
\int_{0}^{\infty} r dr\e^{-g(1-\e^{-2r^{2}/T^{2}})} J_{0}(\sqrt{2}r\sqrt{v_{x}^{2}+v_{y}^{2}})&\approx&\\
\int_{0}^{\infty} r dr\e^{-2gr^{2}/T^{2}} J_{0}(\sqrt{2}r\sqrt{v_{x}^{2}+v_{y}^{2}})&=&
\frac{T^{2}}{4g}\e^{-T^{2}(v_{x}^{2}+v_{y}^{2})/4g}
\end{eqnarray}

 \begin{eqnarray}
\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')p+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>&=&
2\pi A\frac{T^{2}}{2g}e^{-T^{2}(v_{x}^{2}+v_{y}^{2})/4g}\end{eqnarray}

For general $g$, we expand the exponential
$$\e^{-g\e^{-2r^{2}/T^{2}}}=\sum_{m=0}^{\infty}g^{m}/m!\e^{-2mr^{2}/T^{2}}$$
$m$th term ($m > 0$)
\begin{eqnarray}
g^{m}/m!\int_{0}^{\infty} r dr\e^{-2mr^{2}/T^{2}} J_{0}(\sqrt{2}r\sqrt{v_{x}^{2}+v_{y}^{2}})&=&
\frac{g^{m}T^{2}}{4mm!}\e^{-T^{2}(v_{x}^{2}+v_{y}^{2})/4m}
\end{eqnarray}

so
 \begin{eqnarray}
\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>&=&\\
\e^{-g}2\pi A\sum_{m=0}^{\infty}\frac{g^{m}T^{2}}{2mm!}\e^{-T^{2}(v_{x}^{2}+v_{y}^{2})/4m}\end{eqnarray}


The $m=0$  term is
\begin{eqnarray}
\e^{-g} \left|2\pi\int_{0}^{a}r dr J_{0}(r\sqrt{v_{x}^{2}+v_{y}^{2}})\right|^{2}&=&\e^{-g}4\pi^{2}a^{4}\left|\frac{J_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{a\sqrt{v_{x}^{2}+v_{y}^{2}}}\right|^{2}\\
&=&\e^{-g}4a^{2}\pi A\left|\frac{J_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{a\sqrt{v_{x}^{2}+v_{y}^{2}}}\right|^{2}\end{eqnarray}

Putting it all together gives

\begin{eqnarray}
\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>&=&\\
2\pi A\e^{-g}\left(2a^{2}\left|\frac{J_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{a\sqrt{v_{x}^{2}+v_{y}^{2}}}\right|^{2}+T^{2}\sum_{m=1}^{\infty}\frac{g^{m}}{2m!m}\e^{-\frac{(v_{x}^{2}+v_{y}^{2})T^{2}}{4m}}\right)\end{eqnarray}
so the power is
\begin{eqnarray}
\der{P_{2}}{\Omega}&=&P_{0}\frac{\left<R\right>^{2}}{2\pi\cos\theta_{1}}\frac{F_{0}(\theta_{1},\theta_{2},\phi)}{(\cos{\theta_{1}}+\cos{\theta_{2}})^{2}}\times\\
&&\e^{-g}\left(2(ka)^{2}\left|\frac{J_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{a\sqrt{v_{x}^{2}+v_{y}^{2}}}\right|^{2}+\frac{4\pi^{2}T^{2}}{\lambda^{2}}\sum_{m=1}^{\infty}\frac{g^{m}}{2m!m}\e^{-\frac{(v_{x}^{2}+v_{y}^{2})T^{2}}{4m}}\right)\end{eqnarray}

For the diffuse scattering piece, this can be written as

\begin{eqnarray}
\der{P_{2}}{\Omega}&=&P_{0}\frac{\left<R\right>^{2}}{2\pi\cos\theta_{1}}\frac{F_{0}(\theta_{1},\theta_{2},\phi)}{(\cos{\theta_{1}}+\cos{\theta_{2}})^{2}}\e^{-g}\frac{2\pi^{2}T^{2}}{\lambda^{2}}\sum_{m=1}^{\infty}X_{m}\end{eqnarray}

in which
$$X_{m}=\frac{g^{m}}{m!m}\e^{-\frac{(v_{x}^{2}+v_{y}^{2})T^{2}}{4m}}$$
Introducing $x=\cos\theta_{2}$ and $y=\cos\theta_{1},$ we have

$$F_{0}(x,y,\phi)=\left(1+xy-\sqrt{1-y^{2}}\sqrt{1-x^{2}}\cos\phi\right)^{2},$$
and
$$g=k^{2}\sigma^{2}(x+y)^{2}.$$

So

\begin{eqnarray}
\der{P_{2}}{\Omega}&=&P_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{F_{0}(x,y,\phi)}{(x+y)^{4}}g\e^{-g}\tau^{2}\sum_{m=1}^{\infty}X_{m}\end{eqnarray}

in which
$$X_{m}=\frac{g^{m}}{m!m}\e^{-\frac{(v_{x}^{2}+v_{y}^{2})\tau^{2}\sigma^{2}}{4m}}$$

and $\tau=\frac{T}{\sigma}$
Then

$$v_{x}^{2}+v_{y}^{2}=k^{2}\left(\sin\theta_{1}^{2}+\sin\theta_{2}^{2}-2\cos\phi\sin\theta_{1}\sin\theta_{2}\right)=k^{2}\left(2-x^{2}-y^{2}-2\cos\phi\sqrt{1-x^{2}}\sqrt{1-y^{2}}\right)$$

In terms of 

$$h(x,y)=\sqrt{1-(x^{2}+y^{2})+x^{2}y^{2}},$$
we have
$$v_{x}^{2}+v_{y}^{2}=k^{2}\left(2-x^{2}-y^{2}-2h(x,y)\cos\phi\right)$$

Then

$$F_{0}(x,y,\phi)=\left(1+xy-h(x,y)\cos\phi\right)^{2}=(1+xy)^{2}(1-a\cos\phi)^{2}$$

$$\frac{(v_{x}^{2}+v_{y}^{2})\tau^{2}\sigma^{2}}{4m}=\frac{\left(2-x^{2}-y^{2}-2h(x,y)\cos\phi\right)\tau^{2}g}{4m(x+y)^{2}}=\frac{\left(2-x^{2}-y^{2}\right)\tau^{2}g}{4m(x+y)^{2}}-b_{m}\cos\phi$$

with
$$a=\frac{h(x,y)}{1+xy},$$
and
$$b_{m}=\frac{2h(x,y)\tau^{2}g}{4m(x+y)^{2}}$$
Then
\begin{eqnarray}\der{P_{2}}{\Omega}&=&P_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{(1+xy)^{2}(1-a\cos\phi)^{2}}{(x+y)^{4}}\tau^{2}g\e^{-g}\sum_{m=1}^{\infty}X_{m}\end{eqnarray}
$$X_{m}=\frac{g^{m}}{m!m}\e^{-gq(x,y,\phi)/m}$$

$$q(x,y,\phi)=\frac{\left(2-x^{2}-y^{2}-2h(x,y)\cos\phi\right)\tau^{2}}{4(x+y)^{2}}.$$

If $q$ is large, the number of terms in the sum can become very large,
although the total power is very small. This can present a problem for
numerical evaluation.  We can make an estimate of the size of the sum,
to decide whether to evaluate it, or simply set the power to zero, as
follows.

The maximum value of the summand $X_{m}$ occurs when

$$\der{X_{m}}{m}=0\Rightarrow gq(x,y,\phi)-m_{max}+m_{max}^{2}(\ln g-\psi(m_{max}))=0$$

we can solve this equation numerically to find $m_{max}(g,q(x,y,\phi)).$ Then we estimate

$$\sum_{m=1}^{\infty}X_{m}\approx m_{max}\frac{g^{m_{max}}}{m_{max}!m_{max}}\e^{-gq(x,y,\phi)/m_{max}}$$

so

$$\ln\sum_{m=1}^{\infty}X_{m}\approx m_{max}\ln g - \ln m_{max}!-gq(x,y,\phi)/m_{max}$$
If this is less than, for example, $-200$, we set the power to zero. Otherwise we go ahead and evaluate the sum.

%-----------------------------------------------
\subsubsection{Gaussian Autocorrelation: Small g Limit}

For $g\ll 1$, the power is
\begin{eqnarray}
\der{P_{2}}{\Omega}&\approx&P_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{(1+xy)^{2}(1-a\cos\phi)^{2}}{(x+y)^{4}}\tau^{2}g^{2}\e^{-gq(x,y,\phi)}\\
&\approx&P_{0}\frac{\left<R\right>^{2}}{4\pi y}(1+xy)^{2}\left(1-a\cos\phi\right)^{2}\tau^{2}k^{4}\sigma^{4}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\cos\phi\right)T^{2}k^{2}}{4}.}
\end{eqnarray}

%-----------------------------------------------
\subsubsection{Large g limit}
For $g\gg 1$, the power is
\begin{eqnarray}
\der{P_{2}}{\Omega}&=&P_{0}\frac{\left<R\right>^{2}}{2\pi\cos\theta_{1}}\frac{F_{0}(\theta_{1},\theta_{2},\phi)}{(\cos{\theta_{1}}+\cos{\theta_{2}})^{2}}\frac{2\pi^{2}T^{2}}{g\lambda^{2}}\e^{-\frac{(v_{x}^{2}+v_{y}^{2})T^{2}}{4g}}\end{eqnarray}

Introducing $x=\cos\theta_{2}$ and $y=\cos\theta_{1},$ we have

$$F_{0}(x,y,\phi)=\left(1+xy-\sqrt{1-y^{2}}\sqrt{1-x^{2}}\cos\phi\right)^{2},$$
and
$$g=k^{2}\sigma^{2}(x+y)^{2}.$$

So

\begin{eqnarray}
\der{P_{2}}{\Omega}&=&P_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{F_{0}(x,y,\phi)}{(x+y)^{4}}\tau^{2}\e^{-\frac{(v_{x}^{2}+v_{y}^{2})\tau^{2}}{4k^{2}(x+y)^{2}}}\end{eqnarray}

in which $\tau=\frac{T}{\sigma}$
and

$$v_{x}^{2}+v_{y}^{2}=k^{2}\left(\sin\theta_{1}^{2}+\sin\theta_{2}^{2}-2\cos\phi\sin\theta_{1}\sin\theta_{2}\right)=k^{2}\left(2-x^{2}-y^{2}-2\cos\phi\sqrt{1-x^{2}}\sqrt{1-y^{2}}\right)$$

In terms of 

$$h(x,y)=\sqrt{1-(x^{2}+y^{2})+x^{2}y^{2}},$$
we have
$$v_{x}^{2}+v_{y}^{2}=k^{2}\left(2-x^{2}-y^{2}-2h(x,y)\cos\phi\right)$$

Then

$$F_{0}(x,y,\phi)=\left(1+xy-h(x,y)\cos\phi\right)^{2}=(1+xy)^{2}(1-a\cos\phi)^{2}$$

$$\frac{(v_{x}^{2}+v_{y}^{2})\tau^{2}}{4k^{2}(x+y)^{2}}=\frac{\left(2-x^{2}-y^{2}-2h(x,y)\cos\phi\right)\tau^{2}}{4(x+y)^{2}}=\frac{\left(2-x^{2}-y^{2}\right)\tau^{2}}{4(x+y)^{2}}-b\cos\phi$$

with
$$a=\frac{h(x,y)}{1+xy},$$
and
$$b=\frac{2h(x,y)\tau^{2}}{4(x+y)^{2}}$$
Then
\begin{eqnarray}\der{P_{2}}{\Omega}
&=&P_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{(1+xy)^{2}}{(x+y)^{4}}\tau^{2}\e^{-\frac{(2-x^{2}-y^{2})\tau^{2}}{4(x+y)^{2}}}(1-a\cos\phi)^{2}\e^{b\cos\phi}\end{eqnarray}

%-----------------------------------------------
\subsubsection{Large g and tau limit}
For $g\gg 1$,

\begin{eqnarray}
\der{P_{2}}{\Omega}&=&P_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{F_{0}(x,y,\phi)}{(x+y)^{4}}\tau^{2}\e^{-\frac{(v_{x}^{2}+v_{y}^{2})\tau^{2}}{4k^{2}(x+y)^{2}}}\end{eqnarray}

For $\tau\gg 1$, this will be very close to zero except when $v_{x}^{2}+v_{y}^{2}\sim0$, which is the specular direction. Close to the specular direction, we have

$$v_{x}^{2}+v_{y}^{2}\approx k^{2}\left(\phi^{2}(1-x^{2})+(x-y)^{2}\frac{x^{2}}{1-x^{2}}\right),$$

so

$$\frac{(v_{x}^{2}+v_{y}^{2})\tau^{2}}{4k^{2}(x+y)^{2}}=\frac{\tau^{2}}{4(x+y)^{2}}\left(\phi^{2}(1-x^{2})+(x-y)^{2}\frac{x^{2}}{1-x^{2}}\right)$$

Then we use

$$\delta(x)=\lim_{\epsilon\rightarrow 0}\frac{1}{2\sqrt{\pi\epsilon}}\e^{-x^{2}/(4\epsilon)}.$$

So, with $$\epsilon=\frac{(x+y)^{2}}{\tau^{2}(1-x^{2})},$$
when $\tau\gg 1$, 
$$\e^{-\frac{\tau^{2}}{4(x+y)^{2}}\phi^{2}(1-x^{2})}\approx 2\sqrt{\pi}\frac{(x+y)}{\tau\sqrt{1-x^{2}}}\delta(\phi).$$
and
 with $$\epsilon=\frac{(x+y)^{2}(1-x^{2})}{\tau^{2}x^{2}},$$
when $\tau\gg 1$, 
$$\e^{-\frac{\tau^{2}}{4(x+y)^{2}(1-x^{2})}(x-y)^{2}x^{2}}\approx 2\sqrt{\pi}\sqrt{1-x^{2}}\frac{(x+y)}{x\tau}\delta(x-y).$$
so when $\tau\gg 1$, 

\begin{eqnarray}
\der{P_{2}}{\Omega}&=&P_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{F_{0}(x,y,\phi)}{(x+y)^{4}}\tau^{2}2\sqrt{\pi}\frac{(x+y)}{\tau\sqrt{1-x^{2}}}\delta(\phi)2\sqrt{\pi}\sqrt{1-x^{2}}\frac{(x+y)}{x\tau}\delta(x-y)\\
&=&P_{0}\frac{\left<R\right>^{2}}{xy}\frac{F_{0}(x,y,\phi)}{(x+y)^{2}}\delta(\phi)\delta(x-y)
\end{eqnarray}
For $\phi\approx 0$ and $x\approx y$, 
$$F_{0}(x,y,\phi)\approx\left(2y^{2}\right)^{2}=4y^{4},$$
so

\begin{eqnarray}
\der{P_{2}}{\Omega}
&=&P_{0}\frac{\left<R\right>^{2}}{y^{2}}\frac{4y^{4}}{4y^{2}}\delta(\phi)\delta(x-y)=P_{0}\left<R\right>^{2}\delta(\phi)\delta(x-y).
\end{eqnarray}

which corresponds to all scattering in the specular direction.


%-----------------------------------------------
\subsection{Gaussian Autocorrelation: Probability Distributions}

The differential probability, normalized to the total power, may be interpreted as the joint probability distribution of a photon scattering at an angle $\theta_{2}$ and $\phi$.  Thus, in terms of $x=\cos\theta_{2}$ and $\phi,$ the diffuse scattering joint probability distribution is

\begin{eqnarray}
 P(x,\phi)&=&
N_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{(1+xy)^{2}(1-a\cos\phi)^{2}}{(x+y)^{4}}g\e^{-g}\tau^{2}\sum_{m=1}^{\infty}X_{m}(x,y,\phi)
\end{eqnarray}

$N_{0}$ is chosen such that
$$1=\int_{0}^{2\pi}d\phi\int_{0}^{1}dxP(x,\phi).$$



%-----------------------------------------------
\subsubsection{Marginal probability distribution in x}

\begin{eqnarray}
P_{x}(x)=\int_{0}^{2\pi}d\phi P(x,\phi)&=&
\int_{0}^{2\pi}d\phi N_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{(1+xy)^{2}(1-a\cos\phi)^{2}}{(x+y)^{4}}g\e^{-g}\tau^{2}\sum_{m=1}^{\infty}X_{m}(x,y,\phi)
\end{eqnarray}

with
$$X_{m}(x,y,\phi)=\frac{g^{m}}{m!m}\e^{-\frac{\left(2-x^{2}-y^{2}\right)\tau^{2}g}{4m(x+y)^{2}}}\e^{b_{m\cos\phi}}$$
and
with
$$a=\frac{h(x,y)}{1+xy},$$
and
$$b_{m}=\frac{2h(x,y)\tau^{2}g}{4m(x+y)^{2}}$$


$$g=\sigma^{2}k^{2}(x+y)^{2}=r^{2}(x+y)^{2},$$ and $$r=k\sigma,$$ $$s=kT=k\tau\sigma=r\tau$$


Then

\begin{eqnarray}
P_{x}(x)=\int_{0}^{2\pi}d\phi P(x,\phi)&=&
\int_{0}^{2\pi}d\phi N_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{(1+xy)^{2}(1-a\cos\phi)^{2}}{(x+y)^{2}}s^{2}\e^{-r^{2}(x+y)^{2}}\sum_{m=1}^{\infty}X_{m}(x,y,\phi)
\end{eqnarray}

with
$$X_{m}(x,y,\phi)=\frac{r^{2m}(x+y)^{2m}}{m!m}\e^{-\frac{\left(2-x^{2}-y^{2}\right)s^{2}}{4m}}\e^{b_{m}\cos\phi}$$
and
with
$$a=\frac{h(x,y)}{1+xy},$$
and
$$b_{m}=\frac{h(x,y)s^{2}}{2m}$$



Then we use

$$\e^{z\cos\phi}=I_{0}(z)+2\sum_{k=1}^{\infty}I_{k}(z)\cos k\phi.$$
So
\begin{eqnarray}
\int_{0}^{\phi}d\phi'\left(1-a\cos\phi' \right)^{2}\e^{b\cos\phi'}&=&
r_{0}(a,\phi)I_{0}(b)+2r_{1}(a,\phi)I_{1}(b)+2r_{2}(a,\phi)I_{2}(b)+2\sum_{k=3}^{\infty}r_{k}(a,\phi)I_{k}(b)
\end{eqnarray}
in which
$$r_{0}(a,\phi)=(1+a^{2}/2)\phi-2a\sin\phi+(a^{2}/4)\sin2\phi$$
$$r_{1}(a,\phi)=-a\phi+(1+3a^{2}/4)\sin\phi-a\cos\phi\sin\phi+(a^{2}/12)\sin3\phi$$
$$r_{2}(a,\phi)=(a^{2}/4)\phi+\frac{12(2+a^{2})\sin2\phi-16a\sin3\phi+3a^{2}\sin4\phi}{48}$$
$$r_{k}(a,\phi)=\frac{2a\cos k\phi\sin\phi}{k^{2}-1}-2a\cos\phi\left(\frac{a\cos k\phi\sin\phi}{k^{2}-4}+\frac{k\sin k\phi}{k^{2}-1}\right)+\sin k\phi\frac{(2+a^{2})(k^{2}-4)+a^{2}k^{2}\cos2\phi}{2k(k^{2}-4)}$$

Then, we have

$$r_{0}(a,2\pi)=(1+a^{2}/2)2\pi$$
$$r_{1}(a,2\pi)=-2a\pi$$
$$r_{2}(a,2\pi)=(a^{2}/2)\pi$$
$$r_{k}(a,2\pi)=0$$

so
\begin{eqnarray}
\int_{0}^{2\pi}d\phi'\left(1-a\cos\phi' \right)^{2}\e^{b\cos\phi'}&=&
\pi\left((2+a^{2})I_{0}(b)-4aI_{1}(b)+a^{2}I_{2}(b)\right)\\
&=&
2\pi\left((1+a^{2})I_{0}(b)-\frac{a(a+2b)I_{1}(b)}{b}\right)
\end{eqnarray}

For very large $b$,
$$I_{0}(b)\approx I_{1}(b)\approx\frac{\e^{b}}{\sqrt{2\pi b}}$$ so the integral is

$$\int_{0}^{2\pi}d\phi'\left(1-a\cos\phi' \right)^{2}\e^{b\cos\phi'}\approx 2\pi(1+a^{2}-2a)\frac{\e^{b}}{\sqrt{2\pi b}}=(1-a)^{2}\e^{b}\sqrt{\frac{2\pi}{ b}}$$
so
$$P_{x}(x)=G(x,y)\sum_{m=1}^{\infty}F_{m}(x,y)$$
in which
\begin{eqnarray}
G(x,y)&=&N_{0}\frac{\left<R\right>^{2}}{2y}\frac{(1+xy)^{2}\e^{-r^{2}(x+y)^{2}}}{(y+x)^{2}}
s^{2}
\end{eqnarray}

\begin{eqnarray}
F_{m}(x,y)&=&\frac{r^{2m}(x+y)^{2m}}{m!m}\e^{-\frac{\left(2-x^{2}-y^{2}\right)s^{2}}{4m}}\left((1+a^{2})I_{0}(b_{m})-\frac{a(a+2b_{m})I_{1}(b_{m})}{b_{m}}\right)
\end{eqnarray}
For $x=1$ or $y=1$, $b_{m}=0$ and

\begin{eqnarray}
F_{m}(x,y)&=&\frac{r^{2m}(x+y)^{2m}}{m!m}\e^{-\frac{\left(2-x^{2}-y^{2}\right)s^{2}}{4m}}(1+a^{2})
\end{eqnarray}


To handle large quantities:
Let $$I_{k}(x)=\frac{\e^{x}}{\sqrt{2\pi x}}Z_{k}(x).$$

Then
\begin{eqnarray}
I_{k}(b_{m})\e^{-\frac{\left(2-x^{2}-y^{2}\right)s^{2}}{4m}}&=&\frac{1}{\sqrt{2\pi b_{m}}}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\right)s^{2}}{4m}}Z_{k}(b_{m})
\end{eqnarray}

and
\begin{eqnarray}
F_{m}(x,y)&=&\frac{r^{2m}(x+y)^{2m}}{m!m\sqrt{2\pi b_{m}}}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\right)s^{2}}{4m}}\left((1+a^{2})Z_{0}(b_{m})-\frac{a(a+2b_{m})Z_{1}(b_{m})}{b_{m}}\right)
\end{eqnarray}

For $x=1$ or $y=1$
\begin{eqnarray}
F_{m}(x,y)&=&\frac{r^{2m}(x+y)^{2m}}{m!m}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\right)s^{2}}{4m}}(1+a^{2})
\end{eqnarray}



\paragraph{Large $g$ limit}

With
$$a=\frac{h(x,y)}{1+xy},$$
and
$$b=\frac{2h(x,y)\tau^{2}}{4(x+y)^{2}}$$
the power is
\begin{eqnarray}\der{P_{2}}{\Omega}
&=&P_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{(1+xy)^{2}}{(x+y)^{4}}\tau^{2}\e^{-\frac{(2-x^{2}-y^{2})\tau^{2}}{4(x+y)^{2}}}(1-a\cos\phi)^{2}\e^{b\cos\phi}\end{eqnarray}

so

\begin{eqnarray}
P_{x}(x)&=&N_{0}\frac{\left<R\right>^{2}}{2y}\frac{(1+xy)^{2}}{(x+y)^{4}}\tau^{2}\e^{-\frac{(2-x^{2}-y^{2})\tau^{2}}{4(x+y)^{2}}}\left((1+a^{2})I_{0}(b)-\frac{a(a+2b)I_{1}(b)}{b}\right)
\end{eqnarray}

Using

\begin{eqnarray}
I_{k}(b)\e^{-\frac{\left(2-x^{2}-y^{2}\right)\tau^{2}}{4(x+y)^{2}}}&=&\frac{1}{\sqrt{2\pi b}}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\right)\tau^{2}}{4(x+y)^{2}}}Z_{k}(b)
\end{eqnarray}

in terms of $Z$:

\begin{eqnarray}
P_{x}(x)&=&N_{0}\frac{\left<R\right>^{2}}{2y}\frac{(1+xy)^{2}\tau^{2}}{(x+y)^{4}\sqrt{2\pi b}}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\right)\tau^{2}}{4(x+y)^{2}}}\left((1+a^{2})Z_{0}(b)-\frac{a(a+2b)Z_{1}(b)}{b}\right)
\end{eqnarray}

For $x=1$ or $y=1$

\begin{eqnarray}
P_{x}(x)&=&N_{0}\frac{\left<R\right>^{2}}{2y}\frac{(1+xy)^{2}\tau^{2}}{(x+y)^{4}}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\right)\tau^{2}}{4(x+y)^{2}}}(1+a^{2})
\end{eqnarray}

\paragraph{Small $g$ limit}

For $g\ll 1$, we have

\begin{eqnarray}
P(x,\phi)
&\approx&P_{0}\frac{\left<R\right>^{2}}{4\pi y}(1+xy)^{2}\left(1-a\cos\phi\right)^{2}\tau^{2}k^{4}\sigma^{4}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\cos\phi\right)T^{2}k^{2}}{4}.}
\end{eqnarray}

so

\begin{eqnarray}
P_{x}(x)=\int_{0}^{2\pi}d\phi P(x,\phi)&=& N_{0}\frac{\left<R\right>^{2}}{4\pi y}(1+xy)^{2}r^{2}s^{2}\e^{-\frac{\left(2-x^{2}-y^{2}\right)s^{2}}{4}}
\int_{0}^{2\pi}d\phi\left(1-a\cos\phi\right)^{2}\e^{b_{s}\cos\phi}
\end{eqnarray}
in which
$$r=k\sigma,\;\;s=kT,$$
and
$$b_{s}=\frac{s^{2}h(x,y)}{2}.$$

Then we use

\begin{eqnarray}
\int_{0}^{2\pi}d\phi'\left(1-a\cos\phi' \right)^{2}\e^{b\cos\phi'}&=&
2\pi\left((1+a^{2})I_{0}(b)-\frac{a(a+2b)I_{1}(b)}{b}\right)\\
&=&\frac{\e^{b}}{\sqrt{2\pi b}}2\pi\left((1+a^{2})Z_{0}(b)-\frac{a(a+2b)Z_{1}(b)}{b}\right)
\end{eqnarray}

So

\begin{eqnarray}
P_{x}(x)&=& N_{0}\frac{\left<R\right>^{2}}{2 y\sqrt{2\pi b_{s}}}(1+xy)^{2}r^{2}s^{2}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\cos\phi\right)s^{2}}{4}}
\left((1+a^{2})Z_{0}(b_{s})-\frac{a(a+2b_{s})Z_{1}(b_{s})}{b_{s}}\right)
\end{eqnarray}

For $x=1$ or $y=1$

\begin{eqnarray}
P_{x}(x)&=& N_{0}\frac{\left<R\right>^{2}}{2 y}(1+xy)^{2}r^{2}s^{2}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\cos\phi\right)s^{2}}{4}}
(1+a^{2})
\end{eqnarray}

%-----------------------------------------------
\subsubsection{cumulative probability distribution in phi}
We have

$$C_{\phi}(\phi)=\frac{1}{P_x(x)}\int_{0}^{\phi}d\phi'P(x,\phi'),$$

\begin{eqnarray}
P(x,\phi)&=&
 N_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{(1+xy)^{2}(1-a\cos\phi)^{2}}{(x+y)^{2}}s^{2}\e^{-r^{2}(x+y)^{2}}\sum_{m=1}^{\infty}X_{m}(x,y,\phi)
\end{eqnarray}

with
$$X_{m}(x,y,\phi)=\frac{r^{2m}(x+y)^{2m}}{m!m}\e^{-\frac{\left(2-x^{2}-y^{2}\right)s^{2}}{4m}}\e^{b_{m}\cos\phi}$$
and
with
$$a=\frac{h(x,y)}{1+xy},$$
and
$$b_{m}=\frac{h(x,y)s^{2}}{2m}$$



Then we use

$$\e^{z\cos\phi}=I_{0}(z)+2\sum_{k=1}^{\infty}I_{k}(z)\cos k\phi.$$
So
\begin{eqnarray}
\int_{0}^{\phi}d\phi'\left(1-a\cos\phi' \right)^{2}\e^{b\cos\phi'}&=&
r_{0}(a,\phi)I_{0}(b)+2r_{1}(a,\phi)I_{1}(b)+2r_{2}(a,\phi)I_{2}(b)+2\sum_{k=3}^{\infty}r_{k}(a,\phi)I_{k}(b)
\end{eqnarray}
in which
$$r_{0}(a,\phi)=(1+a^{2}/2)\phi-2a\sin\phi+(a^{2}/4)\sin2\phi$$
$$r_{1}(a,\phi)=-a\phi+(1+3a^{2}/4)\sin\phi-a\cos\phi\sin\phi+(a^{2}/12)\sin3\phi$$
$$r_{2}(a,\phi)=(a^{2}/4)\phi+\frac{12(2+a^{2})\sin2\phi-16a\sin3\phi+3a^{2}\sin4\phi}{48}$$
$$r_{k}(a,\phi)=\frac{2a\cos k\phi\sin\phi}{k^{2}-1}-2a\cos\phi\left(\frac{a\cos k\phi\sin\phi}{k^{2}-4}+\frac{k\sin k\phi}{k^{2}-1}\right)+\sin k\phi\frac{(2+a^{2})(k^{2}-4)+a^{2}k^{2}\cos2\phi}{2k(k^{2}-4)}$$




\begin{eqnarray}
G_{m}(x,y,\phi)&=&\int_{0}^{\phi}d\phi'(1-a\cos\phi')^{2}X_{m}(x,y,\phi')\\&=&\frac{r^{2m}(x+y)^{2m}}{m!m}\e^{-\frac{\left(2-x^{2}-y^{2}\right)s^{2}}{4m}}\times\\&&\left(r_{0}(a,\phi)I_{0}(b_{m})+2r_{1}(a,\phi)I_{1}(b_{m})+2r_{2}(a,\phi)I_{2}(b_{m})+2\sum_{k=3}^{\infty}r_{k}(a,\phi)I_{k}(b_{m})\right)\end{eqnarray}

using again
\begin{eqnarray}
I_{k}(b_{m})\e^{-\frac{\left(2-x^{2}-y^{2}\right)s^{2}}{4m}}&=&\frac{1}{\sqrt{2\pi b_{m}}}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\right)s^{2}}{4m}}Z_{k}(b_{m})
\end{eqnarray}

\begin{eqnarray}
G_{m}(x,y,\phi)&=&\frac{r^{2m}(x+y)^{2m}}{m!m}\frac{1}{\sqrt{2\pi b_{m}}}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\right)s^{2}}{4m}}\times\\&&\left(r_{0}(a,\phi)Z_{0}(b_{m})+2r_{1}(a,\phi)Z_{1}(b_{m})+2r_{2}(a,\phi)Z_{2}(b_{m})+2\sum_{k=3}^{\infty}r_{k}(a,\phi)Z_{k}(b_{m})\right)\end{eqnarray}

so

$$C_{\phi}(\phi)=\frac{1}{P_x(x)}\frac{\left<R\right>^{2}}{4\pi y}\frac{(1+xy)^{2}}{(x+y)^{2}}s^{2}\e^{-r^{2}(x+y)^{2}}\sum_{m=1}^{\infty}G_{m}(x,y,\phi)$$


For $x=1$ or $y=1$
\begin{eqnarray}
G_{m}(x,y,\phi)&=&\frac{r^{2m}(x+y)^{2m}}{m!m}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\right)s^{2}}{4m}}r_{0}(a,\phi)\end{eqnarray}

\paragraph{Large $g$ limit}

With
$$a=\frac{h(x,y)}{1+xy},$$
and
$$b=\frac{2h(x,y)\tau^{2}}{4(x+y)^{2}}$$
Then
\begin{eqnarray} P(x,\phi)
&=&N_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{(1+xy)^{2}}{(x+y)^{4}}\tau^{2}\e^{-\frac{(2-x^{2}-y^{2})\tau^{2}}{4(x+y)^{2}}}(1-a\cos\phi)^{2}\e^{b\cos\phi}\end{eqnarray}

so
\begin{eqnarray}
C_{\phi}(\phi)&=&\frac{1}{P_x(x)}\int_{0}^{\phi}d\phi'P(x,\phi')
\end{eqnarray}

define
\begin{eqnarray}
G_{0}(x,y,\phi)&=&\int_{0}^{\phi}d\phi'\e^{-\frac{(2-x^{2}-y^{2})\tau^{2}}{4(x+y)^{2}}}(1-a\cos\phi')^{2}\e^{b\cos\phi'}\\&=&\e^{-\frac{(2-x^{2}-y^{2})\tau^{2}}{4(x+y)^{2}}}\left(r_{0}(a,\phi)I_{0}(b)+2r_{1}(a,\phi)I_{1}(b)+2r_{2}(a,\phi)I_{2}(b)+2\sum_{k=3}^{\infty}r_{k}(a,\phi)I_{k}(b)\right)\\
&=&\frac{1}{\sqrt{2\pi b}}\e^{-\frac{(2-x^{2}-y^{2}-2h(x,y))\tau^{2}}{4(x+y)^{2}}}\times\\&&\left(r_{0}(a,\phi)Z_{0}(b)+2r_{1}(a,\phi)Z_{1}(b)+2r_{2}(a,\phi)Z_{2}(b)+2\sum_{k=3}^{\infty}r_{k}(a,\phi)Z_{k}(b)\right)
\end{eqnarray}

Then

\begin{eqnarray}
C_{\phi}(\phi)&=&\frac{1}{P_x(x)}N_{0}\frac{\left<R\right>^{2}}{4\pi y}\frac{(1+xy)^{2}}{(x+y)^{4}}\tau^{2}G_{0}(x,y,\phi)
\end{eqnarray}

For $x=1$ or $y=1$
\begin{eqnarray}
G_{0}(x,y,\phi)&=&\e^{-\frac{(2-x^{2}-y^{2}-2h(x,y))\tau^{2}}{4(x+y)^{2}}}r_{0}(a,\phi)
\end{eqnarray}


\paragraph{Small $g$ limit}
For $g\ll 1$, we have


\begin{eqnarray}
P_x(x)C_{\phi}(\phi)&=&\int_{0}^{\phi}d\phi' P(x,\phi')\\
&=& N_{0}\frac{\left<R\right>^{2}}{4\pi y}(1+xy)^{2}r^{2}s^{2}\e^{-\frac{\left(2-x^{2}-y^{2}\right)s^{2}}{4}}
\int_{0}^{\phi}d\phi'\left(1-a\cos\phi'\right)^{2}\e^{b_{s}\cos\phi'}
\end{eqnarray}
in which
$$r=k\sigma,\;\;s=kT,$$
and
$$b_{s}=\frac{s^{2}h(x,y)}{2}.$$

Then we use

\begin{eqnarray}
\int_{0}^{\phi}d\phi'\left(1-a\cos\phi' \right)^{2}\e^{b\cos\phi'}&=&\\
\frac{\e^{b}}{\sqrt{2\pi b}}\left(
r_{0}(a,\phi)Z_{0}(b)+2r_{1}(a,\phi)Z_{1}(b)+2r_{2}(a,\phi)I_{2}(b)+2\sum_{k=3}^{\infty}r_{k}(a,\phi)Z_{k}(b)\right)
\end{eqnarray}
So
\begin{eqnarray}
P_x(x)C_{\phi}(\phi)&=& N_{0}\frac{\left<R\right>^{2}}{4\pi y\sqrt{2\pi b_{s}}}(1+xy)^{2}r^{2}s^{2}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\cos\phi\right)s^{2}}{4}}\\
&&\left(
r_{0}(a,\phi)Z_{0}(b_{s})+2r_{1}(a,\phi)Z_{1}(b_{s})+2r_{2}(a,\phi)I_{2}(b_{s})+2\sum_{k=3}^{\infty}r_{k}(a,\phi)Z_{k}(b_{s})\right)
\end{eqnarray}

For $x=1$ or $y=1$
\begin{eqnarray}
P_x(x)C_{\phi}(\phi)&=& N_{0}\frac{\left<R\right>^{2}}{4\pi y}(1+xy)^{2}r^{2}s^{2}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\cos\phi\right)s^{2}}{4}}
r_{0}(a,\phi)\end{eqnarray}


%%%%%%


\paragraph{Large $b$}
The above expression for the integral over $\phi$ does not work very well for large values of $b$: the series does not converge very fast. For large $b$, however, the integrand  is sharply peaked near $\phi=0$ so a small angle approximation can be used:

\begin{eqnarray}
\int_{0}^{\phi}d\phi'\left(1-a\cos\phi' \right)^{2}\e^{b\cos\phi'}&=&\e^{b}\int_{0}^{\phi}d\phi'\left(1-a\cos\phi' \right)^{2}\e^{-b(1-\cos\phi')}\\
&\approx&\e^{b}\int_{0}^{\phi}d\phi'\left(1-a+a\phi'^{2}/2\right)^{2}\e^{-b\phi'^{2}/2}\end{eqnarray}

Define
\begin{eqnarray}
&&H(a,b,\phi)=\int_{0}^{\phi}d\phi'\left(1-a+a\phi'^{2}/2\right)^{2}\e^{-b\phi'^{2}/2}=\\
&&-\frac{a\phi\e^{-b\phi^{2}/2}(4b+a(3+b(\phi^{2}-4))}{4b^{2}}+\sqrt{\frac{\pi}{2}}\textrm{erf}\left(\phi\sqrt{\frac{b}{2}}\right)\frac{4a(1-2b)b+4b^{2}+a^{2}(3-4b+4b^{2})}{4b^{5/2}}\end{eqnarray}

so
$$\int_{0}^{\phi}d\phi'\left(1-a\cos\phi' \right)^{2}\e^{b\cos\phi'}\approx\e^{b}H(a,b,\phi)$$


The total integral, for $b\gg1$, is
$$\lim_{\phi\rightarrow\infty}H(a,b,\phi)\approx\sqrt{\frac{\pi}{2}}\frac{4b^{2}(1+a^{2}-2a)}{4b^{5/2}}=\sqrt{\frac{\pi}{2b}}(1-a)^{2}$$
Then

\begin{eqnarray}
G_{m}(x,y,\phi)&=&\int_{0}^{\phi}d\phi'(1-a\cos\phi')^{2}X_{m}(x,y,\phi')\\&=&\frac{r^{2m}(x+y)^{2m}}{m!m}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\right)s^{2}}{4m}}H(a,b_{m},\phi)\end{eqnarray}

and

\begin{eqnarray}
G_{0}(x,y,\phi)&=&\int_{0}^{\phi}d\phi'\e^{-\frac{(2-x^{2}-y^{2})\tau^{2}}{4(x+y)^{2}}}(1-a\cos\phi')^{2}\e^{b\cos\phi'}=\e^{-\frac{(2-x^{2}-y^{2}-2h(x,y))\tau^{2}}{4(x+y)^{2}}}H(a,b,\phi)
\end{eqnarray}

For $g\ll 1$, we have


\begin{eqnarray}
P_x(x)C_{\phi}(\phi)
&=& N_{0}\frac{\left<R\right>^{2}}{4\pi y}(1+xy)^{2}r^{2}s^{2}\e^{-\frac{\left(2-x^{2}-y^{2}\right)s^{2}}{4}}
\int_{0}^{\phi}d\phi'\left(1-a\cos\phi'\right)^{2}\e^{b_{s}\cos\phi'}
\end{eqnarray}
in which
$$r=k\sigma,\;\;s=kT,$$
and
$$b_{s}=\frac{s^{2}h(x,y)}{2}.$$

so for large $b$,

\begin{eqnarray}
P_x(x)C_{\phi}(\phi)&=& N_{0}\frac{\left<R\right>^{2}}{4\pi y}(1+xy)^{2}r^{2}s^{2}\e^{-\frac{\left(2-x^{2}-y^{2}-2h(x,y)\cos\phi\right)s^{2}}{4}}H(a,b_{s},\phi)
\end{eqnarray}

%-----------------------------------------------
\subsection{Exponential autocorrelation}

For an exponential autocorrelation function, we have
 $$C(\tau/T)=\e^{-|\tau|/T},$$
 so
 $$C(\sqrt{2}r/T)=\e^{-\sqrt{2}r/T},$$

 and
 
 \begin{eqnarray}
\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>&=&\\
4\pi A\int_{0}^{\infty} r dr\e^{-g(1-\e^{-\sqrt{2}r/T})} J_{0}(\sqrt{2}r\sqrt{v_{x}^{2}+v_{y}^{2}})\end{eqnarray}
 
For $g\gg 1$, the falloff with $r$ is extremely rapid and we can approximate

$$1-\e^{-\sqrt{2}r/T}\approx \sqrt{2}r/T.$$

 Then we have
\begin{eqnarray}
\int_{0}^{\infty} r dr\e^{-g(1-\e^{-\sqrt{2}r/T})} J_{0}(\sqrt{2}r\sqrt{v_{x}^{2}+v_{y}^{2}})&\approx&\\
\int_{0}^{\infty} r dr\e^{-\sqrt{2}gr/T} J_{0}(\sqrt{2}r\sqrt{v_{x}^{2}+v_{y}^{2}})&=&
\frac{T^{2}}{2g^{2}\left(1+\frac{T^{2}(v_{x}^{2}+v_{y}^{2})}{g^{2}}\right)^{3/2}}
\end{eqnarray}

 \begin{eqnarray}
\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>&=&
2\pi A\frac{T^{2}}{\left(1+T^{2}(v_{x}^{2}+v_{y}^{2})\right)^{3/2}}
\end{eqnarray}

For general $g$, we expand the exponential
$$\e^{-g\e^{-\sqrt{2}r/T}}=\sum_{m=0}^{\infty}g^{m}/m!\e^{-\sqrt{2}mr/T}$$
$m$th term ($m > 0$)


$$g^{m}/m!\int_{0}^{\infty} dr rJ_{0}(\sqrt{2}r\sqrt{v_{x}^{2}+v_{y}^{2}})\e^{-\sqrt{2}mr/T}= \frac{g^{m}T^{2}}{2m^{2}m!\left(1+\frac{T^{2}(v_{x}^{2}+v_{y}^{2})}{m^{2}}\right)^{3/2}}.$$



The $m=0$  term is
\begin{eqnarray}
\e^{-g} \left|2\pi\int_{0}^{a}r dr J_{0}(r\sqrt{v_{x}^{2}+v_{y}^{2}})\right|^{2}&=&\e^{-g}4\pi^{2}a^{4}\left|\frac{J_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{a\sqrt{v_{x}^{2}+v_{y}^{2}}}\right|^{2}\\
&=&\e^{-g}4a^{2}\pi A\left|\frac{J_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{a\sqrt{v_{x}^{2}+v_{y}^{2}}}\right|^{2}\end{eqnarray}

Putting it all together gives

\begin{eqnarray}
\left<\int dx dydx'dy'\e^{\imath( v_{x}(x-x')+v_{y}(y-y')+v_{z}(\xi(x,y)-\xi(x',y'))}\right>&=&\\
2\pi A\e^{-g}\left(2a^{2}\left|\frac{J_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{a\sqrt{v_{x}^{2}+v_{y}^{2}}}\right|^{2}+T^{2}\sum_{m=1}^{\infty}\frac{g^{m}/m!}{m^{2}\left(1+\frac{T^{2}(v_{x}^{2}+v_{y}^{2})}{m^{2}}\right)^{3/2}}\right)\end{eqnarray}
so the power is
\begin{eqnarray}
\der{P_{2}}{\Omega}&=&P_{0}\frac{\left<R\right>^{2}}{2\pi\cos\theta_{1}}\frac{F_{0}(\theta_{1},\theta_{2},\phi)}{(\cos{\theta_{1}}+\cos{\theta_{2}})^{2}}\times\\
&&\e^{-g}\left(2(ka)^{2}\left|\frac{J_{1}(a\sqrt{v_{x}^{2}+v_{y}^{2}})}{a\sqrt{v_{x}^{2}+v_{y}^{2}}}\right|^{2}+\frac{4\pi^{2}T^{2}}{\lambda^{2}}\sum_{m=1}^{\infty}\frac{g^{m}/m!}{m^{2}\left(1+\frac{T^{2}(v_{x}^{2}+v_{y}^{2})}{m^{2}}\right)^{3/2}}\right)\end{eqnarray}


For $g\gg 1$, the power is
\begin{eqnarray}
\der{P_{2}}{\Omega}&=&P_{0}\frac{\left<R\right>^{2}}{2\pi\cos\theta_{1}}\frac{F_{0}(\theta_{1},\theta_{2},\phi)}{(\cos{\theta_{1}}+\cos{\theta_{2}})^{2}}\frac{4\pi^{2}T^{2}}{g^{2}\lambda^{2}}\frac{1}{\left(1+\frac{T^{2}(v_{x}^{2}+v_{y}^{2})}{g^{2}}\right)^{3/2}}\\&=&
P_{0}\frac{\left<R\right>^{2}}{2\pi\cos\theta_{1}}\frac{F_{0}(\theta_{1},\theta_{2},\phi)}{(\cos{\theta_{1}}+\cos{\theta_{2}})^{6}}\frac{T^{2}}{k^{2}\sigma^{4}}\frac{1}{\left(1+\frac{T^{2}(v_{x}^{2}+v_{y}^{2})}{g^{2}}\right)^{3/2}}
\end{eqnarray}

in which
$$\frac{T^{2}(v_{x}^{2}+v_{y}^{2})}{g^{2}}=\frac{T^{2}\left(\sin\theta_{1}^{2}+\sin\theta_{2}^{2}-2\cos\phi\sin\theta_{1}\sin\theta_{2}\right)}{k^{2}\sigma^{4}(\cos{\theta_{1}}+\cos{\theta_{2}})^{4}}$$

Using $\tau=\frac{T}{\sigma}$, $x=\cos\theta_{2}$, $y=\cos\theta_{1},$ and

$$w=\frac{\tau}{\sigma k(x+y)^{2}}=\frac{\tau}{\sqrt{g}(x+y)}=\frac{\lambda T}{\sigma^{2}}\frac{1}{2\pi(x+y)^{2}}=\frac{\lambda}{\lambda_{0}}\frac{1}{2\pi(x+y)^{2}},$$
with
$$\lambda_{0}=\frac{\sigma^{2}}{T}.$$


$$\frac{T^{2}(v_{x}^{2}+v_{y}^{2})}{g^{2}}=w^{2}\left(2-x^{2}-y^{2}-2\cos\phi\sqrt{1-x^{2}}\sqrt{1-y^{2}}\right)$$

\begin{eqnarray}
\der{P_{2}}{\Omega}&=&
P_{0}\frac{\left<R\right>^{2}}{2\pi y}\frac{F_{0}(x,y,\phi)}{(x+y)^{2}}\frac{w^{2}}{\left(1+w^{2}\left(2-x^{2}-y^{2}-2\cos\phi\sqrt{1-x^{2}}\sqrt{1-y^{2}}\right)\right)^{3/2}}
\end{eqnarray}
in which

$$F_{0}(x,y,\phi)=\left(1+xy-\sqrt{1-y^{2}}\sqrt{1-x^{2}}\cos\phi\right)^{2},$$

Limits: 

$w\ll1$ implies $\lambda \ll \lambda_{0}$, then

\begin{eqnarray}
\der{P_{2}}{\Omega}&=&w^{2}
P_{0}\frac{\left<R\right>^{2}}{2\pi y}\frac{F_{0}(x,y,\phi)}{(x+y)^{2}}\end{eqnarray}

This has a $\phi$ dependence which follows that of $F_{0}$, i.e, it is peaked in the backward direction, near $\phi=\pm\pi$. However, the behavior with $w$ (i.e, vanishing in the small wavelength limit) is unphysical (eg., see \cite{b:ogilvy}, pg. 93)

$w\gg1$ implies $\lambda \gg \lambda_{0}$, then

\begin{eqnarray}
\der{P_{2}}{\Omega}&=&
P_{0}\frac{\left<R\right>^{2}}{2\pi y w}\frac{F_{0}(x,y,\phi)}{(x+y)^{2}}\frac{1}{\left(2-x^{2}-y^{2}-2\cos\phi\sqrt{1-x^{2}}\sqrt{1-y^{2}}\right)^{3/2}}\end{eqnarray}


This has a $\phi$ dependence which is peaked in the forward direction, near $\phi=0$.

%-----------------------------------------------
\subsubsection{Probability distributions}

The differential probability, normalized to the total power, may be interpreted as the joint probability distribution of a photon scattering at an angle $\theta_{2}$ and $\phi$.  Thus, in terms of $x=\cos\theta_{2}$ and $\phi,$ the diffuse scattering joint probability distribution is

\begin{eqnarray}
P(x,\phi)&=&N_{0}\frac{\left<R\right>^{2}}{2\pi\cos\theta_{1}}\frac{F_{0}(\theta_{1},x,\phi)}{(\cos{\theta_{1}}+x)^{2}}
\e^{-g}\left(\frac{4\pi^{2}T^{2}}{\lambda^{2}}\sum_{m=1}^{\infty}\frac{g^{m}/m!}{m^{2}\left(1+\frac{T^{2}(v_{x}^{2}+v_{y}^{2})}{m^{2}}\right)^{3/2}}\right)\end{eqnarray}

$$F_{0}(\theta_{1},x,\phi)=\left(1+x\cos\theta_{1}-\sin\theta_{1}\sqrt{1-x^{2}}\cos\phi\right)^{2}.$$

$$v_{x}^{2}+v_{y}^{2}=k^{2}\left(\sin\theta_{1}^{2}+1-x^{2}-2\cos\phi\sin\theta_{1}\sqrt{1-x^{2}}\right)$$

The normalization factor $N_{0}$ is introduced, so that

$$1=\int_{0}^{2\pi}d\phi\int_{0}^{1}dxP(x,\phi).$$

%-----------------------------------------------
\subsubsection{Marginal probability distribution in x}
\begin{eqnarray}
P_{x}(x)=\int_{0}^{2\pi}d\phi P(x,\phi)&=&
\int_{0}^{2\pi}d\phi N_{0}\frac{\left<R\right>^{2}}{2\pi\cos\theta_{1}}\frac{F_{0}(\theta_{1},x,\phi)}{(\cos{\theta_{1}}+x)^{2}}
\e^{-g}\left(\frac{4\pi^{2}T^{2}}{\lambda^{2}}\sum_{m=1}^{\infty}\frac{g^{m}/m!}{m^{2}\left(1+\frac{T^{2}(v_{x}^{2}+v_{y}^{2})}{m^{2}}\right)^{3/2}}\right)
\end{eqnarray}

Using $y=\cos\theta_{1},$

$$F_{0}(y,x,\phi)=\left(1+xy-\sqrt{1-y^{2}}\sqrt{1-x^{2}}\cos\phi\right)^{2}=\left(1-\cos\phi\sqrt{1-(x^{2}+y^{2})+x^{2}y^{2}}+xy\right)^{2}$$

$$g=\sigma^{2}k^{2}(x+y)^{2}=r^{2}(x+y)^{2}$$,

$$r=k\sigma.$$

$$v_{x}^{2}+v_{y}^{2}=k^{2}\left(2\left(1-\cos\phi\sqrt{1-(x^{2}+y^{2})+x^{2}y^{2}}\right)-(x^{2}+y^{2})\right)$$

Then
\begin{eqnarray}
P_{x}(x)&=&N_{0}\frac{\left<R\right>^{2}}{2\pi y}\frac{\e^{-r^{2}(x+y)^{2}}}{r^{2}(y+x)^{2}}
r^{2}s^{2}
\sum_{m=1}^{\infty}F_{m}(x,y)
\end{eqnarray}
in which
$$s=kT.$$

\begin{eqnarray} F_{m}(x,y)&=&\frac{(r(x+y))^{2m}}{m!m^{2}}\int_{0}^{2\pi}d\phi\left(1-h(x,y)\cos\phi +xy\right)^{2}\times\\
&&\left(1+\frac{s^{2}\left(2(1-h(x,y)\cos\phi )-(x^{2}+y^{2)})\right)}{m^{2}}\right)^{-3/2}
\end{eqnarray}

and

$$h(x,y)=\sqrt{1-(x^{2}+y^{2})+x^{2}y^{2}}.$$
This can be written in the form

\begin{eqnarray} F_{m}(x,y)&=&\frac{(1+xy)^{2}}{(1+(s^{2}/m^{2})(2-(x^{2}+y^{2}))^{3/2}}\int_{0}^{2\pi}d\phi\frac{\left(1-a\cos\phi \right)^{2}}{(1-b_m\cos\phi)^{3/2}},
\end{eqnarray}
in which $s=kT$ and 
$$a=\frac{h(x,y)}{1+xy},$$
and
$$b_m=\frac{2h(x,y)}{m^{2}/s^{2}+2-(x^{2}+y^{2})}$$
Also
\begin{eqnarray} F_{m}(x,y)&=&\frac{m^{3}b_{m}^{3/2}\sqrt{1+xy}}{2\sqrt{2}s^{3}a^{3/2}}\int_{0}^{2\pi}d\phi\frac{\left(1-a\cos\phi \right)^{2}}{(1-b_m\cos\phi)^{3/2}},
\end{eqnarray}


Then we use
\begin{eqnarray}
\int_{0}^{\phi}d\phi'\frac{\left(1-a\cos\phi' \right)^{2}}{(1-b_m\cos\phi')^{3/2}}&=&\\
\frac{2r_{2}(a,b_m,\phi)}{r_{1}(b_m,\phi)}+2(g_{1}(a,b_m)r_{E}(b_m,\phi)+g_{2}(a,b_m)r_{F}(b_m,\phi)).
\end{eqnarray}
in which
$$r_{1}(b,\phi)=\sqrt{\frac{1-b\cos\phi}{1-b}},$$
$$r_{2}(a,b,\phi)=\frac{(a-b)^{2}b}{b^{2}\sqrt{1-b}(1-b^{2})}\sin\phi$$
$$r_{E}(b,\phi)=E\left(\frac{\phi}{2}\left|\frac{2b}{b-1}\right.\right),$$
$$r_{F}(b,\phi)=F\left(\frac{\phi}{2}\left|\frac{2b}{b-1}\right.\right),$$
$$g_{1}(a,b)=\frac{b^{2}-2ab-a^{2}(b^{2}-2)}{b^{2}\sqrt{1-b}(1+b)}$$
$$g_{2}(a,b)=\frac{2a(b-a)}{b^{2}\sqrt{1-b}}$$

and
\begin{eqnarray}
\int_{0}^{2\pi}d\phi'\frac{\left(1-a\cos\phi' \right)^{2}}{(1-b_m\cos\phi')^{3/2}}&=&
4\left(g_{1}(a,b_m)E\left(\frac{2b_m}{b_m-1}\right)+g_{2}(a,b_m)K\left(\frac{2b_m}{b_m-1}\right)\right).
\end{eqnarray}

Here, the elliptic integrals are
$$E(\phi,m)=\int_{0}^{\phi}d\theta\sqrt{1-m\sin^{2}\theta},\;\;E(m)=E(\pi/2,m)$$
$$F(\phi,m)=\int_{0}^{\phi}\frac{d\theta}{\sqrt{1-m\sin^{2}\theta}},\;\;K(m)=F(\pi/2,m)$$

Thus, 
\begin{eqnarray} F_{m}(x,y)&=&\frac{\sqrt{2}mb_{m}^{3/2}\sqrt{1+xy}(r(x+y))^{2m}}{m!s^{3}a^{3/2}}\left(g_{1}(a,b_m)E\left(\frac{2b_m}{b_m-1}\right)+g_{2}(a,b_m)K\left(\frac{2b_m}{b_m-1}\right)\right).
\end{eqnarray}
so
$$P_{x}(x)=G(x,y)\sum_{m=1}^{\infty}F_{m}(x,y)$$
in which
\begin{eqnarray}
G(x,y)&=&N_{0}\frac{\left<R\right>^{2}}{2\pi y}\frac{\e^{-r^{2}(x+y)^{2}}}{r^{2}(y+x)^{2}}
r^{2}s^{2}
\end{eqnarray}


%-----------------------------------------------
\subsubsection{cumulative probability distribution in phi}

We have
$$C_{\phi}(\phi)=\frac{1}{P_x(x)}\int_{0}^{\phi}d\phi'P(x,\phi'),$$
in which


\begin{eqnarray}
\int_{0}^{\phi}d\phi'P(x,\phi')&=&N_{0}\frac{\left<R\right>^{2}}{2\pi y}\frac{\e^{-r^{2}(x+y)^{2}}}{r^{2}(y+x)^{2}}
r^{2}s^{2}
\sum_{m=1}^{\infty}\tilde {F}_{m}(x,y,\phi)
\end{eqnarray}

with

\begin{eqnarray} \tilde F_{m}(x,y,\phi)&=&\frac{m^{3}b_{m}^{3/2}\sqrt{1+xy}}{2\sqrt{2}s^{3}a^{3/2}}\int_{0}^{\phi}d\phi'\frac{\left(1-a\cos\phi'\right)^{2}}{(1-b_m\cos\phi')^{3/2}},
\end{eqnarray}


Then we use
\begin{eqnarray}
\int_{0}^{\phi}d\phi'\frac{\left(1-a\cos\phi' \right)^{2}}{(1-b_m\cos\phi')^{3/2}}&=&\\
\frac{2r_{2}(a,b_m,\phi)}{r_{1}(b_m,\phi)}+2(g_{1}(a,b_m)r_{E}(b_m,\phi)+g_{2}(a,b_m)r_{F}(b_m,\phi)).
\end{eqnarray}
in which
$$r_{1}(b,\phi)=\sqrt{\frac{1-b\cos\phi}{1-b}},$$
$$r_{2}(a,b,\phi)=\frac{(a-b)^{2}b}{b^{2}\sqrt{1-b}(1-b^{2})}\sin\phi$$
$$r_{E}(b,\phi)=E\left(\frac{\phi}{2}\left|\frac{2b}{b-1}\right.\right),$$
$$r_{F}(b,\phi)=F\left(\frac{\phi}{2}\left|\frac{2b}{b-1}\right.\right),$$
$$g_{1}(a,b)=\frac{b^{2}-2ab-a^{2}(b^{2}-2)}{b^{2}\sqrt{1-b}(1+b)}$$
$$g_{2}(a,b)=\frac{2a(b-a)}{b^{2}\sqrt{1-b}}$$

Thus,

$$C_{\phi}(\phi)=\frac{\sum_{m=1}^{\infty} \tilde F_{m}(x,y,\phi)}{\sum_{m=1}^{\infty} F_{m}(x,y)}$$

%-----------------------------------------------
\subsubsection{two-dimensional probability distribution}

using the notation introduced above, the two-dimensional probability distribution

\begin{eqnarray}
P(x,\phi)&=&N_{0}\frac{\left<R\right>^{2}}{2\pi\cos\theta_{1}}\frac{F_{0}(\theta_{1},x,\phi)}{(\cos{\theta_{1}}+x)^{2}}
\e^{-g}\left(\frac{4\pi^{2}T^{2}}{\lambda^{2}}\sum_{m=1}^{\infty}\frac{g^{m}/m!}{m^{2}\left(1+\frac{T^{2}(v_{x}^{2}+v_{y}^{2})}{m^{2}}\right)^{3/2}}\right)\end{eqnarray}


can be written as
$$P(x,\phi)=G(x,y)\sum_{m=1}^{\infty}H_{m}(x,y,\phi)$$
in which


\begin{eqnarray} H_{m}(x,y,\phi)&=&\frac{(r(x+y))^{2m}}{m!m^{2}}\left(1-h(x,y)\cos\phi +xy\right)^{2}\times\\
&&\left(1+\frac{s^{2}\left(2(1-h(x,y)\cos\phi )-(x^{2}+y^{2)})\right)}{m^{2}}\right)^{-3/2}
\end{eqnarray}

This is related to the derivative of the cumulative distribution function in phi via
$$\der{C_{\phi}}{\phi}=\frac{P(x,\phi)}{P_{x}(x)}.$$

%-----------------------------------------------
\subsubsection{Large g}

For $g\gg 1$, we have
\begin{eqnarray}
P(x,\phi)&=&N_{0}\frac{\left<R\right>^{2}}{2\pi\cos\theta_{1}}\frac{F_{0}(\theta_{1},x,\phi)}{(\cos{\theta_{1}}+x)^{2}}
\left(\frac{s^{2}}{g^{2}}\frac{1}{\left(1+\frac{T^{2}(v_{x}^{2}+v_{y}^{2})}{g^{2}}\right)^{3/2}}\right)\end{eqnarray}

so

\begin{eqnarray}
P_{x}(x)=\int_{0}^{2\pi}d\phi P(x,\phi)&=&
\int_{0}^{2\pi}d\phi N_{0}\frac{\left<R\right>^{2}}{2\pi\cos\theta_{1}}\frac{F_{0}(\theta_{1},x,\phi)}{(\cos{\theta_{1}}+x)^{2}}
\left(\frac{s^{2}}{g^{2}}\frac{1}{\left(1+\frac{T^{2}(v_{x}^{2}+v_{y}^{2})}{g^{2}}\right)^{3/2}}\right)\end{eqnarray}

Using $y=\cos\theta_{1},$

$$F_{0}(y,x,\phi)=\left(1+xy-\sqrt{1-y^{2}}\sqrt{1-x^{2}}\cos\phi\right)^{2}=\left(1-\cos\phi\sqrt{1-(x^{2}+y^{2})+x^{2}y^{2}}+xy\right)^{2}$$


$$v_{x}^{2}+v_{y}^{2}=k^{2}\left(2\left(1-\cos\phi\sqrt{1-(x^{2}+y^{2})+x^{2}y^{2}}\right)-(x^{2}+y^{2})\right)$$

Then
\begin{eqnarray}
P_{x}(x)&=&N_{0}\frac{\left<R\right>^{2}}{2\pi y}
r^{2}s^{2}
F_{0}(x,y)
\end{eqnarray}
in which $s=kT$, $r=k\sigma$, and 
\begin{eqnarray} F_{0}(x,y)&=&\frac{1}{r^{6}(x+y)^{6}}\int_{0}^{2\pi}d\phi\left(1-h(x,y)\cos\phi +xy\right)^{2}\times\\
&&\left(1+\frac{s^{2}\left(2(1-h(x,y)\cos\phi) -(x^{2}+y^{2)})\right)}{r^{4}(x+y)^{4}}\right)^{-3/2}
\end{eqnarray}

and

$$h(x,y)=\sqrt{1-(x^{2}+y^{2})+x^{2}y^{2}}.$$

This can be written in the form

\begin{eqnarray} F_{0}(x,y)&=&\frac{(1+xy)^{2}}{\left(r^{4}(x+y)^{4}+s^{2}(2-x^{2}-y^{2})\right)^{3/2}}\int_{0}^{2\pi}d\phi\frac{\left(1-a\cos\phi \right)^{2}}{(1-b_0\cos\phi)^{3/2}},
\end{eqnarray}
in which 
$$a=\frac{h(x,y)}{1+xy},$$
and
$$b_0=\frac{2h(x,y)}{r^{4}(x+y)^{4}/s^{2}+2-(x^{2}+y^{2})}$$
Also
\begin{eqnarray} F_{0}(x,y)&=&\frac{b_{0}^{3/2}\sqrt{1+xy}}{2\sqrt{2}s^{3}a^{3/2}}\int_{0}^{2\pi}d\phi\frac{\left(1-a\cos\phi \right)^{2}}{(1-b_0\cos\phi)^{3/2}},
\end{eqnarray}

Then
\begin{eqnarray}
\int_{0}^{2\pi}d\phi'\frac{\left(1-a\cos\phi' \right)^{2}}{(1-b_0\cos\phi')^{3/2}}&=&
4\left(g_{1}(a,b_0)E\left(\frac{2b_0}{b_0-1}\right)+g_{2}(a,b_0)K\left(\frac{2b_0}{b_0-1}\right)\right).
\end{eqnarray}
Thus, 
\begin{eqnarray} F_{0}(x,y)&=&\frac{\sqrt{2}b_{0}^{3/2}\sqrt{1+xy}}{s^{3}a^{3/2}}\left(g_{1}(a,b_0)E\left(\frac{2b_0}{b_0-1}\right)+g_{2}(a,b_0)K\left(\frac{2b_0}{b_0-1}\right)\right).
\end{eqnarray}
so
\begin{eqnarray}
P_{x}(x)&=&N_{0}\frac{\left<R\right>^{2}}{2\pi y}
r^{2}s^{2}
F_{0}(x,y)
\end{eqnarray}

In this case, the cumulative probability distribution in $\phi$ is 
  $$C_{\phi}(\phi)=\frac{\tilde F_{0}(x,y,\phi)}{ F_{0}(x,y)},$$
with
\begin{eqnarray}
\tilde F_{0}(x,y,\phi)&=&\frac{b_{0}^{3/2}\sqrt{1+xy}}{2\sqrt{2}s^{3}a^{3/2}}\left(
\frac{2r_{2}(a,b_0,\phi)}{r_{1}(b_0,\phi)}+2(g_{1}(a,b_0)r_{E}(b_0,\phi)+g_{2}(a,b_0)r_{F}(b_0,\phi))\right).
\end{eqnarray}

The two-dimensional probability distribution is then
\begin{eqnarray}
P(x,\phi)&=&N_{0}\frac{\left<R\right>^{2}}{2\pi y}
r^{2}s^{2}
H_{0}(x,y)
\end{eqnarray}
in which
\begin{eqnarray} H_{0}(x,y)&=&\frac{1}{r^{6}(x+y)^{6}}\left(1-h(x,y)\cos\phi +xy\right)^{2}\times\\
&&\left(1+\frac{s^{2}\left(2(1-h(x,y)\cos\phi) -(x^{2}+y^{2})\right)}{r^{4}(x+y)^{4}}\right)^{-3/2}
\end{eqnarray}

%-----------------------------------------------
\subsection{Average reflectivity}

The reflectivity is a function of the incident angle relative to a
tangent plane of the local rough surface. If the incident polar angle
is $\theta_{1}$, then the incident grazing angle is
  $$\gamma_{1}=\pi/2-\theta_{1}$$
Let the angle of the tangent plane relative to the $x-y$ plane be
$\beta$. Then, for radiation striking the slopes of the rough surface,
the grazing angle relative to this plane is
  $$\gamma=\gamma_{1}+\beta.$$

Local grazing incidence corresponds to $$\gamma=0\Rightarrow \beta=-\gamma_{1}.$$

Slope values of $\beta <-\gamma_{1}$ are ``shadowed'' and cannot contribute to scattering.

$\psi(\beta)$ is the normalized distribution function of tangent plane
angles. For a Gaussian autocorrelation function, this is a Gaussian
  $$\psi(\beta)=N\e^{-\beta^{2}/(2\sigma_{\beta}^{2})}$$
with
  $$\sigma_{\beta}=\sqrt{2}\sigma/T.$$

The normalization constant is chosen such that 

$$\int_{-\gamma_{1}}^{\infty}d\beta\psi(\beta)=1$$

The restricted lower limit is due to the fact that slopes with $\beta
<-\gamma_{1}$ cannot contribute to scattering.  The result for $N$ is
$$N=\sqrt{\frac{2}{\pi}}\frac{1}{\sigma_{\beta}
\left(1+\textrm{erf}\left(\frac{\gamma_{1}}{\sqrt{2}\sigma_{\beta}}\right)\right)}.$$

The average reflectivity is then
  $$\left<R\right>(\gamma_{1})=\int_{0}^{\infty} d\gamma R(\gamma)\psi(\gamma-\gamma_{1})$$
Then
  \begin{eqnarray}
\left<R\right>(\gamma_{1})&=&
\sqrt{\frac{2}{\pi}}\frac{1}{\sigma_{\beta}\left(1+\textrm{erf}
\left(\frac{\gamma_{1}}{\sqrt{2}\sigma_{\beta}}\right)\right)}
\int_{0}^{\infty} d\gamma R(\gamma)\e^{-(\gamma-\gamma_{1})^{2}/2\sigma_{\beta}^{2}}\\
  \end{eqnarray}


For grazing incidence, $\gamma_{1}=0$,
$$\left<R\right>(0)=
\sqrt{\frac{2}{\pi}}\frac{1}{\sigma_{\beta}}\int_{0}^{\infty} d\gamma R(\gamma)\e^{-\gamma^{2}/(2\sigma_{\beta}^{2})}$$

For example, if the reflectivity is a constant $R$ for $\gamma<\gamma_{max}$, and is zero for other $\gamma$, then
  $$\left<R\right>(\gamma_{1})=
\frac{\left(\textrm{erf}\left(\frac{\gamma_{max}-\gamma_{1}}{\sqrt{2}\sigma_{\beta}}\right)+
\textrm{erf}\left(\frac{\gamma_{1}}{\sqrt{2}\sigma_{\beta}}\right)\right)}{1+\textrm{erf}
\left(\frac{\gamma_{1}}{\sqrt{2}\sigma_{\beta}}\right)}$$

%------------------------------------------------------------------
\section{Default Reflectivity Tables.}
\label{s:dflt.reflect}

  \begin{figure}
  \centering
  \includegraphics[width=5in]{Layered_Mirror_Reflectivity.pdf}
  \caption[Input parameters for the default reflectivity curves.]
  {
Input parameters for the default reflectivity curves used by \srthree.
  }
\label{f:reflect}
  \end{figure}

The default reflectivity used by \srthree is based on a calculation
for a 10 nm C film on an Al substrate. Figure~\ref{f:reflect} shows
the parameters used to generate the reflectivity tables. The tables
are from the LBNL X-ray data base found at:
\begin{example}
  http://henke.lbl.gov/optical_constants/layer2.html
\end{example}

The polarization choice, $P=-1$, was made since this corresponds to the
polarization direction of the direct synchrotron radiation striking
the chamber surface, on the first encounter. It is probably not really
correct for subsequent scatterings. However the polarization
dependence of the reflectivity is not very strong.

The default surface roughness for diffuse scattering is 200~nm and the
default surface roughness correlation length is 5.5~$\mu$m. These
values can be modified by setting \vn{surface_roughness_rms} and
\vn{roughness_correlation_len} in the master input file
(\sref{s:master}).

%------------------------------------------------------------------
\begin{thebibliography}{9}

\bibitem{b:henke} 
B.L. Henke, E.M. Gullikson, and J.C. Davis. X-ray
interactions: photoabsorption, scattering, transmission, and
reflection at E=50-30000 eV,=1-92, Atomic Data and Nuclear Data
Tables Vol. 54 (no.2), 181-342 (July 1993) {\tt
http://henke.lbl.gov/optical\_constants/}

\bibitem{b:synrad3d}
 G.Dugan and D.Sagan, ``SYNRAD3D: Photon Propagation and Scattering Simulations,''
49th ICFA Advanced Beam Dynamics Workshop on Electron Cloud Physics, Proc. ``ECLOUD13'' (2013).

\bibitem{b:beckmann}
P.~Beckmann \& A.~Spizzichino, \emph{The Scattering of Electromagnetic Waves
  from Rough Surfaces}, Pergamon Press, New York (1963).

\bibitem{b:ogilvy}
J.~A. Ogilvy, \emph{Theory of Wave Scattering from Random Rough Surfaces},
  Hilger, Bristol (1993).

\bibitem{b:bmad}
D. Sagan,
``Bmad: A Relativistic Charged Particle Simulation Library''
Nuc.\ Instrum.\ \& Methods Phys.\ Res.\ A, {\bf 558}, pp 356-59 (2006).

\bibitem{b:mehne}
N. Mahne et. al., ``Experimental Determination of ECLOUD Simulation Input
Parameters for DA$\Phi$NE'', EuroTev-Report-2005-013 (2005).

\bibitem{b:jackson} J. D. Jackson,
\emph{Classical Electromagnetism}, third edition, Wiley, New York (1999)

\end{thebibliography}
\end{document}  
