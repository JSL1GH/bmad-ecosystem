\documentclass[11pt]{article}
\usepackage{geometry}            % See geometry.pdf to learn the layout options. There are lots.
\usepackage{xspace}
\geometry{letterpaper}           % ... or a4paper or a5paper or ... 
%\usepackage[parfill]{parskip}   % To begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{alltt}
\usepackage[T1]{fontenc}   % so _, <, and > print correctly in text.
\usepackage[strings]{underscore}    % to use "_" in text
\usepackage{hyperref}

%---------------------------------------------------------------------------------

\newcommand{\sref}[1]{$\S$\ref{#1}}
\newcommand{\srthree}{\texttt{SYNRAD3D}\xspace}
\newcommand\ttcmd{\begingroup\catcode`\_=11 \catcode`\%=11 \dottcmd}
\newcommand\dottcmd[1]{\texttt{#1}\endgroup}
\newcommand{\Begineq}{\begin{equation}}
\newcommand{\Endeq}{\end{equation}}
\newcommand{\fig}[1]{Figure~\ref{#1}}
\newcommand{\vn}{\ttcmd}           
\newcommand{\Th}{$^{th}$\xspace}
\newcommand{\Newline}{\hfil \\}

\newlength{\dPar}
\newlength{\ExBeg}
\newlength{\ExEnd}
\setlength{\dPar}{1.5ex}
\setlength{\ExBeg}{-\dPar}
\addtolength{\ExBeg}{-0.5ex}
\setlength{\ExEnd}{-\dPar}
\addtolength{\ExEnd}{-0.0ex}

\newenvironment{example}
  {\vspace{\ExBeg} \begin{alltt}}
  {\end{alltt} \vspace{\ExEnd}}

%---------------------------------------------------------------------------------

\setlength{\textwidth}{6.25in}
\setlength{\hoffset}{0.0in}
\setlength{\oddsidemargin}{0.25in}
\setlength{\evensidemargin}{0.0in}
\setlength{\textheight}{8.5in}
\setlength{\topmargin}{0in}

\setlength{\parskip}{\dPar}
\setlength{\parindent}{0ex}

%---------------------------------------------------------------------------------

\title{ \srthree information}
\author{G. Dugan, D. Sagan}
\date{June 22, 2010}

\begin{document}
\maketitle

%------------------------------------------------------------------
\section{Introduction} 

\srthree is a program which simulates
the production and scattering of synchrotron radiation generated by an
electron beam in a high energy machine. The program was written by David
Sagan of Cornell University.

The principal motivation for this simulation is to estimate the
distribution of photon absorption sites around the vacuum chamber as a
function of longitudinal position in the machine. This information is
then input to simulation programs such as \vn{POSINST} and
\vn{ECLOUD}, which simulate photoelectron production in various
magnetic environments, which seeds the formation of the electron
cloud.

\srthree is not to be confused with an older program called
\vn{SYNRAD}. The \vn{SYNRAD} program is used for calculating
wall heating from the primary beam.  \vn{SYNRAD} only tracks
photons in the horizontal plane and does not simulate scattering of
the photons from the wall. The advantage of \vn{SYNRAD} is that it
is fast and directly gives wall heating numbers. The advantage of
\srthree is that it tracks photons in three dimensions and it does
simulate scattering from the wall.

Syntax for invoking \srthree:
\begin{example}
  synrad3d \{-cross | -rcross | -norm | -reflect | -xs | -ys\} \{<main_input_file_name>\}
\end{example}
Examples:
\begin{example}
  synrad3d my_input_file.init
  synrad3d -cross my_input_file.init
\end{example}

\srthree has two optional command line arguments. 
The first optional argument may be one of
\begin{example}
  -cross
  -rcross
  -norm
  -reflect
  -xs
  -yx
\end{example}
The \vn{-reflect} option is for viewing photon reflection curves.  The
\vn{-cross} option is for viewing of wall cross-sections at any point
in the machine. The \vn{-rcross} option is like \vn{-cross} except the
$x$-axis is flipped. The \vn{-norm} option is like \vn{-cross} except,
in addition, a number of line segments normal to the wall are
additionally plotted. The \vn{-xs} option plots the wall outline in
the $x$-$s$ plane at $y = 0$. The \vn{-ys} option plots the wall
outline in the $y$-$s$ plane at $x = 0$. These four plot options are
just for diagnostic purposes. When a plot option is given, no photon
tracking is done and instead a plot window is displayed and \srthree
will ask for the appropriate parameters for making a plot.

The \vn{<main_input_file_name>} optional argument is used to set the
main input file name. The default is ``\vn{synrad3d.init}''. 


%------------------------------------------------------------------------
\section{Simulation technique and physics models}
\subsection{Simulation technique} 

The \srthree program is based on the Monte
Carlo method. A section of the machine (which may be the complete machine)
is designated for photon generation.

The total number of photons generated is set by the user. \srthree
calculates how many photons need to be generated within each machine
element. \srthree then slices up each element longitudinally and
generates photons from each slice. The number of photons generated in
a slice weighted by the local probability of photon emission, which
depends on the instantaneous orbit curvature. A transverse location
and angle is selected for the photon generation which mirrors the
transverse distribution of the beam.

A photon is generated with a randomly chosen direction (relative to
the direction of the beam particle) and energy. The directions and
energies follow a distribution based on the standard synchrotron
radiation formulas. The photon is tracked from the point of origin to
the point at which it hits the vacuum chamber wall. The angle of
incidence relative to the local normal to the vacuum chamber is
computed. A scattering probability is computed, based on this angle
and the photon's energy. Depending on the value of this probability,
the photon is either absorbed at this location, or scattered. If it is
scattered, the scattering is taken to be specular (angle of reflection
equals angle of incidence) and elastic (photon energy does not
change).

The photon is then tracked to the next encounter with the vacuum
chamber wall, and the probability of scattering is again
computed. This process continues until the photon is absorbed.

%------------------------------------------------------------------
\subsection{Photon generation}

Photon generation is based on the standard synchrotron radiation
formulas, applicable for dipoles quadrupoles, and wigglers. The
radiation is assumed to be incoherent, so this program cannot treat
undulator radiation. Polarization of the photon is ignored.

The finite dimensions of the electron beam (both in position and
angle) are included in the simulation when the photon is
generated. One of the inputs to \srthree is the model lattice
to use and the simulation uses the lattice to compute the
variation of the beam size around the lattice, including dispersive
effects, is included. The ``wiggle" variation in the reference orbit
in a wiggler is included.

Typically the beam will not have a closed orbit distortion relative to
the reference orbit, but if one is included in the lattice, then
radiation due to the orbit distortion, for example, in a quadrupole,
is included.  

\begin{figure}[tb]
\begin{center}
\includegraphics[width=5in]{reflectivity_4nm.png}
\caption{Reflectivity vs. energy for several grazing angles. 
Points shown are a measurement from INFN~\cite{b.mehne}}
\label{f:reflect}
\end{center}
\end{figure}

%------------------------------------------------------------------
\subsection{Photon scattering} 

Photon scattering from the vacuum chamber wall is treated as purely
specular, with a scattering probability which depends on the photon
energy and polar angle with respect to the chamber normal at the point
of incidence.

The scattering probabilities are taken from an X-ray scattering
database at LBNL~\cite{b.henke}. The scattering probabilities depend on
the material of which the vacuum chamber is composed, and on the
surface condition (oxide coating, roughness, etc.) In principle, the
scattering probability also depends on the photon polarization
relative to the incident normal to the surface, but this dependence is
ignored in the simulation.

The scattering probabilities in the table currently used by the
simulation were computed for a photon p-polarization (electric field
in the plane of incidence), for an aluminum substrate with a 4 nm
layer of Al$_2$O$_3$ having a density of 2.9 gm/cm$^3$ and a surface
roughness of 4 nm. See Fig.~\ref{f:reflect} for some example
reflectivity curves, compared with radiation spectra for wigglers and
dipoles in CesrTA at 2 GeV.

%------------------------------------------------------------------
\subsection{Main input file} 
\label{s:main.file}

The main input file can be specified on the command line invoking synrad3d.
If not given, the default name for the main input file is ``\vn{synrad3d.init}''.
Example main input file:
\begin{example}
  &synrad3d_parameters
    ix_ele_track_start   = 1      ! Radiation region start lattice element.
    ix_ele_track_end     = 912    ! Radiation region end lattice element.
    photon_direction     = 1      ! 1 = Forward generation, -1 = Backward generation.
    num_photons          = 50000  ! Nominal number of unfiltered photons generated. 
    num_photons_per_pass = -1     ! Number of photons generated per pass. -1 = Use num_photons.
    ds_step_min      = 0.01   ! Photons are generated at discrete points. 
                              ! Multipole photons can be generated at each point.
                              ! This is minimum distance between points.
    emit_a       = -1         ! Horizontal emit. Meters. If < 0 -> Calc from lattice.
    emit_b       = 7.52E-11   ! Vertical emit.  Meters. If < 0 -> Calc from lattice.
    sig_e        = -1         ! Sig_E/E. If < 0 -> Calc from lattice.

    lattice_file = "../lattice/cesr/bmad/bmad_6wig_8nm_2085.lat" 
    wall_file    = "synrad3d.wall"   ! Vacuum chamber wall file.
    dat_file     = "synrad3d.dat"    ! Output data file.
    wall_hit_file = ''               ! Photon wall hit data file.
    lat_ele_file  = ''               ! Write lattice element data file.

    random_seed = 123456             ! 0 -> Use sys clock.
    e_init_filter_min = -1           ! Min energy filter param.
    e_init_filter_max = -1           ! Max energy filter param.
    e_filter_min = -1                ! Min energy filter param.
    e_filter_max = -1                ! Max energy filter param.
    s_filter_min = -1                ! Min S position filter param.
    s_filter_max = -1                ! Max S position filter param.
    photon_start_input_file  = ''    ! File for initializing the photons
    photon_start_output_file = ''    ! File recording photon start positions
    num_ignore_generated_outside_wall = 0    !
    turn_off_kickers_in_lattice = F          ! Zero the closed orbit?
    surface_roughness_rms = -1               ! Surface roughness for diffuse scattering.
    roughness_correlation_len = -1           ! Surface roughness correlation length.
    sr3d_params%diffuse_scattering_on = T    ! For testing the effect of diffuse scattering.
    sr3d_params%ds_track_step_max = 3        ! Photon propagation step size 
    sr3d_params%dr_track_step_max = 0.1      ! Photon propagation step size 
    sr3d_params%allow_reflections = T        ! For testing purposes.
    sr3d_params%always_specularly_reflect  = F ! For testing purposes.
    sr3d_params%stop_if_hit_antechamber = F 
  /
\end{example}
Fortran namelist input is used.  The tag \vn{"\&synrad3d_parameters"}
marks the start of the namelist and the namelist ends with the slash
\vn{"/"} tag. Anything outside of this is ignored. Within the
namelist, anything after an exclamation mark \vn{"!"} is ignored
including the exclamation mark.

  \begin{description}
  \item[\vn{ix_ele_track_start}, \vn{ix_ele_track_end}] \Newline
The parameters \vn{ix_ele_track_start} and \vn{ix_ele_track_end} establish
the region where radiation is produced. These are the index numbers of 
elements in the lattice. The radiation region boundary is taken to be at
the exit end of the elements so no radiation is produced in the element
with index \vn{ix_ele_track_start}. If \vn{ix_ele_track_end} is negative,
the end of the radiation region is taken to be end of the lattice.
If \vn{ix_ele_track_end} is positive and less than \vn{ix_ele_track_start},
the track region will be from \vn{ix_ele_track_start} through the
end of the lattice and from the beginning of the lattice to \vn{ix_ele_track_end}.
  \item[\vn{photon_direction}] \Newline
The \vn{photon_direction} parameter determines in what direction the photons
are traveling when initially created. A value of \vn{+1} indicates the photons
are created traveling in the $+s$ direction and a value of \vn{-1} indicates
that the photons are created in the $-s$ direction.
  \item[\vn{num_photons}] \Newline
\vn{num_photons} establishes the minimum number of ``unfiltered''
photons that need to be generated before \srthree will stop the
simulation. The minimum number is actually 0.9 * \vn{num_photons}. See
below for more details. An unfiltered photon is a photon that passes
all filter requirements.  
  \item[\vn{num_photons_per_pass}] \Newline
\vn{num_photons_per_pass} sets the number of photons generated per
``pass''.  A ``pass'' is the act of generating photons throughout the
radiation production region. If \vn{num_photon_per_pass} is negative
(the default), the number of photons generated per pass is taken from
the value of \vn{num_photons}.
  \item[\vn{ds_step_min}] \Newline
This parameter establishes the minimum distance to track the particle beam between emission
points. The thought was that if \srthree decided to make very small steps  between emission
points, this might slow the calculation down. This has not been tested. This parameter
does not influence photon tracking.
  \item[\vn{emit_a}, \vn{emit_b}, \vn{sig_e}] \Newline
These parameters set the particle beam size and so will affect the starting coordinates of
the photons. A negative set of any of these parameters will result in \srthree 
using the value for the parameter from a calculation of the synchrotron radiation integrals.
  \item[\vn{lattice_file}] \Newline
This file defines the
machine optics. The lattice file format may be the Bmad format or, if
the \vn{lattice_file} string is prefixed by \vn{``xsif::''},
may be in xsif format.
  \item[\vn{wall_file}] \Newline
This string gives the name of the vacuum chamber wall definition file. See below for
more details.
  \item[\vn{dat_file}] \Newline
This string gives the name of the output data file.
See below for more details.
  \item[\vn{surface_roughness_rms}] \Newline
This parameter sets the surface roughness RMS value in meters. This is used for diffuse scattering.
If negative (the default), the default value will be used.
  \item[\vn{roughness_correlation_len}] \Newline
This parameter sets the surface roughness correlation length in meters. This is used for diffuse scattering.
If negative (the default), the default value will be used.
  \item[\vn{sr3d_params\%allow_reflections}] \Newline
This parameter, if set False, will cause \srthree to stop tracking a given photon once
it hits the chamber wall. This can be used to generate data on where the primary photons are striking.
  \item[\vn{sr3d_params\%diffuse_scattering_on}] \Newline
This parameter can be used to test whether diffuse scattering is important. If set to \vn{False},
photons that would be diffusely scattered are instead absorbed.
  \item[\vn{sr3d_params\%always_specularly_reflect}] \Newline
This parameter, if set True, will cause \srthree suppress absorption or
diffuse scattering and to always specularly reflect photons when they
hit the chamber wall. This parameter is only used for testing
purposes.
  \item[\vn{sr3d_params\%stop_if_hit_antechamber}] \Newline
This parameter, if set True, will cause \srthree to stop tracking a given photon once
it hits part of an antechamber wall.
  \item[\vn{sr3d_params\%ds_track_step_max}, \vn{sr3d_params\%dr_track_step_max}] \Newline
These parameters determine the maximum distance a photon is tracked in
a given ``step'' see \sref{s:track} for more details.
  \item[\vn{wall_hit_file}] \Newline
This string, if not blank, will create a data file listing the points
where the photons hit the wall including all the reflection
points. This will be in addition to the regular output file.  See
below for more details.
  \item[\vn{lat_ele_file}] \Newline
This string, if not blank, will create a data file listing  the lattice
elements within the emission region. For each element the following are given. 
  \begin{enumerate}
  \item
    The element name
  \item
    The element type (quadrupole, etc.)
  \item
    Longitudinal position at the exit end of the element
  \item
    Element length.
  \item
    $I_0$ radiation integral through the element.
  \item
    The nominal (not actual) number of photons to be generated based upon the $I_0$ integral,
    the total $I_0$ integral, and the setting of \vn{num_photons}
  \item
    The longitudinal step size between photon emission points.
  \end{enumerate}

  \item[\vn{random_seed}] \Newline
Random number see used in by the random number generator. If set to 0, the system clock
will be used. That is, if set to 0, the output results will vary from run to run. 
  \item[\vn{e_init_filter_min}, \vn{e_init_filter_max}] \Newline
Minimum and maximum initial energy filter values. A negative filter value
indicates that the particular filter is not used. See below.
  \item[\vn{e_filter_min}, \vn{e_filter_max}] \Newline
Minimum and maximum energy filter values. A negative filter value
indicates that the particular filter is not used. See below.
  \item[\vn{s_filter_min}, \vn{s_filter_max}] \Newline
Minimum and maximum longitudinal position filter values. A negative filter value
indicates that the particular filter is not used. See below.
  \item[\vn{photon_start_output_file}] \Newline
This string, if not blank, will cause \srthree to create an output
file, with a name given by the value of \vn{photon_start_output_file},
of the photon starting positions along with the state of the random
number generator. Note: If \vn{photon_start_input_file} is set,
\vn{photon_start_output_file} will be ignored (no output file is
generated). Also note that the file will have the starting coordinates
of all photons generated, not just the photons that pass any filtering
tests. Thus, if any of the filter parameters are set, the size of the
file may be very large. See below for the syntax of this file.
  \item[\vn{photon_start_input_file}] \Newline
This string, if not blank, will cause \srthree to initialize photon
starting positions using the values in an input file. The name of the
input file being given by the value of \vn{photon_start_input_file}.
The state of the random number generator at the time of a photon's
initialization can also be specified in the file. In this case, the
random number generator state will also be set along with the state of
the photon. This is useful for diagnostic purposes when one wishes to
compare the results of different versions of the \srthree program. The
syntax for this file is the same as the syntax used to generate the
\vn{photon_start_output_file}. See below for the syntax of this file.
  \item[\vn{num_ignore_generated_outside_wall}] \Newline
Photons may be generated outside of the beam chamber for various
reasons. For example, the beam chamber can be too small or the closed
orbit may lie near or outside the chamber. Another possibility is that
the beam emittance is large enough so that, from time-to-time, a
photon generated at large amplitude will be generated outside the
wall. \srthree will ignore photons generated outside the wall, and
generate another one at the same longitudinal position, up to the
number set by \vn{num_ignore_generated_outside_Wall}. If the number of
photons generated outside the wall exceeds this number, \srthree will
print an error message and stop.
  \item[\vn{turn_off_kickers_in_lattice}] \Newline
If \vn{turn_off_kickers_in_lattice} is set to True (the default is
False), then all kicks from steering elements in the lattice will be zeroed.

\end{description}

The six "filter" parameters are:
\begin{example}
  e_init_filter_min   ! min initial energy filter.
  e_init_filter_max   ! max initial energy filter.
  e_filter_min        ! min energy filter.
  e_filter_max        ! max energy filter.
  s_filter_min        ! min longitudinal position filter.
  s_filter_max        ! max longitudinal position filter.
\end{example}
A filter parameter is "unset" if its value is negative and is "set"
otherwise.  \srthree can run in "filtered" or "unfiltered"
mode. Unfiltered mode occurs when none of the filter parameters have
have been set. In this mode, all photons generated are recorded in
the output file.

In filtered mode, with at least one of the filter parameters set,
photons that do not satisfy the set filter values are discarded. The
\vn{e_init_filter_min} and \vn{e_init_filter_max} parameters are 
compared against the initial photon energy, and the other four
filter parameters are compared against the final photon position and
energy. The s-filter can wrap around $s = 0$: That is,
if both \vn{s_filter_min} and \vn{s_filter_max} have been set,
and \vn{s_filter_min} is {\em greater} than \vn{s_filter_max}, the region
for keeping a photon is from \vn{s_filter_min} through the end of the
lattice along with the region from the start of the lattice to
\vn{s_filter_max}.

\srthree will generate a set of approximately
\vn{num_photons_per_pass} photons in the radiation production region.
This is called a ``pass''.  After any filtering, \srthree will check
to see if the number of unfiltered photons is at least 0.9 *
\vn{num_photons}. If so, photon generation will stop. If not enough
photons have been generated, \srthree will generate another
\vn{num_photons_per_pass}, and so on, until at least 0.9 *
\vn{num_photons} unfiltered photons have been generated.

%------------------------------------------------------------------
\subsection{Vacuum chamber wall definition} 

\begin{figure}[tb]
\begin{center}
\includegraphics[width=6in]{chamber.pdf}
\caption{Example vacuum chamber cross-section for an \vn{elliptical} 
chamber with an antechamber on the $+x$ side of the chamber and an
aperture on the $-x$ side.}
\label{f:chamber}
\end{center}
\end{figure}

The vacuum chamber wall is defined by specifying the chamber
cross-section at a number of longitudinal positions. 
At a given longitudinal
position, the wall cross-section can have one of three ``basic''
shapes:
\begin{example}
  elliptical
  rectangular
  gen_shape
  gen_shape_mesh
\end{example}
The \vn{gen_shape} and \vn{gen_shape_mesh} shapes are discussed
later. An example \vn{elliptical} cross-section is shown in
\fig{f:chamber}.  For \vn{elliptical} or \vn{rectangular} shapes, the
parameters needed to specify the chamber are:
\begin{example}
  s                   ! Longitudinal position
  basic_shape         ! Either "elliptical" or "rectangular"
  width2              ! Half width ignoring antechamber.
  height2             ! Half height ignoring antechamber.
  width2_plus         ! Distance from pipe center to +x side edge.
  ante_height2_plus   ! Antechamber half height on +x side of the wall
  width2_minus        ! Distance from pipe center -x side edge.
  ante_height2_minus  ! Antechamber half height on -x side of the wall
\end{example}

The basic chamber shape at a given position is given by the
\vn{basic_shape} attribute which must be set to 
\vn{"rectangular"} for a \vn{rectangular} shape and \vn{"elliptical"}
for an \vn{elliptical} shape. \vn{width2} and \vn{height2}
define the half-height and half-width of the basic shape.

Antechambers on the $+x$ side and/or $-x$ side of the chamber can be
added to the basic shape. On the $+x$ side, an antechamber is formed
if the \vn{ante_height2_plus} parameter is set to a positive value. If
\vn{ante_height2_plus} is set to a positive value, as shown in
\fig{f:chamber}, the parameter \vn{width2_plus} specifies the
horizontal distance from the chamber center to the far end of the $+x$
side antechamber. In this case, the value of \vn{width2_plus} must be
large enough so that the antechamber far wall does not stick back into
the basic shape. For a rectangular shape, this translates to
\vn{width2_plus} being larger than \vn{width2}. Similarly, if
\vn{ante_height2_minus} is set to a positive value, an antechamber is
formed on the $-x$ side.  In this case, \vn{width2_minus} is the
(positive) horizontal distance from the chamber center to the far end
of the $-x$ antechamber.

If \vn{ante_height2_plus} is not set, a set of \vn{width2_plus}
defines an aperture on the $+x$ side of the chamber. In this case, the
value of \vn{width2_plus} must be less than the value of
\vn{width2}. Similarly, if \vn{ante_height2_minus} is not set, a set of
\vn{width2_minus} defines an aperture on the $-x$ side of the chamber.
A $-x$ aperture is shown in \fig{f:chamber}.

For the \vn{gen_shape} shape, the parameters are:
\begin{example}
  s                   ! Longitudinal position.
  basic_shape         ! "gen_shape".
  ix_gen_shape        ! Index of gen_shape definition to use.
\end{example}
The \vn{ix_gen_shape} index refers to a gen_shape
specification which has the parameters
\begin{example}
  ix_gen_shape        ! Index of this gen_shape definition.
  v(i)                ! (x, y) coordinates of the i\Th vertex.
\end{example}

An example wall definition file is:
\begin{example}
  ! Anything outside the namelists is ignored.
  &wall_def section =   0.0, "elliptical", 0.045, 0.025 /
  &wall_def section =  74.3, "gen_shape", 1 /
  &wall_def section =  82.9, "rectangular", 0.045, 0.025 /
  &wall_def section =  91.1, "rectangular", 0.045, 0.025, -1, -1, 0.08, 0.01 /
  &wall_def section = 101.3, "elliptical", 0.045, 0.025 / 
  &wall_def section =   0.0, "elliptical", 0.045, 0.025 /

  &gen_shape_def
    ix_gen_shape = 1
    v(1) =  0.045,  0.025
    v(2) = -0.045,  0.025
    v(3) = -0.045, -0.025
    v(4) =  0.045, -0.025
  /
  &gen_shape_def
    ix_gen_shape = 2
    v(1) =  0.045,  0.025
    v(2) = -0.045,  0.025
  /
\end{example}
Fortran namelist input is used. 
The \vn{wall_def} namelists begin with \vn{"\&wall_def"}
and ends with a slash \vn{"/"}. Each namelist specifies one cross-section.
Within the namelist, anything after an exclamation
mark \vn{"!"} is ignored including the exclamation mark. 

The format for an \vn{elliptical} or \vn{rectangular} cross-section is
\begin{example}
  &wall_def section = <s>, <basic_shape>, <width2>, <height2>, <width2_plus>, 
                  <ante_height2_plus>, <width2_minus>, <ante_height2_minus> /
\end{example}
The format for a \vn{gen_shape} cross-section is
\begin{example}
  &wall_def section = <s>, "gen_shape", <ix_gen_shape> /
\end{example}

The $<s>$ values for the
cross-sections must be in increasing order starting at $<s> = 0$ for
the first cross-section. The exception is that the $<s>$ value for the last
cross-section is immaterial since \srthree will automatically substitute
the appropriate $<s>$ value at the end of the lattice.

For \vn{elliptical} and \vn{rectangular} shapes, the first four parameters -- \vn{<s>},
\vn{<basic_shape>}, \vn{<width2>}, and \vn{<height2>} -- of a cross-section must be
specified. Values for the other parameters are optional and default to
the ``unset'' value of -1.

For \vn{gen_shape} shapes, the \vn{ix_gen_shape} refers to a
corresponding \vn{gen_shape_def} namelist that specifies the exact
shape of the wall.  The format of the \vn{gen_shape_def}
namelist is:
\begin{example}
  &gen_shape_def
    ix_gen_shape = <index>
    v(1) = <x1> <y1> <radius_x1> <radius_y1> <tilt1>
    v(2) = <x2> <y2> <radius_x2> <radius_y2> <tilt2>
    v(3) = <x3> <y3> <radius_x3> <radius_y3> <tilt3>
    ... etc ...
  /
\end{example}
A gen_shape is specified as a list of connected vertices. Each vertex
is specified by it's $(x, y)$ coordinates. When the vertex points are
expressed in terms of $(r, \theta)$ coordinates, the vertices must be
in order of increasing $\theta$. If all the vertex points have
non-negative $y$ values, it is assumed that the gen_shape is symmetric
with respect to the $x$-axis and that only half the vertex points are
being specified. If all the vertex points have both non-negative $x$
and $y$ values, it is assumed that the gen_shape is symmetric with
respect to both the $x$ and $y$ axes.

Between vertices, the wall is assumed to be a straight line except if
a \vn{<radius_x>} is given. If \vn{<radius_x>} is set to a non-zero
value for a given vertex, the wall segment between that vertex and the
vertex before it is the arc of a circle with the given radius. If, in
addition, \vn{<radius_y>} is given, the arc will be a section of an
ellipse.  If \vn{<tilt>} is given then the ellipse will be tilted.

In the example above, the cross-section at $s = 74.3$~meters is a
\vn{gen_shape} whose definition is given by the first
\vn{gen_shape_def} namelist with an \vn{ix_gen_shape} value of 1. This
definition defines a rectangle and is equivalent to the cross-section
at 82.9~meters. Additionally, the second \vn{gen_shape_def} namelist
with an \vn{ix_gen_shape} value of 2. defines a symmetric gen_shape
which has the exact same shape as the first gen_shape.

The \vn{gen_shape_mesh} shape syntax is exactly the same as the
\vn{gen_shape} syntax except that \vn{basic_shape} is set to
"\vn{gen_shape_mesh}". For \vn{gen_shape_mesh} there is also the added
restriction that the wall between vertices must be straight lines. The
real difference is in the way that the chamber wall is constructed for
\vn{gen_shape_mesh} cross-sections as detailed in \sref{s:wall}.

%------------------------------------------------------------------
\subsection{Vacuum Chamber Wall Interpolation} 
\label{s:wall}

Once a set of chamber cross-sections have been defined, the
cross-section of the chamber at a given longitudinal position is
computed using either a triangular mesh or linear interpolation. The
reason for using two schemes is that originally \srthree only
implemented linear interpolation.  Conceptually, as detailed in in
\sref{s:track}, there are problems with using linear interpolation
with certain chamber geometries. In particular when there is an
antechamber. To get around this, the mesh approach was implemented.
The mesh approach has it's own problems: Potentially it can be slow
and using flat planer surfaces will not model a chamber as well as
linear interpolation which can use curved surfaces. Currently there
is not enough experience running \srthree so it is not clear whether
the conceptual problem with linear interpolation is, on a practical
level, significant. Time will tell but in the meantime both approaches
are available for use. Note that a chamber can uses the mesh approach
in some places and linear interpolation in others.

The triangular mesh approach is associated with \vn{gen_shape_mesh}
cross-sections. In particular, if a given cross-section has been
declared \vn{gen_shape_mesh}, the section of the chamber from the
preceding cross-section (called $C_1$) to the \vn{gen_shape_mesh}
cross-section (called $C_2$) will be constructed using a mesh. In this
case, the preceding cross-section must be of type \vn{gen_shape} or
\vn{gen_shape_mesh} and must use only straight lines between
vertices. Additionally, both cross-sections must have the same number
of vertices.The mesh is then constructed as follows: Let $v_1(i)$ be
the vertices in $C_1$ and let $v_2(i)$ be the vertices in $C_2$ with
$i$ ranging from 1 to $N$. Construct two sets of triangles. The first
set consists of all triangles with vertices in the form $v_1(i),
v_1(i+1), v_2(i)$ for $i$ in the range 1 to $N$. [Modulo arithmetic is
being used here so vertex $v(N+1)$ is equivalent to vertex $v(1)$.]
The second set of triangles consists of all triangles of the form
$v_1(i+1), v_2(i), v_2(i+1)$. These $2 \cdot N$ triangles define the
chamber wall.

The linear interpolation approach is used where ever the mesh approach
is not.  With linear interpolation, the cross-section at some point
$s_1$ where the chamber cross-section has been defined is expressed in
cylindrical coordinates.  Thus let $r_{w1}(\theta)$ be the radius of
the wall as a function of $\theta$ at $s_1$.  Let $r_{w2}(\theta)$ be
the radius of the wall at the next defined cross-section at $s_2$. The
radius of the wall cross-section, $r_w(\theta, s)$ at some position
$s$ with $s_1 \le s \le s_2$ is
\Begineq
  r_w(\theta, s) = 
  \frac{s_2 - s}{s_2 - s_1} \, r_{w1}(\theta) + 
  \frac{s_1 - s}{s_1 - s_2} \, r_{w2}(\theta)
\Endeq
A photon at $(r,\theta, s)$ is inside the chamber if
\Begineq
  r < r_w(\theta, s)
\Endeq

%------------------------------------------------------------------
\subsection{Photon Tracking}
\label{s:track}

\begin{figure}[tb]
\begin{center}
\includegraphics[width=6in]{chamber-problem.pdf}
\caption{A) A convex cross-section can lead to problems with linear interpolation.
since it is assumed that if the beginning and ending points are inside the chamber 
the entire track is inside the chamber. The track shown violates this assumption.
B) With linear interpolation, convex cross-sections are not a guarantee that 
intermediate cross-sections are convex. B1 and B3 are the defined cross sections 
at $s = 0$ and $s = 1$ respectively. These cross sections are ellipses with 5:1 
aspect ratio. The interpolated cross-section B2 at $s = 0.5$ is seen to be concave.}
\label{f:convex-chamber}
\end{center}
\end{figure}

Photons are tracked in ``steps''. A step consists of propagating a
photon from it's current position to some new position that is a
certain distance away. The length to propagate the photon in a given
step is determined by a number of factors. Maximum lengths are set by
the input parameters 
\begin{example}
  sr3d_params%ds_track_step_max
  sr3d_params%dr_track_step_max
\end{example}
These set longitudinal (\vn{%ds_track_step_max}) and transverse
(\vn{%dr_track_step_max}) distances. Additionally, a single step will
always be terminated at, and never cross over, a defined cross-section
plane. steps will also be terminated at the boundaries of bend magnets
and at the point in a bend where a trajectory is closest to the center
of the bending radius.

After a step, the new photon position is checked to see if it is still
inside the chamber. If it is not, the point where it has struck the
chamber wall is calculated via a root finding algorithm.

If the new photon position is inside the chamber, there is still the
question as to whether the photon trajectory between the beginning
step point and the end step point is inside the chamber. If linear
interpolation is being used locally, \srthree assumes that the chamber
is ``locally convex''. That is, given the two end points of a step
with points inside the chamber, it is assumed that the line drawn
between these two points never touches or goes outside the
chamber. This locally convex assumption will be true if every
cross-section $r_w(\theta, s)$ for fixed $s$ is convex where $s$ is in
the range of longitudinal $s$ positions covered by the step in
question.

The presence of antechambers clearly violates the locally convex
assumption as shown in Fig.~\ref{f:convex-chamber}A. Even if two
cross-sections are themselves convex, an intermediate cross-section
can be concave as shown in Fig.~\ref{f:convex-chamber}B. How much of a
problem the possibility that \srthree will not detect some photons
leaving and then entering the chamber will, of course, depend upon the
chamber geometry and what is being calculated. One way to treat this
is to reduce the track step length limits:
\begin{example}
    sr3d_params%ds_track_step_max
    sr3d_params%dr_track_step_max
\end{example}
This will reduce the possibility of mis-tracking at the cost of
increased computing time.  If the results do not change significantly
when the track limits are reduced. This is good evidence that the 
results are valid.

When the chamber is locally specified using a triangular mesh. Each
triangle is checked to see whether the trajectory of a step intersects
it. If so, the photon has hit the chamber wall. This method avoids the
convex assumption so has the advantage of being able to work with
complicated geometries. However, the speed of execution will be dependent
upon the number of triangles.

%------------------------------------------------------------------
\subsection{photon\_start\_input\_file}

The \vn{photon_start_input_file} file is used to specify starting positions
for the photons. This is done typically for debugging purposes.

The \vn{photon_start_input_file} file contains a number of
\vn{\&start} namelists. One for each photon starting position. The
format for a \vn{\&start} namelist is:
\begin{example}
  &start
    p%vec = <x>, <vx/c>, <y>, <vy/c>, <z>, <vy/c>  ! Photon position
    p%energy = <ev>                                ! Photon energy
    ran_state = <random_state_struct>
    random_seed = <num>
  /
\end{example}
If needed, The \vn{ran_state} and \vn{random_see} parameters can be
used to initialize the random number generator.

%------------------------------------------------------------------
\section{Output files} 

%------------------------------------------------------------------
\subsection{Main output file}

The first 20 lines of this file echo the
information provided in the file \vn{synrad3d.init}.
Subsequently, \vn{dat_file} contains 4 lines for each photon
generated. An example of the output generated for two photons is shown
below.
\begin{example}
 1       2     71.52  6.614E-03  ! index, n_wall_hits, eV, intensity
    0.000542    0.000037   -0.000073    0.000080       9.015    1.000000  ! Start position
    0.015165    0.004010    0.023538    0.017410      18.661    0.999840  ! End position
    7.906054  ! photon_track_len
    0.001911  ! photon_track_len - ds_beam
      37   DRIFT             ! Lat ele index and class
       2       1     11.25  6.614E-03  ! index, n_reflect, eV, intensity
   -0.000604   -0.000046    0.000003    0.000826       9.036    1.000000  ! Start position
    0.013187   -0.004171   -0.023902   -0.009377      15.524    0.999947  ! End position
    9.968419  ! photon_track_len
    0.001770  ! photon_track_len - ds_beam
      36   SBEND             ! Lat ele index and class
\end{example}
The first line gives the photon index number, the number of times the
photon struck the vacuum chamber (including the final hit where it is
adsorbed), the photon energy (in eV), and the photon intensity.

The photon intensity is always the same for all photons in a given
run. If $N_{\gamma}$ is the total number of photons per beam particle
emitted in one revolution, then the photon intensity in a simulation
run containing $N_{sim}$ photons is defined as $I=N_{\gamma}/N_{sim}.$
Thus, if a simulation run is done using $N_{sim}$ photons, and $N_L$
is the number of photon absorption sites in a longitudinal region of
length $L$, then the average number of photons per beam particle per
unit length absorbed in this region is $(N_L/L)\times I.$ This number
is needed as input for electron cloud simulation programs.

In the second line, the initial position of the generated photon is
given. The six numbers are $x$ (m), $v_x/c$, $y$ (m), $v_y/c$, $s$
(m), and $v_s/c.$ $x$ is the horizontal position (direction along the
local normal to the closed orbit, in the bend plane, zero on the
closed orbit, positive to the outside of the machine, ), $y$ is the
vertical position (direction perpendicular to the bend plane, zero on
the closed orbit, positive up), and $s$ is the longitudinal position
(direction tangent to the closed orbit, zero at the beginning of the
lattice, positive in the direction of motion of the beam).

The third line gives the position of the point at which the photon is absorbed.

The fourth line gives how far the photon traveled.

The fifth line gives how far the photon traveled relative to how far the beam traveled.

The sixth line gives the lattice element index and element type for
the longitudinal position at which the photon is absorbed. This is
provided so that the photon hits can be sorted by magnetic environment
(e.g., drift, sbend, wiggler, etc.)  


%------------------------------------------------------------------
\subsection{Photon Reflection File}


If the switch \vn{wall_hit_file} is non-blank, an additional output
file is generated, which contains more detailed information. An
example of the output is shown below. (This
example is not for the same run as in the previous section).
\begin{example}
 *********************************************
       1       0     825.0
    0.000163   -0.001690   -0.000078    0.000084  761.691897    1.000000
 *********************************************
       1       1     825.0
    0.044902    0.035208    0.001647    0.000084   13.729227    0.999381
               -0.034247               -0.008171                0.999381
    0.9930    0.1180    0.0000              0.034972    0.409532
 *********************************************
       2       0      59.0
   -0.000135   -0.002640    0.000010    0.000995  761.701478    1.000000
 *********************************************
       2       1      59.0
   -0.037269   -0.002640    0.014011    0.000995    7.332935    1.000000
                0.000462               -0.002783                1.000000
   -0.6345    0.7729    0.0000              0.002444    0.983416
 *********************************************
       2       2      59.0
    0.044491    0.037193   -0.003750   -0.002783   13.714673    0.999308
               -0.033444                0.016510                0.999308
    0.9647   -0.2635    0.0000              0.036612    0.766948
 *********************************************
       2       3      59.0
   -0.008275   -0.030089    0.024574    0.016510   15.429119    0.999414
               -0.026051               -0.022345                0.999414
   -0.1034    0.9946    0.0000              0.019532    0.870489
 *********************************************
       2       4      59.0
    0.010349    0.043049   -0.024330   -0.022345   17.617477    0.998827
                0.035823                0.032699                0.998827
    0.1302   -0.9915    0.0000              0.027758    0.819663
\end{example}
Individual entries are separated by a row of asterisks. Each entry
corresponds to a photon striking the vacuum chamber except the
``zeroth'' entry for a given photon gives the emission point
parameters. There will be at least two entries for each photon.

The format of and entry is:
\begin{example}
  photon_index  wall_hit_index  photon_energy
  x_before  v_x_before  y_before  v_y_before  s_before  v_s_before
            v_x_after             v_y_after             v_s_after
  perp_x   perp_y   perp_z        cos_perp    reflectivity
\end{example}
The \vn{photon_index} is the same index as in the main output file.
The \vn{wall_hit_index} starts at 0 for the emission point entry and
increases up to the value for \vn{n_wall_hits} in the main file.
The \vn{photon_energy} will be the same as in the main file.

The second line gives the 6-coordinate position of the photon as it
strikes the chamber (same conventions as given in the previous
section) except that the zeroth entry gives the emission point
coordinates.

Except for the zeroth entry, there is a third line and fourth
line. The third line gives the values for $v_x, v_y, v_z$ after the
reflection. For the last entry of a given photon, this line gives the
values of $v_x, v_y, v_z$ that the photon would have had had it been
reflected.

The first three numbers on the fourth line give the orientation of the
vector normal to the chamber surface at the hit point. The fourth number
is $\cos{\theta_\perp}$, the angle
relative to the surface normal with which the photon strikes the
wall. The grazing angle is $\theta_g=\pi/2-\theta_\perp$. The last
real number on the fourth line is the probability of reflection, computed
from the X-ray data for the given grazing angle and photon energy.

If the photon is ``adsorbed'' due to reflections being disallowed, or
the photon is adsorbed due to the photon hitting the antechamber when
\vn{sr3d_params%stop_if_hit_antechamber} is set True, then the third
and fourth lines will have zeros.

In the example given above, the first photon is absorbed at the first
encounter with the vacuum chamber and the second photon is reflected 3
times, before being adsorbed on the fourth hit.

%------------------------------------------------------------------
\begin{thebibliography}{9}

\bibitem{b.henke} 
B.L. Henke, E.M. Gullikson, and J.C. Davis. X-ray
interactions: photoabsorption, scattering, transmission, and
reflection at E=50-30000 eV,=1-92, Atomic Data and Nuclear Data
Tables Vol. 54 (no.2), 181-342 (July 1993) {\tt
http://henke.lbl.gov/optical\_constants/}

\bibitem{b.mehne}
N. Mahne et. al., ``Experimental Determination of ECLOUD Simulation Input
Parameters for DA$\Phi$NE", EuroTev-Report-2005-013

\end{thebibliography}
\end{document}  
