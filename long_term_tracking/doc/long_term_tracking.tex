%-----------------------------------------
% Note: Use pdflatex to process this file.
%-----------------------------------------

%\documentclass{article}
\documentclass{hitec}
\usepackage{color,soul}

\usepackage{setspace}
\usepackage{graphicx}
\usepackage{moreverb}    % Defines {listing} environment.
\usepackage{amsmath, amsthm, amssymb, amsbsy, mathtools}
\usepackage{alltt}
\usepackage{rotating}
\usepackage{subcaption}
\usepackage{toc-bmad}
\usepackage{xspace}
\usepackage[section]{placeins}   % For preventing floats from floating to end of chapter.
\usepackage{longtable}  % For splitting long vertical tables into pieces
\usepackage{index}
\usepackage{multirow}
\usepackage{booktabs}   % For table layouts
\usepackage{yhmath}     % For widehat
\usepackage{xcolor}      % Needed for listings package.
\usepackage{listings}
\usepackage[T1]{fontenc}   % so _, <, and > print correctly in text.
\usepackage[strings]{underscore}    % to use "_" in text
\usepackage[pdftex,colorlinks=true]{hyperref}   % Must be last package!

\definecolor{light-gray}{gray}{0.95}
\lstset{backgroundcolor=\color{light-gray}}
\lstset{xleftmargin=0cm}
\lstset{framexleftmargin=0.3em}
%\lstset{basicstyle = \ttfamily\fontsize{11}{11}\selectfont} 
\lstset{basicstyle = \small}
\lstnewenvironment{code}{}{}

%---------------------------------------------------------------------------------

\definecolor{lightestgray}{gray}{0.99}
\sethlcolor{lightestgray}
\soulregister{\texttt}{1}
\newcommand\dottcmd[1]{\hl{\em#1}\endgroup}
%\newcommand\dottcmd[1]{{#1}\endgroup}
\newcommand{\vn}{\begingroup\catcode`\_=11 \catcode`\%=11 \dottcmd}
\newcommand{\ltt}{\vn{long_term_tracking}\xspace}
\newcommand{\Newline}{\hfil \\}
\newcommand{\sref}[1]{$\S$\ref{#1}}

%---------------------------------------------------------------------------------

\renewcommand{\textfraction}{0.1}
\renewcommand{\topfraction}{1.0}
\renewcommand{\bottomfraction}{1.0}

\settextfraction{0.9}  % Width of text
\setlength{\parindent}{0pt}
\setlength{\parskip}{1ex}
%\setlength{\textwidth}{6in}
\newcommand{\Section}[1]{\section{#1}\vspace*{-1ex}}

\newenvironment{display}
  {\vspace*{-1.5ex} \begin{alltt}}
  {\end{alltt} \vspace*{-1.0ex}}

%---------------------------------------------------------------------------------

\title{Long Term Tracking Program}
\author{}
\date{David Sagan \\ April 16, 2019}
\begin{document}
\maketitle

\tableofcontents

%---------------------------------------------------------------------------------

\Section{Introduction} 

The \ltt program is for long term tracking of a particle or beam possibly
including tracking of the spin.

The \ltt program is built atop the the Bmad software library \cite{b:bmad}. The Bmad library,
developed at Cornell, has been developed for modeling relativistic charged particles in storage
rings and Linacs, as well as modeling photons in x-ray beam lines.

\ltt comes in two versions: A single threaded version whose executable is called
\vn{long_term_tracking} and an parallel compute version using MPI whose executable is called
\vn{long_term_tracking_mpi}. [Note to Distribution maintainers: The single threaded version will
always be built when compiling the Distribution. The MPI version can be built by building the
Distribution with MPI enabled. See the documentation on the Bmad web site for more details.]

%------------------------------------------------------------------
\Section{Running the Long Term Tracking Program} 
\label{s:run}

See the documentation for setting up the Bmad environmental variables at
\begin{code}
  \url{https://wiki.classe.cornell.edu/ACC/ACL/RunningPrograms}
\end{code}

Once the Bmad environmental variables have bee set, the syntax for invoking the single threaded
version of the \ltt program is:
\begin{code}
  long_term_tracking {<master_input_file_name>}
\end{code}
Example:
\begin{code}
  long_term_tracking my_input_file.init
\end{code}
The \vn{<master_input_file_name>} optional argument is used to set the master input file name. The
default is ``\vn{long_term_tracking.init}''.

Example input files are in the directory:
\begin{code}
  $ACC_ROOT_DIR/bsim/long_turn_tracking/example
\end{code}

To run the parallel version of \ltt, see the documentation on running programs on the Bmad web site
for more details.

%------------------------------------------------------------------
\Section{Simulation Modes}
\label{s:sim.modes}

There are a number of simulation ``modes'' which determine what is done by the program. The
simulation mode is set by the \vn{ltt%simulation_mode} parameter in the master input file
(\sref{s:input}).  Possible settings of \vn{ltt%simulation_mode} are:
\begin{code}
  "CHECK"   ! Quick map check.
  "SINGLE"  ! Single particle tracking.
  "BUNCH"   ! Bunch tracking.
  "STAT"    ! Lattice statistics.
\end{code}

\begin{description}
\item["CHECK"] \Newline
In this mode a particle is tracked for one turn using the 1-turn map and, using the exact same
starting conditions, tracked element-by-element for one turn. The results are then printed to the
terminal. This mode can be used to get a sense of how accurate the 1-turn map is. One thing to keep
in mind that since the 1-turn map is computed using PTC (see the Bmad manual for an explanation of
what PTC is), there will be differences if the element-by-element tracking is using non-PTC tracking
methods. even if the map is completely accurate. 

No data files are produced in this mode.
%
\item["SINGLE"] \Newline
In this mode a single particle is tracked for \vn{ltt%n_turns} turns. The name of the data file is set
by the \vn{ltt%particle_output_file} parameter (\sref{s:input}). The particle position will be output every

%
\item["BUNCH"] \Newline
In this mode a particle bunch is tracked for \vn{ltt%n_turns} turns. The output data file(s) format is
described in Section~\sref{s:part.out}.
%
\item["STAT"] \Newline
In this mode statistics about the lattice are calculated. No long term tracking is done.

Three data files are produced: 
\begin{code}
  twiss.dat         ! Twiss parameters
  coupling.dat      ! Coupling parameters
  closed_orbit.dat  ! Closed orbit
\end{code}
\end{description}


%------------------------------------------------------------------
\Section{Initial Particle Positions}
\label{s:init.pos}

When the \vn{ltt%simulation_mode} (\sref{s:sim.modes}) is set to \vn{"SINGLE"} or \vn{"CHECK"}, the
initial particle position is determined by the \vn{beam_init%center} and \vn{beam_init%spin}
components of the \vn{beam_init} structure (\sref{s:input}) in the master input file. If the
\vn{ltt%add_closed_orbit_to_init_position} logical is set to \vn{True}, the closed orbit position is added to
\vn{beam_init%center} to get the initial particle position.

When the \vn{ltt%simulation_mode} is set to \vn{"BUNCH"}, the initial particle positions are calculated
using the \vn{beam_init} structure as discussed in the \vn{Beam Initialization} chapter of the Bmad
manual. Like the other modes, if the \vn{ltt%add_closed_orbit_to_init_position} logical is set to
\vn{True}, the closed orbit position is added to the initial particle positions. To read in a file
with beam particle positions, set the \vn{beam_init} structure appropriately. Example:
\begin{code}
  beam_init%file_name = 'beam_particle_file.init'
\end{code}

In all cases, tracking will start at the lattice element set by \vn{ltt%ele_start_name}.

%------------------------------------------------------------------
\Section{Particle Tracking}
\label{s:track.modes}

Tracking can be done on an element-by-element basis or using a one-turn map that includes radiation
damping and excitation and includes both orbital and spin transport. The map is actually three maps
rolled into one. One map is a map with out radiation, another map simulates radiation damping, and
the third map, with the help of a random number generator, is used to include radiation excitation.
radiation damping and/or excitation will or will not be included in tracking depending upon the settings
of (\sref{s:input}):
\begin{code}
  bmad_com%radiation_damping_on
  bmad_com%radiation_excitation_on
\end{code}
Note: When tracking with a map, the RF cavities must be powered so that there are synchrotron
oscillations.

What tracking mode is used is determined by the \vn{ltt%use_1_turn_map} logical (\sref{s:input}).  If a
map is used, the order of the map is given by \vn{ltt%map_order} parameter. A larger map order will mean better
accuracy at the expense of more computation time. Tracking using a map will be extremely quick
compared to element-by-element tracking. However, map tracking can be inaccurate if the map order
is too small or the particle amplitude is too large.

Maps can be saved to a file for later use. Saved maps always include the radiation excitation
component map independent of the setting of \vn{bmad_com%radiation_excitation_on}. Thus, when a
saved map is used for tracking, whether radiation excitation is included is determined by the
setting of \vn{bmad_com%radiation_excitation_on} at the time the map file is read in independent of
the setting at the time the map file is created. Radiation damping is handled differently. The
radiation damping component map depends on the setting of \vn{bmad_com%radiation_damping_on}. Thus,
when a saved map is used for tracking, radiation damping is included only if
\vn{bmad_com%radiation_damping_on} was set True both at the time the map file was created and when
the map file is read back in. The reason why radiation damping is handled differently from radiation
excitation is due to the fact that the spin tracking part of the map is always created with respect
to the closed orbit and the closed orbit will be different if radiation damping is on versus
off. [The closed orbit is always calculated ignoring radiation fluctuations though.] If you don't
care about spin tracking, it generally makes sense to always create maps that have damping.

%------------------------------------------------------------------
\Section{Fortran Namelist}
\label{s:namelist}

Fortran namelist syntax is used for parameter input. The
general form of a namelist is
\begin{code}
&<namelist_name>
  <var1> = ...
  <var2> = ...
  ...
/
\end{code}
The tag \vn{"\&<namelist_name>"} starts the namelist where
\vn{<namelist_name>} is the name of the namelist. The namelist ends
with the slash \vn{"/"} tag. Anything outside of this is
ignored. Within the namelist, anything after an exclamation mark
\vn{"!"} is ignored including the exclamation mark. \vn{<var1>},
\vn{<var2>}, etc. are variable names. Example:
\begin{code}
&place 
  section = 0.0, "arc_std", "elliptical", 0.045, 0.025 
/
\end{code}
here \vn{place} is the namelist name and \vn{section} is a
variable name.  Notice that here \vn{section} is a ``structure'' which
has five components -- a real number, followed by two strings,
followed by two real numbers.

Everything is case insensitive except for quoted strings.

Logical values are specified by \vn{True} or \vn{False} or can be
abbreviated \vn{T} or \vn{F}. Avoid using the dots (periods) that one
needs in Fortran code.

\newpage

%------------------------------------------------------------------
\Section{Master Input File}
\label{s:input}

The master input file holds the parameters needed for running the long term tracking program. The
master input file must contain a single namelist (\sref{s:namelist}) named \vn{params}.  Example:
\begin{code}
&params
  ! Input files
  ltt%lat_file   =  "lat.bmad"     ! Bmad lattice file
  ltt%map_file = 'order5.map'
  ltt%common_master_input_file = ""

  ! Output parameters
  ltt%particle_output_file = "snap.dat"
  ltt%averages_output_file = "average.dat"  
  ltt%sigma_matrix_output_file = "sigma.dat"
  ltt%output_every_n_turns = 200
  ltt%output_initial_position = False
  ltt%print_on_dead_loss = -1
  ltt%merge_particle_output_files = False

  ! Simulation parameters
  ltt%simulation_mode = "BUNCH"
  ltt%ele_start_name     = ""
  ltt%n_turns            = 1000
  ltt%map_order          = 5
  ltt%rfcavity_on        = True
  ltt%use_1-turn_map     = True
  ltt%timer_print_dtime  = 300
  ltt%random_seed        = 0
  ltt%add_closed_orbit_to_init_position = True
  ltt%dead_cutoff = -1
  ltt%b_emittance = 1e-9                 ! Used with space charge calc.

  bmad_com%spin_tracking_on = T          ! See Bmad manual for 
  bmad_com%radiation_damping_on = F      !    bmad_com parameters.
  bmad_com%radiation_fluctuations_on = F 
  bmad_com%space_charge_on = F

  beam_init%n_particle = 10
  beam_init%spin = 0, 1, 0        ! See Bmad manual for 
  beam_init%a_emit = 1e-8         !    beam_init_struct parameters.
  beam_init%b_emit = 1e-8
  beam_init%sig_z = 1e-4
  beam_init%sig_e = 1e-4
/
\end{code}

\newpage

The namelist parameters can be divided into three categories: Input files, output parameters, and
simulation parameters.

%----------------------------------------------------
\subsection{Input Files}

The input files that can be specified in the \vn{params} namelist of the master input file are:
\begin{description}
\item[common_master_input_file] \Newline
The \vn{common_master_input_file} is used in situations where you want to run multipole simulations
with multiple initialization files and where most parameters are the same across all the
simulations. In this case, an initialization file containing the parameters that are the same can be
created along with individual initialization files one for each simulation. The individual files
should set \vn{common_master_input_file} to the name of the common file and the individual files
should only set the parameters that are different for that simulation. Parameter values set in the
individual files will override values set in the common file. Using a common master input file means
that there is only one file to modify when common parameters are changed as opposed to having to
modify all the initialization files. If \vn{common_master_input_file} is set to blank (the default),
no common file is used
%
\item[lat_file] \Newline
Name of the Bmad lattice file to use. This name is required.
%
\item[map_file] \Newline
If not blank, the program will read in the 1-turn map from \vn{ltt%map_file}. To create a map file and
save it to a file, prepend the file name with "WRITE:". Example:
\begin{code}
  map_file = 'WRITE:order5.map'
\end{code}
This will create a map file called "\vn{order5.map}". The saved map will be affected by the setting
of \vn{bmad_com%radiation_damping_on}. See \sref{s:track.modes} for more details.
\end{description}

%----------------------------------------------------
\subsection{Output Parameters}

\begin{description}
\item[ltt\%averages_output_file] \Newline
Used with \vn{ltt%simulation_mode} set to \vn{"BUNCH"}. The name of the file that contain orbital and
spin positions averaged over all the particles of the bunch.  Each line in the file represents the
averages at the end of a turn and a new line is added every \vn{ltt%ouput_every_n_turns} number of
turns. If \vn{ltt%averages_output_file} is blank, no averages file is produced. Data is always recorded
when the beam is at the \vn{ltt%ele_start_name} position independent of where the lattice begins and
ends.
%
\item[ltt\%merge_particle_output_files] \Newline
If set to \vn{True}, all the particle data will be put in one \vn{ltt%particle_output_file} file. Only
relevant for \vn{"BEAM"} tracking.  See Section~\sref{s:part.out}.
%
\item[ltt\%output_every_n_turns] \Newline
Sets the number of turns between files specified by \vn{ltt%averages_output_file} and
\vn{ltt%particle_output_file}.
%
\item[ltt\%output_initial_position] \Newline
Used with \vn{ltt%simulation_mode} set to \vn{"BUNCH"}. If \vn{ltt%output_initial_position} is set to
\vn{True}, additional columns will be added to the output tracking data file to show the initial
particle position and spin. Default is \vn{False}. See Section~\sref{s:part.out}.
%
\item[ltt\%particle_output_file] \Newline
Used with \vn{ltt%simulation_mode} set to \vn{"BUNCH"}. The name of the file or files that are created
to hold the particle positions. If \vn{ltt%merge_particle_output_files} is set to False, a file is
created every \vn{ltt%ouput_every_n_turns} turns.  If \vn{ltt%merge_particle_ouput_files} is set to True,
the files are combined into one. See Section~\sref{s:part.out} for more details. If
\vn{ltt%particle_ouput_file} is blank, no particle output file is created.
%
\item[ltt\%print_on_dead_loss] \Newline
After each turn, the number of particles that are still living (have not hit an aperture) are
counted and if the percentage of particles that have died, counting from the last time a message was
printed, is larger than \vn{ltt%print_on_dead_loss}, a message is printed. For example, if
\vn{ltt%print_on_dead_loss} is set to 0.01, every time the beam loses 1\% of the particles a message is printed.
Default is -1 which will cause a message printed every turn where there is particle loss.
%
\item[ltt\%sigma_matrix_output_file] \Newline
String specifying the name of the file to create to hold the calculated sigma matrix. If blank (the
default), no sigma matrix file will be created. The 6x6 sigma matrix $\boldsymbol{\sigma}$ is a
measure of the beam size defined by
\begin{equation}
  \sigma_{ij} = \left< r_i \, r_j \right>
\end{equation}
where $\bf r$ is the particle phase space vector and $<\ldots>$ denotes an average over all
particles (which will be only one if the \vn{ltt%simulation_mode} is set to "SINGLE") and over all
turns.
\end{description}

%----------------------------------------------------
\subsection{Simulation Parameters}

\begin{description}
\item[ltt\%a_emittance, ltt\%b_emittance] \Newline
Emittances used in the high energy space charge calculation (\sref{s:space.charge}). If set to zero
(the default), the emittance as calculated via radiation integrals will be used.

\item[ltt\%add_closed_orbit_to_init_position] \Newline
If set \vn{True} (the default), initial particle positions are set equal to the input particle positions
plus the closed orbit position. See Section~\sref{s:init.pos}.
%
\item[beam_init\%...] \Newline
This sets the initial beam distribution. See Section~\sref{s:init.pos}.
%
\item[bmad_com\%...] \Newline
The \vn{bmad_com} structure contains various parameters that affect tracking. For example, whether
radiation damping and fluctuations are included in tracking. A full list of \vn{bmad_com} parameters
is detailed in the Bmad reference manual. The \vn{bmad_com%space_charge_on} logical can be used to
turn on/off ultra-relativistic space charge effects. See section~\sref{s:space.charge} for more
details. Note: \vn{bmad_com} parameters can be set in the Bmad lattice file as well. \vn{Bmad_com}
parameter set in the master input file will take precedence over parameters set in the lattice file.
%
\item[ltt\%dead_cutoff] \Newline
Sets the cutoff for the number of dead particles below which the simulation will stop. For example,
if \vn{ltt%dead_cutoff} is set to 0.01, when 1\% of the beam has been lost the simulation will stop. The
default value for \vn{ltt%dead_cutoff} is zero.
%
\item[ltt\%ele_start_name] \Newline
Name or element index of the element to start the tracking. Examples:
\begin{code}
  ele_start_name = "Q3##2"   ! 2nd element named Q3 in the lattice.
  ele_start_name = 37        ! 37th element in the lattice.
\end{code}
The default is to start at the beginning of the lattice. Notice that the tracking starts at the
downstream end of the element so the first element tracked through is the element after the chosen
one.
%
\item[ltt\%map_order] \Newline
Order of the 1-turn map. See Section~\sref{s:track.modes}. The default is what is set in the lattice
file and if not set in the lattice file the default is 3. Note: \vn{ltt%map_order} is only used when
generating a map.  When a map is read in from a file, the order of this map is independent of the
current setting of \vn{ltt%map_order}.
%
\item[ltt\%n_turns] \Newline
Number of turns to track. See Section~\sref{s:track.modes}.
%
\item[ltt\%random_seed] \Newline
The random number seed used by the random number generator. If set to 0, the
system clock will be used. That is, if set to 0, the output results will vary from run to run.
%
\item[ltt\%rfcavity_on] \Newline
If set to \vn{False}, the voltage on all RF cavity elements will be turned off. Default is \vn{True}.
If 1-turn map tracking is used, the RF voltage may not be turned off.
%
\item[ltt\%simulation_mode] \Newline
Sets the simulation mode for the program. See Section~\sref{s:sim.modes}.
%
\item[ltt\%timer_print_dtime] \Newline
The program will print a tracking status message every so often. The nominal time between status
messages is set by \vn{ltt%timer_print_dtime} which is a number in seconds.
%
\item[ltt\%use_1_turn_map] \Newline
If set \vn{True} (the default) use a 1-turn map for tracking as opposed to element-by-element
tracking (\sref{s:track.modes}).
\end{description}

%------------------------------------------------------------------
\Section{simulations with Ultra-Relativistic Space Charge Effects}
\label{s:space.charge}

A space charge kick can be applied in the simulation. The space charge kick is calculated using an
approximation suitable at ultra-relativistic energies. The kick is turned on by setting
the logical \vn{bmad_com%space_charge_on} to \vn{True} (default is \vn{False}. See the Bmad
manual documentation on \vn{bmad_com%space_charge_on} for more details.

The $a$ and $b$ mode emittances are used as input to the space charge calculation. [If there is no
coupling, the $a$ mode corresponds to the ``horizontal'' mode and the $b$ mode corresponds to the
``vertical'' mode.] These emittance can be sepcified by setting \vn{ltt%a_emittance} and/or
\vn{ltt%b_emittance}. If set to zero (the default), an emittance is calculated using a radiation
integral calculation. Additionaly, the longitudinal beam size is calculated via radiation integrals.

%------------------------------------------------------------------
\Section{Particle Data Output Format}
\label{s:part.out}

The following describes the particle data output format. Particle data is outputted when the
\vn{ltt%simulation_mode} is set to \vn{"BUNCH"}.

Particle data is always recorded when the beam is at the \vn{ltt%ele_start_name} position independent of
where the lattice begins and ends.

With \vn{ltt%merge_particle_output_files} set to \vn{False}, an output data file will be produced every
\vn{ltt%output_every_n_turns} turns. Each line in this file records a particle's orbital and
spin position. The name of the data file is derived from the \vn{ltt%particle_output_file} string using
the following rules: If \vn{ltt%particle_output_file} contains a hash character ''\#'', the data file name
is formed by substituting the turn number for the hash token. If there is no hash character, the
data file name is formed by appending the turn number to the \vn{ltt%particle_output_file} string.

With \vn{ltt%merge_particle_output_files} set to \vn{True}, instead of generating multiple files, all data is
put into one file whose name is given by \vn{ltt%particle_output_file}.

Nominally particle data is recorded every \vn{ltt%output_every_n_turns} number of
turns. However, if \vn{ltt%output_every_n_turns} is set to 0, particle data is recorded only
at the start and end of the tracking. If \vn{ltt%output_every_n_turns} is set to -1,
particle data is only recorded at the end of tracking.

If \vn{ltt%output_initial_position} is set to \vn{True}, additional columns will be added to the output
particle data file to show the initial particle position and spin.

%------------------------------------------------------------------
\begin{thebibliography}{9}

\bibitem{b:bmad}
D. Sagan,
``Bmad: A Relativistic Charged Particle Simulation Library''
Nuc.\ Instrum.\ \& Methods Phys.\ Res.\ A, {\bf 558}, pp 356-59 (2006).

\end{thebibliography}

\end{document}



