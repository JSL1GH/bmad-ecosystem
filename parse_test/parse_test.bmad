no_digested
beginning[beta_a] = 10
beginning[beta_b] = 10

bmad_com[max_aperture_limit] = 23.5
bmad_com[ptc_max_fringe_order] = -1
bmad_com[convert_to_kinetic_momentum] = .true.

call, file = sub_dir/sub.bmad

parameter[custom_attribute1] = quadrupole::my_custom

c: diffraction_plate, mode = transmission, 
    surface = {
      grid = {
        dr = (1, 2),
        r0 = (3,4), 
        type = segmented, 
        ix_bounds = (10, 11),
        iy_bounds = (0, 0),
        pt(10,0) = (0, 1, 2, 3),
        pt(11,0) = (1, 2, 3, 4) &
      } }

mm: mask, mode = transmission, 
  wall = {
    section = {s = 0, v(1) = {1, 1}},
    section = {s = 1, v(1) = {1, 1}}}

m2: mask
m2[wall] = mm[wall]

cap: capillary, wall = {
  section = {s = 0, v(1) = {1, 1}},
  section = {s = 1, v(1) = {1, 1}}}

cry: crystal, crystal_type = 'Si(111)'

 B01: SBEND, L = 6.574262, ANGLE = 0.074799746, E1=0.018699937, E2=0.018699937
 B02: SBEND, L = 3.237903, ANGLE = 0.102289270 ! RHO =  31.65434
 B03: RBEND, L = 2.945314, ANGLE = 0.020944245 ! RHO = 140.6264
 B04: RBEND, L = 1.643524, ANGLE = 0.018699330 ! RHO =  87.8915
 B06: RBEND, L = 3.287171, ANGLE = 0.037400530 ! RHO =  87.8915
 B07: SBEND, L = 3.177222, ANGLE = 0.091254660 ! RHO =  34.81718
 B08: SBEND, L = 6.575289, ANGLE = 0.112200220, E1=0.02805, E2=0.02805 ! 58.60

IP_L0: MARKER 
DET_00W: MARKER, ALIAS = "0W" 
Q00W: QUAD, L =  1.524800, ALIAS = "Q00W" 
DET_01W: MARKER, ALIAS = "1W" 
Q01W: QUAD, L =  0.950000, ALIAS = "Q01W", Type = "CSR QUAD CUR   1" 
HV01W: KICKER, L =  0.172700 
Q02W: QUAD, L =  0.600000, ALIAS = "Q02W", Type = "CSR QUAD CUR   2" 
DET_02W: MARKER, ALIAS = "2W" 
SK_Q02W: QUAD, TILT = PI/4, L =  0.172700, ALIAS = "2W", &
        Type = "CSR SQEWQUAD   2" 
SK_Q03W: QUAD, TILT = PI/4, L =  0.172700, ALIAS = "3W", &
        Type = "CSR SQEWQUAD   3" 
B03W:  B03, ALIAS = "B03W" 
B03AW: B04, ALIAS = "B03AW" 
DET_03W: MARKER, ALIAS = "3W" 

! 

l2: line = (3*(-ll))
use, l2

!

beam, energy =   5.28900

parameter[lattice] =  L9A18A000-_MOVEREC
parameter[geometry] = open 

aa: quadrupole, l = 1, my_custom = 123
bb: aa, l = 2

b2: sextupole
cc: sextupole

ov1: overlay = {aa}, hkick
gr1: group = {aa:-1}, vkick

b*[k1] = 1
*[tracking_method] = runge_kutta
sextupole::cc[k2] = 3

pp: pipe, l = 1
q1: quad, L=0.1, superimpose, ref = pp, offset = -0.2
q2: quad, L=0.1, superimpose, ref = pp, offset = 0.2


ll: line = (aa, aa, bb, bb, cc, pp)
use, ll, phot

phot: line = (cap, cry, ff)
phot[E_tot] = 1e4
phot[particle] = photon
phot[beta_a] = 10
phot[beta_b] = 10


ff: fork, to_line = f_line
qq: quadrupole, l = 1
f_line: line = (qq)
f_line[particle] = photon
mk: marker, superimpose, ref = qq, offset = 0.3



! Group using element not in constructed lattice is ok

zzz: quad
gzzz: group = {zz*[k1]}, var = {a}

!

*[thickness] = 1.3
*::*[b_param] = -1.1

expand_lattice

+*[psi_angle] = 2.1

aa[k1] = 2
a*[tracking_method] = symp_lie_bmad
