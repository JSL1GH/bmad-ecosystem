%-----------------------------------------
% Note: Use pdflatex to process this file.
%-----------------------------------------

%\documentclass{article}
\documentclass{hitec}
\usepackage{color,soul}

\usepackage{setspace}
\usepackage{graphicx}
\usepackage{moreverb}    % Defines {listing} environment.
\usepackage{amsmath, amsthm, amssymb, amsbsy, mathtools}
\usepackage{alltt}
\usepackage{rotating}
\usepackage{subcaption}
\usepackage{toc-bmad}
\usepackage{xspace}
\usepackage[section]{placeins}   % For preventing floats from floating to end of chapter.
\usepackage{longtable}   % For splitting long vertical tables into pieces
\usepackage{index}
\usepackage{multirow}
\usepackage{booktabs}    % For table layouts
\usepackage{yhmath}      % For widehat
\usepackage{xcolor}      % Needed for listings package.
\usepackage{listings}
\usepackage[T1]{fontenc}   % so _, <, and > print correctly in text.
\usepackage[strings]{underscore}    % to use "_" in text
\usepackage[pdftex,colorlinks=true,bookmarksnumbered=true]{hyperref}   % Must be last package!

\definecolor{light-gray}{gray}{0.95}
\lstset{backgroundcolor=\color{light-gray}}
\lstset{xleftmargin=0cm}
\lstset{framexleftmargin=0.3em}
%\lstset{basicstyle = \ttfamily\fontsize{11}{11}\selectfont} 
\lstset{basicstyle = \small}
\lstnewenvironment{code}{}{}

%---------------------------------------------------------------------------------

\definecolor{lightestgray}{gray}{0.99}
\sethlcolor{lightestgray}
\soulregister{\texttt}{1}
\newcommand\dottcmd[1]{\hl{\em#1}\endgroup}
%\newcommand\dottcmd[1]{{#1}\endgroup}
\newcommand{\vn}{\begingroup\catcode`\_=11 \catcode`\%=11 \dottcmd}
\newcommand{\da}{\vn{dynamic_aperture}\xspace}
\newcommand{\Newline}{\hfil \\}
\newcommand{\sref}[1]{$\S$\ref{#1}}
\newcommand{\Th}{$^{th}$\xspace}

%---------------------------------------------------------------------------------

\renewcommand{\textfraction}{0.1}
\renewcommand{\topfraction}{1.0}
\renewcommand{\bottomfraction}{1.0}

\settextfraction{0.9}  % Width of text
\setlength{\parindent}{0pt}
\setlength{\parskip}{1ex}
%\setlength{\textwidth}{6in}
\newcommand{\Section}[1]{\section{#1}\vspace*{-1ex}}

\newenvironment{display}
  {\vspace*{-1.5ex} \begin{alltt}}
  {\end{alltt} \vspace*{-1.0ex}}

%---------------------------------------------------------------------------------

\title{Dynamic_Aperture Program}
\author{}
\date{David Sagan \\ June 21, 2022}

\begin{document}
\pdfbookmark[1]{Contents}{contents}

\maketitle

\tableofcontents

%---------------------------------------------------------------------------------
\Section{Introduction} 
\label{s:intro}

The \da program is for measuring the dynamic aperture. The concept of \vn{dynamic aperture} is that
a particle reaching a certain amplitude will quickly be resonantly driven to large amplitude where
it is lost. This amplitude where the particle becomes unstable is the dynamic aperture. This is to
be contrasted by the \vn{physical aperture} which is the aperture where a particle strikes the wall
of the beam chamber. The general idea in designing lattices is to make sure that the dynamic
aperture is large enough so that, in the normal course of events, particles in the beam have a very
small probability of getting lost due to their amplitude exceeding the dynamic aperture. For long
term stability, a common rule of thumb is to design lattices such that the dynamic aperture is 10 times
the beam sigma.\footnote
  {
While this might seem excessive, this rule of thumb gives some safety margin which is desirable
since designs are never exact.
  }
For injection studies, the minimum dynamic aperture will be determined in part by the size of the
injected beam. In any case, if the dynamic aperture is larger than the physical aperture, increasing
the dynamic aperture further will not help beam stability. 

If there are no apertures set in lattice used by the \da program, the calculated aperture will be the
dynamic aperture. If apertures are set in the lattice, the calculated aperture will be the minimum of
the dynamic and physical apertures.

The \da program is built atop the Bmad software toolkit \cite{b:bmad}. The Bmad toolkit is a
library, developed at Cornell, for the modeling relativistic charged particles in storage rings and
Linacs, as well as modeling photons in x-ray beam lines.

For historical reasons, the \vn{Tao} program (another Bmad based program) is also capable of
calculating the dynamic aperture. 
In fact both programs use the same underlying code for the
aperture analysis. The basic difference is that the \da program is more flexible in terms
of tracking. For example, the \da program can handle \vn{ramper} elements and track with maps.

%------------------------------------------------------------------
\Section{Running the Dynamic Aperture Program} 
\label{s:run}

The \da program comes with the ``Bmad Distribution'' which is a package which contains the Bmad toolkit
library along with a number of Bmad based programs. See the Bmad web site for more details.

If the Bmad Distribution is compiled with \vn{OpenMP} enabled (see the documentation on the Bmad
Distribution ``Off-Site'' setup for more details), the \da program can be run parallel. With OpenMP
the computation load is distributed over a number of cores on the machine you are using. To set the
number of cores set the \vn{OMP_NUM_THREADS} environment variable. Example:
\begin{code}
export OMP_NUM_THREADS=8
\end{code}
And run the program as normal as detailed below.

See the documentation for setting up the Bmad environment variables at
\begin{code}
  https://wiki.classe.cornell.edu/ACC/ACL/RunningPrograms
\end{code}

Once the Bmad environment variables have been set, the syntax for invoking the program is:
\begin{code}
  dynamic_aperture {<master_input_file_name>}
\end{code}
Example:
\begin{code}
  dynamic_aperture my_input_file.init
\end{code}
The \vn{<master_input_file_name>} optional argument is used to set the master input file name. The
default value is ``\vn{dynamic_aperture.init}''. The syntax of the master input file is explained
in \sref{s:input}.

Example input files are in the directory (relative to the root of a Distribution):
\begin{code}
  bsim/dynamic_aperture/example
\end{code}

%------------------------------------------------------------------
\Section{Time Ramping --- Time Varying Element Parameters}
\label{s:ramp}

``\vn{Ramping}'' is the situation where lattice parameters are changing as a function of time over
many turns. Ramping examples include changing magnet and RF strengths to ramp the beam energy or
changing magnet strengths to squeeze beta at the interaction pont of a colliding beam machine.

Ramping is accomplished by defining \vn{ramper} elements in the lattice file and setting
\vn{ramping_on} to True in the master input file (\sref{s:input}). Ramper elements will be applied
to each lattice element in turn before particles are tracked through them. See the Bmad manual for
documentation on \vn{ramper} syntax.

Example:
\begin{code}
  ramp_e: ramper = \{*[e_tot]:\{4e+08, 4.00532e+08, 4.01982e+08, ...\}\},
                var = \{time\}, x_knot = \{0, 0.001, 0.002, ...\}

  amp = 1e9;  omega = 0.167;  t0 = 0.053
  ramp_rf: ramper = \{rfcavity::*[voltage]:amp*sin(omega *(time + t0)),
        rfcavity::*[phi0]:0.00158*time^2 + 2*q \}, var = \{time, q\}
\end{code}
The ``\vn{*[e_tot]}'' construct in the definition of \vn{ramp_e} means that the ramper will be
applied all elements (since the wild card character ``\vn{*}'' will match to any element name), and
it is the element's \vn{e_tot} attribute (the element's reference energy) that will be varied.

In the above example, the \vn{ramp_rf} ramper will be applied to all \vn{rfcavity} elements with
the cavity voltage and phase (\vn{phi0}) being varied.

Important restriction: Only those
ramper elements that have \vn{time} as the first variable will be used and it will be this variable
that is varied over time. 

In the case where the reference energy \vn{e_tot} or reference momentum \vn{p0c} is being varied, the
effect on an element will depend upon the setting of the element's \vn{field_master} parameter. For
example:
\begin{code}
  q1: quadrupole, k1 = 0.3
  q2: quadrupole, k1 = 0.3, field_master = T
\end{code}
In this example, \vn{q1} will have its \vn{field_master} parameter set to \vn{False} since the
quadrupole strength was specified using the normalized strength \vn{k1}. With \vn{q1}, since
\vn{field_master} is False, varying the reference energy or momentum will result in the normalized
strength \vn{k1} remaining fixed and the unnormalized strength \vn{B1_gradient} varying in
proportion to the reference momentum. With \vn{q2}, since \vn{field_master} is True, the
unnormalized strength \vn{B1_gradient} will remain fixed and normalized \vn{k1} will vary
inversely with the reference momentum.

Before a simulation, individual ramper elements may be toggled on or off by setting the element's
\vn{is_on} attribute in the lattice file: 
\begin{code}
  ramp_rf: ramper = ...  ! Ramper element defined.
  ramp_rf[is_on] = F     ! Ramper element turned off.
\end{code}

%------------------------------------------------------------------
\Section{Fortran Namelist Input}
\label{s:namelist}

Fortran namelist syntax is used for parameter input in the master input file. The general form of a namelist is
\begin{code}
&<namelist_name>
  <var1> = ...
  <var2> = ...
  ...
/
\end{code}
The tag \vn{"\&<namelist_name>"} starts the namelist where \vn{<namelist_name>} is the name of the
namelist. The namelist ends with the slash \vn{"/"} tag. Anything outside of this is ignored. Within
the namelist, anything after an exclamation mark \vn{"!"} is ignored including the exclamation
mark. \vn{<var1>}, \vn{<var2>}, etc. are variable names. Example:
\begin{code}
&place 
  section = 0.0, "arc_std", "elliptical", 0.045, 0.025 
/
\end{code}
here \vn{place} is the namelist name and \vn{section} is a variable name.  Notice that here
\vn{section} is a ``structure'' which has five components -- a real number, followed by two strings,
followed by two real numbers.

Everything is case insensitive except for quoted strings.

Logical values are specified by \vn{True} or \vn{False} or can be abbreviated \vn{T} or
\vn{F}. Avoid using the dots (periods) that one needs in Fortran code.

\clearpage

\begin{figure}[tb]
  \centering
  \includegraphics[width=4in]{aperture-rays.pdf}
  \caption{
The calculation of a dynamic aperture curve in the $x$-$y$ plane at a given initial $p_z$ value
involves calculating aperture curve points (blue dots) along a set of ``rays'' (dashed lines) having
a common origin point ($\cal O$) which is taken to be the reference orbit. The line segments between
points is simply for visualization purposes. The calculation of an aperture curve point along a
given ray involves iteratively tracking particles with different starting $(x, y)$ position values
to find the boundary between stable (green dots) and unstable (red dots) motion.
  }
  \label{f:da-ray}
\end{figure}

%------------------------------------------------------------------
\Section{Master Input File}
\label{s:input}

The \vn{master input file} holds the parameters needed for running the \da program. The master input
file must contain a single namelist (\sref{s:namelist}) named \vn{params}.  Example:
\begin{code}
&params
  dat_file = "da.dat"

  ltt%lat_file           = "lat.bmad"     ! Bmad lattice file
  ltt%ramping_on         = False
  ltt%ramping_start_time = 0
  ltt%rfcavity_on        = True
  ltt%tracking_method    = "BMAD"
  ltt%ele_start          = ""
  ltt%map_order          = 5
  ltt%random_seed        = 0
  ltt%ptc_aperture       = 0.1, 0.1
  ltt%exclude_from_maps  = "beambeam::*"
  ltt%split_bends_for_stochastic_rad = False
  ltt%symplectic_map_tracking = False
  ltt%set_beambeam_z_crossing = False
  ltt%use_rf_clock       = F

  bmad_com%radiation_damping_on = F
  bmad_com%radiation_fluctuations_on = F 

  dpz = 0.000, 0.005, 0.010
  da_param%min_angle = 0
  da_param%max_angle = 3.1415926
  da_param%n_angle = 0
  da_param%n_turn = 2000
  da_param%x_init = 1e-3
  da_param%y_init = 1e-3
  da_param%rel_accuracy = 1e-2
  da_param%abs_accuracy = 1e-5
/
\end{code}

The parameters beginning with ``\vn{ltt}'' are parameters 

in the master input file are:
\begin{description}
%
\item[bmad_com\%...] \Newline
The \vn{bmad_com} structure contains various parameters that affect tracking. For example, whether
radiation damping is included in tracking. A full list of \vn{bmad_com} parameters is detailed in
the Bmad reference manual. Note: \vn{bmad_com} parameters can be set in the Bmad lattice file as
well. \vn{Bmad_com} parameter set in the master input file will take precedence over parameters set
in the lattice file.
%
\item[da_param\%n_turn] \Newline
Number of turns to track. 
%
\item[da_param\%n_angle] \Newline
The number of boundary points calculated for a scan is set by the \vn{da_param%n_angle} parameter. 
%
\item[da_param\%min_angle, da_param\%max_angle] \Newline
These parameters set the ray minimum and maximum angles, labeled $\theta$ in Fig~\ref{f:da-ray}, in a
scan. In the example above the angle ranges from 0 to $pi$.  That is, the upper half-plane. These
are typical settings since typically storage rings are vertically symmetric so the aperture curves
should vertically symmetric as well.

The angles between adjacent rays is not uniform but are rather calculated to give a roughly
equal spacing between boundary points. This is done by looking at the aperture
points on a horizontal and a vertical ray and then scaling the ray angles appropriately).
%
\item[da_param\%rel_accuracy, da_param\%abs_accuracy] \Newline
These parameters set the relative and absolute accuracies that determine when the search for a
boundary point is considered accurate enough.

If $r = \sqrt{(x-x_0)^2 + (y-y_0)^2}$ is the distance
along any ray of the computed boundary point, where $(x_0, y_0)$ are the coordinates of the origin
point, the search for the boundary point will stop then the accuracy of the boundary point is below
the desired accuracy $\sigma_{cut}$ which is computed from
\begin{equation}
  \sigma_{cut} = \sigma_a + r \, \sigma_r
\end{equation}
with $\sigma_a$ begin the absolute accuracy and $\sigma_r$ being the relative accuracy.
%
\item[da_param\%x_init, da_param\%y_init] \Newline
These parameters set the initial $x$ and $y$ values used in the first two boundary point searches.
The values of these parameters will not affect significantly affect the computed curve but will
affect the computation time. If not set, these parameters will default to 0.001 meter.
%
\item[dat_file] \Newline
Name of the data output file. This name is required.
%
\item[dpz] \Newline
The \vn{dpz} parameter array is a list of $p_z$ values to use. The number of scans (dynamic aperture curves)
that are produced is equal to the number of \vn{pz} values.


%
\item[ele_start] \Newline
Name or element index of the element to start the tracking. Examples:
\begin{code}
  ele_start = "Q3##2"   ! 2nd element named Q3 in the lattice.
  ele_start = 37        ! 37th element in the lattice.
\end{code}
The default is to start at the beginning of the lattice. Notice that the tracking starts at the
downstream end of the element so the first element tracked through is the element after the chosen
one.
%
\item[lat_file] \Newline
Name of the Bmad lattice file to use. This name is required.
%
\item[ramping_on] \Newline
If set to True, \vn{ramper} control elements will be use to modify the lattice during tracking
(\sref{s:ramp}). Default is False.
%
\item[ramping_start_time] \Newline
The starting (offset) time used to set \vn{ramper} elements. This enables simulations to start in the middle
of a ramp cycle. Default is 0.
%
\item[set_rf_off] \Newline
If set to \vn{True}, the voltage on all RF cavity elements will be turned off. Default is \vn{False}.
%
\end{description}


\begin{figure}[tb]
  \centering
  \includegraphics[width=4in]{da-plot.pdf}
  \caption{
Example dynamic aperture plot using \vn{gnuplot}.
  }
  \label{f:da-plot}
\end{figure}

%------------------------------------------------------------------
\Section{Data Output and Plotting}
\label{s:data.out}

The data output file whose name is set by \vn{dat_file} will look like:

\begin{code}
# lat_file              = chess_arc_pretzel_20150106.lat
# set_rf_off            = T
# da_param%min_angle    =       0.0
# da_param%max_angle    =       3.1
# da_param%rel_accuracy =  1.00E-02
... etc. ...
# da_param%n_angle      = 37
# gnuplot plotting command: 
#   plot for [IDX=1:3] "da.dat" index (IDX-1) u 1:2 w lines ...

"dpz =  0.000000"
"x_ref_orb =  0.000124"
"y_ref_orb =  0.000037"
   0.068125   0.000000    544      Hit +X Side        Q11E
   0.033668   0.002675    442      Hit -Y Side        Q06E
   0.033807   0.005414    717      Hit +Y Side        Q26W
   0.033673   0.008195    410      Hit +X Side        B28W
   0.033759   0.011160    119      Hit -X Side        SEX_08E
   0.034006   0.014403    855      Hit +Y Side        SEX_21W
... etc. ...

dpz =  0.005000"
"x_ref_orb =  0.006591"
"y_ref_orb =  0.006591"
   0.073979   0.000000    904      Hit -Y Side        SEX_16W
   0.050379   0.004234    554      Hit -Y Side        SEX_19E
   0.038989   0.006603    987      Hit -X Side        SEX_39E
   0.038242   0.009842    447      Hit +Y Side        SEX_15W
   0.037746   0.013196    365      Hit +X Side        SEX_41E
... etc. ...
\end{code}

The top part of the data file will be a record of input parameter values. This is followed by a number of
data blocks, one for each setting of \vn{dpz}. The five columns of these data blocks are:
\begin{code}
1 & 2: x_aperture, y_aperture
3:     Number of turns a particle initially at the aperture limit survived. 
4:     Transverse location where particle died.
5:     Lattice element where particle died.
\end{code}
Note that a particle will ``die'' if it hits an aperture or its amplitude is beyond the setting of
\vn{bmad_com%max_aperture_limit}. The default value of this maximum aperture is 1000 meters.

One way to plot the data is to use the \vn{gnuplot} program (documentation for gnuplot is available using a
web search). Run \vn{gnuplot} and use the command printed in the top section of the data file. An example of
what such a plot looks like is shown in Fig.~\ref{f:da-plot}.

%------------------------------------------------------------------
\begin{thebibliography}{9}

\bibitem{b:bmad}
D. Sagan,
``Bmad: A Relativistic Charged Particle Simulation Library''
Nuc.\ Instrum.\ \& Methods Phys.\ Res.\ A, {\bf 558}, pp 356-59 (2006).

\end{thebibliography}

\end{document}

