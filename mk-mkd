#!/bin/bash
#
# NOTE: This script is dual-purpose and it's behvaior is determined by the
#       name of the symlink used to invoke it!
#
# Purpose:
# Run a build for a type determined by the name of the script invoked.
# The actual name of this script is 'mk-mkd', depending on the name of
# the symlink used to invoke it, different behavior is triggered.
#   invoking 'mk' causes a production build
#            'mkd' causes a debug build
#
# This reduces overhead and potential confusion as there 
# is only one script to maintain.
#
# Arguments:
#  Command-line arguments passed to this script are handed off to the
#  gmake invocation that executes the builder generated by the
#  cmake pass immediately prior.
#  This allows for 
#        mk[mkd] clean       -to clean the build and output trees
#                             of object, library, and executables files.
#
#        mk[mkd] cleaner     -removes all bin/lib/module files in the 
#                             current project production/debug directory 
#                             tree and the upper level production/debug
#                             directory tree 
#                        
#        mk[mkd] obliterate  -removes ALL bin/lib/module files for ALL 
#                             projects in ALL production/debug directories.
#                             PLEASE USE WISELY!
#                            
#        mk[mkd] test        -Runs a build and then runs a build check or 
#                             test, if available.
#                            
# 
#---------------------------------------------------------------------------

#set -x

# Start time
DATE1=$(date +"%s")

# Function to calculate and display total Compile and Link time
func_display_build_time () {
    DATE2=$(date +"%s")
    DIFF=$((${DATE2}-${DATE1}))
    DTIME=$(echo "scale = 2; ${DIFF}/60" | bc)
    DTIME_MIN=$(echo "scale = 0; ${DIFF}/60" | bc)
    DTIME_SEC=$(echo "$(echo ${DTIME:(-3)})*60" | bc)
    [ "${DTIME_MIN}" != 0 ] && DTIME_MESS="${DTIME_MIN}min ${DTIME_SEC}sec" || DTIME_MESS="${DTIME_SEC}sec"
    echo -e "\n${PWD} Compile/Link time: ${DTIME_MESS}\n"
}

# Assign build type based on invoked name of script.
THIS_SCRIPT=`basename $0`
[ "${THIS_SCRIPT}" == "mk" ] &&  BUILD_TYPE="production" || BUILD_TYPE="debug"

# Determine which cmake is available 
if [ -e /usr/bin/cmake28 ]
then 
    CMAKE_BINARY=/usr/bin/cmake28
else
    CMAKE_BINARY=cmake
fi

# Determine which ctest is available 
if [ -e /usr/bin/ctest ]
then 
    CTEST_BINARY=/usr/bin/ctest
else
    CTEST_BINARY=ctest
fi

# Determine if the current working directory is a buildable project
if [ ! -e CMakeLists.txt ] && [ ! -e acc_build ]
then
    echo -e "\nThis working directory is not a project supported by the ACC build system.\n"
    exit 1
fi

# Just incase the gmake -j level is not set, we'll set it here, to "2".
if [ -z ${ACC_SET_GMAKE_JOBS} ] || [ "${ACC_SET_GMAKE_JOBS}" == "0" ]
then
    export ACC_SET_GMAKE_JOBS=2
fi

# Only invoke cmake if the user has not requested a 'clean'.
case ${1} in
    clean)
	if [ -d ${BUILD_TYPE} ]
	then
	    cd ${BUILD_TYPE}
	    gmake clean
	fi
	;;

    cleaner)
	rm -rf `pwd`/${BUILD_TYPE}
	DIR=`pwd`
	rm -rf "../config/$(basename ${DIR})"
	[ -e acc_build ] && ./acc_build -"${BUILD_TYPE}" -"${1}"
	echo -e "\nRemoved cached files.  This will force a reconfiguration upon the next build request.\n"
	;;

    obliterate)
	rm -rf `pwd`/${BUILD_TYPE}
	DIR=`pwd`
	rm -rf "../config/$(basename ${DIR})"
	cd ..
	rm -rf ${BUILD_TYPE}
	rm -rf `pwd`/*/${BUILD_TYPE}
	echo -e "\nRemoved ${BUILD_TYPE} directories in all build project directories within the current tree:\n" 
	echo -e "   "`pwd`"\n"
	;;

    test)
	if [ -e acc_build ] 
	then 
	    ./acc_build -"${BUILD_TYPE}" -"${1}"
	    [ $? -eq 0 ] && func_display_build_time
	else
	    [ -d ${BUILD_TYPE} ] && cd ${BUILD_TYPE}
	    ${CTEST_BINARY} --verbose --build-and-test
	    [ $? -eq 0 ] && func_display_build_time
	fi
	;;

    *)
	if [ -e acc_build ] 
	then 
	    ./acc_build -"${BUILD_TYPE}"
	    [ $? -eq 0 ] && func_display_build_time
	else
            # If the local out-of-source build directory does not yet exist, create it.
	    [ ! -d ${BUILD_TYPE} ] && mkdir ${BUILD_TYPE}
	    cd ${BUILD_TYPE}
	    ${CMAKE_BINARY} -DCMAKE_BUILD_TYPE=${BUILD_TYPE} .. || exit 1
	    gmake -j ${ACC_SET_GMAKE_JOBS} ${@}
	    [ $? -eq 0 ] && func_display_build_time
	fi
	;;
esac

