\chapter{Automatic Scaling of Accelerating Fields}
\label{c:autoscale}
\index{automatic field scaling|hyperbf}

\index{e_gun}\index{em_field}\index{lcavity}\index{rfcavity}
The elements that can have accelerating fields are:
\begin{example}
  e_gun       ! \sref{s:e.gun}
  em_field    ! \sref{s:em.field}
  lcavity     ! \sref{s:lcav}
  rfcavity    ! \sref{s:rfcav}
\end{example}

The problem that arises with accelerating fields is how to set the
overall amplitude (and phase if the fields are oscillating) of the
field so that the reference particle has the desired acceleration. The
problem becomes even more complicated at non-ultra relativistic
energies where the velocity is not a constant. In this case, the
proper amplitude and/or phase settings will depend upon what the
incoming energy of the reference particle is.

The scaling problem is not present when \vn{bmad_standard} tracking
(\sref{s:tkm}) is used since \vn{bmad_standard} tracking uses an
integrated formula that is designed to give the proper acceleration.

To help with the scaling problem, \bmad has the capability to automatically
scale an accelerating field's amplitude and/or phase. The two
parameters that turn on/off autoscaling are (\sref{s:param}):
\begin{example}
  parameter[auto_scale_field_phase]    = <Logical>  ! Automatic phase scaling.
  parameter[auto_scale_field_amp]      = <Logical>  ! Automatic amplitude scaling.
\end{example}
The default value is True for both parameters. 

Scaling takes place during program execution when a lattice is
initially created (that is, when the lattice file is parsed) and when
parameters in the lattice that would change the scaling are varied.

The parameters that are varied when the field is auto scalled depend
upon how the field is calculated. When the fields are specified using
modes (\sref{s:em.fields}), each mode has a \vn{field_scale} that
varies the field amplitude and each mode has a phase offset
\vn{phi0_ref}. Not all modes are involved with autoscaling. For
example, an \vn{em_field} element may have an accelerating mode along
with a mode for a solenoid field which is independently powered. In
this instance, only the accelerating mode should be autoscaled. The
``primary'' mode that is autoscaled is set by the
\vn{mode_to_autoscale} component of the \vn{field}
(\sref{v:field}). Additionally, any other mode (called ``seconday''
modes) whose \vn{master_scale} is the same as the \vn{master_scale} of
the primary autoscaled mode will be autoscaled. All modes involved in
autoscaling have their \vn{field_scale} adjusted by the same ratio.

When the fields are {\em not} specified using modes, the 








