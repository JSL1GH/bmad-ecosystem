\chapter{Fringe Fields}
\label{s:fringe.std}

The fringe field kick is divided into two pieces. 
The first piece is called the \vn{hard edge} fringe kick and is the kick in the limit
that the longitudinal extent of the fringe is zero. The second piece is the 
\vn{soft edge} fringe kick which is the fringe kick with the fringe having a finite
longitudinal extent minus the hard edge fringe kick. That is
\begin{example}
  fringe kick = hard fringe kick + soft fringe kick
\end{example}
The advantage of separating the fringe kick in this way is that the hard fringe can
be used without having to know anything about the longitudinal extent of the fringe
field. In many cases, this is a good enough approximation. 

Currently, the only magnetic elements where a fringe kick is applied are:
\begin{example}
  sbend \& rbend
  quadrupole
  sad_mult
\end{example}

%---------------------------------------------------------------------------------
\section{Dipole Soft Edge Fringe Map for Bends and Sad_Mult}
\label{s:fringe.bend.soft}

The dipole soft edge fringe model is adapted from SAD\cite{b:sad}. For \vn{sbend} and \vn{rbend}
elements, the fringe map is defined in terms of the field integrals $F_{H1}$ for the entrance end
and $F_{H2}$ for the exit end given by (see \Eq{fsbbb})
\begin{equation}
  F_{H1} \equiv F_{int} \, H_{gap} = \int_{pole} \! \! ds \, \frac{B_y(s) \, (B_{y0} - B_y(s))}
  {2 \, B_{y0}^2}
\end{equation}
With a similar equation for $F_{H2}$.  

For a \vn{sad_mult} element the corresponding parameters are \vn{fb1} and \vn{fb2}. the conversion between
the bend and \vn{sad_mult} parameters is
\begin{equation}
  \text{fb1} = 12 \, F_{H1}, \qquad \text{fb2} = 12 \, F_{H2}
\end{equation}

The soft edge map is
\begin{align}
  x_2 &=  x_1 + c_1 \, p_z \CRNO
  p_{y2} &= p_{y1} + c_2 \, y_1 - c_3 \, y_1^3 \\
  z_2 &= z_1 + \frac{1}{1 + p_{z1}} \, \left( 
    c_1 \, p_{x1} + \frac{1}{2} \, c_2 \, y_1^2 -\frac{1}{4} \, c_3 \, y_1^4 \right)
    \nonumber
\end{align}
For the entrance face:
\begin{align}
  c_1 = \frac{g_\tot \, \text{fb1}^2}{24 \, (1 + p_z)} &= \frac{6 \, g_\tot \, F_{H1}^2}{1 + p_z}, \qquad 
  c_2 = \frac{g_\tot^2 \, \text{fb1}}{6 \, (1 + p_z)} = \frac{2 \, g_\tot^2 \, F_{H1}}{1 + p_z}, \CRNO
  &c_3 = \frac{2 \, g_\tot^2}{3 \, \text{fb1} \, (1 + p_z)} = \frac{g_\tot^2}{18 \, F_{H1} \, (1 + p_z)}
\end{align}
For a bend, \vn{g_\tot} is the total bending strength
\begin{equation}
  g_\tot = \text{g} + \text{dg}
\end{equation}
\vn{g} being the reference bend strength and \vn{dg} being bend the difference between the actual
and reference bend strengths (\sref{s:bend}). For a \vn{sad_mult} element \vn{g_tot} is calculated
from the equation
\begin{equation}
  g_\tot = \sqrt{a_0^2 + b_0^2}
\end{equation}

It might seem strange that $c_3$ diverges to infinity as $F_H$ goes to zero since naively one would
expect the soft edge kick to vanish in the hard edge limit where the fringe has no longitudinal
extent. However, in the hard edge limit, the field does not obey Maxwell's equations. The limiting
map, as $F_H$ goes to zero, has fields that diverge to infinity and this explains why the full
(hard + soft) limiting map is not the same as the hard edge map at the limit of zero longitudinal
extent.

For the exit face, the appropriate equations can be derived using the substitution
\begin{align}
  F_{H1} &\rightarrow F_{H2} \CRNO
  g_\tot &\rightarrow -g_\tot
\end{align}

%---------------------------------------------------------------------------------
\section{Dipole Hard Edge Fringe Map}
\label{s:fringe.bend.hard}

The bend fringe kick is a combination of the equations developed by Hwang and Lee\cite{b:hwang}
modified to include quadrupole terms as given in Section~5.3.1 of Iselin\cite{b:madphysics}. The
Lie map generator $\Omega_M$ given by Hwang and Lee Eqs.~(35) and (36) is used under the conditions
that
\begin{equation}
  K_{0h} = K_{1h} = K_{2h} = K_{3h} = K_{4h} = K_{5h} = K_{6h} = 0
\end{equation}
Here the subscript ``\vn{h}'' has been added so as to not confuse these parameters with the magnetic
multipole coefficients $K_1$, $K_2$, etc. Note: Hwang and Lee do not present an equation for the
change in $z$ in their paper.

The generator used by \bmad for the entrance fringe is:
\begin{align}
  \Omega_{M1} &= \frac{(x^2 - y^2) \, g_\tot \, \tan (e_1)}{2} 
  + \frac{y^2 \, g_\tot^2 \, \sec^3 (e_1) \, [1 + \sin^2 (e_1)] \, f_{int} \,  h_{gap}}{2 \, (1 + p_z)} \CRNO
  & \qquad + \frac{x^3 \, [4 \, K_1 \, \tan (e_1) - g_\tot^2 \, \tan^3 (e_1)]}{12 \, (1 + p_z)}
  + \frac{x \, y^2 \, [-4 \, K_1 \, \tan (e_1) + g_\tot^2 \, \tan (e_1) \, \sec^2 (e_1)]}{4 \, (1 + p_z)} \\
  &\qquad + \frac{(x^2 \, p_x - 2 \, x \, y \, p_y) \, g_\tot \, \tan^2 (e_1)}{2 \, (1 + p_z)}
  - \frac{y^2 \, p_x \, g_\tot \, [1 + \tan^2 (e_1)]}{2 \, (1 + p_z)} \nonumber
\end{align}
where $g_\tot$ is the total bending strength (design + error) and $K_1$ is the quadrupole moment of the bend.
The generator for the exit fringe is
\begin{align}
  \Omega_{M2} &= \frac{(x^2 - y^2) \, g_\tot \, \tan (e_2)}{2} 
  + \frac{y^2 \, g_\tot^2 \, \sec^3 (e_2) \, [1 + \sin^2 (e_2)] \, f_{int} \,  h_{gap}}{2 \, (1 + p_z)} \CRNO
  &\qquad + \frac{x^3 \, [4 \, K_1 \, \tan (e_2) - g_\tot^2 \, \tan^3 (e_2)]}{12 \, (1 + p_z)}
  + \frac{x \, y^2 \, [-4 \, K_1 \, \tan (e_2) + g_\tot^2 \, \tan (e_2) \, \sec^2 (e_2)]}{4 \, (1+p_z)} \\
  &\qquad + \frac{(-x^2 \, p_x + 2 \, x \, y \, p_y) \, g_\tot \tan^2 (e_2)}{2 \, (1 + p_z)}
  + \frac{y^2 \, p_x \, g_\tot \, [1 + \tan^2 (e_2)]}{2 \, (1 + p_z)} \nonumber
\end{align}

The map $\cal M$ is obtained from the equation $\Cal M = \exp[\colon\Omega_M\colon]$. To second order in the
transverse coordinates the map can be obtained by expanding the exponential to second order
\begin{equation}
  \Cal M \simeq 1 + \colon\Omega_M\colon + \frac{1}{2} \, \colon\Omega_M\colon \, \colon\Omega_M\colon
\end{equation}
The transport for the entrance fringe is then
\begin{align}
  \Delta x &= \frac{g_\tot}{2 \, (1 + p_z)} \, \left[ -x^2 \, \tan^2 (e_1) + y^2 \sec^2 (e_1) \right] \CRNO
  \Delta p_x &= x \, g_\tot \, \tan (e_1)
    + \frac{y^2 \, g_\tot^2 \, [ \tan (e_1) + 2 \, \tan^3 (e_1) ]}{2 \, (1 + p_z)} \CRNO
    &\qquad\qquad + \frac{(x^2 - y^2) \, K_1 \tan (e_1)}{1 + p_z}
    + \frac{(x \, p_x - y \, p_y) \, g_\tot \, \tan^2 (e_1)}{1 + p_z} \CRNO
  \Delta y &= \frac{x \, y \, g_\tot \, \tan^2 (e_1)}{1 + p_z} \\
  \Delta p_y &= y \left[ -g_\tot \, \tan (e_1)
    + \frac{g^2_\tot \, [1 + \sin^2 (e_1)] \, \sec^3 (e_1)}{1 + p_z} \, f_{int} \,  h_{gap} \right] \CRNO
    &\qquad\qquad - \frac{(x \, p_y \, g_\tot \, \tan^2 (e_1)}{1 + p_z} 
    - \frac{y \, p_x \, g_\tot \, [1 + \tan^2 (e_1)]}{1 + p_z} 
    - \frac{2 \, x \, y \, K_1 \tan (e_1)}{(1 + p_z)} \CRNO
  \Delta z &= \frac{\Omega_{M1} - (x^2 - y^2) \, g_\tot \, \tan (e_1)/2}{1 + p_z} \nonumber
\end{align}
The transport for the exit fringe is
\begin{align}
  \Delta x &= \frac{g_\tot}{2 \, (1 + p_z)} \, \left[ x^2 \, \tan^2 (e_2) - y^2 \sec^2 (e_2) \right] \CRNO
  \Delta p_x &= x \, g_\tot \, \tan (e_2)
    - \frac{(x^2 + y^2) \, g_\tot^2 \, \tan^3 (e_2)}{2 \, (1 + p_z)} \CRNO
    &\qquad\qquad + \frac{(x^2 - y^2) \, K_1 \tan (e_2)}{1 + p_z}
    + \frac{(-x \, p_x + y \, p_y) \, g_\tot \, \tan^2 (e_2)}{1 + p_z} \CRNO
  \Delta y &= -\frac{x \, y \, g_\tot \, \tan^2 (e_2)}{1 + p_z} \\
  \Delta p_y &= y \left[ -g_\tot \, \tan (e_2)
    + \frac{g^2_\tot \, [1 + \sin^2 (e_2)] \, \sec^3 (e_2)}{1 + p_z} \, f_{int} \,  h_{gap} \right]
    + \frac{x \, y \, g^2_\tot \, \sec^2 (e_2) \, \tan (e_2)}{1 + p_z} \CRNO
    &\qquad\qquad + \frac{(x \, p_y \, g_\tot \, \tan^2 (e_2)}{1 + p_z} 
    + \frac{y \, p_x \, g_\tot \, [1 + \tan^2 (e_2)]}{1 + p_z} 
    - \frac{2 \, x \, y \, K_1 \tan (e_2)}{(1 + p_z)} \CRNO
  \Delta z &= \frac{\Omega_{M2} - (x^2 - y^2) \, g_\tot \, \tan (e_2)/2}{1 + p_z} \nonumber
\end{align}

%---------------------------------------------------------------------------------
\section{Quadrupole Soft Edge Fringe Map}
\label{s:q.soft}

The quadrupole soft edge fringe model is adapted from SAD\cite{b:sad}. The fringe map is:
\begin{align}
  x_2 &= x_1 \, e^{g_1} + g_2 \, p_{x1} \CRNO
  p_{x2} &= p_{x1} e^{-g_1} \CRNO
  y_2 &= y_1 \, e^{-g_1} - g_2 \, p_{y1} \\
  p_{y2} &= p_{y1} e^{g_1} \CRNO
  z_2 &= z_1 - 
    \left[g_1 \, x_1 \, p_{x1} + g_2 \, \left( 1 + \frac{g_1}{2} \right)
    \, e^{-g_1} \, p_{x1}^2 \right] + 
    \left[g_1 \, y_1 \, p_{y1} + g_2 \, \left( 1 - \frac{g_1}{2} \right)
    \, e^{g_1} \, p_{y1}^2 \right] \nonumber
\end{align}
where
\begin{equation}
  g_1 = \frac{K_1 \, \text{fq1}}{1 + p_z} , \qquad
  g_2 = \frac{K_1 \, \text{fq2}}{1 + p_z}
\end{equation}
$K_1$ is the quadrupole strength, and \vn{fq1} and \vn{fq2} are the fringe
quadrupole parameters. These parameters are related to the field integral $I_n$
via
\begin{equation}
  \text{fq1} = I_1 - \frac{1}{2} \, I_0^2 , \qquad
  \text{fq2} = I_2 - \frac{1}{3} \, I_0^3
\end{equation}
where $I_n$ is defined by
\begin{equation}
  I_n = \frac{1}{K_1} \, \int_{-\infty}^{\infty} \; 
    (K_1(s) - H(s-s_0) \, K_1) \, (s - s_0)^n \, ds
\end{equation}
and $H(s)$ is the step function
\begin{equation}
  H(s) = \begin{cases}
    1   & s > 0 \\
    0   & s < 0
  \end{cases}
\end{equation}
and it is assumed that the quadrupole edge is at $s_0$ and the interior is 
in the region $s > s_0$. 

See Sec.~\sref{s:fringe} for the relation between \vn{fq1} / \vn{fq2} and
the corresponding \vn{f1} and \vn{f2} parameters of SAD.

%---------------------------------------------------------------------------------
\section{Magnetic Multipole Hard Edge Fringe}

The magnetic multipole hard edge fringe field is modeled using the method shown in
Forest\cite{b:forest}. For the $m$\Th order multipole the Lee transform 
is (Forest Eq.~(13.29)):
\begin{align}
  f_\pm &= \mp \Re \left[ \frac{(b_m + i \, a_m) \, 
    (x + i \, y)^{m+1}}{4 \, (m + 2) \, (1 + \delta)} \,
    \left\{ x \, p_x + y \, p_y + i \frac{m+3}{m+1} 
    (x \, p_x - y \, p_y) \right\} \right] \CRNO
  &\equiv \frac{p_x \, f^x + p_y \, f^y}{1 + \delta}
\end{align}
The multipole strengths $a_m$ and $b_m$ are given by \eq{bib1nb}
and the second equation defines $f^x$ and $f^y$. On the right had side of the first
equation, the minus sign is appropriate for particles entering the magnet and the
plus sign is for particle leaving the magnet.
Notice that here the multipole order $m$ is equivalent to $n-1$ in Forest's notation.

With this, the implicit multipole map is (Forest Eq.~(13.31))
\begin{align}
  x^f &= x - \frac{f^x}{1 + \delta} \CRNO
  p_x &= p_x^f - \frac{p_x^f \, \partial_x f^x + p_y^f \, \partial_x f^y}{1 + \delta} \CRNO
  y^f &= y - \frac{f_y}{1 + \delta} \\
  p_y &= p_y^f - \frac{p_x^f \, \partial_y f^x + p_y^f \, \partial_y f^y}{1 + \delta} \CRNO
  \delta^f &= \delta \CRNO
  z^f &=\frac{p_x^f \, f^x + p_y^f \, f^y}{(1 + \delta)^2} \nonumber
\end{align}

%---------------------------------------------------------------------------------
\section{Electrostatic Multipole Hard Edge Fringe}
\label{s:spin.hard.fringe}

The electric multipole hard edge fringe field, to lowest order, consists of just a
longitudinal field. The integrated longitudinal field at constant $(x,y)$ for the $n$\Th
order multipole is simply obtained by requiring that the curl of the field is zero.
This gives:
\begin{equation}
  \int E_s(x,y) \, ds = \phi_n(x,y)
\end{equation}
where $\phi_n$ is given in \Eq{pbian1}. [For a magnetic multipole there is an analogous
equation.]

The effect on the spin when tracking through the fringe field of a multipole field tends
to be weak. As such, this hard edge model is sufficient.  and the spin is tracked using
the T-BMT equation (\Eq{tbmt}).
