\chapter{Spin Dynamics}
\label{c:spin}
\index{spin|hyperbf}   

%-----------------------------------------------------------------   
\section{Equations of Motion}
\label{s:spin.dyn}

The propagation of the classical spin vector $\Bf S$ is described in the local reference
frame (\sref{s:ref}) by a modified Thomas-Bargmann-Michel-Telegdi
(T-BMT) equation\cite{b:spin.hoff}
\begin{equation}
  \frac{\mathrm{d}}{\mathrm{d}s} \Bf S = 
  \left\{ \frac{(1+\Bf r_t \dotproduct \bfg)}{c \, \beta_z} \, 
  \left( {\pmb\Omega}_{BMT} + {\pmb\Omega}_{EDM} \right) - 
  \bfg \times \bfhat z \right\} \times \mathbf{S}
  \label{tbmt}
\end{equation}
where $\bfg$ is the bend curvature function which points away from the center of curvature
of the particle's reference orbit (see \fig{f:local.coords}), $\Bf r_t = (x, y)$ are the
transverse coordinates, $c \, \beta_z$ is the longitudinal component of the velocity, and
$\bfhat z$ is the unit vector in the $z$-direction. $\pmb\Omega_{BMT}$ is the usual T-BMT
precession vector due to the particle's magnetic moment and $\pmb\Omega_{EDM}$ is the
precession vector due to a finite Electric Dipole Moment (EDM) \cite{b:silenko}. Note:
The value for the EDM is set by \vn{bmad_com%electric_dipole_moment} (\sref{s:bmad.common}).
\begin{align}
  {\pmb\Omega}_{BMT} (\mathbf{r,P},t) &= 
    - \frac{q}{m \, c} \left[ 
    \left(\frac{1}{\gamma} + a \right) \, c \, \Bf B -
    \frac{a \, \gamma \, c}{1 + \gamma} \, ( \bfbeta \dotproduct \Bf B ) \, \bfbeta -
    \left( a + \frac{1}{1 + \gamma} \right) \, \mathbf{\bfbeta \times  E} 
    \right] \label{orpt} \\
  &= - \frac{q}{m \, c} \left[ 
    \left( \frac{1}{\gamma} + a \right) \, c \, \Bf B_{\perp} +
    \frac{(1 + a) \, c}{\gamma} \, \Bf B_\parallel -
    \left( a + \frac{1}{1 + \gamma} \right) \mathbf{\bfbeta \times E} 
    \right] \nonumber
\end{align}
and
\begin{equation}
  {\pmb\Omega}_{EDM} (\mathbf{r,P},t) = 
  - \frac{q \, \eta}{2 \, m \, c} \left[
  \Bf E - \frac{\gamma}{1 + \gamma} \, 
  ( \bfbeta \dotproduct \Bf E ) \, \bfbeta +
  c \, \mathbf{\bfbeta \times B}
  \right]
\end{equation}
Here $\Bf E (\Bf r ,t)$ and $\Bf B (\Bf r ,t)$ are the electric and magnetic fields, $\Bf B_\perp$
and $\Bf B_\parallel$ are the components perpendicular and parallel to the particle's momentum,
$\gamma$ is the particle's relativistic gamma factor, $q$, and $m$ are the particle's charge and
mass, $\bfbeta$ is the normalized velocity, $a = (g-2)/2$ is the particle's anomalous magnetic
moment (values given in Table~\ref{t:constants}), and $\eta$ is the normalized electric dipole
moment which is related to the dipole moment $\Bf d$ via
\begin{equation}
  \Bf d = \frac{\eta}{2} \, \frac{q}{m \, c} \, \Bf S
\end{equation}
Note: Some authors define $\eta$ without the factor of $c$ is the denominator.

It is important to keep in mind that the $a$ and $g$-factors used here are defined using \Eq{mgq2m}
which, in the case of nuclei and other composite baryonic particles, differs from the conventional
definition \Eq{mgq2m2}. See the discussion after \Eq{mgq2m}.

%-----------------------------------------------------------------   
\section{Quaternion Representation of Spin Rotations}
\label{s:quat}

\bmad uses a quaternion representation for spin rotations. The following is a brief introduction to
quaternions. For more information, the reader is referred to the Web. In particular, the
\vn{Quaternions and spatial rotation} article at \vn{wikipedia.org}. 

A quaternion $\bfq$ is a 4-vector $\bfq = (q_0, q_x, q_y, q_z)$ where the components are reals if they represent a
rotation and are Taylor series if they represent a rotation map (\sref{s:spin.map}). A quaternion can
also be represented in the form:
\begin{equation}
  \bfq = q_0 + q_x \, \cali + q_y \, \calj + q_z \calk
  \label{qqqqq}
\end{equation}
where $\cali$, $\calj$, and $\calk$ are the {\em fundamental quaternion units} with the properties
under multiplication
\begin{equation}
  \cali^2 = \calj^2 = \calk^2 = \cali \, \calj \, \calk = -1, \quad 
  \cali \, \calj = \calk, \quad \calj \, \cali = -\calk, \quad \text{etc.}
\end{equation}
$\cali$, $\calj$, and $\calk$ do not commute among themselves but do commute with real numbers. 

The $q_0$ component of a quaternion is called the \vn{real} (or sometimes \vn{scalar}) part and the
other three components are called the \vn{imaginary} (or sometimes \vn{vector}) part. The dot
product (inner product) of two quaternions is defined to be standard Euclidean dot product in 4D:
\begin{equation}
  \bfa \dotproduct \bfb = a_0 \, b_0 + a_x \, b_x + a_y \, b_y + a_z \, b_z
\end{equation}

When a quaternion represents a rotation, $\cali$, $\calj$, and $\calk$ can be thought of as representing unit
vectors along the three Cartesian axes $\bfx$, $\bfy$, and $\bfz$ respectively. A rotation through an angle
$\theta$ around the unit axis $\bfu = (u_x, u_y, u_z)$ is represented by the quaternion
\begin{equation}
  \bfq = \cos\frac{\theta}{2} + (u_x \, \cali + u_y \, \calj + u_z \, \calk) \sin\frac{\theta}{2}
  \label{qt2ui}
\end{equation}

A rotation quaternion $\bfq$ has unit normalization:
\begin{equation}
  1 = ||\bfq|| = \sqrt{\bfq \dotproduct \bfq} = \sqrt{q_0^2 + q_x^2 + q_y^2 + q_z^2}
  \label{1qqq}
\end{equation}
Such a quaternion is called a \vn{unit} quaternion.
The quaternion conjugate $\bfq^*$ is defined by
\begin{equation}
  \bfq^* = q_0 - q_x \, \cali - q_y \, \calj - q_z \calk
\end{equation}
and the inverse $\bfq^{-1}$ is given by
\begin{equation}
  \bfq^{-1} = \frac{\bfq^*}{||\bfq||^2}
\end{equation}

Given an ordinary spatial vector $(\bfr_x, \bfr_y, \bfr_z)$, this vector is represented by a
quaternion $\bfr = (0, \bfr_x, \bfr_y, \bfr_z)$. The rotation of $\bfr$ through a rotation
represented by quaternion $\bfq$ to position $\bfr'$ is given by
\begin{equation}
  \bfr' = \bfq \, \bfr \, \bfq^*
  \label{rqrq}
\end{equation}
The transformation matrix corresponding to the transformation of \Eq{rqrq} is
\begin{equation}
  \bfR = \begin{pmatrix}
    q_0^2 + q_x^2 - q_y^2 - q_z^2    & 2 \, q_x \ q_y - 2 \, q_0 \, q_z & 2 \, q_x \ q_z + 2 \, q_0 \, q_y \\
    2 \, q_x \ q_y + 2 \, q_0 \, q_z & q_0^2 - q_x^2 + q_y^2 - q_z^2    & 2 \, q_y \ q_z - 2 \, q_0 \, q_x \\
    2 \, q_x \ q_z - 2 \, q_0 \, q_y & 2 \, q_y \ q_z + 2 \, q_0 \, q_x & q_0^2 - q_x^2 - q_y^2 + q_z^2 
  \end{pmatrix}
  \label{rqqq}
\end{equation}

In quaternion notation, two rotations $\bfq_1$ and $\bfq_2$ are combined into one rotation using the formula
\begin{equation}
  \bfq_{12} = \bfq_2 \, \bfq_1
\end{equation}
where $\bfq_{12}$ is the result of rotation $\bfq_1$ followed by $\bfq_2$. Note that this equation
is analogous to how rotation matrices are combined (for more information see \cite{b:quat}).

%-----------------------------------------------------------------   
\section{Invariant Spin Field}
\label{s:isf}

In a storage ring, the \vn{invariant spin field} $\bfn(\bfr, s) = (n_x, n_y, n_z)$
\cite{b:spin.hoff,b:duan15}, which is a function of phase space position $\bfr = (x, p_x, y, p_y, z,
p_z)$ and longitudinal position $s$, is the {\em continuous function} with unit amplitude that
satisfies
\begin{equation}
  \bfn(\Cal M_r \bfr, s) = \Cal M_s(\bfr) \, \bfn(\bfr, s)
  \label{nmrs}
\end{equation}
where $\Cal M_r$ is the orbital part of the 1-turn transfer map and $\Cal M_s(\bfr)$, derived from
T-BMT equation, is the spin part of the map which is a function of $\bfr$. That is, the invariant
spin field (ISF) obeys the T-BMT equation so a particle whose spin points in the direction of
$\bfn(\bfr, s)$ at some time $t$ will, in the absence of radiation effects, always have its spin
pointing in the direction of $\bfn(\bfr, s)$. When there are no resonances, $\bfn(\bfr, s)$ is
unique up to a flip of sign.

In general, it is not straightforward to calculate $\bfn$. The exceptional case (besides the cases
where there is a resonance) is if the particle is on the closed orbit $\bfr_0$. In this case, since
$\Cal M_r \bfr_0 = \bfr_0$, and since $\Cal M_s(\bfr)$ is a rotation matrix, \Eq{nmrs} can be solved
to give the invariant spin field on the closed orbit denoted by $\bfn_0$.  Over one turn, a spin on
the closed orbit rotates around $\bfn_0$ by the angle $2 \pi \nu_0$ where $\nu_0$ is the
closed-orbit spin tune.

Once the invariant spin field has been calculated, various quantities of interest can be
computed. For example, given some initial distribution of spins in a beam, the maximum possible time
averaged polarization $\left< \bfS \right>_{\max}$ is
\begin{equation}
  \left< \bfS \right>_{\max} = \int d\bfr \, \rho(\bfr) \, \bfn(\bfr)
\end{equation}
where the integral is over the beam phase space space density $\rho$ and the longitudinal
$s$-dependence is implicit. The above equation neglects any single spin polarization or
depolarization processes. Notice that what is calculated is a time averaged quantity.
Instantaneously, the beam can be fully polarized but the average over many turns, at some given
position $s$, cannot exceed $\left< \bfS \right>_{\max}$.

Another quantity that can be computed from knowledge of $\bfn$ is the equilibrium polarization of a beam
$\bfP_{dk}$ using the Derbenev-Kondratenko-Mane formula\cite{b:barber99}.
\begin{align}
  \bfP_{dk}(s) &= -\bfn(s) \, P_{dk} \\
  P_{dk} &= -\frac{8}{5 \, \sqrt{3}}
  \frac{\displaystyle \oint ds \,\left< g^3 \, \what\bfb \dotproduct 
    \left( \bfn - \frac{\partial \bfn}{\partial \delta} \right) \right>}
  {\displaystyle \oint ds \, \left< g^3 \left( 1 - \frac{2}{9} (\bfn \dotproduct \what\bfs)^2 + 
    \frac{11}{18} \left| \frac{\partial \bfn}{\partial \delta} \right|^2 \right) \right>}
    \nonumber
\end{align}
This formula neglects any non-radiative processes so it is generally only valid for positrons and
electrons.  In the above formula, $<>$ denotes an average over phase space, $g = 1/\rho$ is the
bending strength ($\rho$ is the bending radius), $\what\bfs$ is the unit vector in the direction of
motion, and $\delta$ is the fractional energy deviation which, for ultra-relativistic particles, is
the same as phase space $p_z$. In the above equation $\what\bfb$ is defined to be
\begin{equation}
  \what\bfb \equiv \frac{\what\bfs \cross d\what\bfs/ds}{|d\what\bfs/ds|}
\end{equation}
Notice that $\what\bfb$ is the direction of the magnetic field when $\what\bfs$ is perpendicular to
the magnetic field and when there is no electric field.

The time dependence of the polarization is \cite{b:barber99})
\begin{equation}
  \bfP(t) = \bfP_{dk} \, \left( 1 - \exp{-t/\tau_{dk}} \right) + \bfP_0 \, \exp{-t/\tau_{dk}}
\end{equation}
where $\bfP_0$ is the initial polarization and the polarization rate $\tau_{dk}^{-1}$ is 
\begin{equation}
  \tau_{dk}^{-1} = \frac{5 \, \sqrt{3}}{8} \frac{r_e \, \gamma^5 \, \hbar}{m}
  \frac{1}{C} \, \oint ds \, \left< g^3 \, \left( 1 - \frac{2}{9} (\bfn \dotproduct \what\bfs)^2 + 
  \frac{11}{18} \left| \frac{\partial \bfn}{\partial \delta} \right|^2 \right) \right>
  \label{t583}
\end{equation}

$\tau_{dk}^{-1}$ can be decomposed into two parts:
\begin{equation}
  \tau_{dk}^{-1} = \tau_{st}^{-1} + \tau_{dep}^{-1}
  \label{tdk}
\end{equation}
where $\tau_{st}^{-1}$ is the Sokolov-Ternov polarization rate given by the first two terms on the
RHS in \Eq{t583} and the depolarization rate $\tau_{dep}^{-1}$ is given by the the third term:
\begin{equation}
  \tau_{dep}^{-1} = \frac{5 \, \sqrt{3}}{8} \frac{r_e \, \gamma^5 \, \hbar}{m}
  \frac{1}{C} \, \oint ds \, \left< g^3 \,
  \frac{11}{18} \left| \frac{\partial \bfn}{\partial \delta} \right|^2 \right>
  \label{tdep}
\end{equation}

%-----------------------------------------------------------------   
\section{Linear \texorpdfstring{$d\bfn/d\delta$}{dn/dpz} Calculation}
\label{s:dn.calc}

When evaluating the equations in the previous section, in many situations it is sufficient to just
use the value of $d\bfn/d\delta$ as calculated in the linear regime. In the linear regime,
$d\bfn/d\delta$ is only dependent upon the $s$-position and is independent of the phase space
position. The calculation of $d\bfn/d\delta$ starts with the linearized transport equations which
are characterized by a $6\times6$ orbital transfer matrix $\bfM$ along with the spin transport which
can be written in the form
\begin{equation}
  \bfq_s(\bfr) = \bfq_0 + \overrightarrow{\bfq} \dotproduct \bfr
  \label{qqqr}
\end{equation}
The quaternion map $\bfq$, evaluated at the orbital phase space point $\bfr$, has a zeroth order
part $\bfq_0$ (the spin rotation for a particle on the closed orbit) and the first order part
$\overrightarrow{\bfq} = (\bfq_1, \ldots, \bfq_6)$ which is a vector of six quaternions and which is
evaluated in \Eq{qqqr} by taking the dot product with the vector $\bfr$.

The closed orbit invariant spin $\bfn_0$ which has unit amplitude satisfies the equation
\begin{equation}
  \bfq_0 \, \bfn_0 \, \bfq_0^* = \bfn_0
  \label{qnqn}
\end{equation}
The solution to this equation, normalized to one, is
\begin{equation}
  \bfn_0 = \frac{(q_{0,x}, q_{0,y}, q_{0,z})}{\|(q_{0,x}, q_{0,y}, q_{0,z})\|}
  \label{nkqqq}
\end{equation}
Since $\bfq_s$ is a rotation quaternion, the magnitude of $\bfq_s(\bfr)$ must remain one. Using
\Eq{qqqr} in \Eq{1qqq}, to keep a unit magnitude to linear order gives the condition
\begin{equation}
  \bfq_0 \dotproduct \bfq_i = 0, \qquad i = 1, \ldots, 6
\end{equation}
for all $\bfq_i$ components of $\overrightarrow{\bfq}$.

To calculate the linear $d\bfn/d\delta$, the first step is to compute the eigenvectors $\bfv_j$ and
eigenvalues $\lambda_j$, $j = 1, \ldots, 6$ of the 1-turn orbital matrix. The
corresponding spin eigenvectors $\bfn_j$ are computed from the equation
\begin{equation}
  \bfq_s(\bfv_j) \,\, (\bfn_0 + \bfn_j) \,\, \bfq_s^*(\bfv_j) = \bfn_0 + \lambda_j \, \bfn_j
  \label{qnnq}
\end{equation}
Using \Eqs{qqqr} and \eq{qnqn}, and keeping only linear terms gives
\begin{equation}
  \lambda_j \, \bfn_j - \bfq_0 \, \bfn_j \, \bfq_0^* = 
  (\overrightarrow{\bfq} \dotproduct \bfv_j) \, \bfn_0 \, \bfq_0^* + 
  \bfq_0 \, \bfn_0 \, (\overrightarrow{\bfq}^* \dotproduct \bfv_j)
  \label{lnqnq}
\end{equation}
This equation is linear in the unknown $\bfn_j$ and so may be easily solved using standard linear
algebra techniques.

Since the eigenvectors $\bfv_j$ span phase space, for any given phase space position $\bfr$, there
exist a set of values $A_j(\bfr)$, $j = 1, \ldots, 6$, such that
\begin{equation}
  \bfr = \sum_{j = 1}^6 A_j \, \bfv_j
\end{equation}
Define the function $\bfn$ by
\begin{equation}
  \bfn(\bfr) \equiv \bfn_0 + \sum_{j = 1}^6 A_j(\bfr) \, \bfn_j
\end{equation}
This function obeys the T-BMT equation and is continuous and thus is the solution (up to a flip in
sign) for the invariant spin field. From this, ${\partial \bfn}/\partial \delta$, which is computed
taking the derivative at constant $x$, $p_x$, $y$, $p_y$, and $z$, is obtained via
\begin{equation}
  \frac{\partial \bfn}{\partial \delta} = 
  \sum_{j = 1}^6 A_j \, \bfn_j
  \label{ndan}
\end{equation}
with the $A_j$ being computed by inverting the equation
\begin{equation}
  (0, 0, 0, 0, 0, 1)^t = \sum_{j = 1}^6 A_j \, \bfv_j
  \label{000001}
\end{equation}
where the superscript $t$ means transpose. Notice that for ${\partial \bfn}/\partial \delta$, as
well as any other partial derivative, the component in the direction of $\bfn_0$ will be zero since,
to first order, the amplitude of $\bfn$ must be constant (since the equation for $\bfn$ is only
valid to first order, the computed amplitude will have non-zero higher order terms).

A problem arises if the machine that is being simulated does not have any RF cavities or the voltage
in the cavities is zero. In this case, there are no synchrotron oscillations which results in
degenerate eigenvectors and the eigenvectors will not span all of phase space. The solution here
is to reduce the dimensionality of phase space to five by remove the $z$ coordinate. The above
equations then can be used with the sums over $j$ ranging from 1 to 5. 

It is sometimes informative to compute the contribution of ${\partial \bfn}/\partial \delta$ due to a single
mode of oscillation. That is, to compute ${\partial \bfn}/\partial \delta$ with the sum in
\Eq{ndan} restricted to be over the two corresponding eigen states that comprise the oscillation
mode of interest. This information can help guide lattice design.

%-----------------------------------------------------------------   
\section{SLIM Formalism}
\label{s:slim}

The \vn{SLIM} formalism\cite{b:chao.spin,b:barber99}, introduced by Alex Chao (the name references
an early computer program that implemented the formalism), is a way to represent the linearized
(that is, first order) orbital and spin transport as an $8 \cross 8$ matrix which then can be
analyzed. The idea is to expand the transport map around the closed orbit $(\bfr_0, \bfn_0)$ where
$\bfr_0$ is the orbital closed orbit and $\bfn_0$ is the ``spin closed orbit''. Namely the
unit-vector, one-turn periodic solution of the Thomas-BMT equation on $\bfr_0$\footnote
  {
Warning: The symbol $\hat n$ or
$\vec n$ used in \cite{b:chao.spin,b:barber85} and other early literature to denote the periodic
solution of the T--BMT equation on the closed orbit should be replaced by the symbol $\hat n_0$ to
conform to the modern convention \cite{b:barber99} and thereby avoid confusion with the symbol $\hat
n$ which denotes the invariant spin field.  In addition, the symbols $\vec m$ and $\vec l$
appearing, for example, in the formulae for the matrix $\bfG$ in \cite{b:barber85}, should be
replaced by the symbols $\hat m_0$ and $\hat l_0$, namely by the modern symbols for the two
(normally) non-periodic solutions of the T-BMT equation, which together with $\hat n_0$, form an
orthonormal coordinate system.
  }.
% 
$\bfn_0$ is just the invariant spin field on the closed orbit. The formalism provides estimates of
the equilibrium spin polarization and the rate of depolarization in electron storage rings, both
under the restriction of the aforementioned linearization. Moreover, a procedure known as
spin-matching, for minimizing depolarization driven by the noise injected into synchro-betatron
motion by synchrotron radiation, and which involves optimizing the layout of the ring, can be
executed in a simple and elegant way via the SLIM formalism. The formalism can also give insights
into proton spin dynamics in regimes where the linearization suffices.

The \vn{SLIM} formalism expresses spin components using two right-hand coordinate systems:
\footnote{Different authors will use different conventions for the ordering of the axes
The ordering used here puts $\bfn_0$ second reflecting the fact that in many rings the $\bfn_0$
axis will point in the vertical $y$-direction in the arcs.}
\begin{align}
  &\big( \bfl(s), \bfn_0(s), \bfm(s) \big)
  \qquad \text{and} \qquad \CRNO
  &\big( \bfl_0(s), \bfn_0(s), \bfm_0(s) \big)
\end{align}
The axes $\bfl_0(s)$ and $\bfm_0(s)$ are solutions of the Thomas-BMT equation on the closed orbit
and, generally, are not one-turn periodic. The axes $\bfl(s)$ and $\bfm(s)$ are chosen to be
one-turn periodic but can have an arbitrary $s$ dependence which can be chosen for convenience
otherwise. The axes $\bfl_0(s)$ and $\bfm_0(s)$ are used for spin-matching and $\bfl(s)$ and
$\bfm(s)$ are used for calculating polarization and depolarization.  With respect to these axes, a
unit-length spin $\bfS$ can be written as
\begin{align}
  \bfS &= \sqrt{1- \alpha_0^2 - \beta_0^2} ~\bfn_0 + \alpha_0 \, \bfl_0 + \beta_0 \, \bfm_0 
  \qquad \text{or} \qquad \CRNO
  \bfS &= \sqrt{1- \alpha^2 - \beta^2} ~\bfn_0 + \alpha \, \bfl + \beta \, \bfm
  \label{s1ab}
\end{align}

To linearize the transport, it is assumed that $\alpha_0$, and $\beta_0$ (and hence $\alpha$ and
$\beta$) are small compared to one. To first order, the variation from unity of the spin component
along the $\bfn_0$ axis will be second order and can be ignored:
\begin{align}
  \bfS &\approx \bfn_0 + \alpha_0 \, \bfl_0 + \beta_0 \, \bfm_0
  \qquad \text{or} \qquad \CRNO
  \bfS &\approx \bfn_0 + \alpha \, \bfl + \beta \, \bfm
\end{align}

The $\bfn_0$ coordinate is dropped since the spin component along $\bfn_0$ is a constant. With this,
the eight-dimensional spin-orbit phase space used in the SLIM formalism is
\begin{align}
  &(x, p_x, y, p_y, z, p_z, \alpha_0, \beta_0)
  \qquad \text{or} \qquad \CRNO
  &(x, p_x, y, p_y, z, p_z, \alpha, \beta)
  \label{xpxypy}
\end{align}
where the orbital part $x, p_x$, etc. is taken with respect to the closed orbit. 

The first order map between two any points $s_1$ and $s_2$ is an $8 \cross 8$ matrix $\wt\bfM$ which
is written in the form
\begin{equation}
  \wt\bfM(s1, s2) = \begin{pmatrix}
    \bfM_{6\cross6} & \Bf 0_{6\cross2} \\
    \bfG_{2\cross6} & \bfD_{2\cross2}
  \end{pmatrix}
  \label{mm0gd}
\end{equation}
where $\bfM(s_1, s_2)$ is the $6\cross6$ orbital phase space transport matrix, and $\bfG(s_1, s_2)$
contains the coupling of the spin coordinates $(\alpha_0, \beta_0)$ or $(\alpha, \beta)$ to the
orbital motion. The upper right block $\Bf 0_{6\cross2}$ in the $\wt\bfM$ matrix is zero since
Stern-Gerlach effects are ignored. When $\bfG$ is calculated with respect to the $(\bfl_0, \bfm_0)$
axes, large spin precessions on the closed orbit due to dipole and solenoid fields are
eliminated. That leaves small precessions due to synchro-betatron motion. The $\bfG$ matrix then
represents the dominating linear dependence of the small precessions on the six synchro-betatron
coordinates and it then provides a good framework for analysis \cite{b:barber85,b:barber99}. In
\Eq{mm0gd}, $\bfD$ is a $2\cross2$ rotation matrix for the spin transport of a particle on the
closed orbit. In this case, since the $\bfl_0(s)$ and $\bfm_0(s)$ are solutions to the T-BMT
equation, $\bfD$ is the unit matrix.

To compute $\widetilde\bfM$ for a section of the ring, the first step is to find the $6 \times 6$
orbital matrix for the section. To calculate $\bfn_0$, $\bfl_0$ and $\bfm_0$, first $\bfn_0$ at some
starting point $s$ is calculated (section 18.3) and propagated around the ring. This $\bfn_0$ is
then available for calculations involving the whole ring. If only part of the ring is being
analyzed, the orientation of $\bfn_0$ at the start of the section can be an input parameter. That
is, it can be given by the User and not calculated. However, for spin-matching, it usually only
makes physical sense to use the $\bfn_0$ at the start of the section that corresponds to the
$\bfn_0$ calculated for the whole ring. After $\bfn_0$ is known at some $s$-position, $\bfl_0$ and
$\bfm_0$ at that $s$-position can be chosen somewhat arbitrarily to form the right handed coordinate
system. Sometimes it is possible to make a special choice of the initial $\bfl_0$ and $\bfm_0$ in
order to simplify the $\bfG$ matrices. For example, in a section where there are only drifts and
quadrupoles so that there is no spin rotation for a particle traveling on the centerline, with
$\bfn_0$ pointing vertically, a choice of $\bfm_0$ pointing in the longitudinal $s$-direction results
in the first line of the $\bfG$ matrix for the section being zero. After the initial $\bfl_0$ and
$\bfm_0$ axes have been specified at some initial $s$, the axes can be transported along the closed
orbit of the section.

If the one-turn $\bfG$ were zero everywhere, the spin motion would be completely decoupled from the
orbital motion (at least to first order) and the depolarization rate $\tau_{dep}^{-1}$ given by
\Eq{tdep} would be zero since $\partial\bfn / \partial\delta$ would be zero. Therefore,
spin-matching analysis for a section of the ring involves adjusting the parameters (quadrupole
strengths, drift lengths etc) of the section so as to minimize elements in appropriate columns of
the $\bfG$ matrix. This decreases the rate of depolarization by minimizing
$\partial\bfn/\partial\delta$ at the dipole magnets (where $g$ in \Eq{tdep} is nonzero)
\cite{b:barber99}. Such adjustments are made while simultaneously maintaining acceptable
Courant-Snyder parameters and for this the closed orbit should be taken to be the design orbit.
This optimization can be carried out using standard facilities in \bmad. The calculation of
$\partial\bfn/\partial\delta$ in the SLIM approximation is described below.

The process for calculating electron polarization and the rate of depolarization in the \vn{SLIM}
formalism is as follows. First, the $8 \times 8$ matrix $\widetilde\bfM$ for one-turn is calculated
as described above. After this, using the closed-orbit spin tune $\nu_0$, a specific version of
$(\bfl, \bfm)$ is constructed by rotating the vectors $\bfl_0$ and $\bfm_0$ backwards around
$\bfn_0$ by the angle $2\pi \nu_0$ in a drift space right at the end of the turn, thereby
transforming $\alpha_0$ and $\beta_0$ into $\alpha$ and $\beta$ and transforming the $\bfG$ matrix
correspondingly\footnote{Adding a rotation at the end is just for convenience. For some other
applications it is useful to choose axes $\bfl$ and $\bfm$ with respect to which spins precess at
the constant rate with a phase advance of $2\pi \nu_0$ per turn.}. The original one-turn $\bfG$
matrix is not one-turn periodic but the transformed $\bfG$ matrix is one-turn periodic and the
matrix $\bfD$ for one-turn becomes the $2 \times 2$ rotation matrix with rotation angle $2\pi \nu_0$
\cite{b:chao.spin}. The new matrix $\widetilde \bfM$ is then also one-turn periodic and its
eigenvectors are used as described after \Eq{qvw} for calculating the derivative ${\partial
\bfn}/\partial \delta$ used in \Eq{tdep}. Note that if the elements in the appropriate columns of
the non-periodic $\bfG$ matrix for the one-turn map at a dipole have been minimized by
spin-matching, the corresponding elements of the periodic one-turn $\bfG$ matrix have been minimized
too. As a consequence it can be seen, via \Eqs{wdlgv} and \eq{ndaw}, that
$\partial\bfn/\partial\delta$ has been minimized as required.

In contrast to the approach in \cite{b:barber85,b:barber99}, \bmad calculates the $\bfG$ and $\bfD$
matrices from the quaternion of the spin transport map (which \bmad calculates via PTC
(\sref{c:ptc.use})). After the $(\bfl_0, \bfn_0, \bfm_0)$ coordinates have been calculated (or set by
the User) at some initial point, the spin axes can be transported using the $\bfq_0$ quaternion
(\Eq{qqqr}). When analyzing only a section of a ring, there is no identifiable spin tune so nothing
further needs to be done. In this case, the $\bfD$ matrix is just a unit matrix. When analyzing
one-turn maps, if the $\bfl$ and $\bfm$ axes are set to be the $\bfl_0(s)$ and $\bfm_0(s)$ axes
except at the end of the lattice, the spin phase advance as a function of $s$ will be zero except
just before the starting position where there will be a discontinuous jump in phase.

Once the $(\bfl_0, \bfn_0, \bfm_0)$ axes have been calculated, the matrices $\bfG$ and $\bfD$ can be
calculated from the spin transport map (which \bmad calculates via PTC (\sref{c:ptc.use})).  The
first order transport map \Eq{qqqr} is used. Let $\bfq_{lnm}(s)$ be the quaternion that transforms
from $(\bfl_0, \bfn_0, \bfm_0)$\footnote{ Such a formalism works also with the $(\bfl, \bfn_0,
\bfm)$} coordinates to $(x, y, z)$ coordinates at a given point $s$. With this, the spin transport
$\what\bfq$ from $s_1$ to $s_2$ in the $(\bfl_0, \bfn_0, \bfm_0)$ coordinate system is
\begin{equation}
  \what\bfq_s(s_1, s_2) = \bfq_{lnm}(s_2) \, \bfq_s(s_1, s_2) \, \bfq_{lnm}^{-1}(s_1)
\end{equation}
The zeroth order part of this map 
\begin{equation}
  \what\bfq_0(s_1,s_2) = \bfq_{lnm}(s_2) \, \bfq_0(s_1, s_2) \, \bfq_{lnm}^{-1}(s_1) 
\end{equation}
represents a rotation around the $\bfn_0$ axis. 

To calculate the $\bfD$ matrix, $\what\bfq_0$ is converted into a $3 \times 3$ rotation matrix
$\bfR_0$ via \Eq{rqqq}). The second row and second column of this rotation matrix corresponds to the
$\bfn_0$ axis. Since the component of the spin along this axis does not vary to first order,
$\bfR_0$ has the form
\begin{equation}
  \Bf R_0 = \begin{pmatrix}
      R_0(1,1) & 0 & R_0(1,3) \\
      0        & 1 & 0        \\
      R_0(3,1) & 0 & R_0(3,3)
  \end{pmatrix}
\end{equation}
That is, the rotation is around the $\bfn_0$ axis. Since the $\bfn_0$ spin component is ignored in
the SLIM formalism (\Eq{xpxypy}), the $2 \times 2$ $\Bf D$ matrix is simply $\bfR_0$ with the second
row and second column removed.
\begin{equation}
  \Bf D(s_1, s_2) = \begin{pmatrix}
      R_0(1,1) & R_0(1,3) \\
      R_0(3,1) & R_0(3,3)
  \end{pmatrix}
\end{equation}
In particular, with $(\bfl_0, \bfn_0, \bfm_0)$, $\widehat \bfq_0$ represents the identity ($\equiv
(1, 0, 0, 0)$) and $\bfD$ is a unit matrix as expected.

The rows of the $\bfG$ matrix encode the first-order dependence of the changes of the angles
$\alpha_0$ and $\beta_0$ (or of the angles $\alpha$ and $\beta$).  The $\bfG$ matrix can therefore
be calculated from $\what\bfq_i$ which is the first order part of $\what\bfq_s$
\begin{equation}
  \what\bfq_i = \bfq_{lnm}(s_2) \, \bfq_i(s_1, s_2) \, \bfq_{lnm}^{-1}(s_1)
\end{equation}
Using \Eq{qqqr} in \Eq{rqqq} and keeping only first order terms gives
\begin{align}
  \bfG(1,i) &= 2 (\what q_{0,y} \, \what q_{i,x} - \what q_{0,0} \, \what q_{i,z}) 
  \label{g2qqqq} \\
  \bfG(2,i) &= 2 (\what q_{0,0} \, \what q_{i,x} + \what q_{0,y} \, \what q_{i,z}),
  \quad i = 1, \ldots, 6
  \nonumber
\end{align}
where the fact that $\what q_{0,x} = \what q_{0,z} = 0$ has been used.\footnote
  {
Do not be confused by the $x$, $y$ and $z$ subscripts which refer to the components of $\what q$
as defined in \Eq{qqqqq}. $\what q$ rotates spins in the $(\bfl_0, \bfn_0, \bfm_0)$ coordinate system.
Not the $(x, y, z)$ coordinate system.
  }
\footnote
  {
Notice that unlike the operation of going from the linearized quaternion transport (\Eq{qqqr} to the
$\widetilde\bfM$ matrix, given an $\widetilde\bfM$ matrix, it is not possible to uniquely construct
the $\what\bfq_i$ quaternions. $\what q_{i,x}$ and $\what q_{i,z}$ can be determined by
\Eq{g2qqqq}. However, $\what q_{i,0}$ and $\what q_{i,y}$ can only be determined via \Eq{qnqn} up
to an unknown factor $\kappa$:
\begin{equation}
  \what q_{i,0} = \kappa \, \what q_{0,y}, \qquad \what q_{i,y} = -\kappa \, \what q_{0,0}
\end{equation}
A finite $\kappa$ represents a variation of the spin tune with a particle's orbital phase space
position. This is, a finite $q_{i,0}$ and $q_{i,y}$ represent a non-linear effect which will average
to zero over many turns as a particle with constant orbital amplitude samples different points on
the phase space torus it is on.
  }

The calculation of the derivative ${\partial\bfn}/\partial\delta$ within the SLIM formalism is
similar to the calculation using quaternions (\sref{s:dn.calc}). The following follows
Barber\cite{b:barber99}.  The calculation starts with the one-turn periodic $8 \times 8$ matrix
$\widetilde \bfM$ [Here the periodic $(\bfl(s), \bfn_0(s), \bfm(s))$ coordinate system must be used
since the ending coordinates for $\bfM$ must be the same as the starting coordinates.]  The
eigenvectors $\bfu_j$ and eigenvalues $\lambda_j$ ($j = 1, \ldots 8$) of $\widetilde \bfM$ are of
the form
\begin{align}
  \bfu_j &= \begin{pmatrix} \bfv_j \\ \bfw_j \end{pmatrix}, \quad j = 1, \ldots, 6
  \label{qvw} \\
  \bfu_j &= \begin{pmatrix} \Bf 0_6 \\ \bfw_j \end{pmatrix}, \quad j = 7, 8 \nonumber
\end{align}
where $\bfv_j$ are eigenvectors of the orbital submatrix $\bfM$, and for the first six eigenvectors
the $\bfw_j$ are computed via (compare with \Eqs{lnqnq})
\begin{equation}
  \bfw_j = \left[ \lambda_j \, \bfI_2 - \bfD \right]^{-1} \bfG \, \bfv_j, \quad j = 1, \ldots, 6
  \label{wdlgv}
\end{equation}
where $\bfI_2$ is the $2 \times 2$ unit matrix. These eigenvectors, computed at the chosen starting
point $s1$ and are then propagated to other $s$-positions $s2$ using ${\widetilde \bfM}(s1, s2)$.

The derivative ${\partial \bfn}/\partial \delta$ is computed analogously to \Eq{ndaw}
\begin{equation}
  \frac{\partial \bfn}{\partial \delta} = 
  \left( \frac{\partial \alpha}{\partial \delta}, \, \frac{\partial \beta}{\partial \delta} \right) = 
  \sum_{j = 1}^6 A_j \, \bfw_j
  \label{ndaw}
\end{equation}
with the $A_j$ being computed from \Eq{000001}.

Alternatively, Chao \cite{b:chao79} gives a an analytical formulation where the eigenvectors are
normalized in the form
\begin{equation}
  \bfv_{j+1}^{t} \, \bfS \, \bfv_j = i, \quad j = 1, 3, 5
  \label{vsvi}
\end{equation}
where the eigenvectors have been arranged in complex conjugate pairs with $\bfv_{j+1} = \bfv_j^*, \,
j = 1, 3, 5$ with the superscript $*$ denoting the complex conjugate. In \Eq{vsvi} $\bfS$ is the matrix
\begin{equation}
  \bfS = \begin{pmatrix}
      0 & -1 &  0 &  0 &  0 &  0 \\
      1 &  0 &  0 &  0 &  0 &  0 \\
      0 &  0 &  0 & -1 &  0 &  0 \\
      0 &  0 &  1 &  0 &  0 &  0 \\
      0 &  0 &  0 &  0 &  0 & -1 \\
      0 &  0 &  0 &  0 &  1 &  0 \\
  \end{pmatrix}
\end{equation}
With this, ${\partial \bfn}/{\partial \delta}$ is computed via
\begin{equation}
  \frac{\partial \bfn}{\partial \delta} = i \, \sum_{j = 1}^6 \bfv_{j5}^* \, \bfw_j
  \label{ndivw}
\end{equation}

%-----------------------------------------------------------------   
\section{Spinor Notation}

The following describes the old spinor representation formally used by \bmad to represent
spins. This documentation is kept as an aid for comparison with the spin tracking literature.

In the SU(2) representation, a spin $\Bf S$ is written as a spinor $\Psi = \left( \psi_{1}, \psi_{2}
\right)^{T}$ where $\psi_{1,2}$ are complex numbers. The conversion between SU(2) and SO(3) is
\begin{equation}  
  \Bf S = \Psi^{\dagger} \Bf {\bfsig} \, \Psi 
  \qquad \longleftrightarrow \qquad
  \Psi  = \frac{e^{i \xi}}{\sqrt{2 \left(1+s_{3}\right)}}   
     \begin{pmatrix} 1+s_{3} \\ s_{1}+i s_{2} \end{pmatrix}   
\end{equation}  
Where $\xi$ is an unmeasurable phase factor, and ${\bfsig} = (\sigma_x, \sigma_y, \sigma_z)$ are
the three Pauli matrices
\begin{equation}
  \sigma_x = \begin{pmatrix} 0 &  1 \\ 1 &  0 \end{pmatrix}, \qquad
  \sigma_y = \begin{pmatrix} 0 & -i \\ i &  0 \end{pmatrix}, \qquad
  \sigma_z = \begin{pmatrix} 1 &  0 \\ 0 & -1 \end{pmatrix}
\end{equation}
In polar coordinates
\begin{equation}   
  \Psi = \begin{pmatrix} \psi_{1} \\ \psi_{2} \end{pmatrix}
       = e^{i \xi}
         \begin{pmatrix} 
            \cos \frac{\theta}{2} \\   
            e^{i \phi} \, \sin \frac{\theta}{2}
         \end{pmatrix}
  \qquad \longleftrightarrow \qquad
  \Bf S = \begin{pmatrix} \sin \theta \cos \phi \\   
                          \sin \theta \sin \phi \\   
                          \cos \theta \end{pmatrix}
  \label{pp1p2}
\end{equation}
Due to the unitarity of the spin vector,   
$|\psi_{1}|^{2} + |\psi_{2}|^{2} = 1$.
The spinor eigenvectors along the $x$, $y$ and $z$ axes are
\begin{align}
   \Psi_{x+} &= \frac{1}{\sqrt{2}} \, \begin{pmatrix} 1 \\ 1 \end{pmatrix} \, , 
  &\Psi_{x-} &= \frac{1}{\sqrt{2}} \, \begin{pmatrix} 1 \\ -1 \end{pmatrix} \, , \CRNO
   \Psi_{y+} &= \frac{1}{\sqrt{2}} \, \begin{pmatrix} 1 \\ i \end{pmatrix} \, , 
  &\Psi_{y-} &= \frac{1}{\sqrt{2}} \, \begin{pmatrix} 1 \\ -i \end{pmatrix} \, , \\
   \Psi_{z+} &=                       \begin{pmatrix} 1 \\ 0 \end{pmatrix} \, , 
  &\Psi_{z-} &=                       \begin{pmatrix} 0 \\ -1 \end{pmatrix} \, . \nonumber
\end{align}

In spinor notation, the T-BMT equation can be written as
  \begin{equation}   
    \frac{\mathrm{d}}{\mathrm{d} t} \Psi = - \frac{i}{2} \left( \bfsig \dotproduct   
    {\pmb\Omega} \right) \Psi = -\frac{i}{2} \begin{pmatrix}
    \Omega_z & \Omega_x - i \, \Omega_y \\
    \Omega_x + i \, \Omega_y & -\Omega_z \end{pmatrix}
    \Psi
  \end{equation}
The solution over a time interval $\Delta t$, assuming constant $\pmb\Omega$, leads to a rotation of
the spin vector by an angle $\alpha = |\pmb\Omega| \, \Delta t$ around a unit vector $\bfhat a$
pointing in the same direction as $\pmb\Omega$
  \begin{align}   
    \Psi_f &= \exp \left[ -i \frac{\alpha}{2} \bfhat a \dotproduct \bfsig \right] \Psi_i \CRNO
         &= \left[ \cos \left( \frac{\alpha}{2} \right) \, \Bf I_{2} - 
            i \, (\bfhat a \dotproduct \bfsig) \, \sin \left( \frac{\alpha}{2} \right) \right] \Psi_i \\
         &= \Bf A \Psi_i. \nonumber
  \end{align}   
where $\Psi_i$ is the initial spin state, $\Psi_f$ is the final spin state, and $\Bf A$, describes
the spin transport. The Pauli matrices constitute a 2x2 Hermitian-matrix representation of the
quaternion components $\cali$, $\calj$, and $\calk$ in \Eq{qqqqq} and $\Bf A$ is the SU(2) matrix
representation of the quaternion $(a_0, \Bf a) = (\cos(\alpha/2), -\sin(\alpha/2) \, \bfhat
a)$. $\Bf A$ has the normalization condition $a_{0}^{2} + \boldsymbol{a}^{2} = 1$.

With spinors, the matrix representation of the observable $S_{\Bf u}$
corresponding to the measurement of the spin along the unit vector
$\Bf u$ is
\begin{align}
  S_{\Bf u} &\equiv \frac{\hbar}{2} \, \bfsig \dotproduct \Bf u \\   
            &= \frac{\hbar}{2} 
                   \begin{pmatrix} 
                     u_z            & u_x - i \, u_y \\
                     u_x + i \, u_y & u_z
                   \end{pmatrix}
\end{align}
The expectation value of this operator, $\Psi^\dagger \, \Bf S_u \, \Psi$, representing the spin of
a particle, satisfies the equation of motion of a classical spin vector in the particle's
instantaneous rest frame.

For a distribution of spins, the polarization $P_s$ along the unit
vector $\Bf u$ is defined as the absolute value of the average
expectation value of the spin over all N particles times
$\frac{2}{\hbar}$,
  \begin{equation}
    P_s = \frac{2}{\hbar} \frac{1}{N} \sum_{j=1}^{N} \Psi_j^\dagger S_{\Bf u} \Psi_j
  \end{equation}  

See \S~\sref{s:spin.hard.fringe} for formulas for tracking a spin through a multipole
fringe field.
