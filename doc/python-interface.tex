\chapter{Python/GUI Interface}
\index{python interface}
\label{c:python}

It is sometimes convenient to be able to run Tao via Python. For example, in an online control
system environment. \tao has scripts for doing this in one of two ways. One way is using the
\vn{ctypes} module. The other way is using the \vn{pexpect} module. A Web search will point to
documentation on \vn{ctypes} and \vn{pexpect}. The advantage of \vn{ctypes} is that it directly
acceses \tao code which makes communication between Python and \tao more robust. The disadvantage of
\vn{ctypes} is that it needs a shared-object version of the \vn{Tao} library. [See the Bmad web site
for information on building shared-object libraries.] The disadvantage of \vn{pexpect} is that it is
slower and it is possible for \vn{pexpect} to time out waiting for a response from \tao.

%--------------------------------------------------------------------------
\section{Python Interface Via Pexpect}

A python module, \vn{tao_pipe.py}, for interfacing \tao to \vn{Python}
is provided in the directory \vn{tao/python/p_expect}.

The \vn{tao_pipe} module uses the \vn{pexpect} module. The
\vn{pexpect} module is a general purpose tool for interfacing
Python with programs like \tao. If \vn{pexpect} is not present
your system, it can be downloaded from
\vn{www.noah.org/wiki/pexpect}. 

Example:
\begin{example}
  >>> import tao_pipe                                       # import module
  >>> p = tao_pipe.tao_io("../bin/tao -lat my_lat.bmad")    # init session
  >>> p.cmd_in("show global")               # Command to Tao
  >>> print(p.output)                       # print the output from Tao
  >>> p.cmd("show global")                  # Like p.cmd_in() excepts prints the output too.
\end{example}

After each call to \vn{tao_io.cmd} and \vn{tao_io.cmd_in}, the
\vn{tao_io.output} variable is set to the multiline output string
returned by \tao. To chop this string into lines, use the splitlines()
string method.

\index{python}
To get information from \tao into Python, the output from \tao,
contained in \vn{tao_io.output}, needs to be parsed. For long term
maintainability of python scripts, use the \vn{python} (\sref{s:python}) command 
as opposed to the \vn{show} command . See the \vn{python} command for more details.

%--------------------------------------------------------------------------
\section{Python Interface Via Ctypes}

A \vn{ctypes} based python module \vn{pytao.py} for interfacing \tao to \vn{Python} is provided in
the directoy \vn{tao/python/pytao}.

A test driver script named \vn{pytao_example.py} is in the same directory. See the documentation in both of
these files for further information.

%--------------------------------------------------------------------------
\section{Tao Python command}

To get output from \tao that can be easily parsed by Python, use the \vn{python} command
(\sref{s:python}). The output of this command are semi-colon delimited lists. Besides being easily
parsed, the syntax of the output from the \vn{python} command will not change over time as the \tao
program is developed.

Documentation on the \vn{python} command is contained in the code file itself at:
\begin{example}
  tao/code/tao_python_cmd.f90
\end{example}

Example: The command
\begin{example}
  python global
\end{example}
will produce as output:
\begin{example}
  lm_opt_deriv_reinit;REAL;T; -1.0000000000000000E+00
  de_lm_step_ratio;REAL;T;  1.0000000000000000E+00
  de_var_to_population_factor;REAL;T;  5.0000000000000000E+00
  lmdif_eps;REAL;T;  9.9999999600419720E-13
  svd_cutoff;REAL;T;  9.9999997473787516E-06
  unstable_penalty;REAL;T;  1.0000000474974513E-03
  ... etc ...
\end{example}


%--------------------------------------------------------------------------
\section{Plotting Issues}
\label{s:gui.plot}

When using \tao with a \vn{gui}, and when the \vn{gui} is doing the plotting, the \vn{-noplot}
option (\sref{s:command.line}) should be used when starting \tao. The \vn{-noplot} option (which
sets \vn{global%plot_on}) prevents \tao from opening a plotting window.

Normally when \tao is not displaying the plot page when the \vn{-noplot} option is used, \tao will,
to save time, not calculate the points needed for plotting curves. If it is desired for \tao to
calculate points for plotting, the \vn{force_plot_data_calc} component of the \vn{global} structure
(\sref{s:globals}) can be set to True using the \vn{set} command:
\begin{example}
  set global force_plot_data_calc = T
\end{example}

When \tao is calculating data points with \vn{global%plot_on} set to False and
\vn{global%force_plot_data_calc} set to True, a few points must be kept in mind: First
the names of the default plot regions are simplified to be 'r1', 'r2', etc. Use the \vn{show plot}
command (\sref{s:show.plot}) to view a list. Second, to prevent unneeded computation, the
\vn{visible} parameter of template plots that are placed (\sref{s:place}) is set to False and must
be set to True, using the \vn{set plot} command (\sref{s:set.plot}), to enable computation of the
curve points.
