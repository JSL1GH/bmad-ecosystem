\chapter{Tao Initialization}
\label{c:init}

\tao is custimized for specific machines and specific calculations
using input files and custom software routines. Writing custom software is
covered in the programmer's guide section. This chapter covers the
input files. 

In general the input files tell \tao:
\begin{example}
  1) What the "standard" variables should be.
  2) What the "standard" data is.
  3) What to plot and where to plot it.
\end{example}

\tao first looks for input files in the current directory and then
looks in a directory pointed to by the enviironmental variable
\vn{TAO_INIT_DIR}.

Initialization parameters are read in from a file using Fortran
namlist input. Fortran namelist breaks up the input file into
blocks. The first line of a namelist block starts with an ampersand ``\&''
followed by the block identifying name. Variables are assigned using
an equal sign ``='' and the end of the block is denoted by a slash ``/''
For example:
\begin{example}
  \&this_block_name
    var1 = 0.123   ! exclamation marks are used for comments
    var2 = 0.456
  /
\end{example}
Variables that have default values can be omitted from the block.  The
order of the variables inside a block is irrelavent.  Inbetween
namelist blocks all text is ignored. Inside a block comments may be
included by using an exclamation mark ``!''.

Note: string variables are case sensitive.

%-----------------------------------------------------------------
\section{Initializing Start}
\label{s:init_global} 

The initialization starts with an initialization file named \vn{tao.init}. 
\vn{tao.init} needs to have a \vn{tao_start} namelist block with the following syntax:
\begin{example}
  \&tao_start
    lattice_file      = "<lat_file_name>"   ! Default = this file.
    data_and_var_file = "<data_file_name>"  ! Default = this file.
    plot_file         = "<plot_file_name>"  ! Default = this file.
    n_universes       = <integer>           ! Number of universes. Default = 1.
  /
\end{example}
\vn{n_universes} is the number of universes to be created. The \vn{data_and_var_file}
and \vn{plot_file} files are described in the following sections.
The \vn{lattice_file} is the
name of the file with the \vn{tao_design_lattice} namelist that
defines where the lattice input files are. The \vn{tao_design_lattice}
namelist has the form
\begin{example}
  design_lattice_file = "<lattice_file>", "<parser>"
\end{example}
\vn{<lattice_file>} is the name of an input lattice file and
\vn{<parser>} is the name of the parser to use. Possible choices for
\vn{<parser>} are:
\begin{example}
  bmad    ! For a standard bmad lattice file.
  xsif    ! For an xsif lattice file.
\end{example}

%-----------------------------------------------------------------
\section{Initializing Globals}
\label{s:globals} 

Global variables are initialized in the \vn{data_and_var_file} using a
namelist block named \vn{tao_params} The syntax of this block is:
\begin{example}
  \&tao_params
    n_d2_data_max = <integer>   ! number of d2 data structures.
    n_v1_var_max = <integer>    ! number of v1 data structures.
    n_data_max = <integer>      ! Total number of data points
    n_var_max = <integer>       ! Total number of variables.
  /
\end{example}
Example:
\begin{example}
  \&tao_params
    n_d2_data_max = 6
    n_v1_var_max = 5
    n_data_max = 2000
    n_var_max = 2000
  /
\end{example}
\vn{n_d2_data_max} and \vn{n_v1_var_max} are the maximum
number of \vn{d2_data} and \vn{v1_var} structures
needed. \vn{n_data_max} is the maximum number of datums needed and
\vn{n_var_max} is the maximum total number variables used.

%-----------------------------------------------------------------
\section{Initializing Variables}
\label{s:init_var} 

\vn{Variable}s are initialized using the \vn{tao_var} namelist. The
format for this is
\begin{example}
  \&tao_var
    v1_var%class           = "<class_name>"       ! Variable array name.
    v1_var%universe       = <integer>           ! Universe variables belong in.
                                                !   0 => all universes (default).
    v1_var%attribute      = "<attribute_name>"  ! Attribute to control.
    var%default_weight = <number>            ! Merit_funtion weight.
    var%default_step   = <number>            ! Small step value.
    var%ix_min         = <integer>           ! Minimum array index.
    var%ix_max         = <integer>           ! Maximum array index.
    var%name(:)        = "<var_name>"        ! Individual variable name.
    var%ele_name(i)    = "<ele_name>"        ! Element to be controlled.
    var%weight(i)      = <number>            ! Merit function weight.
    var%step(i)        = <number>            ! Small step size.
  /
\end{example}
Example:
\begin{example}
  \&tao_var
    v1_var%class           = "v_steer"   ! vertical steerings
    v1_var%universe       = 0
    v1_var%attribute      = "vkick"     ! vertical kick attribute
    var%default_weight = 1e3
    var%default_step   = 1e-5
    var%ix_min         = 0
    var%ix_max         = 120
    var%name(1:)       = "v01w", "v02w", "    ", "v04w", ...
    var%ele_name(1:)   = "1w", "2w", "  ", "4w", ...
  /
\end{example}

A \vn{tao_var} block is needed for each variable array to be defined.
\vn{v1_var%class} is the name of the array to be used with \tao
commands. \vn{var%ele_name(i)} is the lattice element associated
with the variable and \vn{v1_var%attribute} is the \bmad attribute
that is varied by the variables. The variable array's index runs from
\vn{var%ix_min} to \vn{var%ix_max}. If elements in the variable
array do not exist the corresponding \vn{var%name} and
\vn{var%ele_name} should be left blank. \vn{var%weight(:)} gives
the weigth coefficient for a variable in the merit function. If not
present then the default weight of \vn{var%default_weight} is used.
\vn{var%step(i)} establishes what a ``small'' variation of the
variable is. This is used, for example, by some optimizers when
varying variables. If \vn{var%step(i)} is not given for a
particular variable then the default \vn{var%default_weight} is
used. Finally \vn{v1_var%universe} gives the universe that the
variables live in. A value of zero means that an array of variables
will be generated for each universe.


%-----------------------------------------------------------------
\section{Initializing Data}
\label{s:init_data} 

Data is initialized using the \vn{tao_data} namelist block whose format is
\begin{example}
  \&tao_data
    d2_data%class = "<class_name>"          ! d2_data name.
    d2_data%universe = <integer>          ! Universe variables belong in.
                                          !   0 => all universes (default).
    d1_data(i)%sub_class = "<sub_name>"    ! d1_data Sub-class name.
    data(i)%default_weight = <number>  ! Merit function weight.
    data(i)%ix_min = <integer>         ! Minimum array index.
    data(i)%ix_max = <integer>         ! Maximum array index.
    data(i)%name(j) = "<data_name>"    ! Data names.
    data(i)%ele_name(j) = "<ele_name>" ! Lattice element names.

  /
\end{example}
For example:
\begin{example}
  \&tao_data
    d2_data%class = "orbit" 
    d2_data%universe = 0  ! apply to all universes

    d1_data(1)%sub_class = "x"  
    data(1)%default_weight = 1e6
    data(1)%ix_min = 0
    data(1)%ix_max = 99
    data(1)%name(0:)     = "0W",      " ", "2W", ...
    data(1)%ele_name(0:) = "DET_00W", " ", "DET_02W", ...

    d1_data(2)%sub_class = "y"  
    data(2)%default_weight = 1e6
    data(2)%ix_min = 0 
    data(2)%ix_max = 99  
    data(2)%name(0) = "SAME: orbit:x"
    data(2)%ele_name(0) = "SAME: orbit:x"
  /
\end{example}

A \vn{tao_data} block is needed for each \vn{d2_data} structure
defined. \vn{d2_data%class} gives the class name of the
structure. Certain \vn{d2_data} classes are recognized by \tao. These are:
\begin{example}
  "orbit"       ! Orbit data
  "phase"       ! Betatron phase data
  "eta"         ! Dispersion data
  "beta"        ! Beta data
  "coupling"    ! Coupling (Ratio of shaking amplitudes) data
  "cbar"        ! Cbar data
\end{example}

\vn{d2_data%universe} gives the universe that the data is
associated with. A value of zero means that a \vn{d2_data} structure
is set up in each universe. \vn{d1_data(i)%sub_class} gives the
sub--class name for a \vn{d1_data} structure within the \vn{d2_data}
structure. Certain \vn{d1_data} classes are recognized by \tao. These are:
\begin{example}
  "X" & "Y"                   ! With "orbit", "phase", "eta", and "beta".
  "11", "12a", "12b", & "21"  ! With "coupling".
  "11", "12", "21", & "22"    ! With "cbar".
\end{example}

\vn{data(i)%ix_min} and \vn{data(i)%ix_max} give the bounds for the
\vn{data(i)} structure array that is associated with the \vn{d1_data}
structure. \vn{data(i)%name(:)} gives the names of the data points and
\vn{data(i)%ele_name(:)} gives the lattice element names associated
with the data points.  If elements in the \vn{data} array do not exist
the corresponding \vn{var%name} and \vn{data%ele_name} should be left
blank. Lists of names can be reused using the syntax:
\begin{example}
  data(i)%name(0) = "SAME: <d1_data_name>"
  data(i)%ele_name(0) = "SAME: <d1_data_name>"
\end{example}

\vn{data%weight(:)} gives the weigth coefficient for a variable in the
merit function. If not present then the default weight of
\vn{data%default_weight} is used.


%-----------------------------------------------------------------
\section{Initializing Plotting}
\label{s:init_plot} 

\subsection{Plot Window}

\begin{figure}
  \centering
  \includegraphics{plot_page.psfig}
  \caption{Regions define where on the plot page plots are placed.}
  \label{f:plot_page}
\end{figure}

Plotting is defined by an initialization file named
\vn{tao_plot.init}.  The first namelist block in the file has a block
name of \vn{tao_plot_page}. This block sets the size of the plot
window (also called the plot page) and defines the ``regions'' where
plots go. The syntax of this block is:
\begin{example}
  \&tao_plot_page
    plot_page%size = <x_size>, <y_size>            ! size in POINTS 
    plot_page%border = <b_x1>, <b_x2>, <b_y1>, <b_y2>, "<units>"
    region(i)%name = "<region_name>"
    region(i)%location = <l_x1>, <l_x2>, <l_y1>, <l_y2>  ! % plot area
    place(i)% = "<region>", "<template>"
  /
\end{example}
For example:
\begin{example}
  \&tao_plot_page
    plot_page%size = 700, 800           ! Points
    plot_page%border = 0, 0, 0, 50, "POINTS"  
    region(1)%name = "top"
    region(1)%location = 0.0, 1.0, 0.5, 1.0
    region(2)%name = "bottom"
    region(2)%location = 0.0, 1.0, 0.0, 0.5
    place(1) = 'top', 'orbit'
    place(2) = 'bottom', 'phase'
  /
\end{example}

\vn{plot_page%size} sets the horizontal and vertical size of the plot
window in \vn{POINTS} units (72 points = 1 inch. Roughly 1 point = 1
pixel). 

\vn{plot_page%border} sets a border around the the edges of the
window. As shown in Figure~\ref{f:plot_page} \vn{b_x1}, \vn{b_x2} are
the right and left border widths and \vn{b_y1} and \vn{b_y2} are the
bottom and top border widths respectively.  The rectangle within this
border is called the plot area.

The plot area is divided up into rectangular regions where plots may
be placed (what defines a plot is discussed below).
\vn{region(i)%name} is the name of a region and my be any character
string. \vn{l_x1}, and \vn{l_x2} define the location of the left and
right edges of the region as a percentage of the plot area width
starting from the left edge of the plot area.  \vn{l_y1} and \vn{l_y2}
define the location of the bottom and top edges of the region as a
percentage of the height of the plot area with respect to the plot
area's bottom edge. Thus, in the above example, region 1 extends from
the left border of the plot area (\vn{region(1)%l_x1} = 0) to the
right border (\vn{region(1)%l_x2} = 0) and vertically from the center
(\vn{region(1)%l_y1} = 0.5) to the top edge (\vn{region(1)%l_x2} =
1.0). Regions may overlap any one can define as many regions as one
likes.

\vn{place(i)} determines the initial placement of plots.

\subsection{Templates}

As shown in Figure~\ref{f:plot}, a ``plot'' is made up of a collection
of ``graphs'' and a graph consists of axes plus a set of ``curves''.
In the \vn{tao_plot.init} file there needs to be defined a set of
``template plots''. A template plot specifies the layout of a plot:
How the graphs are placed within a plot, what curves are associated
with what graphs, etc. When running \tao, the information in a
template plot may then be transfered to a region using the \vn{place}
command and this will produce a visible plot.

Template plots are defined using namelists with a name of
\vn{tao_template_graph}. The general syntax is:
\begin{example}
  \&tao_template_plot
    plot%class       = "name"
    plot%who(i)     = "who_to_plot", sign
    plot%box_layout = ix, iy
    plot%x          = qp_axis_struct
    plot%convert    = Logical
    plot%box_layout = ix_b, iy_b
    plot%n_graph    = n_graphs
  /
\end{example}
For example:
\begin{example}
  \&tao_template_plot
    plot%class        = "orbit"
    plot%who(1)      = "model", +1
    plot%who(2)      = "design", -1
    plot%box_layout  = 1, 2                ! break page into boxes.
    plot%x%min       =   0
    plot%x%max       = 100
    plot%x%major_div = 10
    plot%x%label     = " "
    plot%n_graph     = 2
  /
\end{example}

\vn{plot%class} defines what class of data is being plotting. \tao knows
about the following classes:
\begin{example}
  beta      ! Beta Twiss parameter
  phase     ! Betatron phase
  orbit     ! Orbit
  eta       ! Dispersion
  cbar      ! Cbar coupling matrix
  coupling  ! Coupling measurements.
\end{example}

\vn{plot%who(i)} sets what is being plotted. Possibilities are:
\begin{example}
  model     ! model values.
  desgin    ! design values.
  base      ! Base values
  data      ! data values.
  ref       ! reference data values.
\end{example}
The default is to plot \vn{model - design}. 

\vn{plot%box_layout} sets the layout of the boxes in the plot
region. For a definition of what a box is see the Quick Plot
documentation in the \bmad reference manual. In the above example the
region is divided into two vertically stacked boxes. \vn{plot%x}
defines the horizontal axis for all the graphs contained in the
plot. See the Quick Plot documentation for the definition of the
\vn{qp_axis_struct}. \vn{plot%convert} is a logical that is only used
with \vn{plot%class = "coupling"} and tells \tao to convert the
coupling data into cbar data before plotting.

For example:
\begin{example}
  \&tao_template_graph
  	graph%name         = "x"
  	graph_index        = 1
    graph%this_box     = 1, 2
    graph%title        = "Horizontal Orbit (mm)"
    graph%margin       =  60, 200, 30, 30, "POINTS"
    graph%y%label      = "X"
    graph%y%max        =  4
    graph%y%min        = -4
    graph%y%major_div  = 4
    graph%n_curve      = 1
    curve(1)%sub_class  = "x"
    curve(1)%units_factor = 100
  /
\end{example}

