\chapter{Electromagnetic Fields}

%-----------------------------------------------------------------
\section{Magnetic Static Multipole Fields}
\label{s:mag.field}
\index{magnetic fields|hyperbf}

\index{MAD}
Start with the assumption that the local magnetic field has no longitudinal component
(obviously this assumption does not work with, say, a solenoid).  Following \mad, ignoring
skew fields for the moment, the vertical magnetic field along the $y = 0$ axis is expanded
in a Taylor series
\Begineq
  B_y(x, 0) = \sum_n B_n \, \frac{x^n}{n!}
  \label{byx0b}
\Endeq
Assuming that the reference orbit is locally straight (there are correction terms if the
Reference Orbit is curved), the field is
\begin{alignat}{5}
  B_x &=           &&B_1 y \plus         &&B_2 \, xy       
                   && \plus && \frac{1}{6} B_3 (3x^2 y - y^3) \plus \ldots \\
  B_y &= B_0 \plus &&B_1 x + \frac{1}{2} &&B_2 (x^2 - y^2) 
                   && \plus && \frac{1}{6} B_3 (x^3 - 3x y^2) \plus \ldots
\end{alignat}
For some fields, the normalized integrated multipole $K_nL$ can be used when specifying
magnetic multipole components
\index{multipole!KnL, Tn|hyperbf}
\Begineq
  K_nL \equiv \frac{q \, L \, B_n}{P_0}
\Endeq
where $q$ is the charge of the reference particle (in units of the elementary charge), $L$
is the element length, and $P_0$ is the reference momentum (in units of eV/c).  Note that
$P_0/q$ is sometimes written as $B\rho$. This is just an old notation where $\rho$ is the
bending radius of a particle with the reference energy in a field of strength $B$.

The kicks $\Delta p_x$ and $\Delta p_y$ that a
particle experiences going through a multipole field is
\begin{alignat}{5}
  \Delta p_x & = \frac{-q \, L \, B_y}{P_0} \label{pqlbp1} \\
             & = -K_0 L \;-\; 
             && K_1 L \, x \plus 
             \frac{1}{2} && K_2 L (y^2 - x^2) && \plus 
             && \frac{1}{6} K_3 L (3x y^2 - x^3) \plus \ldots 
             \nonumber \\
  \Delta p_y & = \frac{q \, L \, B_x}{P_0} \label{pqlbp2} \\
             & =     
             && K_1 L \, y \plus 
             && K_2 L \, xy && \plus 
             && \frac{1}{6} K_3L (3x^2 y - y^3) \plus \ldots \nonumber 
\end{alignat}
A positive $K_1L$ quadrupole component gives
horizontal focusing and vertical defocusing. The general form is
\begin{align}
  \Delta p_x &= \sum_{n = 0}^{\infty} \frac{K_n L}{n!} 
             \sum_{m = 0}^{\lfloor \frac{n}{2} \rfloor}
             \begin{pmatrix} n \cr 2m \end{pmatrix} \,
             (-1)^{m+1} \, x^{n-2m} \, y^{2m} \\
  \Delta p_y &= \sum_{n = 0}^{\infty} \frac{K_n L}{n!} 
             \sum_{m = 0}^{\lfloor \frac{n-1}{2} \rfloor}
             \begin{pmatrix} n \cr 2m+1 \end{pmatrix} \,
             (-1)^{m} \, x^{n-2m-1} \, y^{2m+1}
\end{align}
where $\lfloor\alpha\rfloor$ means round down to the integer equal to or less than $\alpha$.

\index{multipole!KnL, Tn|hyperbf}
So far only the normal components of the field have been
considered. If the fields associated with a particular $B_n$ multipole
component are rotated in the $(x, y)$ plane by an angle $\theta_n$, the
magnetic field at a point $(x,y)$ can be expressed in complex notation
as
\Begineq
  B_y(x,y) + i B_x(x,y) = 
    \frac{1}{n!} B_n e^{-i(n+1)\theta_n} \, e^{i n \theta} \, r^n 
  \label{bib1nb}
\Endeq
where $(r, \theta)$ are the polar coordinates of the point $(x, y)$.

\index{multipole}
Note that, for compatibility with MAD, the $K0L$ component of a \vn{Multipole} element
rotates the reference orbit essentially acting as a zero length bend. This is not true
for multipoles of any other type of element.

Instead of using magnitude $K_n$ and rotation angle $\theta_n$,
Another representation is using normal $\wt K_n$ and skew $\wt
KS_n$. The conversion between the two are
\begin{align}
  \wt K_n  &= K_n \, \cos((n + 1) \theta_n) \CRNO
  \wt KS_n &= K_n \, \sin((n + 1) \theta_n) 
\end{align}

\index{multipole!an, bn|hyperbf}
Another representation of the magnetic field used by \bmad divides
the fields into normal $b_n$ and skew $a_n$ components. In terms of
these components the magnetic field for the $n$\Th\ order multipole is
\Begineq
  \frac{q \, L}{P_0} \, (B_y + i B_x) = (b_n + i a_n) \, (x + i y)^n
  \label{qlpbb}
\Endeq
The $a_n$, $b_n$ representation of multipole fields can be used in elements such as
quadrupoles, sextupoles, etc. to allow ``error'' fields to be represented.  
The conversion between $(a_n, b_n)$ and $(K_nL, \theta_n)$ is
\Begineq
  b_n + i a_n = \frac{1}{n!} \, K_nL \, e^{-i(n+1)\theta_n}
\Endeq
or
\begin{align}
  K_n L &= n! \, \sqrt{a_n^2 + b_n^2} \\
  \tan[(n+1) \theta_n] &= \frac{-a_n}{b_n}
\end{align}
To convert a normal magnet (a magnet with no skew component) into a skew
magnet (a magnet with no normal component) the magnet should be rotated
about its longitudinal axis with a rotation angle of
\Begineq
  (n+1) \theta_n = \frac{\pi}{2}
\Endeq
For example, a normal quadrupole rotated by $45^\circ$ becomes a
skew quadrupole.

\index{r0_mag}
\index{F (multipole scale factor)}
The actual $a_n$, $b_n$ values used in particle tracking are scaled from the input values
given in the lattice file. There are two scale factors that are applied. The first scale
factor is used if the \vn{field_master} attribute (\sref{s:field.master}) is True for an
element so that the multipole values specified in the lattice file are not reference
energy normalized
\Begineq
  \bigl[ a_n, b_n \bigr] \longrightarrow
  \bigl[ a_n, b_n \bigr] \cdot \frac{q}{P_0}
  \label{ababq}
\Endeq

The second scaling is applied when the multipoles are associated with a non
\vn{AB_Multipole} element and if the \vn{scale_multipoles} attribute (\sref{s:multip}) is
\vn{True}. This scaling uses a measurement radius $r_0$ and a scale factor $F$:
\Begineq
  \bigl[ a_n, b_n \bigr] =
  \bigl[ a_n, b_n \bigr]
  \cdot F \cdot \frac{r_0^{n_\text{ref}}}{r_0^n}
  \label{ababf}
\Endeq
$r_0$ is set by the \vn{r0_mag} attribute of an element. $F$ and $n_\text{ref}$ are set
automatically depending upon the type of element as shown in Table~\ref{t:ab}. The
$\gamma_p$ term is

\index{kicker}\index{hkicker}\index{vkicker}
\index{rbend}\index{sbend}\index{elseparator}
\index{quadrupole}\index{solenoid}\index{sol_quad}
\index{sextupole}\index{octupole}
\begin{table}[ht]
\centering
\begin{tabular}{lll} \toprule
\tt
  {\em Element} & $F$                              & $n_\text{ref}$ \\ \midrule
  \vn{Elseparator} & $\sqrt{{\tt Hkick}^2 + {\tt Vkick}^2}$ & 0 \\
  \vn{Hkicker}     & Kick                                   & 0 \\
  \vn{Kicker}      & $\sqrt{{\tt Hkick}^2 + {\tt Vkick}^2}$ & 0 \\
  \vn{Rbend}       & G * L                                  & 0 \\
  \vn{Sbend}       & G * L                                  & 0 \\
  \vn{Vkicker}     & Kick                                   & 0 \\
  \vn{Wiggler}     & $\dsfrac{2 \, c \, {\tt L\_pole} \, B_{max}}{\pi \, {\tt p0c}}$ 
                                                            & 0 \\
  \vn{Quadrupole}  & K1 * L                                 & 1 \\
  \vn{Sol_Quad}    & K1 * L                                 & 1 \\
  \vn{Solenoid}    & KS * L                                 & 1 \\
  \vn{Sextupole}   & K2 * L                                 & 2 \\
  \vn{Octupole}    & K3 * L                                 & 3 \\ \bottomrule
\end{tabular}
\caption{$F$ and $n_\text{ref}$ for various elements.}
\label{t:ab}
\end{table}

%-----------------------------------------------------------------
\section{Electric Static Multipole Fields}
\label{s:elec.field}
\index{electric fields}

Except for the \vn{elseparator} element, \bmad specifies DC electric fields using normal
$b_{en}$ and skew $a_{en}$ components (\sref{s:multip}. The potential $\phi_n$ for the
$n$\Th\ order multipole is
\Begineq
  \phi_n = -\re \left[ \frac{b_{en} - i a_{en}}{n + 1} \, \frac{(x + i y)^{n+1}}{r_0^n} \right]
  \label{pbian1}
\Endeq
where $r_0$ is a ``measurement radius'' set by the \vn{r0_elec} attribute of an element
(\sref{s:multip}).

The electric field for the $n$\Th order multipole is
\Begineq
  E_x - i E_y = (b_{en} - i a_{en}) \, \frac{(x + i y)^n}{r_0^n}
  \label{exiey}
\Endeq
Notice that the magnetic multipole components $a_n$ and $b_n$ are normalized by the
element length, reference charge, and reference momentum (\Eq{qlpbb}) while their electric
counterparts are not.

Using the paraxial approximation, The kick given a particle due to the electric field is
\Begineq
  \frac{dp_x}{ds} = \frac{q \, E_x}{\beta \, P_0}, \qquad \frac{dp_y}{ds} = \frac{q \, E_y}{\beta \, P_0}
\Endeq
Where $\beta$ is the normalized velocity.

%-----------------------------------------------------------------
\section{Exact Multipole Fields in a Bend}
\label{s:field.exact}

For static magnetic and electric multipole fields in a bend, the spacial dependence of the
field is different from multipole fields in an element with a straight geometry as given
by \Eqs{qlpbb} and \eq{exiey}. The analysis of the multipole fields in a bend here follows
McMillan\cite{b:mcmillan}.  

In the rest of this section, normalized coordinates $\what r = r / \rho$, $\what x / = x /
\rho$, and $\what y = y / \rho$ will be used where $\rho$ is the bending radius of the
reference coordinate system, $r$ is the distance, in the plane of the bend, from the bend
center to the observation point, $x$ is the distance in the plane of the from the referece
coordinates to the observation point and $y$ is the distance out-of-plane. With this
convention $\what r = 1 + \what x$.

In the rest of this section only normalized coordinates will be used. Thus, to simplify
the displayed equations, the circumflex over the normalized coordinates will be dropped.

An electric or magnetic multipole can be characterized by a scaler potential $\phi$ with
the field given by $\nabla \phi$.  The potential is a solution to Laplace's equation
\Begineq
  \frac{1}{r} \, \frac{\partial}{\partial \, r} 
  \left( r \, \frac{\partial \, \phi}{\partial \, r} \right) +
  \frac{\partial^2 \phi}{\partial \, y^2} = 0
\Endeq
As McMillian shows, it is also possible to calculate the magnetic field by constructing the
appropriate vector potential. However, from a practical point of view, it is simpler to use the
scaler potential for both the magnetic and electric fields.

Solutions to Laplace's equation can be found in form
\Begineq
  \phi_{n}^r = \frac{1}{1+n} \sum_{p = 0}^{\lfloor (n+1)/2 \rfloor} 
             \begin{pmatrix} n + 1 \cr 2 \, p \end{pmatrix} \,
             (-1)^{p} \, F_{n+1-2p}(r) \, y^{2p}
  \label{pspn1}
\Endeq
and in the form
\Begineq
  \phi_{n}^i = \frac{1}{1+n} \sum_{p = 0}^{\lfloor n/2 \rfloor} 
             \begin{pmatrix} n + 1 \cr 2p +1 \end{pmatrix} \,
             (-1)^{p} \, F_{n-2p}(r) \, y^{2p+1}
  \label{pspn2}
\Endeq
[Notice that here $n$ is related to $m$ in McMillian's paper by $m = n + 1$. Also note
that the $\phi^r$ and $\phi^i$ here have a normalization factor that is different from
McMillian.]  where $n$ is the order number which can range from 0 to infinity,
$\lfloor\alpha\rfloor$ means round down to the integer equal to or less than $\alpha$, and
the $F_p(r)$ are related by
\Begineq
  F_{p+2} = (p + 1) \, (p + 2) \, \int_1^r \frac{dr}{r} \left[ \int_1^r dr \, r \, F_{p} \right]
\Endeq
with the ``boundary condition'':
\begin{align}
  F_0(r) &= 1 \CRNO
  F_1(r) &= \ln \, r
\end{align}
This condition ensures that the number of terms in the sums in \Eqs{pspn1} and \eq{pspn2}
are finite. With this condition, all the $F_p$ can be constructed:
\begin{align}
  F_1 &= \ln \, r = x - \frac{1}{2}x^2 + \frac{1}{3}x^3 - \ldots \CRNO
  F_2 &= \frac{1}{2} (r^2 - 1) - \ln r = x^2 - \frac{1}{3}x^3 + \frac{1}{4} x^4 - \ldots \CRNO
  F_3 &= \frac{3}{2} [-(r^2 - 1) + (r^2 + 1) \ln r] = x^3 - \frac{1}{2} x^4 + \frac{7}{20} x^5 - \ldots 
         \label{ffff} \\
  F_4 &= 3 [ \frac{1}{8} (r^4 - 1) + \frac{1}{2} (r^2 - 1) - (r^2 + \frac{1}{2}) \ln r] = 
         x^4 - \frac{2}{5} x^5 + \frac{3}{10} x^6 \ldots \CRNO
  &\text{Etc...} \nonumber
\end{align}
In terms of implementing these functions on a computer, the exact $r$-dependent functions
are problematical due to round off error near $x = 0$. For example, Evaluating $F_4(r)$ at
$x = 10^{-4}$ results in a complete loss of accuracy (no significant digits!) when using
double precision numbers. In practice, \bmad uses the expansion in $x$ for $x$ small
enough and then switches to the $r$-dependent formulas for $x$ away from zero.

For magnetic fields, the ``real'' $\phi_n^r$ solutions will correspond to skew fields and the
``imaginary'' $\phi_n^i$ solutions will correspond to normal fields
\Begineq
  \bfB = \frac{P_0}{q \, L} \, 
    \sum_{n = 0}^\infty \rho^n \, \left[ a_n \, \nabla \phi_n^r + b_n \, \nabla \phi_n^i \right]
\Endeq
where the gradient $\nabla$ is with respect to the normalized coordinates. For electric fields, the reverse is true
\Begineq
  \bfE = \sum_{n = 0}^\infty \rho^n \, \left[ a_{en} \, \nabla \phi_n^i + b_{en} \, \nabla \phi_n^r \right]
\Endeq

In the vertical plane, with $x = 0$, the solutions $\phi_n^r$ and $\phi_n^i$ have the
same variation in $y$ as the multipole fields with a straight geometry. For example, the
field strength of a $n = 1$ (quadrupole) multipole will be linear in $y$ for $x = 0$. In the
horizontal plane, with $y = 0$, this is not the case. Thus, for example, a $n = 1$
multipole field in the horizontal plane will vary like $dF_2/dx$ which has terms of all orders in
$x$. In light of this, the solutions $\phi_n^r$ and $\phi_n^i$ are called ``vertically
pure'' solutions.

It is possible to construct ``horizontally pure'' solutions as well. That is, it is
possible to construct solutions that in the horizontal plane with $y = 0$ behave the same
as the corresponding multipole fields with a straight geometry. A straight forward way to
do this is, for some given multipole of order $n$, is to construct the horizontally pure
solutions from the vertically pure solutions via
\begin{align}
  \psi_n^r &= \sum_{k = n}^\infty \frac{1}{\rho^{k-n}} \, C_{nk} \, \phi_{k1} \CRNO
  \psi_n^i &= \sum_{k = n}^\infty \frac{1}{\rho^{k-n}} \, D_{nk} \, \phi_{k2}
\end{align}
with the normalizations $C_{nn} = D_{nn} = 1$. The $C_{nk}$ and $D_{nk}$ are chosen, order
by order, so that $\psi_n^r$ and $\psi_n^i$ are horizontally pure. For the real
potentials, the $C_{nk}$, are obtained from a matrix $\bfM$ where $M_{ij}$ is the
coefficient of the $x^j$ term of $\rho^{i-j} (dF_i/dx)/i$ when $F_i$ is expressed as an expansion in
$x$ (\Eq{ffff}). $C_{nk}$, $k = 0, \ldots \infty$ are the row vectors of the the inverse
matrix $\bfM^{-1}$. For the imaginary potentials, the $D_{nk}$ are constructed similarly
but in this case the rows of $\bfM$ are the coefficients in $x$ for the functions $\rho^{i-j} F_i$.

When expressed as a funciton of $r$ and $y$, the vertically pure solutions $\phi_n$ have a
finite number of terms (\Eqs{pspn1} and \eq{pspn2}). On the other hand, the horizontally
pure solutions $\psi_n$ have an infinite number of terms.

The vertically pure solutions form a complete set. That is, any given field that satisfies
Maxwell's equations and is independent of $z$ can be expressed as a linear combination of
$\phi_n^r$ and $\phi_n^i$. Similarly, the horizontally pure solutions form a complete
set. Additionally, it is possible to construct other complete sets in which the basis
functions are neither horizontally pure nor vertically pure.

This brings up an important point. to properly simulate a machine, one must first of all
understand whether the multipole values that have been handed to you are for horizontally
pure multipoles, vertically, pure multipoles, or perhaps the values do not correspond to
either horizontally pure nor vertically pure solutions! Furthermore, it is important to
know how a program models multipoles. For example, the chromaticity induced by a
horizontally pure quadrupole field will be different from the chromaticity of a vertically
pure quadrupole field of the same strength.

%-----------------------------------------------------------------
\section{Map Decomposition of Magnetic and Electric Fields}
\label{s:field.map}
\index{electric fields!map decomposition}
\index{magnetic fields!map decomposition}

Electric and magnetic fields can be parameterized as the sum over a number of functions
with each function satisfying Maxwell's equations. These functions are also referred to as
``maps'', ``modes'', or ``terms''. \bmad has two parameterizations:
\begin{example}
  Cartesian_Map      ! \sref{s:cart.map.phys}.
  Cylindrical_Map    ! \sref{s:cylind.map.phys}
\end{example}
These parameterizations are two of the four \vn{field map} parameterizations that \bmad
defines \sref{s:fieldmap}.

The \vn{cartesian_map} decomposition involves a set of terms, each term a solution the
Laplace equation solved using separation of variables in Cartesian coordinates. This
decomposition can be used for DC but not AC fields. See \sref{s:cart.map.phys}.
for more details. The syntax for specifying the \vn{cartesian_map} decomposition
is discussed in \sref{s:cart.map}.

The \vn{cylindrical_map} decomposition can be used for both DC and AC fields. See
\sref{s:cylind.map.phys} for more details. The syntax for specifying the
\vn{cylindrical_map} decomposition is discussed in \sref{s:cylind.map}.

%-----------------------------------------------------------------
\section{Cartesian Map Field Decomposition}
\label{s:cart.map.phys}
\index{cartesian_map}

Electric and magnetic fields can be parameterized as the sum over a number of functions
with each function satisfying Maxwell's equations. These functions are also referred to as
``maps'', ``modes'', or ``terms''. \bmad has two types. The ``\vn{Cartesian}''
decomposition is explained here. The other type is the \vn{cylindrical} decomposition
(\sref{s:cylind.map.phys}).

The \vn{Cartesian} decomposition implemented by \bmad involves a set of terms, each
term a solution the Laplace equation solved using separation of variables in Cartesian
coordinates. This decomposition is for DC electric or magnetic fields. No AC Cartesian Map
decomposition is implemented by \bmad. In a lattice file, a \vn{Cartesian} map is specified using
the \vn{cartesian_map} attribute as explained in Sec.~\sref{s:cart.map}.

The \vn{Cartesian} decomposition is modeled using an extension of the method of Sagan,
Crittenden, and Rubin\cite{b:wiggler}. In this decomposition, the magnetic(or electric
field is written as a sum of terms $B_i$ (For concreteness the symbol $B_i$ is used but
the equations below pertain equally well to both electric and magnetic fields) with:
\Begineq
  \bfB(x,y,z) = \sum_i \bfB_i(x, y, z; A, k_x, k_y, k_z, x_0, y_0, \phi_z, family)
\Endeq
Each term $B_i$ is specified using seven numbers $(A, k_x, k_y, k_z,
x_0, y_0, \phi_z)$ and a switch called \vn{family} which can be one of:
\begin{example}
  x,  qu
  y,  sq
\end{example}
Roughly, the \vn{x} \vn{family} gives a field that is like a horizontal dipole, the \vn{y}
\vn{family} is good for simulating vertical dipole fields, the \vn{qu} \vn{family} is good
for simulating quadrupole fields, and the \vn{sq} \vn{family} is good for simulating skew
quadrupole fields.

Each family has three possible forms These are designated as ``\vn{hyper-y}'',
``\vn{hyper-xy}'', and ``\vn{hyper-x}''. 

For the \vn{x} \vn{family} the \vn{hyper-y} form is:
\begin{alignat}{4}
  B_x &=  &A \, &\dfrac{k_x}{k_y} & \cos(\kxx) \, \cosh(\kyy) \, \cos(\kzz) \CRNEG
  B_y &=  &A \, &                 & \sin(\kxx) \, \sinh(\kyy) \, \cos(\kzz) \CRNEG
  B_s &= -&A \, &\dfrac{k_z}{k_y} & \sin(\kxx) \, \cosh(\kyy) \, \sin(\kzz) \label{cm1} \\
  & \makebox[1pt][l]{with $k_y^2 = k_x^2 + k_z^2$ .} &&& \nonumber
\end{alignat}
The \vn{x} \vn{family} \vn{hyper-xy} form is:
\begin{alignat}{4}
  B_x &=  &A \, &\dfrac{k_x}{k_z} & \cosh(\kxx) \, \cosh(\kyy) \, \cos(\kzz) \CRNEG
  B_y &=  &A \, &\dfrac{k_y}{k_z} & \sinh(\kxx) \, \sinh(\kyy) \, \cos(\kzz) \CRNEG
  B_s &= -&A \, &                 & \sinh(\kxx) \, \cosh(\kyy) \, \sin(\kzz) \label{cm3} \\
  & \makebox[1pt][l]{with $k_z^2 = k_x^2 + k_y^2$ ,} &&& \nonumber
\end{alignat}
And the \vn{x} \vn{family} \vn{hyper-x} form is:
\begin{alignat}{4}
  B_x &=  &A \, &                 & \cosh(\kxx) \, \cos(\kyy) \, \cos(\kzz) \CRNEG
  B_y &= -&A \, &\dfrac{k_y}{k_x} & \sinh(\kxx) \, \sin(\kyy) \, \cos(\kzz) \CRNEG
  B_s &= -&A \, &\dfrac{k_z}{k_x} & \sinh(\kxx) \, \cos(\kyy) \, \sin(\kzz) \label{cm5} \\
  & \makebox[1pt][l]{with $k_x^2 = k_y^2 + k_z^2$ .} &&& \nonumber
\end{alignat}

The relationship between $k_x$, $k_y$, and $k_z$ ensures that
Maxwell's equations are satisfied. Notice that which form
\vn{hyper-y}, \vn{hyper-xy}, and \vn{hyper-x} a particular $\bfB_i$
belongs to can be computed by \bmad by looking at the values of $k_x$,
$k_y$, and $k_z$.

Using a compact notation where $\Ch \equiv \cosh$, subscript $x$ is $\kxx$, subscript $z$
is $\kzz$, etc., the \vn{y} \vn{family} of forms is:
\begin{alignat}{7}
  & \text{Form} \quad  && \text{hyper-y} \quad && \text{hyper-xy} \quad && \text{hyper-x} \quad \CRNO
  & B_x  
    &-& A \, \dfrac{k_x}{k_y} \, \Se_x \, \Sh_y \, \Ce_z \quad
    & & A \, \dfrac{k_x}{k_z} \, \Sh_x \, \Sh_y \, \Ce_z \quad
    & & A \, \hphphp          \, \Sh_x \, \Se_y \, \Ce_z \quad \CRNO
  & B_y
    & & A \, \hphphp          \, \Ce_x \, \Ch_y \, \Ce_z \quad
    & & A \, \dfrac{k_y}{k_z} \, \Ch_x \, \Ch_y \, \Ce_z \quad
    & & A \, \dfrac{k_y}{k_x} \, \Ch_x \, \Ce_y \, \Ce_z \quad \label{family.y} \\
  & B_z
    &-& A \, \dfrac{k_z}{k_y} \, \Ce_x \, \Sh_y \, \Se_z \quad
    &-& A \, \hphphp          \, \Ch_x \, \Sh_y \, \Se_z \quad
    &-& A \, \dfrac{k_z}{k_x} \, \Ch_x \, \Se_y \, \Se_z \quad \CRNO
  & \text{with} 
    && k_y^2 = k_x^2 + k_z^2 
    && k_z^2 = k_x^2 + k_y^2
    && k_x^2 = k_y^2 + k_z^2 \nonumber
\end{alignat}

the \vn{qu} \vn{family} of forms is:
\begin{alignat}{7}
  & \text{Form} \quad  && \text{hyper-y} \quad && \text{hyper-xy} \quad && \text{hyper-x} \quad \CRNO
  & B_x  
    & & A \, \dfrac{k_x}{k_y} \, \Ce_x \, \Sh_y \, \Ce_z \quad
    & & A \, \dfrac{k_x}{k_z} \, \Ch_x \, \Sh_y \, \Ce_z \quad
    & & A \, \hphphp          \, \Ch_x \, \Se_y \, \Ce_z \quad \CRNO
  & B_y
    & & A \, \hphphp          \, \Se_x \, \Ch_y \, \Ce_z \quad
    & & A \, \dfrac{k_y}{k_z} \, \Sh_x \, \Ch_y \, \Ce_z \quad
    & & A \, \dfrac{k_y}{k_x} \, \Sh_x \, \Ce_y \, \Ce_z \quad \\
  & B_z
    &-& A \, \dfrac{k_z}{k_y} \, \Se_x \, \Sh_y \, \Se_z \quad
    &-& A \, \hphphp          \, \Sh_x \, \Sh_y \, \Se_z \quad
    &-& A \, \dfrac{k_z}{k_x} \, \Sh_x \, \Se_y \, \Se_z \quad \CRNO
  & \text{with} 
    && k_y^2 = k_x^2 + k_z^2 
    && k_z^2 = k_x^2 + k_y^2
    && k_x^2 = k_y^2 + k_z^2 \nonumber
\end{alignat}

the \vn{sq} \vn{family} of forms is:
\begin{alignat}{7}
  & \text{Form} \quad  && \text{hyper-y} \quad && \text{hyper-xy} \quad && \text{hyper-x} \quad \CRNO
  & B_x  
    &-& A \, \dfrac{k_x}{k_y} \, \Se_x \, \Ch_y \, \Ce_z \quad
    & & A \, \dfrac{k_x}{k_z} \, \Sh_x \, \Ch_y \, \Ce_z \quad
    &-& A \, \hphphp          \, \Sh_x \, \Ce_y \, \Ce_z \quad \CRNO
  & B_y
    & & A \, \hphphp          \, \Ce_x \, \Sh_y \, \Ce_z \quad
    & & A \, \dfrac{k_y}{k_z} \, \Ch_x \, \Sh_y \, \Ce_z \quad
    & & A \, \dfrac{k_y}{k_x} \, \Ch_x \, \Se_y \, \Ce_z \quad \label{bsq} \\
  & B_z
    &-& A \, \dfrac{k_z}{k_y} \, \Ce_x \, \Ch_y \, \Se_z \quad
    &-& A \, \hphphp          \, \Ch_x \, \Ch_y \, \Se_z \quad
    & & A \, \dfrac{k_z}{k_x} \, \Ch_x \, \Ce_y \, \Se_z \quad \CRNO
  & \text{with} 
    && k_y^2 = k_x^2 + k_z^2 
    && k_z^2 = k_x^2 + k_y^2
    && k_x^2 = k_y^2 + k_z^2 \nonumber
\end{alignat}


The singular case where $k_x = k_y = k_z = 0$ is not allowed. If a
uniform field is needed, a term with very small $k_x$, $k_y$, and
$k_z$ can be used. Notice that since $k_y$ must be non-zero for the
\vn{hyper-y} forms (remember, $k_y^2 = k_x^2 + k_z^2$ for these forms
and not all $k$'s can be zero), and $k_z$ must be non-zero for the
\vn{hyper-xy} forms, and $k_x$ must be nonzero for the \vn{hyper-x}
forms. The magnetic field is always well defined even if one of the
$k$'s is zero.

%-----------------------------------------------------------------
\section{Cylindrical Map Decomposition}
\label{s:cylind.map.phys}
\index{cylindrical map}

Electric and magnetic fields can be parameterized as the sum over a number of functions
with each function satisfying Maxwell's equations. These functions are also referred to as
``maps'', ``modes'', or ``terms''. \bmad has two types. The ``\vn{cylindrical}''
decomposition is explained here. The other type is the \vn{Cartesian} decomposition
(\sref{s:cylind.map.phys}).

In a lattice file, a \vn{cylindrical} map is specified using the \vn{cylindrical_map}
attribute as explained in Sec.~\sref{s:cylind.map}.

The \vn{cylindrical} decomposition takes one of two forms depending upon whether the
fields are time varying or not. The DC decomposition is explained in
Sec.~\sref{s:cylind.dc} while the RF decomposition is explained in
Sec.~\sref{s:cylind.ac}. 

%-----------------------------------------------------------------
\subsection{DC Cylindrical Map Decomposition}
\label{s:cylind.dc}

The DC \vn{cylindrical} parametrization used by \bmad essentially
follows Venturini et al.\cite{b:vent.map}. The electric and magnetic
fields are both described by a scaler potential
\Begineq
  \bfB = \nabla \, \psi_B, \qquad \bfE = \nabla \, \psi_E
\Endeq
The scaler potentials both satisfy the Laplace equation $\nabla^2 \, \psi = 0$.

The scaler potentials 
\Begineq
  \psi_B = \re \left[ \sum_{m = 0}^\infty \, \psi_{Bm} \right]
\Endeq
[Here and below, only equations for the magnetic field will be shown,
the equations for the electric fields are similar.] Each $\psi_{Bm}$
is a sum of a number of modes expressed in cylindrical coordinates as
\Begineq
  \psi_{Bm} = \sum_{n=1-N/2}^{N/2} \psi_{Bmn} =
  \sum_{n=1-N/2}^{N/2} \frac{1}{k_n} \, e^{i \, k_n \, z} \,
  e^{i \, m \, \theta} \, b_m(n) \, I_m(k_n \, \rho)
  \label{psps1k}
\Endeq
where $I_m$ is a modified Bessel function of the first kind, and the
$b_m(n)$ are complex coefficients. For electric fields, $e_m(n)$ is
substituted for $b_m(n)$ in \Eq{psps1k}. In \Eq{psps1k} $k_n$ is
given by
\Begineq
  k_n = \frac{2 \pi \, n}{N \, dz}
\Endeq
where $N$ is the number of modes of $\psi_m$, and $dz$ is the
longitudinal ``distance between points''. That is, the the
above equations will only be accurate over a longitudinal length
$(N-1) \, dz$.

The field associated with $\psi_{Bm}$ is for $m = 0$:
\begin{align}
  B_\rho &= \re \left[ 
    \sum_{n=1-N/2}^{N/2} e^{i \, k_n \, z} \, b_0(n) \,
    I_1(k_n \, \rho) \right] \CRNO
  B_\theta &= 0 \\
  B_z &= \re \left[ 
    \sum_{n=1-N/2}^{N/2} i \, e^{i \, k_n \, z} \, b_0(n) \,
    I_0(k_n \, \rho) \right]
    \nonumber
\end{align}

And for $m \neq 0$:
\begin{align}
  B_\rho &= \re \left[ 
    \sum_{n=1-N/2}^{N/2} \frac{1}{2} \, e^{i \, k_n \, z} \, 
    e^{i \, m \, \theta} \, b_m(n) \,
    \Big[ I_{m-1}(k_n \, \rho) + I_{m+1}(k_n \, \rho) \Big] \right] \CRNO
  B_\theta &= \re \left[ 
    \sum_{n=1-N/2}^{N/2} \frac{i}{2} \, e^{i \, k_n \, z} \, 
    e^{i \, m \, \theta} \, b_m(n) \,
    \Big[ I_{m-1}(k_n \, \rho) - I_{m+1}(k_n \, \rho) \Big] \right] \\
  B_z &= \re \left[ 
    \sum_{n=1-N/2}^{N/2} i \, e^{i \, k_n \, z} \, 
    e^{i \, m \, \theta} \, b_m(n) \,
    I_m(k_n \, \rho) \right]
    \nonumber
\end{align}

While technically $\psi_{Bm0}$ is not well defined due to the $1/k_n$ factor
that is present, the field itself is well behaved. Mathematically,
\Eq{psps1k} can be corrected if, for $n = 0$, the term $I_m(k_n \,
\rho) / k_n$ is replaced by
\Begineq
  \frac{I_m(k_0 \, \rho)}{k_0} \rightarrow 
  \begin{cases}
    \rho   &\text{if } m = 0 \\
    \rho/2 &\text{if } m = 1 \\
    0      &\text{otherwise}
  \end{cases}
\Endeq

The magnetic vector potential for $m = 0$ is constructed such that
only $A_\theta$ is non-zero
\begin{align}
  A_\rho &= 0 \CRNO
  A_\theta &= \re \left[ 
    \sum_{n=1-N/2}^{N/2} \frac{i}{k_n} \, e^{i \, k_n \, z} \, b_0(n) \, I_1(k_n \, \rho) \right] \\
  A_z    &= 0 \nonumber
\end{align}
For $m \ne 0$, the vector potential is chosen so that $A_\theta$ is zero.

\begin{align}
  A_\rho &= \re \left[ 
    \sum_{n=1-N/2}^{N/2} \frac{-i \, \rho}{2 \, m} \, e^{i \, k_n \, z} \, 
    e^{i \, m \, \theta} \, b_m(n) \,
    \Big[ I_{m-1}(k_n \, \rho) - I_{m+1}(k_n \, \rho) \Big] \right] \CRNO
  A_\theta &= 0 \\
  A_z    &= \re \left[ 
    \sum_{n=1-N/2}^{N/2} \frac{-i \, \rho}{m} \, e^{i \, k_n \, z} \, 
    e^{i \, m \, \theta} \, b_m(n) \,
    I_m(k_n \, \rho) \right] \nonumber
\end{align}

%-----------------------------------------------------------------
\subsection{AC Cylindrical Map Decomposition}
\label{s:cylind.ac}
\index{rf fields|hyperbf}

For RF fields, the \vn{cylindrical} mode parameterization used by \bmad essentially
follows Abell\cite{b:rf.abell}. The electric field is written in the form
\Begineq
  \bfE(\bfr) = \sum_{j=1}^M \, \bfE_j(\bfr) \, e^{-i \, (\omega_j \, t + \theta_{0j})}
  \label{eseei}
\Endeq
where $M$ is the number of modes. Each mode satisfies the vector Helmholtz
equation
\Begineq
  \nabla^2 \bfE_j + k_{tj}^2 \, \bfE_j = 0
  \label{bke}
\Endeq
where $k_{tj} = \omega_j/c$ with $\omega_j$ being the mode frequency.

For a given mode, the electric field can be characterized by the values on 
a cylindrical surface of some radius $R$. The field will be of the form
\begin{align}
  E_\rho(R, \theta, z) &= E_{\rho c}(R, z) \, \cos(m \, \theta - \theta_0) \CRNO
  E_\theta(R, \theta, z) &= E_{\theta s}(R, z) \, \sin(m \, \theta - \theta_0) \\
  \label{erpze}
  E_z(R, \theta, z)    &= E_{z c}(R, z)    \, \cos(m \, \theta - \theta_0) \nonumber
\end{align}
in this and in subsequent equations, the mode index $j$ has been
dropped.

The azimuthal mode number $m_j$ is a non-negative integer. If $m_j
= 0$, there are two different modes, one with $\theta_{0j} = 0$ and
the other with $\theta_{0j} = -\pi/2$. The $\theta_{0j} = 0$ mode is an
accelerating mode with the electric field is in the form
\begin{align}
  E_\rho(\bfr) &= \sum_{n=1-N/2}^{N/2} -e^{i \, k_n \, z} \, 
    i \, k_n \, e_0(n) \, \wt I_1(\kappa_n, \rho) \CRNO
  E_\theta(\bfr) &= 0 \\
  E_z(\bfr) &= \sum_{n=1-N/2}^{N/2}e^{i \, k_n \, z} \, 
    e_0(n) \, \wt I_0(\kappa_n, \rho) \nonumber
\end{align}
where $\wt I_m$ is
\Begineq
  \wt I_m (\kappa_n, \rho) \equiv \frac{I_m(\kappa_n \, \rho)}{\kappa_n^m}
\Endeq
with $I_m$ being a modified Bessel function first kind, and $\kappa_n$ is given by
\Begineq
  \kappa_n = \sqrt{k_n^2 - k_t^2} = 
  \begin{cases}
    \sqrt{k_n^2 - k_t^2} & |k_n| > k_t \\
    -i \, \sqrt{k_t^2 - k_n^2} & k_t > |k_n|
  \end{cases}
\Endeq
with
\Begineq
  k_n = \frac{2 \pi \, n}{N \, dz}
\Endeq
$N$ is the number of points where $E_{zc}$ is evaluated, and $dz$ is
the distance between points. The length of the field region is $(N-1) \, dz$. When
$\kappa_n$ is imaginary, $I_m(\kappa_n \, \rho)$ can be evaluated
through the relation
\Begineq
  I_m(-i \, x) = i^{-m} \, J_m(x)
\Endeq
where $J_m$ is a Bessel function of the first kind.
The $e_0$ coefficients are obtained from the equation
\begin{align}
  e_0(n) &= \frac{1}{\wt I_0(\kappa_n, R)} \, \frac{1}{N} \, \sum_{p=0}^{N-1}
    e^{-2 \, \pi \, i \, n \, p / N} \, E_{zc}(R, p \, dz) \CRNO
  &\equiv \frac{\wt E_{zc}(R, n)}{\wt I_0(\kappa_n, R)} 
\end{align}

The non-accelerating $m = 0$ mode with $\theta_0 = -\pi/2$ has an
electric field in the form
\begin{align}
  E_\rho(\bfr) &= E_z(\bfr) = 0 \CRNO
  E_\theta(\bfr) &= \sum_{n=1-N/2}^{N/2}e^{i \, k_n \, z} \, 
    b_0(n) \, \wt I_1(\kappa_n, \rho)
\end{align}
where
\Begineq
  b_0(n) = \frac{\wt E_{\theta s}(R, n)}{\wt I_1(\kappa_n, R)} 
\Endeq

For positive $m$, the electric field is in the form
\begin{align}
  E_\rho(\bfr) &= \sum_{n=1-N/2}^{N/2}
    -i \, e^{i \, k_n \, z} \, 
    \left[ 
    k_n \, e_m(n) \, \wt I_{m+1}(\kappa_n, \rho) +
    b_m(n) \, \frac{\wt I_m(\kappa_n, \rho)}{\rho}
    \right]
    \cos(m \, \theta - \theta_0) \CRNO
  E_\theta(\bfr) &= \sum_{n=1-N/2}^{N/2} 
    -i \, e^{i \, k_n \, z} \, 
    \left[
    k_n \, e_m(n) \, \wt I_{m+1}(\kappa_n, \rho) \, + \right. \\
  & \left. \qquad \qquad \qquad \qquad \qquad \qquad
    b_m(n) \, \left( \frac{\wt I_m(\kappa_n, \rho)}{\rho} - 
    \frac{1}{m} \, \wt I_{m-1}(\kappa_n, \rho) \right)
    \right] 
    \sin(m \, \theta - \theta_0) \CRNO
  E_z(\bfr) &= \sum_{n=1-N/2}^{N/2}e^{i \, k_n \, z} \, 
    e_m(n) \, \wt I_m(\kappa_n, \rho) \cos(m \, \theta - \theta_0) \nonumber
\end{align}
with
\begin{align}
  e_m(n) &= \frac{\wt E_{zc}(R, n)}{\wt I_m(\kappa_n, R)} \CRNO
  b_m(n) &= \frac{R}{\wt I_m(\kappa_n, R)} \left[
    i \, \wt E_{\rho c} - k_n \, e_m(n) \, \wt I_{m+1}(\kappa_n, R)
    \right]
\end{align}

The above mode decomposition was done in the gauge where the scalar
potential $\psi$ is zero. The electric and magnetic fields are thus
related to the vector potential $\bfA$ via
\Begineq
  \bfE = -\partial_t \, \bfA, \qquad \bfB = \nabla \times \bfA
\Endeq
Using \Eq{eseei}, the vector potential can be obtained from the
electric field via
\Begineq
  \bfA_j = \frac{-i \, \bfE_j}{\omega_j}
  \label{aiew}
\Endeq
 
Symplectic tracking through the RF field is discussed in
Section~\sref{s:symp.track}.  For the fundamental accelerating mode,
The vector potential can be analytically integrated using the identity
\Begineq
  \int dx \,\frac{x \, I_1 (a \, \sqrt{x^2+y^2})}{\sqrt{x^2+y^2}}  = 
  \frac{1}{a} \, I_0 (a \, \sqrt{x^2+y^2})
\Endeq

%-----------------------------------------------------------------
\section{Field Modeling Using Taylor Maps}
\label{s:taylor.field.phys}
\index{taylor field modeling}

\bmad has a number of \vn{field map} models that can be used to model electric or magnetic fields
(\sref{s:fieldmap}). One model involves a set of Taylor maps. This model is restricted to
modeling DC fields. In a lattice file, the \vn{Taylor} field model is specified using the
\vn{taylor_field} attribute as exaplined in Sec.~\sref{s:taylor.field}.

The Taylor field model specifies the field using a set of Taylor maps. Each map defines
the field in the transverse $(x, y)$ plane at constant longitudinal $z$: That is, each
Taylor map is comprised of three Taylor series, one for each field component, and each
Taylor series is a polynomial in $x$ and $y$:
\Begineq
  \Bf B = (B_x(x,y;i), B_y(x,y;i), B_z(x,y;i))
\Endeq
where the $B_x, B_y, B_z$ on the right hand side represent the tree Taylor series, $i$
denotes the Taylor map at $z_i = i \cdot dz$ where $dz$ is the spacing between maps. The
maps are restricted to be equally spaced to enable higher order integration schemes in PTC
(See \vn{default_integ_order} in \sref{s:bmad.com}).  [Note: Each Taylor field model
specifes either an electric or magnetic field. In this section, the symbol $B$ can refer
to either magnetic or electric fields.]

Interpolation of the field in \bmad is done using a cubic spline fit. Given a position
$(x, y, z)$, the field $\Bf B$ and transverse field derivatives $\partial \Bf B / \partial
\Bf r$, are evaluated at two positions $\Bf r_0 = (x, y, z_{i0})$ and $\Bf r_1 = (x, y,
z_{i1})$ with $z_{i0}$ being the positions of the maps to either side of $z$.
The longitudinal field derivatives are derived from the transverse ones using Maxwell's equations:
\Begineq
  \frac{\partial B_x}{\partial z} = \frac{\partial B_z}{\partial x}, \qquad
  \frac{\partial B_y}{\partial z} = \frac{\partial B_z}{\partial y}, \qquad
  \frac{\partial B_z}{\partial z} = 
    - \left( \frac{\partial B_x}{\partial x} + \frac{\partial B_y}{\partial y} \right)
\Endeq

Once the field and longitudinal derivatives are known at $\Bf r_0$ and $\Bf r_1$, a
standard cubic spline interpolation is done.

Note: If the Taylor field model uses curved coordinates, There will be inaccuracies in the
computed field to the extent that Maxwell's equations have to be modified to take into
account the coordinate curvature.

%-----------------------------------------------------------------
\section{Wake fields}
\label{s:wake.fields}
\index{wake fields|hyperbf}

%-----------------------------
\subsection{Short--Range Wakes}
\label{s:wake.short}
\index{wake fields!short-range}

Wake field effects are divided into short--range (within a bunch) and
long--range (between bunches).

Only the transverse dipole and longitudinal monopole components of the
short--range wake field are modeled. The longitudinal monopole energy
kick $dE$ for the $i$\Th (trailing) macroparticle due to the wake from
the $j$\Th (leading) macroparticle is computed from the equation
\Begineq
  \Delta p_z(i) = \frac{-e \, L}{v \, P_0} \, \left(
        \frac{1}{2}\WlS(0) \,  |q_i| +
        \sum_{j \ne i} \WlS(dz_{ij}) \, |q_j| \right)
  \label{delvp}
\Endeq
where $v$ is the particle velocity, $e$ is the charge on an electron,
$q$ is the macroparticle charge, $L$ is the cavity length, $dz_{ij}$
is the longitudinal distance between the $i$\Th and $j$\Th
macroparticles, $\WlS$ is the short--range longitudinal wake field
function.

For the transverse kick, there are two types of wakes: Those that are
dependent upon transverse offset of the leading particle (but
independent of the position of the trailing particle) and those that
are dependent upon the transverse offset of the trailing particle (but
independent of the position of the leading particle. If the beam
chamber has azimuthal symmetry, the only wakes present are those that
are dependent upon the offset of the leading particle. 

\bmad assumes that the beam chamber wall is mirror symmetric with
respect to both the $x$-axis and $y$-axis. In this case, a horizontal
displacement (of either particle) results in a horizontal kick and
similarly for vertical displacements. That is, the horizontal and
vertical wakes are decoupled. 

With the above symmetry assumpltion, 
the transverse kick $\Delta p_x(i)$ for the $i$\Th macroparticle due to the 
dipole short--range transverse wake field is modeled with the equation
\Begineq
  \Delta p_x(i) = \frac{-e \, L \, \sum_j |q_j| \, x \, \WtS(dz_{ij})}
                 {v \, P_0}
  \label{pelqxw}
\Endeq
Where $x$ is the horizontal displacement of the leading or trailing
particle as appropriate. There is a similar equation for $\Delta
p_y(i)$. $\WtS$ is the transverse short--range wake function.

The wake field functions $\WlS$ and $\WtS$ can be specified in a \bmad
lattice file using ``pseudo'' modes where
\Begineq
  W(z) = \sum_i A_i \, e^{d_i z} \, \sin (k_i \, z + \phi_i)
  \label{wadzk}
\Endeq
The parameters $(A_i, d_i, k_i, \phi_i)$ are chosen to fit the calculated wake potential
(\sref{s:sr.wake.file}). The reason why the mode approach is used in \bmad is due to the
fact that, using pseudo modes, the calculation time scales as the number of particles $N$
while a calculation based upon a table of wake vs $z$ would scale as $N^2$. [The
disadvantage is that initially the user must proform a fit to the wake potential to
generate the mode parameter values.]

%-----------------------------
\subsection{Long--Range Wakes}
\label{s:wake.long}
\index{wake fields!long-range}

Following Chao\cite{b:chao} Eq.~2.88, the long--range wake fields are
characterized by a set of cavity modes. The wake function $W_m$ for a
mode of order $m$ is given by
\Begineq
  W_m(t) = -c \, \left( \frac{R}{Q} \right)_m \,\,
  e^{-\omega \, t/ 2 Q} \, \sin (\omega \, t)
  \label{wcrq}
\Endeq
The mode strength $(R/Q)_m$ has units of Ohms/meter$^{2m}$.
The lattice syntax for defining long-range wakes is discussed in \Sref{s:lr.wake.file}.

Assuming that the macroparticle generating the wake is offset a
distance $r_w$ along the $x$--axis, a trailing macroparticle will see a kick
\begin{align}
  \Delta {\Bf p}_\perp &= 
    -C \, I_m \, W_m(t) \, m \, r^{m-1} \, \left( 
    \bfhat r \cos m\theta - {\bf\hat\theta} \sin m\theta \right) \\
  &= -C \, I_m \, W_m(t) \, m \, r^{m-1} \, \left( 
    \bfhat x \cos [(m-1) \theta] - 
    \bfhat y \sin [(m-1)\theta] \right) \CRNO
  \Delta p_z &= -C \, I_m \, W'_m(t) \, r^m \, \cos m\theta
\end{align}
where $m$ is the order of the mode, $C$ is given by
\Begineq
  C = \frac{e}{c \, P_0}
\Endeq
 and
\Begineq
  I_m = q_w \, r_w^m
\Endeq
with $q_w$ being the magnitude of the charge on the particle. 
Generalizing the above, a macroparticle at $(r_w, \theta_w)$ will generate a wake
\begin{align}
  -\Delta p_x + i\Delta p_y &= C \, I_m \, W_m(t) \, 
    m \, r^{m-1} \, e^{-i m \theta_w} \, e^{i (m-1) \theta} 
    \label{ppcimr} \\
  \Delta p_z &= C \, I_m \, W'_m(t) \, r^m \, \cos [m(\theta - \theta_w)]
    \label{pciwr}
\end{align}
Comparing \Eq{ppcimr} to \eq{bib1nb}, and using the relationship between
kick and field as given by \eq{pqlbp1} and \eq{pqlbp2}, shows that
the form of the wake field transverse kick is the same as for a
multipole of order $n = m - 1$. 

The wake field felt by a particle is due to the wake fields generated by
all the particles ahead of it. If the wake field kicks are computed by
summing over all particle pairs, the
computation will scale as $N^2$ where $N$ is the number of
particles. This quickly becomes computationally exorbitant. A better
solution is to keep track of the wakes in a cavity. When a particle
comes through, the wake it generates is simply added to the existing
wake. This computation scales as $N$ and makes simulations with large
number of particles practical. 

To add wakes together, a wake must be decomposed into its
components.  Spatially, there are normal and skew components and
temporally there are sin and cosine components. This gives 4
components which will be labeled $a_{\cos}$, $a_{\sin}$, $b_{\cos}$,
and $b_{\sin}$. For a mode of order $m$, a particle passing through at
a time $t_w$ with respect to the reference particle will produce
wake components
\begin{alignat}{2}
  \delta a_{\sin, m} &=  &c \, \left( \frac{R}{Q} \right)_m \,
    e^{\omega \, t_w/ 2 Q} \, \cos (\omega \, t_w) \, I_m \, \sin(m \theta_w) 
    \CRNO
  \delta a_{\cos, m} &= -&c \, \left( \frac{R}{Q} \right)_m \,
    e^{\omega \, t_w/ 2 Q} \, \sin (\omega \, t_w) \, I_m \, \sin(m \theta_w) 
    \label{ac2rq} 
    \\
  \delta b_{\sin, m} &=  &c \, \left( \frac{R}{Q} \right)_m \,
    e^{\omega \, t_w/ 2 Q} \, \cos (\omega \, t_w) \, I_m \, \cos(m \theta_w) 
    \CRNO
  \delta b_{\cos, m} &= -&c \, \left( \frac{R}{Q} \right)_m \,
    e^{\omega \, t_w/ 2 Q} \, \sin (\omega \, t_w) \, I_m \, \cos(m \theta_w) 
    \nonumber
\end{alignat}
These are added to the existing wake components. The total is
\Begineq
  a_{\sin, m} = \sum_{\text{particles}} \delta a_{\sin, m}
\Endeq
with similar equations for $a_{\cos, m}$ etc. Here the sum is over all particles
that cross the cavity before the kicked particle. To calculate the kick
due to wake, the normal and skew components are added together
\begin{align}
  a_m &= e^{-\omega \, t/ 2 Q} \, \left( 
    a_{\cos, m} \, \cos (\omega \, t) - a_{\sin, m} \, \sin (\omega \, t) \right) 
    \label{akz2q} \\
  b_m &= e^{-\omega \, t/ 2 Q} \, \left(
    b_{\cos, m} \, \cos (\omega \, t) - b_{\sin, m} \, \sin (\omega \, t) \right) \nonumber 
\end{align}
Here $t$ is the passage time of the particle with respect to the
reference particle. In analogy to \Eq{ppcimr} and \eq{pciwr}, the kick
is
\begin{align}
  -\Delta p_x + i\Delta p_y &= C \, 
    m \, (b_m + i a_m) \, r^{m-1} \, e^{i (m-1) \theta} 
    \label{ppcmbar} \\
  \Delta p_z &= -C \, r^m \, \left( 
    (b_m' + i a_m') e^{i m\theta} + (b_m' - i a_m') e^{-i m\theta} \right)
\end{align}
where $a' \equiv da/dt$ and $b' \equiv db/dt$.

When simulating trains of bunches, the exponential factor $\omega \, t_w / 2
Q$ in \Eq{ac2rq} can become very large. To prevent numerical overflow,
\bmad uses a reference time $z_{\text{ref}}$ so that all times
$t$ in the above equations are replaced by
\Begineq
  t \longrightarrow t - t_{\text{ref}}
\Endeq

The above equations were developed assuming cylindrical symmetry. With
cylindrical symmetry, the cavity modes are actually a pair of
degenerate modes. When the symmetry is broken, the modes no longer have the
same frequency. In this case, one has to consider a mode's polarization
angle $\phi$. Equations \eq{akz2q} and \eq{ppcmbar} are unchanged. 
In place of \Eq{ac2rq}, the contribution of a particle to a mode is
\begin{alignat}{2}
  \delta a_{\sin, m} &=  &c \, \left( \frac{R}{Q} \right)_m \,
    e^{\omega \, t_w/ 2 Q} \, \cos (\omega \, t_w) \, I_m \, \left[
    \sin(m \theta_w) \, \sin^2(m \phi) + 
    \cos(m \theta_w) \, \sin(m \phi) \, \cos(m\phi) \right]
    \CRNO
  \delta a_{\cos, m} &= -&c \, \left( \frac{R}{Q} \right)_m \,
    e^{\omega \, t_w/ 2 Q} \, \sin (\omega \, t_w) \, I_m \, \left[ 
    \sin(m \theta_w) \, \sin^2(m \phi) + 
    \cos(m \theta_w) \, \sin(m \phi) \, \cos(m\phi) \right]
    \\
  \delta b_{\sin, m} &=  &c \, \left( \frac{R}{Q} \right)_m \,
    e^{\omega \, t_w/ 2 Q} \, \cos (\omega \, t_w) \, I_m \, \left[
    \cos(m \theta_w) \, \cos^2(m \phi) + 
    \sin(m \theta_w) \, \sin(m \phi) \, \cos(m\phi) \right]
    \CRNO
  \delta b_{\cos, m} &= -&c \, \left( \frac{R}{Q} \right)_m \,
    e^{\omega \, t_w/ 2 Q} \, \sin (\omega \, t_w) \, I_m \, \left[
    \cos(m \theta_w) \, \cos^2(m \phi) + 
    \sin(m \theta_w) \, \sin(m \phi) \, \cos(m\phi) \right]
    \nonumber
\end{alignat}

Each mode is characterized by an $R/Q$, $Q$, $\omega$, and $m$. Notice
that $R/Q$ is defined so that it includes the cavity length. Thus the
long--range wake equations, as opposed to the short--range ones, do
not have any explicit dependence on $L$. 

To make life more interesting, different people define $R/Q$
differently. A common practice is to define an $R/Q$ ``at the beam
pipe radius''. In this case the above equations must be modified to
include factors of the beam pipe radius. Another convention uses a
``linac definition'' which makes $R/Q$ twice as large and adds a
factor of 2 in \Eq{wcrq} to compensate.

