\chapter{Etienne Forest's PTC/FPP}
\label{c:etienne}
\index{PTC/FPP}
%----------------------------------------------------------------------------

Etienne Forest\cite{b:forest} has written what is actually two
software libraries: FPP and PTC. The software and a manual can be
obtained at
\begin{example} 
  <http://acc-physics.kek.jp/forest/PTC/Introduction.html>    
\end{example}

FPP stands for ``Fully Polymorphic Package.'' What this library does
is implement Taylor maps (aka Truncated Power Series Algebra or TPSA)
and Lie algebraic operations. Thus in FPP you can define a Hamiltonian
and then generate the Taylor map for this Hamiltonian. FPP is very
general. It can work with an arbitrary number of dimensions.  FPP,
however, is a purely mathematical package in the sense that it knows
nothing about accelerator physics. That is, it does not know about
bends, quadrupoles or any other kind of element, it has no conception
of a lattice (a string of elements), it doesn't know anything about
Twiss parameters, etc.

This is where PTC (Polymorphic Tracking Code) comes in PTC. PTC
implements the high energy physics stuff and uses FPP as the engine to
do the Lie algebraic calculations.  PTC is a very general package and
\bmad only makes use of a small part of its features. Essentially
the part that \bmad uses is the part that creates Taylor maps and
does symplectic integration. Not used is, for example, the
Calculational part that does normal form analysis Twiss parameters
(\bmad does its own), beam envelope tracking, etc. PTC also has the
ability, which \bmad does not take advantage of, to define ``knobs''
which means that the Taylor map can be a function of the phase space
coordinates plus other variables (for example the strength of a
quadrupole). The list goes on. 

\bmad has been structured so that ``normally'' a programmer will not have
to deal with PTC (in general when PTC is written it is meant PTC in
conjunction with FPP) subroutines directly. 

%--------------------------------------------------------------------------
\section{Phase Space}
\label{s:etienne.space}
\index{PTC/FPP!phase space}

PTC uses different longitudinal phase space coordinates compared to \bmad.
\bmad's phase space coordinates are
\Begineq
  (x, p_x, y, p_y, z, p_z)
\Endeq
PTC uses
\Begineq
  (x, p_x, y, p_y, p_z, ct \sim -z)
\Endeq
\vn{vec_bmad_to_ptc} and \vn{vec_ptc_to_bmad} are conversion routines
that translate between the two. Actually there are a number of
conversion routines that translate between \bmad and PTC
structures. See \sref{r:ptc} for more details.

%--------------------------------------------------------------------------
\section{Initialization}
\label{s:etienne.init}
\index{PTC/FPP!initialization}

One important parameter in PTC is the order of the Taylor maps.
By default \bmad will set this to 3. The order can be set within
a lattice file using the \vn{parameter[taylor_order]} attribute.
In a program the order can be set using \vn{set_ptc}. In fact
\vn{set_ptc} must be called by a program before PTC can be used.
\vn{bmad_parser} will do this when reading in a lattice file.
That is, if a program does not use \vn{bmad_parser} then to use PTC it
must call \vn{set_ptc}. Note that resetting PTC to a different order
reinitializes PTC's internal memory so one must be careful if one wants
to change the order in mid program.

%--------------------------------------------------------------------------
\section{Taylor Maps}
\label{s:etienne.taylor}
\index{PTC/FPP!Taylor Maps}

\index{PTC/FPP!real_8}\index{PTC/FPP!universal_taylor}
FPP stores its \vn{real_8} Taylor maps in such a way that it is not
easy to access them directly to look at the particular terms. To
simplify life, Etienne has implemented the
\vn{universal_taylor}structure:
\begin{example}
  type universal_taylor
    integer, pointer  :: n       ! Number of coefficients
    integer, pointer  :: nv      ! Number of variables
    real(dp), pointer :: c(:)    ! Coefficients C(N)
    integer, pointer  :: j(:,:)  ! Exponents of each coefficients J(N,NV)
  end type
\end{example}
\bmad always sets \vn{nv} = 6. \bmad overloads the equal sign to call 
routines to convert between Etienne's
\vn{real_8} Taylor maps and \vn{universal_taylor}:
\begin{example}
  type (real_8) tlr(6)           ! Taylor map
  type (universal_taylor) ut(6)  ! Taylor map
  ...
  tlr = ut                       ! Convert universal_taylor -> real_8
  ut = tlr                       ! Convert real_8 -> universal_taylor
\end{example}
