\documentclass[11pt]{article}
\usepackage{moreverb}    % Defines {listing} environment.
\usepackage{tocloft}
\usepackage{geometry}            % See geometry.pdf to learn the layout options. There are lots.
\usepackage{xspace}
\geometry{letterpaper}           % ... or a4paper or a5paper or ... 
%\usepackage[parfill]{parskip}   % To begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{alltt}
\usepackage[T1]{fontenc}   % so _, <, and > print correctly in text.
\usepackage[strings]{underscore}    % to use "_" in text
\usepackage[pdftex,colorlinks=true]{hyperref}

\newcommand{\fig}[1]{Figure~\ref{#1}}
\newcommand{\lux}{Lux\xspace}
\newcommand{\chess}{CHESS\xspace}
\newcommand{\Begineq}{\begin{equation}}
\newcommand{\Endeq}{\end{equation}}
\newcommand{\CRNO}{\nonumber \\}

\newcommand\ttcmd{\begingroup\catcode`\_=11 \catcode`\%=11 \dottcmd}
\newcommand\dottcmd[1]{\texttt{#1}\endgroup}
\newcommand{\vn}{\ttcmd}   

\newcommand{\Newline}{\hfil \\}
\newcommand{\sref}[1]{$\S$\ref{#1}}

\newenvironment{example}
  {\vspace{\ExBeg} \begin{alltt}}
  {\end{alltt} \vspace{\ExEnd}}

%---------------------------------------------------------------------------------

\newlength{\dPar}
\newlength{\ExBeg}
\newlength{\ExEnd}
\setlength{\dPar}{1.5ex}
\setlength{\ExBeg}{-\dPar}
\addtolength{\ExBeg}{-0.5ex}
\setlength{\ExEnd}{-\dPar}
\addtolength{\ExEnd}{-0.0ex}

\setlength{\textwidth}{6.25in}
\setlength{\hoffset}{0.0in}
\setlength{\oddsidemargin}{0.25in}
\setlength{\evensidemargin}{0.0in}
\setlength{\textheight}{8.5in}
\setlength{\topmargin}{0in}

\setlength{\parskip}{\dPar}
\setlength{\parindent}{0ex}

\setlength\cftparskip{0pt}
\setlength\cftbeforesecskip{3pt}
\setlength\cftaftertoctitleskip{15pt}

%---------------------------------------------------------------------------------

\title{Lux Program}
\author{D. Sagan, K. Finkelstein}
\date{Revision 1.2 \\ June, 15 2015}

%---------------------------------------------------------------------------------

\begin{document}
\maketitle

\pdfbookmark[1]{Contents}{Contents}
\tableofcontents

%------------------------------------------------------------------
\section{Introduction} 
\label{s:intro}

\lux is a program for Monte Carlo simulations of X-rays using either
coherent or incoherent ray tracing. \lux works by generating
photons at a source element and tracking them through to a
detector. \lux uses the Bmad subroutine library\cite{b:bmad} for
tracking and lattice bookkeeping.

\lux comes in two versions: A single threaded version whose executable
is called \vn{lux} and an parallel compute version using MPI whose
executable is called \vn{mpi_lux}.

%------------------------------------------------------------------
\section{Building \lux} 
\label{s:build}

Chances are that a \lux excutable is already built for you to use. If
you do need to build \lux, first copy the \vn{lux} directory (ask your
local Bmad guru where this directory resides if you need to) to your
local area 

\lux is built using the same build system based on \vn{CMake} that is
used for building Bmad. To build the single threaded version of \lux,
go to the \lux directory and use the \vn{mk} and/or the \vn{mkd}
command to build production and/or debug executables (See the
documentation of the Bmad build system for more details).

To build the parallel version of \lux, go to the \lux directory and
use the \vn{./build_mpi mk} and/or the \vn{./build_mpi mkd} command to
build production and/or debug executables.

%------------------------------------------------------------------
\section{Running \lux} 
\label{s:run}

Syntax for invoking the single threaded version of \lux:
\begin{example}
 <path-to-lux-exe>/lux \{-silent\} \{<master-input-file-name>\}
\end{example}
The \vn{<master-input-file-name>} optional argument is used to set the
master input file name. The default is ``\vn{lux.init}''. 

The \vn{-silent} optional argument supresses the terminal output that
\lux generates at the end of a run. This is useful to avoid long
output when \lux is run repeatedly via a script.

Example input files are in the \vn{lux/examples} subdirectory.

To run the parallel version of \lux, a script \vn{run_lux_mpi.sh} for
running on the Laboratory compute farm is provided in
\vn{lux/examples} subdirectory. [For non-Cornell people, ask your
local MPI guru for help.] To run on the Lab compute farm, copy this
script into a local directory, modify as needed (at minimum you will
need to set where the \lux executable is and how many nodes you want
to use in this script), and then start \lux with the command:
\begin{example}
  qsub run_lux_mpi.sh
\end{example}

%------------------------------------------------------------------
\section{Data Visualization}
\label{s:vis}

There is a python script for making an intensity plot of the
\vn{det_pix_out_file} (\sref{s:det.pix.file}) in:
\begin{example}
  lux/plot/det_pix_plot.py
\end{example}
For help run the script
\begin{example}
  <path_to_script>/det_pix_plot.py -help
\end{example}

%------------------------------------------------------------------
\section{Fortran Namelist}
\label{s:namelist}

Fortran namelist syntax is used for setting parameters in \lux's
master input file (\sref{s:master.file}). The general form of a
namelist is
\begin{example}
  &<namelist_name>
    <var1> = ...
    <var2> = ...
    ...
  /
\end{example}
The tag \vn{"\&<namelist_name>"} starts the namelist where
\vn{<namelist_name>} is the name of the namelist. The namelist ends
with the slash \vn{"/"} tag. Anything outside of this is
ignored. Within the namelist, an exclamation mark \vn{"!"} and
everything after it on a line is ignored. \vn{<var1>}, \vn{<var2>},
etc. are variable names. Example:
\begin{example}
  &section_def section =   0.0, "arc_std", "elliptical", 0.045, 0.025 /
\end{example}
here \vn{section_def} is the namelist name and \vn{section} is a variable
name.  Notice that here \vn{section} is a ``structure'' which has five
components (0.0, ``arc_str'', etc.).

%------------------------------------------------------------------
\section{Master Input File} 
\label{s:master.file}

%------------------------------------------------------------------
\subsection{Master Input File Example}
\label{ss:master.example}

The master input file consists of a single \vn{namelist} called \vn{params}.
An example is:
\begin{example}
  &params
    lux_param%lattice_file = 'test.bmad'           ! Defines experimental layout.
    lux_param%det_pix_out_file = 'lux.det_pix#'
    lux_param%photon1_out_file = 'lux.photon1'     ! Individual photon positions.

    lux_param%photon_init_element = 'p_init'       ! Name of element emitting photons
    lux_param%detector_element = 'det'
    lux_param%photon1_element = ''

    lux_param%random_seed = 0                      ! 0 => Use system clock
    lux_param%random_engine = 'pseudo'

    lux_param%scale_initial_field_to_1 = False
    lux_param%intensity_normalization_coef = 1e6   ! photon intensities norm.

    lux_param%stop_total_intensity = 10            ! Cumulative intensity to stop at.
    lux_param%stop_num_photons = 1e8               ! Max number of photons to track.
    lux_param%mpi_run_size = 0.1                   ! Normalized num photons to track.

    lux_param%intensity_min_det_pixel_cutoff = 0.1 ! det_pix_out file Cutoff

    lux_param%intensity_min_photon1_cutoff = 1e-3  ! photon1_out file cutoff
    lux_param%n_photon1_out_max = 100              ! Max photons in photon1_out_file.
    lux_param%reject_dead_at_det_photon1 = False
    lux_param%n_energy_bin_pts = 40                ! Number of energy bins


  /
\end{example}

%------------------------------------------------------------------
\subsection{Master Input File Parameters}
\label{ss:master.params}

The components of the params namelist are:
  \begin{description}
  \item[\vn{lux_param\%det_pix_out_file}] \Newline
Name of the output data file recording the X-ray intensity on the
detector. See section~\sref{s:det.pix.file} for more details. The file
name may be ``numbered'' using a ``\#'' character (\sref{s:number}). A
blank file name will prevent a file being generated.

  \item[\vn{lux_param\%detector_element}] \Newline
Name of the lattice detector element where the photon are absorbed.

  \item[\vn{lux_param\%intensity_min_det_pixel_cutoff}] \Newline
Sets the threshold absorbed photon intensity such that all pixels
who's intensity is below this will not be included in the
\vn{det_pix_out} file (\sref{s:det.pix.file}). This intensity is
relative to the maximum pixel intensity. [Note: pixels must also have
non-zero intensity to be included.]

  \item[\vn{lux_param\%intensity_min_photon1_cutoff}] \Newline
Cutoff intensity below which a photon will not be included in
the photon1_out file (\sref{s:photon1.file}).

  \item[\vn{lux_param\%intensity_normalization_coef}] \Newline
Coefficient used to normalize the photon intensity with (\sref{s:det}).

  \item[\vn{lux_param\%lattice_file}] \Newline
Name of the input file that defines the X-ray optics setup from source
to detector. The syntax of the file conforms to the Bmad lattice
format. The Bmad manual has a detailed description of this format.
Examples are presented in section~\sref{s:lat.file}.

  \item[\vn{lux_param\%mpi_run_size}] \Newline
Only used when running the parallel version of \lux. This parameter
determins how many photons a slave process is asked to track before
sending back data to the master process:
\begin{example}
  Number to track = lux_param%stop_num_photons * 
           lux_param%mpi_run_size / (Number_processes - 1)
\end{example}
\vn{%mpi_run_size} should be set to some number between 0 and 1.
The value 0.1 is the default. Changing this number can affect
running time but the running time should be fairly insensitive
to the value of \vn{%mpi_run_size}.

  \item[\vn{lux_param\%n_energy_bin_pts}] \Newline
Number of energy bins used for the table of intensity of photons
hitting the detector as a function of photon energy
(\sref{s:det.pix.file}).

  \item[\vn{lux_param\%photon_init_element}] \Newline
Name of the lattice element that is the source of the photons (\sref{s:lat.file}).

  \item[\vn{lux_param\%n_photon1_out_max}] \Newline
Maximum number of photons to record in the \vn{photon1_out_file}.
Default is 100.

  \item[\vn{lux_param\%photon1_element}] \Newline
The photon position recorded in the photon1_out file will be the
photon position at the lattice element named by \vn{lux_param%photon1_element}. 
If \vn{photon1_element} is blank (default), the
detector element used will be used (\sref{s:photon1.file}).

  \item[\vn{lux_param\%photon1_out_file}] \Newline
Name of the output data file recording the starting and ending
positions of individual photons. See section~\sref{s:photon1.file} for
more details. The file name may be ``numbered'' using 
a ``\#'' character (\sref{s:number}). A blank file name will prevent a
file being generated.

  \item[\vn{lux_param\%random_engine}] \Newline
Type of ``random'' number generator to use. Possibilities are:
\begin{example}
  quasi      
  pseudo      ! Default
\end{example}
The \vn{quasi} number generator gives a more-or-less uniform
distribution of numbers. That is, a quasi random generator is not
actually random. The numbers generated with the quasi random generator
are always the same from run to run.

  \item[\vn{lux_param\%random_seed}] \Newline
Random number seed used in by the random number generator if the
\vn{random_engine} is set to \vn{pseudo}. If set to 0, the system
clock will be used. That is, if set to 0, the output results will vary
from run to run. Not used if the \vn{random_engine} is set to \vn{quasi}.

  \item[\vn{lux_param\%reject_dead_at_det_photon1}] \Newline
If \vn{reject_dead_to_det_photon1} is set to True, do not print to the
photon_out file any photons that do not reach the detector. This switch
is only relavent when the lattice element at which the photon positions
are being evaluated is not the detector (\sref{s:photon1.file}).

  \item[\vn{lux_param\%scale_initial_field_to_1}] \Newline
Scale the field so that $E_x^2 + E_y^2 = 1$ Only used if at least
one field component is non-zero.

  \item[\vn{lux_param\%stop_num_photons}] \Newline
Maximum number of photons to track (\sref{s:det}).

  \item[\vn{lux_param\%stop_total_intensity}] \Newline
Cumulative unnormalized intensity at the detector to stop
at (\sref{s:det}).  Note: This parameter is ignored if running the
parallel version of \lux and only \vn{lux_param%stop_num_photons}
is used.

  \end{description}

%------------------------------------------------------------------
\section{Photon Description}
\label{s:photon.descrip}

Photons are described by:
\begin{example}
  (x, vx/c, y, vy/c, z, vz/c)   ! six dimensional phase space vector 
  E                       ! Photon energy (eV)
  e_field_x, e_field_y    ! Electric field magnitude vector
  phase_x, phase_y        ! Electric field phase 
\end{example}
$(x, y, z)$ is the spatial position of the photon with $z$ being the
longitudinal coordinate and $z=0$ corresponds to the beginning of the
element the photon is passing though (Thus $z$ is generally not
interesting). $(v_x/c, v_y/c, v_z)/c$ is the photon velocity normalized to 1.
Generally photons that make it to the detector will have $v_z/c$ close to
1 and $v_x/c$ and $v_y/c$ small.

The photon phases \vn{phase_x} and \vn{phase_y} are only relavent with
coherent tracking set in the lattice by the
\vn{parameter[photon_type]}. See the Bmad manual for more details.

The unnormalized intensity of a photon is:
\begin{example}
  I(unnormalized) = e_field_x^2 + e_field_y^2
\end{example}

To properly normalize the intensity at the detector in the output
files, a normalization factor $f_n$ is applied.
\Begineq
  I (\mbox{normalized}) = f_n I (\mbox{unnormalized}) 
\Endeq
$f_n$ is constructed so that the normalized intensity will be
independent of the number of simulation photons. Explicitly:
\Begineq
  f_n = \frac{C_f}{N_p}
\Endeq
where $N_p$ is the number of photons tracked, and $C_f$ is a
normalization coefficient set by the \vn{intensity_normalization_coef}
parameter in the master input file, $C_f$ can be used, for example, to
scale the output numbers to correspond to actual measured values.

%------------------------------------------------------------------
\subsection{Photon Polarization Initialization}

When using a \vn{photon_init} element without an associated ``physical
elemement'', the polarization of the photons is set by the
\vn{photon_init} parameters \vn{e_field_x} and \vn{e_field_y}. 

When using a \vn{photon_init} element with an associated physical
element (which is generally a bend, wiggler, and undulator element),
the polarization the photons is determined by the
properties of the physical element.

If the parameter \vn{lux_param%scale_initial_field_to_1} is set to
True, \lux will scale the field so that the \vn{unnormalized}
intensity (\sref{s:photon.descrip}) of each photon is 1 at the start
of tracking. If both field components are set to zero, the
polarization will be random. As photons travel, they can loose
intensity via, for example, diffraction from a crystal.

%------------------------------------------------------------------
\section{Photon Detection}
\label{s:det}

Photons are tracked until they are lost (hit an aperture) or until
they get to the detector which is the last element in the lattice.

Two parameters in the master input file determine when the simulation
is stopped:
\begin{example}
    lux_param%stop_total_intensity
    lux_param%stop_num_photons
\end{example}
If \vn{lux_param%stop_total_intensity} is positive, the simulation
ends when the total accumulated unnormalized intensity at the detector
passes this threshold. Intensity is the square of the photon electric
field and the unnormalized photon intensity will vary from zero to one for
each photon.

If \vn{lux_param%stop_num_photons} is positive, the simulation is
stopped when the number of photons generated passes this threshold. If
both stop parameters are positive, the simulation is stopped when either
the intensity or the number of photons passes the set threshold.

%------------------------------------------------------------------
\section{Lattice Description File}
\label{s:lat.file}

The name of the lattice description file which defines the
experimental setup is given by the \vn{lattice_file} parameter in the
master input file (\sref{s:master.file}). Bmad standard syntax is
used\cite{b:bmad}. 

The starting element for tracking photons, specified by the
\vn{lux_param%photon_init_element} parameter must be of type:
\begin{example}
  photon_init
\end{example}
This element may have an associated ``physical source'' element which
should be a bend, wiggler, or undulator element.

The detector element, specified by the \vn{lux_param%detector_element}
parameter must be of type:
\begin{example}
  detector
\end{example}
The detector element must define a grid of pixels. Example:
\begin{example}
  det: detector, surface = {grid = {ix_bounds = (-100, 100), 
                            iy_bounds = (-200, 200), dr = (0.001, 0.001)}}
\end{example}
See the Bmad manual for details of the detector syntax.

%------------------------------------------------------------------
\subsection{Example: Lattice Using an photon_init Source}
\label{ss:x.ray.init}

An example lattice using an \vn{photon_init} element without an
associated physical source is:
\begin{listing}{1}
beginning[e_tot] = 1e4
parameter[particle] = photon
parameter[no_end_marker] = T

c_rad = 75e-3  ! Crystal transverse radius 
r0 = 0.2
angle  = 80 * pi / 180
qq = r0 * tan(pi/2-graze_angle)
dft_len = sqrt(qq^2 + r0^2)

src: photon_init, energy_distribution = gaussian
drift1: pipe, l = dft_len, x_limit = 0.01, y_limit = 0.01
cryst: crystal, crystal_type = 'Si(444)', b_param = -1, tilt = pi, 
        a2_trans_curve = 1 / (2 * c_rad), a4_trans_curve = 1 / (8 * c_rad^3)
drift2: drift, l = dft_len
det: marker, x_limit = 0.01, y_limit = 0.01

lux_line: line = (src, drift1, cryst, drift2, det)
use, lux_line
\end{listing}

The list of lattice elements is given in line 19.  This lattice
constructs of five elements: The source, a crystal, and a detector
with two drift spaces in between. 

The definitions of the lattice elements is given in lines 11 through
17.  The reference photon energy is specified in line 1 as 10~KeV and
line 2 sets photons as the reference particle.

In this example the source element, called \vn{src}, is specified on
lines 11 and 12.  The physical extent of the source is given by the
parameters
\begin{example}
  l              ! Longitudinal length (\(2 \sigma\))
  x_half_length  ! Half length in x-direction (\(1 \sigma\))
  y_half_length  ! Half length in the y-direction (\(1 \sigma\)).
\end{example}
With Gaussian spatial distributions, \vn{l} is the $2\sigma$
longitudinal length of the source and \vn{x_half_length} and
\vn{y_half_length} are the $1\sigma$ transverse extents.

The source can be moved spatially by setting the parameters
\begin{example}
  x_offset, y_offset, z_offset
  x_pitch, y_pitch, tilt
\end{example}
See the Bmad manual for more details.

%------------------------------------------------------------------
\subsection{Example: Lattice Using an Bend Source}
\label{ss:bend}

When photons are generated via charged particles in an insertion
device or a bend, the lattice must have (at least) two \vn{branch}
lines: One branch containing the insertion device or bend and the
other branch is the X-ray branch containing the detector. Connecting the
charged particle branch to the X-ray branch There must be a
\vn{photon_fork} element.  Example Bmad lattice file:

\begin{listing}{1}
beam_start[emittance_a] = 1.446E-7
beam_start[emittance_b] = beam_start[emittance_a] / 100

parameter[e_tot] = 5.289E+09
parameter[geometry] = open

beginning[beta_a]  =  2.2611   
beginning[alpha_a] = -1.35379
beginning[eta_x]   =  0.549325
beginning[etap_x]  = -0.064612

beginning[beta_b]  = 9.3144
beginning[alpha_b] = 1.12414
beginning[eta_y]   = 0
beginning[etap_y]  = 0

b05w: sbend, l = 3.237903, angle = 0.102289270 ! rho =  31.65434

bend_line: line = (b05w)
c_fork: photon_fork, to_line = c_line, superimpose, 
        ref = b05w, ref_origin = beginning, offset =  23.6980 - 23.3814

!-----------------------------

drift1: drift, l = 10.25
drift2: drift, l = 10.75 - drift1[l]
drift3: drift
drift4: drift

white_beam_slit: rcollimator, x_limit = 0.005/2, y_limit = 0.001/2
mono_slit: rcollimator

cryst1: crystal, crystal_type = Si(531), ref_tilt = -pi/2, b_param = -1
cryst2: crystal, crystal_type = Si(531), ref_tilt = pi/2, b_param = -1

det: detector, x_limit = 1, y_limit = 1, 
     surface = {grid = {ix_bounds = (-1, 1), iy_bounds = (-1, 1), dr = (1, 1)}}

c_line: line = (drift1, white_beam_slit, drift2, cryst1, drift3, 
                cryst2, drift4, mono_slit, det)
c_line[particle] = photon
c_line[e_tot] = 8.979e3

use, bend_line

expand_lattice  ! So that bragg angles are computed

! drift3 length is set so that crystal2 is positioned 75 mm 
! vertically from the beam plane

drift3[l] = 0.075 / sin(cryst1[bragg_angle_in] + cryst1[bragg_angle_out])
drift4[l] = 14.5 - (drift1[l] + drift2[l] + drift3[l])
\end{listing}

Lines 1 through 21 define the charged particle branch which is
simply a bend called \vn{b05w} with a \vn{photon_fork} element, called
\vn{c_fork}, superimposed on top of it.

The \vn{c_fork} element branches to a branch called \vn{c_line}. The
elements of \vn{c_line} are given in lines 39 and 40: Two slits, two
crystals, and a detector with drifts in between. 

%------------------------------------------------------------------
\section{Numbering the Output Data Files}
\label{s:number}

The names of the output data files are specified by the following
variables (\sref{s:master.file}):
\begin{example}
  photon1_out_file
  det_pix_out_file
\end{example}

If an output data file name contains a pound character ``\#'', then a
number will substituted for the pound character and the number
substituted will be increased by one each time \lux is run. For example,
if \vn{det_pix_out_file} is defined by
\begin{example}
  det_pix_out_file = 'lux.det_pix#'
\end{example}
Then the first time \lux is run, the pixel data file will be named
``lux.det_pix1''.  The next time \lux is run, the data file will be
named ``lux.det_pix2'', etc.

Using a numbering system prevents data files from being
overwritten. If more than one output file name has a pound character,
all such files will receive the same number on a given run. To set the
number given, one can edit the file:
\begin{example}
  lux_out_file.number
\end{example}

When using the parallel version of \lux, if the \vn{photon1_out_file}
contains an ``\vn{\@}'' character, then, for each slave process doing
tracking, that slave process will generate a file with the rank id
number of slave process substituted for the \@ character. If the
single tread version of \lux is being used then a zero character will
be substituted.

%------------------------------------------------------------------
\section{Photon1 Data File}
\label{s:photon1.file}

The \vn{photon1_out_file} parameter (set in the master input file) is
the name of an output data file containing beginning and ``end''
coordinates of a set of photons.

The location where the ``end'' coordinates are evaluated is set by the
\vn{photon1_element} parameter from the master input file. If
\vn{photon1_element} is blank, the end coordinates are
evalueated at the detector element.  

If \vn{reject_dead_at_det_photon1} is set to True, photons that do not
make it to the detector will not be included in the photon1_out
file. In any case, a photon that does not reach the \vn{photon1_element}
element will not be included. Thus, if the lattice element where the
photon position is being evaluated at is the detector, it will always
be the case that photons that do not make it to the detector will not
be included in the photon1_out file irregardless of the setting of
\vn{reject_dead_at_det_photon1}.

If the file name is blank then no file will be generated. The file
name may be ``numbered'' using a ``\#'' character (\sref{s:number}).

If a photon at the detector has an intensity of less than
\vn{lux_param%intensity_min_photon1_cutoff} then the photon is not
counted.

Each row in the file is a single photon. The columns in the file are:
\begin{example}
  n_live           ! Index of this photon.
  beginning_orbit  ! Five columns: (x, vx, y, vy, z) at the source
  orbit_at_ix_ele  ! Five columns: (x, vx, y, vy, z) at the ``end''
  energy           ! Photon energy (eV).
  intensity_x      ! x-axis unnormalized photon intensity
  intensity_y      ! y-axis unnormalized photon intensity
\end{example}

%------------------------------------------------------------------
\section{Detector Pixel Data Files}
\label{s:det.pix.file}

The \vn{det_pix_out_file} parameter (set in the master input file) is
the name of an output data file containing pixel-by-pixel information.

If the file name is blank then no file will be generated. The file
name may be ``numbered'' using a ``\#'' character (\sref{s:number}).

The intensity of a pixel is the accumulated intensity of the photons
hitting the pixel. Only pixels whose intensity is non-zero and whose
intensity is greater than
\vn{lux_param%intensity_min_det_pixel_cutoff} are recorded in the
output file. This cutoff is relative to the intensity of the pixel
with the highest intensity.
\vn{lux_param%intensity_min_det_pixel_cutoff} is useful for keeping
the data file sizes small.

Each row in this file represents a single pixel. The columns in this
file are:
\begin{example}
  ix_pix            ! $x$-axis index
  iy_pix            ! $y$-axis index
  x_pix             ! $x$ coordinate of pixel center
  y_pix             ! $y$ coordinate of pixel center
  intensity_x       ! Normalized pixel intensity of x-polarized light.
  intensity_y       ! Normalized pixel intensity of y_polarized light
  intensity         ! Normalized pixel intensity = intensity_x + intensity_y
  n_photon          ! Number of photons hitting pixel
  E_ave             ! Average energy deviation from reference (eV)
  E_rms             ! RMS about the average energy (eV)
\end{example}
\vn{E_ave} is an intensity weighted average photon energy deviation
from the reference energy at a pixel. \vn{E_rms} is the RMS variation
of the photon energy with respect to \vn{E_ave}.

In addition to the pixel-by-pixel data file, three additional files
will be generated. Two of these files contain data projected on the
$x$ and $y$ detector axes. The name of these two files will be the same as
\vn{det_pix_out_file} with ``.x'' and ``.y'' suffilux indicating
projected data on the $x$ and $y$ axes respectively. The columns for
the $x$-axis projected data is:
\begin{example}
  ix_pix            ! x-axis index
  x_pix             ! x coordinate of pixel center
  intensity_x       ! Normalized x-polarized light pixel intensity sum
  intensity_y       ! Normalized y-polarized light pixel intensity sum
  intensity         ! Normalized pixel intensity sum = intensity_x + intensity_y
  n_photon          ! Number of photons hitting pixels
  E_ave             ! Average energy deviation from reference (eV)
  E_rms             ! RMS about the average energy (eV)
\end{example}
With similar columns for the $y$-axis file. The columns for the
$x$-axis projected file records the sum of the intensities for all
pixels with a common \vn{y_pix}. Since this can include pixels not
recorded in the pixel-by-pixel file (due to a non-zero
\vn{lux_param%intensity_min_det_pixel_cutoff} setting), quantities
like the total number of photon need not match between the
pixel-by-pixel file and the projected files.

The third of the three additional files generated will have the same name as 
\vn{det_pix_out_file} with a ``.energy'' suffix. This file contains 
This file will contain a table with columns:
\begin{example}
  Energy            ! Center photon energy of bin (eV).
  intensity_x       ! Normalized x-polarized intensity of photons in bin
  intensity_y       ! Normalized y-polarized intensity of photons in bin
  intensity         ! Normalized intensity = intensity_x + intensity_y
  n_photon          ! Number of photons in bin.
\end{example}
Photons that fall on the detector are binned acording to the photon's
energy.  Each row in the file represents one bin. \vn{n_photon} is the
number of photon in a bin and the intensity columns are the
intensities of these photons. 

The number of energy bins is determined by the setting of
\vn{lux_param%n_energy_bin_pts}. The center energy bin is set by
\vn{photon_init%dE_center}.  The span of the energy bins is determined
by \vn{photon_init%sig_E}. If the \vn{photon_init%energy_distribution}
is set to 'UNIFORM', the span of the energy bins is set to
2*\vn{photon_init%sig_E}. If \vn{photon_init%energy_distribution} is
set to 'GAUSSIAN', the span of the energy bins is set to
6*\vn{photon_init%sig_E}. In this latter case, if photons have an
energy that falls outside the energy range of bins, these photons are
counted in the edge bin with the nearest energy.

%------------------------------------------------------------------
\section{Python Scripting}
\label{s:python}

In some cases it is desired to study some output parameter while
varying some input parameter. For example, it may be desired to look
at a ``rocking curve'' where the initial angle of the photons are
varied and the output intensity is monitored.  Such studies can be
easily achieved using a scripting language like \vn{python}.

Example:
\begin{listing}{1}
#!/usr/bin/env python

import subprocess
import glob

# Read in template lattice file

t_file = open ('template.bmad', 'r')
template = t_file.readlines()
t_file.close()

# open output file

out_file = open('output.dat', 'w')
out_file.write('#       Var         I_x/I         I_y/I   (I_x-I_y)/I           I_x           I_y             I\n')

# Loop over all runs

n_max = 10
dvar = 0.00001
for ix in range(-n_max, n_max+1):

  # Create file with var_to_change set to correct value

  var = ix * dvar
  print ('Run with var_to_change set to: ' + str(var))

  b_file = open ('lat.bmad', 'w')

  for line in template:
    if (line[:8] == 'var_to_change'): line = 'var_to_change = ' + str(var) + '\n'
    b_file.write(line)

  b_file.close()

  # Run lux
  # Remove any Bmad "digested" files to make sure Bmad rereads the lattice file.

  if len(glob.glob('*digested*')) > 0: subprocess.call('rm *digested*', shell=True)
  subprocess.call('/home/dcs16/linux_lib/production/bin/lux -silent', shell=True)

  # Get output

  with open('det.pix', 'r') as d_file:
    for line in d_file:
      if 'intensity_x_norm' in line: exec(line)
      if 'intensity_y_norm' in line: exec(line)
      if 'intensity_norm' in line: exec(line)

  # write results

  ii = intensity_norm
  ix = intensity_x_norm
  iy = intensity_y_norm

  if ii == 0:
    out_file.write('{:12.2e}'.format(var) + '{:14.4e}'.format(0) + 
                   '{:14.4e}'.format(0) + '{:14.4e}'.format(0))
  else:
    out_file.write('{:12.2e}'.format(var) + '{:14.4e}'.format(ix/ii) + 
                   '{:14.4e}'.format(iy/ii) + '{:14.4e}'.format((ix-iy)/ii))

  out_file.write('{:14.4e}'.format(ix) + '{:14.4e}'.format(iy) + 
                 '{:14.4e}'.format(ii) + '\n')

out_file.close()
\end{listing}

The heart of the script is the loop that begins on line 21 and ends on
line 64. Each iteration of this loop changes one variable in the
lattice file (lines 28 to 34), runs \lux (line 39), and then extracts
the pertanent data (lines 44 to 48). Finally at the end of the loop
the data is appended to the output file in lines 52 through 64.


The lattice file that \lux uses is called \vn{lat.bmad} (this is set
by the \vn{lattice_file} parameter in the \vn{lux.init} file which is
not shown). The python script constructs this \vn{lat.bmad} file by
first readinging in a lattice file called \vn{template.bmad} (lines (8
to 10). In lines 30 to 32 the script transfers, line-by-line, the lines
from \vn{template.bmad} to \vn{lat.bmad}. It has been arranged that
the \vn{template.bmad} file contains the following:
\begin{example}
  var_to_change = 0
  cryst1: crystal, ..., x_pitch = var_to_change
\end{example}
The \vn{var_to_change} variable sets the \vn{x_pitch} attribute of the
crystal named \vn{cryst1}. The Python script will take the line
\begin{example}
  var_to_change = 0
\end{example} 
and modify this (in line 31) to read:
\begin{example}
  var_to_change = <var>
\end{example}
where \vn{<var>} is the value of the \vn{var} variable in the
script. The value of \vn{var} is set in line 25 and ranges from
\vn{-n_max * dvar} to \vn{n_max * dvar} which in this case is from
-10e-5 to 10e-5.

To get the data after \lux is run, the script opens up a file
\vn{det.pix}. This name has been set in the \vn{lux.init} file as the
name of the \vn{det_pix_out_file} parameter:
\begin{example}
   det_pix_out_file = 'det.pix'
\end{example}
The \vn{det_pix_out_file} has a number of initial rows that give
overall parameters. Example:
\begin{example}
  master_input_file   = "lux.init"
  lattice_file        = "lat.bmad"
  normalization       =  1.000000E+02
  intensity_x_unnorm  =     9.41577E+01
  intensity_x_norm    =     9.41577E+03
  intensity_y_unnorm  =     4.64621E-02
  intensity_y_norm    =     4.64621E+00
  intensity_unnorm    =     9.42042E+01
  intensity_norm      =     9.42042E+03
\end{example}
When the script (see line 46) finds a line in \vn{det.pix} that has
the string \vn{intensity_x_norm}, the script ``executes'' this
line. The result is that the script set a variable named
\vn{intensity_x_norm} to the value given in the \vn{det.pix}
file. Similarly, the script extracts the values of
\vn{intensity_y_norm} and \vn{intensity_norm} in lines 47 and 48.

%------------------------------------------------------------------
\begin{thebibliography}{9}

\bibitem{b:bmad}
D. Sagan,
"Bmad: A Relativistic Charged Particle Simulation Library"
Nuc.\ Instrum.\ \& Methods Phys.\ Res.\ A, {\bf 558}, pp 356-59 (2006).

\end{thebibliography}
\end{document}  
