\chapter{Bmad Parameter Structures}

\bmad has various parameters which affect various
calculations that \bmad performs. A given program may give the user
access to some of these parameters so, in order to allow the intelligent
setting of these parameters, this chapter gives an in-depth description.

A set of parameters are grouped that affect a particular type
of calculation are grouped into \vn{``structures''}. Each structure
has a \vn{``structure name''} (also called a \vn{``type name''}) which identifies
the list of parameters in the structure. 
Additionally, there will be an
\vn{``instance name''} which is what the user uses to refer to this
\vn{structure}. For global parameters there will be a unique instance name.
For non-global parameters the instance name will be program specific. 
It is possible to have multiple instance names. For example, in the situation
where a program is simulating multiple particle beams, there could be
multiple \vn{beam_init_struct} (\sref{s:beam.init}) instances. 
To refer to a particular parameter use the syntax
\begin{example}
  instance_name%parameter_name
\end{example}
For example, To refer to the \vn{max_aperture_limit} parameter in
Section~\sref{s:bmad.params} the syntax is
\begin{example}
  bmad_com%max_aperture_limit
\end{example}

%-----------------------------------------------------------------
\section{Bmad Global Parameters}
\label{s:bmad.params}
\index{Bmad general parameters|hyperbf}

Some overall parameters are stored in the \vn{bmad_common_struct}
structure. The instance name here is \vn{bmad_com}. The parameters of
this structure are:
\begin{example}
  type bmad_common_struct
    real(rp) :: max_aperture_limit = 1e3       ! Max Aperture.
    real(rp) :: d_orb(6)           = 1e-5      ! for the make_mat6_tracking routine.
    real(rp) :: grad_loss_sr_wake  = 0         ! Internal var for Cavities.
    real(rp) :: default_ds_step    = 0.2       ! Integration step size.  
    real(rp) :: rel_tolerance = 1e-5           ! Runge-Kutta: Relative tolerance.
    real(rp) :: abs_tolerance = 1e-8           ! Runge-Kutta: Absolute tolerance.
    integer :: taylor_order = 3                ! 3rd order is default
    integer :: default_integ_order = 2         ! PTC integration order
    logical :: canonical_coords = .true.       ! Use (x, px) [not (x, x')]
    logical :: use_liar_lcavity = .false.      ! Liar like tracking?
    logical :: sr_wakes_on = .true.            ! Short range wake fields?
    logical :: lr_wakes_on = .true.            ! Long range wake fields
    logical :: mat6_track_symmetric = .true.   ! symmetric offsets
    logical :: auto_bookkeeper = .true.        ! Automatic bookkeeping?
    logical :: trans_space_charge_on = .false. ! Space charge switch
    logical :: coherent_synch_rad_on = .false. ! csr 
    logical :: spin_tracking_on = .false.      ! spin tracking?
    logical :: radiation_damping_on = .false.       ! Damping toggle.
    logical :: radiation_fluctuations_on = .false.  ! Fluctuations toggle.
    logical :: compute_ref_energy = .true.          ! Enable recomputation?
  end type
\end{example}

\vn{max_aperture_limit} is the maximum amplitude a particle can have
during tracking. If this amplitude is exceeded, the particle is
lost even if there is no element aperture set. Having a maximum
aperture limit helps prevent numerical overflow in the tracking calculations.

\vn{d_orb} is the orbit displacement used in the routine that
calculates the transfer matrix through an element via tracking.

%-----------------------------------------------------------------
\section{Beam Initialization Parameters}
\label{s:beam.init}
\index{Beam initialization parameters|hyperbf}

Beams of particles are used for simulating inter-bunch intra-bunch effects.
The \vn{beam_init_struct} structure holds parameters which are used to initialize
the beam. The parameters of this structure are:
\begin{example}
  type beam_init_struct
    real(rp) a_norm_emitt     ! a-mode emittance
    real(rp) b_norm_emitt     ! b-mode emittance
    real(rp) :: dPz_dz = 0    ! Correlation of Pz with long position.
    real(rp) :: center(6) = 0 ! Bench center offset relative to reference.
    real(rp) ds_bunch         ! Distance between bunches.
    real(rp) sig_z            ! Z sigma in m.
    real(rp) sig_e            ! e_sigma in dE/E.
    real(rp) bunch_charge     ! charge in a bunch.
    real(rp) :: center_jitter(6) = 0.0 ! Bunch center rms jitter
    real(rp) :: emitt_jitter(2)  = 0.0 ! a and b normalized rms emittance jitter
    real(rp) :: sig_z_jitter     = 0.0 ! bunch length RMS jitter 
    real(rp) :: sig_e_jitter     = 0.0 ! energy spread RMS jitter 
    type(beam_spin_struct)  spin       ! Initialize the spin
    integer :: n_particle = 0          ! Number of simulated particles per bunch.
    integer :: n_bunch = 0             ! Number of bunches.
    logical :: renorm_center = .true.  ! Renormalize centroid?
    logical :: renorm_sigma = .true.   ! Renormalize sigma?
    logical :: preserve_dist = .false. ! use the same grid distribution each time
    logical :: init_spin     = .false. ! initialize beam spinors
  end type
\end{example}
The number of bunches in the beam is set by \vn{n_bunch}. 
The number of simulation particles in a bunch is set by \vn{n_particle}.


%-----------------------------------------------------------------
\section{CSR Parameters}
\label{s:csr.params}
\index{CSR parameters|hyperbf}

The Coherent Synchrotron Radiation (CSR) calculation is discussed in
Section~\sref{s:csr}. Besides the parameters discussed below, the
\vn{coherent_synch_rad_on} parameter in Section~\sref{s:bmad.params}
must be set True to enable the CSR calculation.

The CSR parameter structure has a \vn{type name}
of \vn{csr_parameter_struct} and an \vn{instance name} of \vn{csr_param}.
This structure has components
\begin{example}
  type csr_parameter_struct 
    real(rp) :: ds_track_step = 0          ! Tracking step size
    real(rp) :: beam_chamber_height = 0    ! Used in shielding calculation.
    real(rp) :: sigma_cutoff = 0.1         ! Cutoff for the lsc calc. If a bin sigma
                                           !  is < cutoff * sigma_ave then ignore.
    integer :: n_bin = 0                   ! Number of bins used
    integer :: particle_bin_span = 2       ! Longitudinal particle length / dz_bin
    integer :: n_shield_images = 0         ! Chamber wall shielding. 0 = no shielding.
    logical :: lcsr_component_on = .true.  ! Longitudinal csr component
    logical :: lsc_component_on = .true.   ! Longitudinal space charge component
    logical :: tsc_component_on = .true.   ! Transverse space charge component
    logical :: small_angle_approx = .true. ! Use lcsr small angle approximation?
  end type
\end{example}
The values for the various quantities shown above are their default values. 

\vn{ds_track_step} is the nominal longitudinal distance traveled by
the bunch between CSR kicks. The actual distance between kicks within
a lattice element is adjusted so that there is an integer number of
steps from steps from the element entrance to the element exit.  This
parameter must be set to something positive otherwise an error will
result. Larger values will speed up the calculation at the expense of
accuracy.

\vn{beam_chamber_height} is the height of the beam chamber in
meters. This parameter is used when shielding is taken into account.
See also the description of the parameter \vn{n_shield_images}.

\vn{sigma_cutoff} is used in the longitudinal space charge (LSC)
calculation and is used to prevent bins with only a few particles in
them to give a large contribution to the kick when the computed
transverse sigmas are abnormally low.

\vn{n_bin} is the number of bins used. The bind width is dynamically
adjusted at each kick point so that the bins will span the bunch
length.  This parameter must be set to something positive. Larger
values will slow the calculation while smaller values will lead to
inaccuracies and loss of resolution. \vn{n_bin} should also not be set
so large that the average number of particles in a bin is too small. 
``Typical'' values are in the range 100 --- 1000.

\vn{particle_bin_span} is the width of a particle's triangular density
distribution (cf.~\sref{s:csr}) in multiples of the bin width. A
larger span will give better smoothing of the computed particle
density with an attendant loss in resolution.

\vn{n_shield_images} is the number of shielding current layers used in
the shielding calculation. A value of zero results in no
shielding. See also the description of the parameter
\vn{beam_chamber_height}. The proper setting of this parameter depends
upon how strong the shielding is. Larger values give better accuracy
at the expense of computation speed. ``Typical'' values are in the
range 0 --- 5.

\vn{lcsr_component_on} toggles on or off the (longitudinal) CSR kick.

\vn{lsc_component_on} toggles on or off the transverse space charge
kick. Currently this calculation is not implemented so this parameter
does not have any affect.

\vn{small_angle_approx} toggles whether the small angle approximation
is used in the calculation. This is generally an excellent
approximation.

