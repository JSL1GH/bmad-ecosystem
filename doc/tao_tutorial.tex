\documentclass{book}


\usepackage{graphicx}
\usepackage{moreverb}
\usepackage{amsmath}
\usepackage{alltt}
\usepackage{rotating}
\usepackage{subfigure}
\usepackage{toc}
\usepackage{xspace}

\input{macros.tex}

\setlength{\textwidth}{6.25in}
\setlength{\oddsidemargin}{0.25in}
\setlength{\evensidemargin}{0.00in}
\setlength{\textheight}{8.5in}
\setlength{\topmargin}{0in}

\begin{document}

%----------------------------------------------------------------
% Cover Page

\thispagestyle{empty}

\begin{flushright}
\large
  Revision: 0.1 \\
  9 June, 2004 \\
\end{flushright}

\vfill

{
\begin{center}
{\Huge \sf\bf The} \\
\vskip 0.1in
\includegraphics[width=10cm]{tao.psfig} \\
\vskip 0.1in
{\Huge \sf\bf Tutorial} \\
\vskip 0.1in
{\normalsize \sf\bf by Jeffrey C. Smith} \\
\end{center}
}

\vskip 1in
\begin{center}
{\Huge \bf *** VERY ROUGH DRAFT ***}
\end{center}
\vfill
\break
%----------------------------------------------------------------
%Introduction

{
\setlength{\parskip}{\dPar}
\setlength{\parindent}{0ex}

\section*{Tao: The Tool for Accelerator Optics}

Many simulation problems fall into one of three categories: 

\begin{itemize}
\item 
You want to design a lattice subject to various constraints.
\item 
You have some measured data and you want to make a correction. For
example, you want to know what steering strength changes will make an orbit
flat.
\item
You want to simulate what happens to the orbit, beta function,
etc., when you change something in the machine.
\end{itemize}

Programs that are written to solve these types of problems have common
elements: You have variables you want to vary in your model of your
machine, you have "data" that you want to view, and, in the first two
categories above, you want to match the machine model to the data (in
designing a lattice the constraints correspond to the data).

Because of this commonality of design, the \tao program was developed
to reduce the time needed to develop working programs. \tao is a
machine independent program that implements the essential ingredients
needed to solve simulation problems. To make the
connection, \tao uses configuration input files that can be tailored to
specific machines. Additionally, \tao has been built
to be easily customizable so that extending \tao to solve new and
different problems is relatively straight forward.

More information, including the most up--to--date version of this
tutorial, can be found at the \bmad web site at
\begin{example}
  http://www.lepp.cornell.edu/~dcs/bmad
\end{example}

Tutorials are always difficult to write. Please send any recommendations 
for imporvement or notices of outright errors to:
\begin{example}
  Jeff Smith <js344@cornell.edu>
\end{example}
}

%----------------------------------------------------------------
\tableofcontents
%% \listoffigures
%% \listoftables

\setlength{\parskip}{\dPar}
\setlength{\parindent}{0ex}

%----------------------------------------------------------------
\chapter{Before we start}
\label{c:before_beginning}

\tao is readily customizable. However beginners are advised to start with
''out of the box'' \tao while getting to know the program.

\section{Getting and Compiling \tao}

\tao is available in the \cesr CVS area. To checkout a copy type \cmd{cvs co
tao} in the directory from where you want to run \tao. If you don't have \cesr
CVS write permission then type \cmd{cesrcvs co tao}. This will check out a copy
but will not allow you to check in changes to the code. If you aren't at Wilson
Laboratory then contact David Sagan <dcs16@cornell.edu> to obtain a copy. 

From the newly created \cs{./tao} directory type \cmd{gmake} to create the
libraries and then type \cmd{gmake -f M.tao} to create
the ''vanilla'' \tao program. Vanilla \tao is the basic \tao program without any
user customizations. this tutorial covers to basic usage of this program.
If you are using a custom version of \tao then
follow the compiling directions from the custom \tao author. Keep in mind that
command syntax and usage may vary between custom versions of \tao (this is a
\textit{feature} \textbf{not} a bug!).

Once \tao has compile go to the subdirectory \cs{./program} and type
\cmd{../../bin/tao} to run the program. This directory contains all the
configuration files to get everything working.

\subsection{customising \tao}

If you are creating a custom version of \tao then you are already more advanced than
the scope of this tutorial! See the \tao Reference Manual for details.

%----------------------------------------------------------------
%----------------------------------------------------------------
\chapter{In the Beginning...}
\label{c:beginning}

%----------------------------------------------------------------
\section{There was the the user}

This tutorial assumes the reader is already familiar with basic particle beam
dynamics and its formalism. There are several books that introduce the topics
very well. the best the author has found so far is \textit{The Physics of
Particle Accelerators} by Klaus Wille. 

\tao is based on the \bmad subroutins library and the reader is assumed to have
a working knowledge of the conventions used by \bmad. \tao can be used ''out of
the box'' so an understanding of the nitty-gritty details of \bmad is not
necessary, however, one should be familiar with the material in chapters 1 and 2
of the \bmad manual.

\fbox{introduce the basic things one would want to do with \tao}

This tutorial is designed to get the user up and starting with \tao without
needing to dredge through the entire reference manual. Full command syntax
or greater detail on any topic can be found in this manual.

%----------------------------------------------------------------
\section{Then there was the super-universe}

Everything known to \tao is placed in an area called the
\textit{super-universe}. Within the \textit{super-universe} lies one or more
universes each containing a particular machine lattice. This allows for the user
to do analysis on multiple machines or multiple configurations of a single
machine at the same time. 

\subsection{A typical universe}
A universe contains a \bmad lattice plus whatever data one wishes to study
within this lattice (i.e. twiss parameters, orbit, phase \&etc...\. Actually,
there are three lattice instances within each universe: the \textbf{design
lattice}, \textbf{model lattice} and \textbf{base lattice}. All lattice changes
specified during a session are incurred on the model lattice. The design lattice is
fixed at initilization time and serves as a reference point for any elemental
changes incurred during the \tao session. The base lattice also serves as a
reference point but the user can transfer the model lattice over to the base
lattice whenever it is desired.

Each data point (for example, the horizontal orbit at some detector) has 5 datum
 quantities associated with it: the \textbf{measured data}, \textbf{reference
data}, \textbf{model data}, \textbf{design data} and \textbf{base data}. The
model, design and base data areas correspond to the appropriate quantity
calculated in their respective lattice above. The measured data corresponds to 
data obtained during a measurement. If doing design work then the desired data
value would be placed here \( this is also refered to as a constraint during
optimization\). The reference data is just like the base data except it isn't
associated or synchronized with a lattice.

\subsection{Variables}

Variables control attributes of elements in the model lattice of one or more
universes. So, a given variable may control a single atribute of one element
for one or more universes. 

\subsection{Other stuff in the Superuniverse}

The super-universe also contains information pertaining to global variables and
plotting. The the \tao referenc emanual for details.

%----------------------------------------------------------------
%----------------------------------------------------------------
\chapter{Initializing \tao}
\label{c:initializing}

There are three files used to initialize \tao.
  \vspace*{-3ex}
\begin{description}
  \item[tao.init] \Newline 
    This is where global parameters are specified and the data and variable
arrays are specified.
  \item[tao\_plot.init] \Newline
    This is where the plotting is set up.
  \item[tao.startup] \Newline
    this is a command file that is read in after initialization. Any commands you
want entered in \tao everytime you start up are put here. This is also a great
place to define aliases.
\end{description}

There is no need to go into the details of the initialization files here. If
using vanilla \tao these are already set up for you in \cs{/tao/program}. These
initialization files setup \tao for use with a \cesr lattice. If
using a custom version of \tao then the author will have already set something
up for you to use. If he or she didn't then go complain to him or her for making
your life difficult and demand proper treatment.

\textbf{NOTE: the following chapters will work with vanilla \tao. The commands
entered and plotting output may be different for custom versions.}


%----------------------------------------------------------------
%----------------------------------------------------------------
\chapter{Getting information from \tao}
\label{c:get_info}

%----------------------------------------------------------------
\section{the plotting window}

When \tao first starts up you will see a plot window and a command prompt. 
Figure~\ref{f:plot_begin} shows what you will see in the plot window. In the top
two plots you see the \vn{x} and \vn{y} model lattice orbit data. The horizontal
axis is the \cesr BPM index. The pretzel and L03 vertical bump can be clearly 
seen. The slight vertical displacement due to the solenoid can also be seen around 
the IP. The default particle is the electron. The bottom two plots show the relative 
particle phase. That is the difference
between the model and design phases (as specified in the plot title: [model -
design]. 

As a first step let's view the absolute model phase. At the TAO> prompt type
\begin{example}
  plot bottom model
\end{example}
This will change the data plotted in the bottom two graphs to just the model.
The plots are now way off scale. To let \tao automatically set the scale type
\begin{example}
  scale bottom
\end{example}
As expected, the phase increases approximately linearly as the particle travels
through the ring. Zero phase is halfway through the ring (at L03 in \cesr lingo).
This is always true. Absolute phase is arbitrary so \tao sets the average
phase to zero when generating the data. OK, lets' set this back to relative
phase by typing
\begin{example}
  plot bottom model - design
\end{example}

Let's now look at the beta function by typing
\begin{example}
  place bottom beta
\end{example}
Again, we need to rescale the plots by typing
\begin{example}
  scale bottom
\end{example}

Likewise, we can look at the dispersion in the top two graphs by typing
\begin{example}
  place top eta
  scale top
\end{example}
The plot window should now look like Figure~\ref{f:plot_eta_beta}.

Now let's look at the coupling (C-matrix) by typing
\begin{example}
  place bottom cbar
  scale bottom
\end{example}
We see that there is strong coupling within the CLEO solenoid and virtually no
coupling anywhere else.

\begin{figure}
  \centering
  \includegraphics[width=5in]{plot_page1.psfig}
  \caption{The plot window at startup}
  \label{f:plot_begin}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=5in]{plot_eta_beta.psfig}
  \caption{Plotting dispersion and beta function}
  \label{f:plot_eta_beta}
\end{figure}

%----------------------------------------------------------------
\section{the \cmd{show} command}

Anything in the super-universe can be displayed using the \cmd{show} command. To
get a list of the data elements currently defined in \tao type
\begin{example}
  show data
\end{example}
the output should look like:
\begin{example}
   1  orbit
   2  phase
   3  eta
   4  beta
   5  cbar
   6  coupling
\end{example}
There are 6 data types defined. The sixth is \textbf{WTF is this?}. 

To see the data values for the horizontal beta function for \cesr BPMs 1 through
50 type
\begin{example}
  show data beta:x 1:50
\end{example}
since we haven't changed any elements in the lattice yet the model values equal
the design values.

You can also view variables by typing
\begin{example}
  show var
\end{example}
To view the quadrupole k1 values for \cesr quadrupoles 5  and 20 through 30 type
\begin{example}
  sho var quad\_k1 5 20:30
\end{example}
Again, since we haven't changed any quadrupoles the model values are all at their
design values.

You can also see details of a particular lattice element. To view the details
for quadrupole Q05W type
\begin{example}
  sho ele Q03W
\end{example}

A list of lattice elements betweem two elements can be shown by typing (for
example)
\begin{example}
  sho lattice beginning Q05W
\end{example}

%----------------------------------------------------------------
%----------------------------------------------------------------
\chapter{Modifying the lattice}
\label{c:modify_lattice}

Let's change a variable and see what happend to the lattice. We are going to
change a quadrupole strength so we should plot beta and phase. So type
\begin{example}
  place top beta
  plot top model - design
  place bottom phase
  scale
\end{example}

The k1 value can be increased by 0.01 units for quadrupole Q05W by typing
\begin{example}
  change var quad\_k1 5 0.01
  scale
\end{example}
Note the information returned after the command and the relative changes in
beta and phase in the plot window. This is a vertically focusing quadrupole so
the vertical beta and phase is affected more than the horizontal.

Let's put this quadrupole back where we found it. We can also modify the quadrupole
by modifying the element directly bytyping
\begin{example}
  change ele Q05W k1 -0.01
\end{example}

A great way to set all variable back to their design values is to type
\begin{example}
  set var all model = design
\end{example}

%----------------------------------------------------------------
%----------------------------------------------------------------
\chapter{Running the optimizer}
\label{c:optimizer}

There are two optimizers included with \tao. DESCRIBE THE OPTIMIZERS.

Let's mess the lattice up a little and see if the optimizer can ''fix'' the
lattice. First transfer the ''correct'' lattice to the \vn{meas} data area.
\begin{example}
  set data all meas = design
\end{example}
Now mess up the lattice a bit
\begin{example}
  change var quad\_k1 10 0.001
  change var quad\_k1 21 -0.001
  change var quad\_k1 67 -0.005
  plot all meas - model
  scale
\end{example}

Now specify what variable and data to use in the optimization. First type
\begin{example}
  show top10
\end{example}
to see what data is affecting the merit function the most. The merit function is
defined by
\Begineq
  {\cal M} \equiv \sum_{i} w_i \,
    \bigl[ \data\_\model(i) -  \data\_\meas(i) \bigr]^2 + 
  \sum_{j} w_j \,
    \bigl[ \var\_\model(j) - \var\_\meas(j) \bigr]^2
  \label{m1}
\Endeq
We see that the beta function is affecting the merit function the most. Since we
are looking at beta and phase let's only use that data in the optimization.
\begin{example}
  veto data orbit all
  veto data eta all
  veto data cbar all
  veto data coupling all
  use  data beta all
  use  data phase all
\end{example}
We also know that we need to change quadrupoles to ''correct'' the lattice.
\begin{example}
  use var quad\_k1 all
  veto var h\_steer all
  veto var v\_steer all
\end{example}
Now let's see if we have the optimizer set up correctly.
\begin{example}
  sho optimizer
\end{example}
Whoops! we want to use the Levenberg-marquat optimizer so
\begin{example}
  set global optimizer = lm
  sho opt
\end{example}

Now we're ready to run or ''flatten'' the model to the data.
\begin{example}
  flatten
\end{example}
You see the optimizer going through its cycles and it did it! The model is now
''flattened.''

%----------------------------------------------------------------
%----------------------------------------------------------------
\chapter{Single Mode}
\label{c:single_mode}

%----------------------------------------------------------------
%----------------------------------------------------------------
\chapter{Where to go from here}
\label{c:where_to_go}

\end{document}
