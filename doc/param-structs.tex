\chapter{Parameter Structures}
\label{c:param.structs}

%-----------------------------------------------------------------
\section{What is a Structure?}
\label{s:struct}
\index{structure|hyperbf}

A ``structure'' is a collection of parameters.  \bmad has various
structures which can be used for various tasks. For example, the
\vn{beam_init_struct} structure (\sref{s:beam.init.struct}) is used to set
parameters used to initialize particle beams.

A given program may give the user access to some of these structures
so, in order to allow intelligent parameter setting, this chapter
gives an in-depth description of the most common ones.

Each structure has a \vn{``structure name''} (also called a \vn{``type
name''}) which identifies the list of parameters (also called
``components'') in the structure. Associated with a structure there
will be an \vn{``instance''} of this structure and this instance will
have an \vn{``instance name''} which is what the user uses to set
parameters. It is possible to have multiple instances of a
structure. For example, in the situation where a program is simulating
multiple particle beams, there could be multiple \vn{beam_init_struct}
(\sref{s:beam.init.struct}) instances with one for each beam.

\bmad defines uses some structures to hold global parameters. That is,
parameters that shared by all code. Each of these structures has
a single associated instance. These are:
\begin{center}
  \begin{tabular}{ll} \toprule
  Structure           & Instance    \\
  \midrule
  bmad_common_stuct   & bmad_com    \\
  csr_parameter_stuct & csr_param   \\
  \bottomrule
  \end{tabular}
\end{center}
All other structures will have instance names that are program
specific.  That is, see the program documentation for the instance
name(s) used.

To set a particular component of an instance use the syntax
\begin{example}
  instance_name%parameter_name = value
\end{example}
Example:
\begin{example}
  bmad_com%max_aperture_limit = 10
\end{example}
this sets the \vn{max_aperture_limit} parameter of \vn{bmad_com}.

%-----------------------------------------------------------------
\section{Bmad_Common_Struct}
\label{s:bmad.common}
\index{Bmad!general parameters|hyperbf}

The \vn{bmad_common_struct} structure contains a set of global parameters. There is only
one global instance (\sref{c:param.structs}) of this structure and this instance has the name
\vn{bmad_com}. The components of this structure along with the default values are:
\index{max_aperture_limit}\index{d_orb(6)}
\index{grad_loss_sr_wake}\index{default_ds_step}
\index{rel_tol_tracking}\index{abs_tol_tracking}
\index{rel_tol_adaptive_tracking}\index{abs_tol_adaptive_tracking}
\index{taylor_order}\index{default_integ_order}
\index{sr_wakes_on}\index{lr_wakes_on}
\index{mat6_track_symmetric}\index{auto_bookkeeper}\index{csr_and_space_charge_on}
\index{spin_tracking_on}\index{radiation_damping_on}\index{spin_sokolov_ternov_flipping_on}
\index{radiation_fluctuations_on}\index{be_thread_safe}
\index{absolute_time_tracking_default}
\index{bmad_common_struct|hyperbf}
\begin{example}
  type bmad_common_struct
    real(rp) max_aperture_limit = 1e3           ! Max Aperture.
    real(rp) d_orb(6)           = 1e-5          ! for the make_mat6_tracking routine.
    real(rp) default_ds_step    = 0.2           ! Integration step size.  
    real(rp) significant_length = 1e-10         ! meter 
    real(rp) rel_tol_tracking = 1e-8            ! Closed orbit relative tolerance.
    real(rp) abs_tol_tracking = 1e-11           ! Closed orbit absolute tolerance.
    real(rp) rel_tol_adaptive_tracking = 1e-8   ! Runge-Kutta tracking relative tolerance.
    real(rp) abs_tol_adaptive_tracking = 1e-10  ! Runge-Kutta tracking absolute tolerance.
    real(rp) init_ds_adaptive_tracking = 1e-3   ! Initial step size.
    real(rp) min_ds_adaptive_tracking = 0       ! Minimum step size to use.
    real(rp) fatal_ds_adaptive_tracking = 1e-8  ! Threshold for loosing particles.
    real(rp) autoscale_amp_abs_tol = 0.1_rp     ! Autoscale absolute amplitude tolerance (eV).
    real(rp) autoscale_amp_rel_tol = 1d-6       ! Autoscale relative amplitude tolerance
    real(rp) autoscale_phase_tol = 1d-5         ! Autoscale phase tolerance.
    real(rp) electric_dipole_moment = 0         ! Particle's EDM. Call set_ptc to transfer value to PTC.
    real(rp) ptc_cut_factor = 0.006             ! Cut factor for PTC tracking
    real(rp) sad_eps_scale = 5.0d-3             ! Used in sad_mult step length calc.
    real(rp) sad_amp_max = 5.0d-2               ! Used in sad_mult step length calc.
    integer sad_n_div_max = 1000                ! Used in sad_mult step length calc.
    integer taylor_order = 3                    ! 3rd order is default
    integer default_integ_order = 2             ! PTC integration order
    integer ptc_max_fringe_order = 2            ! PTC max fringe order (2 => Quadrupole !).
    integer max_num_runge_kutta_step = 10000    ! Max num RK steps before particle is lost.
    logical rf_phase_below_transition_ref = F   ! Autoscale around phase phi0 = 0.5
    logical sr_wakes_on = T                     ! Short range wakefields?
    logical lr_wakes_on = T                     ! Long range wakefields
    logical mat6_track_symmetric = T            ! symmetric offsets
    logical orientation_to_ptc_design = F       ! Ele orientation translated to PTC design?
    logical auto_bookkeeper = T                 ! Automatic bookkeeping?
    logical csr_and_space_charge_on = F         ! CSR and space charge (separate from HE SC).
    logical spin_tracking_on = F                ! spin tracking?
    logical spin_sokolov_ternov_flipping_on = F ! Spin flipping during radiation emission?
    logical radiation_damping_on = F            ! Damping toggle.
    logical radiation_fluctuations_on = F       ! Fluctuations toggle.
    logical conserve_taylor_maps = T            ! Enable bookkeeper to set
                                                ! ele%taylor_map_includes_offsets = F?
    logical absolute_time_tracking_default = F  ! Default for lat%absolute_time_tracking
    logical aperture_limit_on = T               ! Use aperture limits in tracking.
    logical debug = F                           ! Used for code debugging.
  end type
\end{example}

Note: \vn{bmad_com} parameters may always be set in a lattice file as
discussed in Section~\sref{s:bmad.com}. However, thought must be given
to setting \vn{bmad_com} parameters in a lattice file since that will
affect every program that uses the lattice.

Parameter description:
\begin{description}
\index{aperture_limit_on}
\item[\vn{\%abs_tol_adaptive_tracking}] \Newline
Absolute tolerance to use in adaptive tracking. This is used in
\vn{runge-kutta} and \vn{time_runge_kutta} tracking (\sref{s:integ}).
%
\item[\vn{\%abs_tol_tracking}] \Newline
Absolute tolerance to use in tracking. Specifically, Tolerance to use
when finding the closed orbit.
%
\item[\vn{\%absolute_time_tracking_default}] \Newline
Default setting to be applied to a lattice if
\vn{absolute_time_tracking} (\sref{s:param}) is not specified in a
lattice file. Additionally, if an element that is not associated with a lattice
is tracked, \vn{%absolute_time_tracking_default} will be used to
determine whether absolute time tracking is used. 

To change between absolute and relative time tracking
(\sref{s:rf.time}) after lattice file parsing, the
\vn{%absolute_time_tracking} component of a \vn{lat_struct}
(\sref{s:abs.time}) can be appropriately set.
%
\item[\vn{\%aperture_limit_on]}] \Newline
Aperture limits may be set for elements in the lattice
(\sref{s:limit}). Setting \vn{aperture_limit_on} to \vn{False} will
disable all set apertures. \vn{True} is the default.
%
\item[\vn{\%auto_bookkeeper}] \Newline
Toggles automatic or intelligent bookkeeping. See
section~\sref{s:lat.bookkeeping} for more details.
%
\item[\vn{\%autoscale_amp_abs_tol}] \Newline
Used when \bmad autoscales (\sref{s:autoscale}) an elements field amplitude. This parameter sets the
absolute tolerance for the autoscale amplitude parameter.
%
\item[\vn{\%autoscale_amp_rel_tol}] \Newline
Used when \bmad autoscales (\sref{s:autoscale}) an elements field amplitude. This parameter sets the
relative tolerance for the autoscale amplitude parameter.
%
Used when \bmad autoscales (\sref{s:autoscale}) an elements AC phase. This parameter sets the
absolute tolerance for the autoscale parameter.
%
\item[\vn{\%autoscale_phase_tol}] \Newline
\item[\vn{\%init_ds_adaptive_tracking}] \Newline
Initial step to use for adaptive tracking. This is used in
\vn{runge-kutta} and \vn{time_runge_kutta} tracking (\sref{s:integ}).
%
\item[\vn{\%conserve_taylor_maps}] \Newline
Toggle to determine if the Taylor map for an element include any
element ``misalignments''.  See Section~\sref{s:mapoff} for more
details.
%
\item[\vn{\%csr_and_space_charge_on}] \Newline
Turn on or off the coherent synchrotron radiation and space charge calculations. (\sref{s:csr}).
The space charge calculation here is not to be confused with the high energy space charge
calculation (\sref{s:he.space.charge})
%
\item[\vn{\%d_orb}] \Newline 
Sets the orbit displacement used in the routine that calculates the transfer matrix through an
element via tracking. That is, when the \vn{mat6_calc_method} (\sref{s:xfer}) is set to
\vn{tracking}. \vn{%d_orb} needs to be large enough to avoid significant round-off errors but not so
large that nonlinearities will affect the results. The default value is $10^{-5}$. Also see
\vn{%mat6_track_symmetric}.
%
\item[\vn{\%debug}] \Newline
Used for communication between program units for debugging purposes.
%
\item[\vn{\%default_ds_step}] \Newline
Step size for tracking code \sref{c:methods} that uses a fixed step
size. For example, \vn{symp_lie_ptc} tracking.
%
\item[\vn{\%default_integ_order}] \Newline
Order of the integrator used by \'Etienne Forest's PTC code (\sref{s:libs}).
The order of the PTC integrator is like the order of a Newton-Cotes method.
Higher order means the error term involves a higher order derivative of the field.
%
\item[\vn{\%electric_dipole_moment}] \Newline
The electric dipole moment value used in tracking a particle's spin (\sref{s:spin.dyn}).
%
\item[\vn{\%fatal_ds_adaptive_tracking}] \Newline
This is used in \vn{runge-kutta} and \vn{time_runge_kutta} tracking
(\sref{s:integ}).  If the step size falls below the value set for
\vn{%fatal_ds_adaptive_tracking}, a particle is considered lost.
This prevents a program from ``hanging'' due to taking a large number
of extremely small steps. The most common cause of small step size is
an ``unphysical'' magnetic or electric field.
%
\item[\vn{\%lr_wakes_on}] \Newline
Toggle for turning on or off long-range higher order mode wakefield effects.
%
\item[\vn{\%mat6_track_symmetric}] \Newline
Toggle to turn off whether the transfer matrix from tracking routine
(\Hyperref{r:twiss.from.tracking}{twiss_from_tracking}) tracks 12 particles at both plus and minus
\vn{%d_orb} values or only tracks 7 particles to save time but is less accurate..
%
\item[\vn{\%max_aperture_limit}] \Newline 
Sets the maximum amplitude a particle can have during tracking. If this amplitude is exceeded, the
particle is lost even if there is no element aperture set. Having a maximum aperture limit helps
prevent numerical overflow in the tracking calculations.
%
\item[\vn{\%max_num_runge_kutta_step}] \Newline 
The maximum number of steps to take through an element with \vn{runge_kutta} or
\vn{time_runge_kutta} tracking. The default value is 10,000. If the number of steps reaches this
value, the particle being tracked is marked as lost and a warning message is issued. Under
``normal'' circumstances, a particle will take far fewer steps to track through an element. If a
particle is not through an element after 10,000 steps, it generally indicates that there is a
problem with how the field is defined. That is, the field does not obey Maxwell's
Equations. Especially: discontinuities in the field can cause problems.
%
\item[\vn{\%min_ds_adaptive_tracking}] \Newline
This is used in \vn{runge-kutta} and \vn{time_runge_kutta} tracking (\sref{s:integ}). Minimum step
size to use for adaptive tracking. If To be useful, \vn{%min_ds_adaptive_tracking} must be set
larger than the value of \vn{%fatal_ds_adaptive_tracking}. In this case, particles are never lost
due to taking too small a step.
%
\item{orientation_to_ptc_design} \Newline
With \bmad, there is no distinction whether an element's orientation attributes (\vn{offsets},
\vn{pitches}, or \vn{tilt} (\sref{s:offset})) is deliberate (part of the ``design'' of the machine)
or an error (a ``misalignment'').  With PTC this is not true. If the \vn{orientation_to_ptc_design}
switch is set to False (the default), when a \bmad element is translated to PTC (for example, if a
Taylor map is to be constructed), the element's orientation attributes are stored as misalignments.
If set to True, these parameters are stored as design values. This will generally not make any
difference to a calculation. The exception comes with PTC centric programs that vary machine
parameters.\footnote
  {
None of the programs that come bundled with \bmad (a \bmad \vn{Distribution}) are
PTC centric.
  }
%
\item{ptc_max_fringe_order} \Newline
Maximum order for computing fringe field effects in PTC. 
%
\item[\vn{\%rf_phase_below_transition_ref}] \Newline
Used when \bmad autoscales (\sref{s:autoscale}) an \vn{rfcavity} and when \bmad calculates the
reference time through a cavity (which affects calculation of phase space $z$ via \Eq{zbctt}).  If
True, the reference phase will be taken to be at \vn{phi0} = 0.5 which is appropriate for a ring
below transition. Default is False in which case autoscaling will be around the phase \vn{phi0} = 0.
%
\item[\vn{\%radiation_damping_on}] \Newline
Toggle to turn on or off effects due to radiation damping in particle tracking.
%
\item[\vn{\%radiation_fluctuations_on}] \Newline
Toggle to turn on or off effects due to radiation fluctuations in particle tracking.
%
\item[\vn{\%rel_tol_adaptive_tracking}] \Newline
Relative tolerance to use in adaptive tracking. This is used in \vn{runge_kutta} and
\vn{time_runge_kutta} tracking (\sref{s:integ}).
%
\item[\vn{\%rel_tol_tracking}] \Newline
Relative tolerance to use in tracking. Specifically, Tolerance to use
when finding the closed orbit.
%
\item[\vn{\%significant_length}] \Newline
Sets the scale to decide if two length values are significantly different. For example, The
superposition code will not create any super_slave elements that have a length less then this.
%
\item[\vn{\%sr_wakes_on}] \Newline
Toggle for turning on or off short-range higher order mode wakefield effects.
%
\item[\vn{\%spin_sokolov_ternov_flipping_on}] \Newline
This determines if the Sokolov-Ternov effect is included in a simulation.  The Sokolov-Ternov
effect\cite{b:barber99} is the self-polarization of charged particle beams due to asymmetric flipping
of a particle's spin when the particle is bent in a magnetic field. Also, spin flipping will {\em
not} be done if spin tracking is off or both radiation damping and excitation are off.
%
\item[\vn{\%spin_tracking_on}] \Newline
Determines if spin tracking is performed or not.
%
\item[\vn{\%taylor_order}] \Newline
Cutoff Taylor order of maps produced by \vn{sym_lie_ptc}.
\end{description}

%-----------------------------------------------------------------
\section{Bmad_Com}
\label{s:bmad.com}

\index{bmad_com}
The parameters of the \vn{bmad_com} instance of the
\vn{bmad_common_struct} structure (\sref{s:bmad.common}) can be set in
the lattice file using the syntax
\begin{example}
  bmad_com[parm-name] = value
\end{example}
where \vn{parm-name} is the name of a component of
\vn{bmad_common_struct}. For example:
\begin{example}
  bmad_com[rel_tol_tracking] = 1e-7
\end{example}

Be aware that setting a \vn{bmad_com} parameter value in a lattice
file will affect all computations of a program even if the program
reads in additional lattice files. That is, setting of \vn{bmad_com}
components is ``sticky'' and persists even when other lattice files
are read in. There are two exceptions: A program is always free to
override settings of \vn{bmad_com} parameters. Additionally, a second
lattice file can also override the setting made in a prior lattice
file.

%-----------------------------------------------------------------
\section{CSR_Parameter_Struct}
\label{s:csr.params}
\index{csr parameters|hyperbf}

The Coherent Synchrotron Radiation (CSR) calculation is discussed in Section~\sref{s:csr}.

Besides the parameters discussed below, the \vn{csr_and_space_charge_on} parameter of \vn{bmad_com}
(\sref{s:bmad.com}) must be set True to enable the CSR calculation. Additionally, tracking with
\vn{CSR} will only be done through elements where the parameter \vn{csr_method} (\sref{s:integ}) has
been set to \vn{1_dim}. This is done so that the computationally intensive \vn{CSR} calculation can
be restricted to places where the \vn{CSR} effect is significant.

The CSR parameter structure has a \vn{type name} of \vn{csr_parameter_struct} and an \vn{instance
name} of \vn{csr_param}.  This structure has components
\index{space_charge_mesh_size}
\begin{example}
  type csr_parameter_struct 
    real(rp) ds_track_step = 0                  ! Tracking step size
    real(rp) beam_chamber_height = 0            ! Used in shielding calculation.
    real(rp) sigma_cutoff = 0.1                 ! Cutoff for the lsc calc. If a bin sigma
                                                !  is < cutoff * sigma_ave then ignore.
    integer n_bin = 0                           ! Number of bins used
    integer particle_bin_span = 2               ! Longitudinal particle length / dz_bin
    integer n_shield_images = 0                 ! Chamber wall shielding. 0 = no shielding.
    integer sc_min_in_bin = 10                  ! Min number of particle needed to compute sigmas.
    integer space_charge_mesh_size = [32,32,64] ! Mesh size with fft_3d space charge calc.
    integer csr_3d_mesh_size = [32,32,64]       ! Mesh size for 3D CSR calc.
    logical small_angle_approx = T              ! Use lcsr small angle approximation?
    logical print_taylor_warning = T            ! Print Taylor element warning?
    logical write_csr_wake = F                  ! Write a CSR wake file?
  end type
\end{example}
The values for the various quantities shown above are their default values. 

\begin{description}
\item{ds_track_step} \Newline
\vn{ds_track_step} is the nominal longitudinal distance traveled by the bunch between CSR kicks if
the lattice element in which the bunch is being tracked has not set element's \vn{csr_ds_track}
parameter. The actual distance between kicks within a lattice element is adjusted so that there is
an integer number of steps from the element entrance to the element exit. Either \vn{ds_track_step}
or the element's \vn{csr_track_step} must be set to something positive otherwise an error will
result when doing CSR or space charge tracking. Larger values will speed up the calculation at the
expense of accuracy.
%
\item{beam_chamber_height} \Newline
\vn{beam_chamber_height} is the height of the beam chamber in meters. This parameter is used when
shielding is taken into account.  See also the description of the parameter \vn{n_shield_images}.
%
\item{sigma_cutoff} \Newline
\vn{sigma_cutoff} is used in the longitudinal space charge (LSC) calculation and is used to prevent
bins with only a few particles in them to give a large contribution to the kick when the computed
transverse sigmas are abnormally low.
%
\item{n_bin} \Newline
\vn{n_bin} is the number of bins used. The bind width is dynamically adjusted at each kick point so
that the bins will span the bunch length.  This parameter must be set to something positive. Larger
values will slow the calculation while smaller values will lead to inaccuracies and loss of
resolution. \vn{n_bin} should also not be set so large that the average number of particles in a bin
is too small.  ``Typical'' values are in the range 100 --- 1000.
%
\item{particle_bin_span} \Newline
\vn{particle_bin_span} is the width of a particle's triangular density distribution
(cf.~\sref{s:csr}) in multiples of the bin width. A larger span will give better smoothing of the
computed particle density with an attendant loss in resolution.
%
\item[\vn{\%space_charge_mesh_size}] \Newline
The \vn{%space_charge_mesh_size} sets the size of the grid used when an element's
\vn{space_charge_method} is set to \vn{fft_3d} (\sref{s:csr.sc.meth}). The value of this parameter
is a 3-element array $(n_x, n_y, n_z)$ giving the mesh size in the $x$, $y$, and $z$ directions
respectively. Default values are $(32, 32, 64)$.
%
\item[\vn{\%csr3d_mesh_size}] \Newline
The \vn{%csr3d_mesh_size} sets the size of the grid used when an element's
\vn{csr_method} is set to \vn{steady_state_3d} (\sref{s:csr.sc.meth}). The value of this parameter is a
3-element array $(n_x, n_y, n_z)$ giving the mesh size in the $x$, $y$, and $z$ directions
respectively. Default values are $(32, 32, 64)$.
%
\item{n_shield_images} \Newline
\vn{n_shield_images} is the number of shielding current layers used in the shielding calculation. A
value of zero results in no shielding. See also the description of the parameter
\vn{beam_chamber_height}. The proper setting of this parameter depends upon how strong the shielding
is. Larger values give better accuracy at the expense of computation speed. ``Typical'' values are
in the range 0 --- 5.
%
\item{sc_min_in_bin} \Newline
the \vn{sc_min_in_bin} parameter sets the minimum number of particle in a bin needed to compute the
transverse beam sigmas for that bin. If the number of particles is less than this number, the beam
sigmas are taken to be equal to the beam sigmas of a nearby bin where there are enough particle to
compute the sigma. The beam sigmas are needed for the CS calculation but not need for the CSR
calculation.
%
\item{write_csr_wake} \Newline
If True (default is False), an output file called \vn{csr_wake.dat} is created that contains a table
of the CSR wake at each track step (the track step size is set by \vn{ds_track_step}). If tracking is 
done through multiple lattice elements, the wake tables for the elements are appended to the file. This
file is useful for visualization of the wake.
\end{description}

Note: \vn{Taylor} map elements (\sref{s:taylor}) that have a finite length cannot be subdivided for
the CSR calculation. \bmad will ignore any \vn{taylor} elements present in the lattice but will
print a warning that it is doing so. To suppress the warning, \vn{print_taylor_warning} should be
set to False.

%-----------------------------------------------------------------
\section{Opti_DE_Param_Struct}
\label{s:de.params}
\index{de optimizer parameters|hyperbf}

\index{opti_de_param_struct}
The Differential Evolution (\vn{DE}) optimizer is used in nonlinear optimization problems. This
optimizer is based upon the work of Storn and Price\cite{b:de}. There are a number of parameters
that can be varied to vary how the optimizer works. These parameters are are contained in a
structure named \vn{opti_de_param_struct}. the instance name is \vn{opti_de_param}.  This structure
has components
\begin{example}
                              Default
  type opti_de_param_struct
    real(rp) CR             = 0.8    ! Crossover Probability.
    real(rp) F              = 0.8    !
    real(rp) l_best         = 0.0    ! Percentage of best solution used.
    logical  binomial_cross = False  ! IE: Default = Exponential.
    logical  use_2nd_diff   = False  ! use F * (x_4 - x_5) term
    logical  randomize_F    = False  !
    logical  minimize_merit = True   ! F => maximize the Merit func.
  end type
\end{example}

The "perturbed vector" is
  v = x_1 + l_best * (x_best - x_1) + F * (x_2 - x_3) + F * (x_4 - x_5)
The last term F * (x_4 - x_5) is only used if \vn{use_2nd_diff} = T.

The crossover can be either "Exponential" or "Binary". 
Exponential crossover is what is described in the paper.
With Exponential crossover the crossover parameters from a contiguous block
and the average number of crossover parameters is approximately
    average crossovers $\sim$ min(D, CR / (1 - CR))
where D is the total number of parameters.
With Binary crossover the probability of crossover of a parameter is 
uncorrelated with the probability of crossover of any other parameter and
the average number of crossovers is
    average crossovers = D * CR

\vn{randomize_F} = True means that the F that is used for a given 
generation  is randomly chosen to be within the range 
[0, 2*F] with average F.

%-----------------------------------------------------------------
\section{Dynamic Aperture Simulations: Aperture_Param_Struct}

\index{dynamic_aperture_struct|hyperbf}
The \vn{dynamic_aperture_struct} is used for dynamic aperture
calculations. This structure has components:
\begin{example}
  type aperture_param_struct
    real(rp) :: min_angle = 0
    real(rp) :: max_angle = pi
    integer :: n_angle   = 9
    integer :: n_turn = 100                ! Number of turns a particle must survive
    real(rp) :: x_init = 1e-3              ! Initial estimate for horizontal aperture
    real(rp) :: y_init = 1e-3              ! Initial estimate for vertical aperture
    real(rp) :: accuracy = 1e-5            ! Resolution of bracketed aperture.
  end type
\end{example}

